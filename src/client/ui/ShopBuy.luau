-- å•†åº—è´­ä¹°ç•Œé¢æ¨¡å—

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- å®‰å…¨è·å–å…±äº«æ¨¡å—
local function getSharedModule(moduleName, timeout)
    timeout = timeout or 10
    local SharedModules = ReplicatedStorage:WaitForChild("SharedModules", timeout)
    if SharedModules then
        local module = SharedModules:WaitForChild(moduleName, timeout)
        if module then return module end
    end
    error("âŒ æ— æ³•æ‰¾åˆ°å…±äº«æ¨¡å—: " .. moduleName)
end

local ShopData, ShopEvents
local success, result = pcall(function()
    ShopData = require(getSharedModule("ShopData"))
    ShopEvents = require(getSharedModule("ShopEvents"))
    return true
end)

if not success then
    warn("âŒ [ShopBuy] å…±äº«æ¨¡å—åŠ è½½å¤±è´¥:", result)
    ShopData = {}
    ShopEvents = {User = {}, Admin = {}}
end
-- è·å–ShopUtilsæ¨¡å—
local function getShopUtils()
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    local playerScripts = player:WaitForChild("PlayerScripts")
    local clientFolder = playerScripts:FindFirstChild("Client")
    if not clientFolder then
        error("âŒ æ‰¾ä¸åˆ°Clientæ–‡ä»¶å¤¹")
    end

    local functionsFolder = clientFolder:FindFirstChild("functions")
    if functionsFolder and functionsFolder:FindFirstChild("ShopUtils") then
        return require(functionsFolder.ShopUtils)
    else
        error("âŒ æ‰¾ä¸åˆ°ShopUtilsæ¨¡å—")
    end
end

local ShopUtils = getShopUtils()

local ShopBuy = {}

-- åˆ›å»ºå•†å“å¡ç‰‡ï¼ˆè´­ä¹°æ¨¡å¼ï¼‰
function ShopBuy.createItemCard(item, itemId, shopData, playerData, showQuantityDialog)
    local card = Instance.new("Frame")
    card.Name = itemId .. "Card"
    card.Size = UDim2.new(1, -50, 0, 120)
    card.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    card.BorderSizePixel = 0
    card.ClipsDescendants = true

    ShopUtils.createCorner(card, 16)

    -- æ·»åŠ æ¸å˜èƒŒæ™¯
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, ShopUtils.COLORS.SECONDARY),
        ColorSequenceKeypoint.new(1, ShopUtils.COLORS.TERTIARY)
    }
    gradient.Rotation = 135
    gradient.Parent = card

    -- æ·»åŠ è¾¹æ¡†å‘å…‰
    local stroke = Instance.new("UIStroke")
    stroke.Color = ShopUtils.COLORS.ACCENT
    stroke.Transparency = 0.8
    stroke.Thickness = 2
    stroke.Parent = card

    -- æ‚¬åœæ•ˆæœ
    card.MouseEnter:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {
            Transparency = 0.3,
            Thickness = 3
        }):Play()
    end)

    card.MouseLeave:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {
            Transparency = 0.8,
            Thickness = 2
        }):Play()
    end)

    -- å•†å“å›¾ç‰‡å®¹å™¨
    local imageContainer = Instance.new("Frame")
    imageContainer.Name = "ImageContainer"
    imageContainer.Size = UDim2.new(0, 90, 0, 90)
    imageContainer.Position = UDim2.new(0, 20, 0, 20)
    imageContainer.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    imageContainer.BorderSizePixel = 0
    imageContainer.Parent = card
    ShopUtils.createCorner(imageContainer, 12)

    -- æ·»åŠ å›¾ç‰‡å®¹å™¨çš„å‘å…‰è¾¹æ¡†
    local imageStroke = Instance.new("UIStroke")
    imageStroke.Color = ShopUtils.COLORS.ACCENT
    imageStroke.Transparency = 0.7
    imageStroke.Thickness = 2
    imageStroke.Parent = imageContainer

    -- å•†å“å›¾ç‰‡
    local imageLabel = Instance.new("ImageLabel")
    imageLabel.Name = "ItemImage"
    imageLabel.Size = UDim2.new(1, -4, 1, -4)
    imageLabel.Position = UDim2.new(0, 2, 0, 2)
    imageLabel.Image = item.imageId or ""
    imageLabel.BackgroundTransparency = 1
    imageLabel.BorderSizePixel = 0
    imageLabel.Parent = imageContainer
    ShopUtils.createCorner(imageLabel, 10)

    -- å•†å“åç§°
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "ItemName"
    nameLabel.Text = item.name
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextSize = 18
    nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    nameLabel.Size = UDim2.new(0, 300, 0, 25)
    nameLabel.Position = UDim2.new(0, 120, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
    nameLabel.Parent = card

    -- å•†å“æè¿°
    local descLabel = Instance.new("TextLabel")
    descLabel.Name = "ItemDesc"
    descLabel.Text = item.description
    descLabel.Font = Enum.Font.Gotham
    descLabel.TextSize = 13
    descLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    descLabel.Size = UDim2.new(0, 300, 0, 20)
    descLabel.Position = UDim2.new(0, 120, 0, 35)
    descLabel.BackgroundTransparency = 1
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.TextWrapped = true
    descLabel.TextTruncate = Enum.TextTruncate.AtEnd
    descLabel.Parent = card

    -- ä»·æ ¼æ ‡ç­¾
    local priceLabel = Instance.new("TextLabel")
    priceLabel.Name = "PriceLabel"
    priceLabel.Text = "ğŸ’° " .. item.price .. " é‡‘å¸"
    priceLabel.TextColor3 = ShopUtils.COLORS.WARNING
    priceLabel.Font = Enum.Font.GothamBold
    priceLabel.TextSize = 16
    priceLabel.Size = UDim2.new(0, 150, 0, 20)
    priceLabel.Position = UDim2.new(0, 120, 0, 60)
    priceLabel.BackgroundTransparency = 1
    priceLabel.TextXAlignment = Enum.TextXAlignment.Left
    priceLabel.TextTruncate = Enum.TextTruncate.AtEnd
    priceLabel.Parent = card

    -- è´­ä¹°æŒ‰é’®
    local buyButton = ShopUtils.createButton("ğŸ›’ è´­ä¹°", ShopUtils.COLORS.SUCCESS, card, function()
        showQuantityDialog(itemId, "buy", item)
    end)
    buyButton.Position = UDim2.new(0, 300, 0, 85)
    buyButton.Size = UDim2.new(0, 100, 0, 25)

    -- åº“å­˜æ˜¾ç¤º
    local stockLabel = Instance.new("TextLabel")
    stockLabel.Name = "StockLabel"
    stockLabel.Font = Enum.Font.Gotham
    stockLabel.TextSize = 12
    stockLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    stockLabel.Size = UDim2.new(0, 120, 0, 20)
    stockLabel.Position = UDim2.new(1, -130, 0, 85)
    stockLabel.BackgroundTransparency = 1
    stockLabel.TextXAlignment = Enum.TextXAlignment.Right
    stockLabel.TextTruncate = Enum.TextTruncate.AtEnd
    stockLabel.Parent = card

    -- ä½¿ç”¨ä»æœåŠ¡å™¨è·å–çš„å®æ—¶åº“å­˜æ•°æ®
    local stock = nil
    if shopData and shopData[itemId] and shopData[itemId].currentStock ~= nil then
        stock = shopData[itemId].currentStock
    elseif item.maxQuantity ~= nil then
        stock = item.maxQuantity
    end

    -- æ£€æŸ¥æ¯æ—¥é™è´­ä¿¡æ¯
    local dailyPurchaseStatus = nil
    if playerData and playerData.id then
        local success, result = pcall(function()
            return nil
        end)

        if success then
            dailyPurchaseStatus = result
        else
            warn("âš ï¸ è·å–æ¯æ—¥è´­ä¹°çŠ¶æ€å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°è®¤è¯")
        end
    end

    -- æ˜¾ç¤ºåº“å­˜å’Œæ¯æ—¥é™è´­ä¿¡æ¯
    local stockText = ""
    if stock == nil or stock == -1 then
        stockText = "åº“å­˜: âˆ"
    else
        stockText = "åº“å­˜: " .. stock
        if stock <= 0 then
            buyButton.BackgroundColor3 = ShopUtils.COLORS.TEXT_MUTED
            buyButton.Text = "ç¼ºè´§"
            buyButton.Active = false
        end
    end

    -- æ·»åŠ æ¯æ—¥é™è´­ä¿¡æ¯
    if dailyPurchaseStatus and dailyPurchaseStatus.hasLimit then
        stockText = stockText .. "\nä»Šæ—¥é™è´­: " .. dailyPurchaseStatus.remaining .. "/" .. dailyPurchaseStatus.dailyLimit

        if dailyPurchaseStatus.remaining <= 0 then
            buyButton.BackgroundColor3 = ShopUtils.COLORS.TEXT_MUTED
            buyButton.Text = "é™è´­å·²æ»¡"
            buyButton.Active = false
        end
    end

    stockLabel.Text = stockText
    stockLabel.TextWrapped = true

    return card
end

-- æ˜¾ç¤ºè´­ä¹°å•†å“åˆ—è¡¨
function ShopBuy.showBuyItems(scrollFrame, shopData, playerData, showQuantityDialog)
    if not scrollFrame then return end

    -- æ¸…ç©ºç°æœ‰å†…å®¹
    for _, child in pairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") and child.Name:find("Card") then
            child:Destroy()
        end
    end

    local yPos = 0
    local itemsToShow = shopData or {}

    -- å°†å•†å“è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼Œç¡®ä¿membershipç±»å‹å•†å“æ’åœ¨æœ€å‰é¢
    local sortedItems = {}
    if itemsToShow and type(itemsToShow) == "table" then
        for itemId, item in pairs(itemsToShow) do
            table.insert(sortedItems, {id = itemId, data = item})
        end

        -- æ’åºï¼šmembershipä¼˜å…ˆï¼Œç„¶åæŒ‰åˆ†ç±»ï¼Œæœ€åæŒ‰åç§°
        table.sort(sortedItems, function(a, b)
            local aCategory = a.data.category or "default"
            local bCategory = b.data.category or "default"

            -- membershipç±»å‹ä¼˜å…ˆ
            if aCategory == "membership" and bCategory ~= "membership" then
                return true
            elseif aCategory ~= "membership" and bCategory == "membership" then
                return false
            end

            -- å¦‚æœéƒ½æ˜¯æˆ–éƒ½ä¸æ˜¯membershipï¼ŒæŒ‰åˆ†ç±»æ’åº
            if aCategory ~= bCategory then
                return aCategory < bCategory
            end

            -- åŒåˆ†ç±»å†…æŒ‰åç§°æ’åº
            return (a.data.name or "") < (b.data.name or "")
        end)

        -- æ˜¾ç¤ºæ’åºåçš„å•†å“
        for _, itemInfo in ipairs(sortedItems) do
            local card = ShopBuy.createItemCard(itemInfo.data, itemInfo.id, shopData, playerData, showQuantityDialog)
            card.Position = UDim2.new(0, 20, 0, yPos + 20)
            card.Parent = scrollFrame
            yPos = yPos + 140
        end
    end

    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 40)
end

return ShopBuy
