-- é¶å­ç³»ç»Ÿå®¢æˆ·ç«¯UIé€»è¾‘
-- è´Ÿè´£å¤„ç†é¶å­çš„å¯è§†åŒ–æ˜¾ç¤ºå’ŒUIæ›´æ–°
-- é€šè¿‡TargetControllerä¸æœåŠ¡ç«¯é€šä¿¡

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))

-- å¼•å…¥TargetController
local Players = game:GetService("Players")
local StarterPlayer = game:GetService("StarterPlayer")
local TargetController = require(StarterPlayer.StarterPlayerScripts.Client.controller.TargetController)

local TargetUI = {}

-- æœ¬åœ°é¶å­UIæ•°æ®å­˜å‚¨
local targetUIs = {}

-- é¶å­æ–‡ä»¶å¤¹å¼•ç”¨
local targetsFolder = nil

-- åˆå§‹åŒ–é¶å­UIç³»ç»Ÿ
function TargetUI.initialize()
    print("ğŸ¯ åˆå§‹åŒ–é¶å­UIç³»ç»Ÿ...")

    -- è·å–é¶å­æ–‡ä»¶å¤¹å¼•ç”¨
    targetsFolder = Workspace:WaitForChild("Targets", 10)
    if not targetsFolder then
        warn("âš ï¸ æ— æ³•æ‰¾åˆ°é¶å­æ–‡ä»¶å¤¹")
        return false
    end

    -- ç»‘å®šControlleräº‹ä»¶è€Œä¸æ˜¯æœåŠ¡ç«¯äº‹ä»¶
    TargetUI.bindControllerEvents()

    print("âœ… é¶å­UIç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    return true
end

-- ç»‘å®šControlleräº‹ä»¶
function TargetUI.bindControllerEvents()
    -- é¶å­åˆ›å»ºäº‹ä»¶
    TargetController.Events.TargetCreated:Connect(function(targetId, targetData)
        TargetUI.createTargetUI(targetId, targetData)
    end)

    -- é¶å­å—æŸäº‹ä»¶
    TargetController.Events.TargetDamaged:Connect(function(targetId, health, maxHealth, attackerId)
        TargetUI.updateTargetHealth(targetId, health, maxHealth)
        TargetUI.showDamageEffect(targetId, attackerId)
    end)

    -- é¶å­æ‘§æ¯äº‹ä»¶
    TargetController.Events.TargetDestroyed:Connect(function(targetId, destroyerId)
        TargetUI.hideTargetUI(targetId)
        TargetUI.showDestroyEffect(targetId, destroyerId)
    end)

    -- é¶å­é‡ç”Ÿäº‹ä»¶
    TargetController.Events.TargetRespawned:Connect(function(targetId, targetData)
        TargetUI.showTargetUI(targetId, targetData)
    end)

    -- é¶å­çŠ¶æ€å˜åŒ–äº‹ä»¶
    TargetController.Events.TargetStatusChanged:Connect(function(targetId, newStatus, oldStatus)
        TargetUI.handleStatusChanged(targetId, newStatus, oldStatus)
    end)
end

-- åˆ›å»ºé¶å­UI
function TargetUI.createTargetUI(targetId, targetData)
    -- ç­‰å¾…é¶å­æ¨¡å‹åˆ›å»º
    local targetModel = targetsFolder:WaitForChild(targetId, 5)
    if not targetModel then
        warn("âš ï¸ æ— æ³•æ‰¾åˆ°é¶å­æ¨¡å‹:", targetId)
        return
    end

    local targetPart = targetModel:WaitForChild("Base", 5)
    if not targetPart then
        warn("âš ï¸ æ— æ³•æ‰¾åˆ°é¶å­ä¸»ä½“éƒ¨åˆ†:", targetId)
        return
    end

    -- ç­‰å¾…æœåŠ¡ç«¯åˆ›å»ºçš„è¡€æ¡UI
    local healthGui = targetPart:WaitForChild("BillboardGui", 5)
    local healthFill = nil
    if healthGui then
        local healthBar = healthGui:FindFirstChild("Frame")
        if healthBar then
            healthFill = healthBar:FindFirstChild("HealthFill")
        end
    end

    -- åˆ›å»ºUIæ•°æ®ç»“æ„
    local uiData = {
        targetId = targetId,
        targetPart = targetPart,
        targetModel = targetModel,
        gui = healthGui,  -- ä½¿ç”¨æœåŠ¡ç«¯åˆ›å»ºçš„UI
        healthBar = healthGui and healthGui:FindFirstChild("Frame"),
        healthFill = healthFill,
        textLabel = healthGui and healthGui:FindFirstChild("TextLabel")
    }

    targetUIs[targetId] = uiData
    print("ğŸ¯ åˆ›å»ºé¶å­UI:", targetId, "è¡€æ¡UI:", healthGui and "å·²æ‰¾åˆ°" or "æœªæ‰¾åˆ°")
end


-- æ›´æ–°é¶å­è¡€é‡æ˜¾ç¤ºï¼ˆæœåŠ¡ç«¯å·²å¤„ç†ï¼Œå®¢æˆ·ç«¯ä»…è®°å½•ï¼‰
function TargetUI.updateTargetHealth(targetId, health, maxHealth)
    local uiData = targetUIs[targetId]
    if not uiData then
        return
    end

    -- è¡€æ¡æ›´æ–°ç”±æœåŠ¡ç«¯å¤„ç†ï¼Œå®¢æˆ·ç«¯ä»…è®°å½•çŠ¶æ€
    print("ğŸ©¸ é¶å­è¡€é‡æ›´æ–°:", targetId, "è¡€é‡:", health .. "/" .. maxHealth)
end

-- æ˜¾ç¤ºä¼¤å®³æ•ˆæœ
function TargetUI.showDamageEffect(targetId, attackerId)
    local uiData = targetUIs[targetId]
    if not uiData or not uiData.targetPart then
        return
    end

    -- åˆ›å»ºä¼¤å®³æ•°å­—æ˜¾ç¤º
    local damageGui = Instance.new("BillboardGui")
    damageGui.Size = UDim2.new(0, 50, 0, 30)
    damageGui.StudsOffset = Vector3.new(math.random(-2, 2), 6, math.random(-2, 2))
    damageGui.Parent = uiData.targetPart

    local damageLabel = Instance.new("TextLabel")
    damageLabel.Size = UDim2.new(1, 0, 1, 0)
    damageLabel.BackgroundTransparency = 1
    damageLabel.Text = "ğŸ’¥"
    damageLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    damageLabel.TextSize = 24
    damageLabel.TextStrokeTransparency = 0
    damageLabel.Parent = damageGui

    -- åŠ¨ç”»æ•ˆæœ
    local tween = game:GetService("TweenService"):Create(
        damageGui,
        TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {StudsOffset = damageGui.StudsOffset + Vector3.new(0, 3, 0)}
    )

    local fadeTween = game:GetService("TweenService"):Create(
        damageLabel,
        TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {TextTransparency = 1}
    )

    tween:Play()
    fadeTween:Play()

    -- æ¸…ç†
    game:GetService("Debris"):AddItem(damageGui, 1.2)
end

-- æ˜¾ç¤ºæ‘§æ¯æ•ˆæœ
function TargetUI.showDestroyEffect(targetId, destroyerId)
    local uiData = targetUIs[targetId]
    if not uiData or not uiData.targetPart then
        return
    end

    -- åˆ›å»ºæ‘§æ¯ç‰¹æ•ˆ
    local explosionGui = Instance.new("BillboardGui")
    explosionGui.Size = UDim2.new(0, 80, 0, 80)
    explosionGui.StudsOffset = Vector3.new(0, 2, 0)
    explosionGui.Parent = uiData.targetPart

    local explosionLabel = Instance.new("TextLabel")
    explosionLabel.Size = UDim2.new(1, 0, 1, 0)
    explosionLabel.BackgroundTransparency = 1
    explosionLabel.Text = "ğŸ’¥"
    explosionLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
    explosionLabel.TextSize = 48
    explosionLabel.TextStrokeTransparency = 0
    explosionLabel.Parent = explosionGui

    -- çˆ†ç‚¸åŠ¨ç”»
    local scaleTween = game:GetService("TweenService"):Create(
        explosionLabel,
        TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out),
        {TextSize = 72}
    )

    local fadeTween = game:GetService("TweenService"):Create(
        explosionLabel,
        TweenInfo.new(0.8, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {TextTransparency = 1}
    )

    scaleTween:Play()
    wait(0.2)
    fadeTween:Play()

    -- æ¸…ç†
    game:GetService("Debris"):AddItem(explosionGui, 1)

    -- æ˜¾ç¤ºæ‘§æ¯è€…ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ç©å®¶ï¼‰
    if destroyerId then
        TargetUI.showDestroyerInfo(targetId, destroyerId)
    end
end

-- æ˜¾ç¤ºæ‘§æ¯è€…ä¿¡æ¯
function TargetUI.showDestroyerInfo(targetId, destroyerId)
    local destroyer = Players:GetPlayerByUserId(destroyerId)
    if not destroyer then
        return
    end

    local uiData = targetUIs[targetId]
    if not uiData or not uiData.targetPart then
        return
    end

    -- åˆ›å»ºæ‘§æ¯è€…ä¿¡æ¯æ˜¾ç¤º
    local infoGui = Instance.new("BillboardGui")
    infoGui.Size = UDim2.new(0, 120, 0, 25)
    infoGui.StudsOffset = Vector3.new(0, 8, 0)
    infoGui.Parent = uiData.targetPart

    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(1, 0, 1, 0)
    infoLabel.BackgroundTransparency = 1
    infoLabel.Text = "ğŸ† " .. destroyer.Name .. " æ‘§æ¯äº†é¶å­!"
    infoLabel.TextColor3 = Color3.fromRGB(255, 215, 0)
    infoLabel.TextSize = 14
    infoLabel.TextStrokeTransparency = 0.5
    infoLabel.TextScaled = true
    infoLabel.Parent = infoGui

    -- æ·¡å‡ºåŠ¨ç”»
    local fadeTween = game:GetService("TweenService"):Create(
        infoLabel,
        TweenInfo.new(3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {TextTransparency = 1}
    )

    wait(1)
    fadeTween:Play()

    -- æ¸…ç†
    game:GetService("Debris"):AddItem(infoGui, 4)
end

-- éšè—é¶å­UI
function TargetUI.hideTargetUI(targetId)
    local uiData = targetUIs[targetId]
    if not uiData then
        return
    end

    -- éšè—GUI
    if uiData.gui then
        uiData.gui.Enabled = false
    end

    print("ğŸ™ˆ éšè—é¶å­UI:", targetId)
end

-- æ˜¾ç¤ºé¶å­UI
function TargetUI.showTargetUI(targetId, targetData)
    local uiData = targetUIs[targetId]
    if not uiData then
        -- å¦‚æœUIä¸å­˜åœ¨ï¼Œé‡æ–°åˆ›å»º
        TargetUI.createTargetUI(targetId, targetData)
        return
    end

    -- æ˜¾ç¤ºGUI
    if uiData.gui then
        uiData.gui.Enabled = true
    end

    -- é‡ç½®è¡€æ¡
    if uiData.healthFill then
        uiData.healthFill.Size = UDim2.new(1, 0, 1, 0)
        uiData.healthFill.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    end

    print("ğŸ‘ï¸ æ˜¾ç¤ºé¶å­UI:", targetId)
end

-- å¤„ç†çŠ¶æ€å˜åŒ–äº‹ä»¶
function TargetUI.handleStatusChanged(targetId, newStatus, oldStatus)
    if targetId == "all" then
        -- å…¨é‡çŠ¶æ€æ›´æ–°
        TargetUI.syncAllTargetStatus(newStatus)
    else
        -- å•ä¸ªé¶å­çŠ¶æ€æ›´æ–°
        TargetUI.syncSingleTargetStatus(targetId, newStatus)
    end
end

-- åŒæ­¥æ‰€æœ‰é¶å­çŠ¶æ€
function TargetUI.syncAllTargetStatus(allTargetStatus)
    local activeCount = 0
    for _ in pairs(allTargetStatus) do
        activeCount = activeCount + 1
    end
    print("ğŸ”„ åŒæ­¥æ‰€æœ‰é¶å­çŠ¶æ€ï¼Œæ´»è·ƒé¶å­æ•°é‡:", activeCount)

    -- éšè—ä¸å­˜åœ¨çš„é¶å­UI
    for targetId, uiData in pairs(targetUIs) do
        if not allTargetStatus[targetId] then
            TargetUI.hideTargetUI(targetId)
        end
    end

    -- æ˜¾ç¤º/æ›´æ–°æ´»è·ƒé¶å­çš„UI
    for targetId, targetStatus in pairs(allTargetStatus) do
        if targetStatus.alive then
            if not targetUIs[targetId] then
                TargetUI.createTargetUI(targetId, targetStatus)
            else
                TargetUI.showTargetUI(targetId, targetStatus)
                TargetUI.updateTargetHealth(targetId, targetStatus.health, targetStatus.maxHealth)
            end
        else
            TargetUI.hideTargetUI(targetId)
        end
    end
end

-- åŒæ­¥å•ä¸ªé¶å­çŠ¶æ€
function TargetUI.syncSingleTargetStatus(targetId, targetStatus)
    if targetStatus.alive then
        if not targetUIs[targetId] then
            TargetUI.createTargetUI(targetId, targetStatus)
        else
            TargetUI.showTargetUI(targetId, targetStatus)
            TargetUI.updateTargetHealth(targetId, targetStatus.health, targetStatus.maxHealth)
        end
    else
        TargetUI.hideTargetUI(targetId)
    end
end

-- è¯·æ±‚é¶å­çŠ¶æ€æ›´æ–°ï¼ˆé€šè¿‡Controllerï¼‰
function TargetUI.requestStatusUpdate()
    return TargetController.requestTargetStatus()
end

-- è·å–é¶å­çŠ¶æ€ï¼ˆé€šè¿‡Controllerï¼‰
function TargetUI.getTargetStatus(targetId)
    return TargetController.getTargetStatus(targetId)
end

-- è·å–æ‰€æœ‰é¶å­çŠ¶æ€ï¼ˆé€šè¿‡Controllerï¼‰
function TargetUI.getAllTargetStatus()
    return TargetController.getAllTargetStatus()
end

-- è·å–é¶å­ç»Ÿè®¡ä¿¡æ¯ï¼ˆé€šè¿‡Controllerï¼‰
function TargetUI.getTargetStats()
    return TargetController.getTargetStats()
end

-- æ¸…ç†é¶å­UIç³»ç»Ÿ
function TargetUI.cleanup()
    -- æ¸…ç†æ‰€æœ‰UI
    for targetId, uiData in pairs(targetUIs) do
        if uiData.gui then
            uiData.gui:Destroy()
        end
    end

    targetUIs = {}
    targetsFolder = nil

    print("ğŸ§¹ é¶å­UIç³»ç»Ÿå·²æ¸…ç†")
end

-- è·å–é¶å­UIæ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
function TargetUI.getTargetUIData(targetId)
    return targetUIs[targetId]
end

-- è·å–æ‰€æœ‰é¶å­UIæ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
function TargetUI.getAllTargetUIData()
    return targetUIs
end

return TargetUI
