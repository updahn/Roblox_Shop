-- æ— äººæœºUIç®¡ç†å™¨

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local DroneUI = {}
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ç­‰å¾…æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))

-- ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®
local DroneConfig = Config.DRONE_CONFIG

-- UIå…ƒç´ 
local screenGui
local droneFrame
local spawnButton
local recallButton
local modeButton
local statusLabel
local timerLabel

-- DroneControllerå¼•ç”¨ï¼ˆå°†åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®ï¼‰
local DroneController = nil

-- ==============================================
-- å†…éƒ¨å·¥å…·å‡½æ•°
-- ==============================================

local function log(message, ...)
    Config.log("INFO", "[DroneUI] " .. message, {...})
end

-- åˆ›å»ºæŒ‰é’®
local function createButton(name, text, position, size, color)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Text = text
    button.Position = position
    button.Size = size
    button.BackgroundColor3 = color
    button.BorderSizePixel = 0
    button.Font = Enum.Font.GothamBold
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextScaled = true

    -- æ·»åŠ åœ†è§’
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button

    -- æ·»åŠ é˜´å½±æ•ˆæœ
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 4, 1, 4)
    shadow.Position = UDim2.new(0, -2, 0, 2)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.7
    shadow.BorderSizePixel = 0
    shadow.ZIndex = button.ZIndex - 1
    shadow.Parent = button

    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 6)
    shadowCorner.Parent = shadow

    -- ç‚¹å‡»åŠ¨ç”»
    button.MouseButton1Down:Connect(function()
        local pressedSize = UDim2.new(size.X.Scale * 0.95, size.X.Offset * 0.95, size.Y.Scale * 0.95, size.Y.Offset * 0.95)
        local tween = TweenService:Create(button, TweenInfo.new(0.1), {Size = pressedSize})
        tween:Play()
    end)

    button.MouseButton1Up:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.1), {Size = size})
        tween:Play()
    end)

    return button
end

-- åˆ›å»ºæ ‡ç­¾
local function createLabel(name, text, position, size)
    local label = Instance.new("TextLabel")
    label.Name = name
    label.Text = text
    label.Position = position
    label.Size = size
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextScaled = true
    label.TextStrokeTransparency = 0.5

    return label
end

-- ==============================================
-- UIçŠ¶æ€æ›´æ–°å‡½æ•°
-- ==============================================

-- æ›´æ–°æŒ‰é’®çŠ¶æ€
function DroneUI.updateButtonStates(droneStatus)
    if not screenGui or not droneStatus then return end

    -- æ£€æŸ¥UIå…ƒç´ æ˜¯å¦å­˜åœ¨
    if not spawnButton or not recallButton or not modeButton or not statusLabel or not timerLabel then
        warn("âŒ [DroneUI] UIå…ƒç´ æœªå®Œå…¨åˆ›å»ºï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°")
        return
    end

    if droneStatus.isActive then
        spawnButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        spawnButton.Text = "æ— äººæœºæ´»è·ƒ"

        recallButton.BackgroundColor3 = DroneConfig.UI.COLORS.RECALL_BUTTON
        recallButton.Text = DroneConfig.UI.TEXT.RECALL

        modeButton.BackgroundColor3 = DroneConfig.UI.COLORS.MODE_BUTTON
        if droneStatus.mode == DroneConfig.MODES.FOLLOW then
            modeButton.Text = DroneConfig.UI.TEXT.SWITCH_TO_GUARD
        else
            modeButton.Text = DroneConfig.UI.TEXT.SWITCH_TO_FOLLOW
        end

        statusLabel.Text = "çŠ¶æ€: " .. (droneStatus.mode == DroneConfig.MODES.FOLLOW and "è·Ÿéšæ¨¡å¼" or "é©»å®ˆæ¨¡å¼")

        -- æ›´æ–°è®¡æ—¶å™¨
        DroneUI.updateTimer(droneStatus.timeRemaining)
    else
        spawnButton.BackgroundColor3 = DroneConfig.UI.COLORS.SPAWN_BUTTON
        spawnButton.Text = DroneConfig.UI.TEXT.SPAWN

        recallButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        recallButton.Text = "æ— æ— äººæœº"

        modeButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        modeButton.Text = "æ¨¡å¼åˆ‡æ¢"

        statusLabel.Text = "çŠ¶æ€: å¾…å‘½"
        timerLabel.Text = "å‰©ä½™æ—¶é—´: --"
    end
end

-- æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
function DroneUI.updateTimer(timeRemaining)
    if not timerLabel then
        warn("âŒ [DroneUI] timerLabelæœªåˆ›å»ºï¼Œè·³è¿‡è®¡æ—¶å™¨æ›´æ–°")
        return
    end

    if timeRemaining and timeRemaining > 0 then
        timerLabel.Text = string.format("å‰©ä½™æ—¶é—´: %.1fç§’", timeRemaining)
    else
        timerLabel.Text = "å‰©ä½™æ—¶é—´: --"
    end
end

-- æ›´æ–°çŠ¶æ€æ˜¾ç¤ºï¼ˆç”±DroneControllerè°ƒç”¨ï¼‰
function DroneUI.updateStatus(status)
    DroneUI.updateButtonStates(status)
end

-- ==============================================
-- UIåˆ›å»ºå‡½æ•°
-- ==============================================

local function createDroneUI()
    -- åˆ›å»ºScreenGui
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "DroneUI"
    screenGui.ResetOnSpawn = false
    screenGui.Enabled = true
    screenGui.Parent = playerGui

    -- ä¸»æ¡†æ¶
    droneFrame = Instance.new("Frame")
    droneFrame.Name = "DroneFrame"
    droneFrame.Size = UDim2.new(0, 280, 0, 200)
    droneFrame.Position = UDim2.new(1, -300, 1, -220)
    droneFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    droneFrame.BackgroundTransparency = 0.1
    droneFrame.BorderSizePixel = 0
    droneFrame.Parent = screenGui

    -- æ·»åŠ åœ†è§’
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = droneFrame

    -- æ ‡é¢˜
    local titleLabel = createLabel("TitleLabel", "ğŸ¤– æ— äººæœºæ§åˆ¶", UDim2.new(0, 0, 0, 0), UDim2.new(1, 0, 0, 30))
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.Parent = droneFrame

    -- å¬å”¤æŒ‰é’®
    spawnButton = createButton("SpawnButton", DroneConfig.UI.TEXT.SPAWN,
        UDim2.new(0, 10, 0, 40), UDim2.new(0.45, -7.5, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.SPAWN_BUTTON)
    spawnButton.Parent = droneFrame

    -- æ”¶å›æŒ‰é’®
    recallButton = createButton("RecallButton", DroneConfig.UI.TEXT.RECALL,
        UDim2.new(0.55, 7.5, 0, 40), UDim2.new(0.45, -7.5, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.RECALL_BUTTON)
    recallButton.Parent = droneFrame

    -- æ¨¡å¼åˆ‡æ¢æŒ‰é’®
    modeButton = createButton("ModeButton", DroneConfig.UI.TEXT.MODE_FOLLOW,
        UDim2.new(0, 10, 0, 90), UDim2.new(1, -20, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.MODE_BUTTON)
    modeButton.Parent = droneFrame

    -- çŠ¶æ€æ ‡ç­¾
    statusLabel = createLabel("StatusLabel", "çŠ¶æ€: å¾…å‘½",
        UDim2.new(0, 10, 0, 140), UDim2.new(1, -20, 0, 20))
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = droneFrame

    -- è®¡æ—¶å™¨æ ‡ç­¾
    timerLabel = createLabel("TimerLabel", "å‰©ä½™æ—¶é—´: --",
        UDim2.new(0, 10, 0, 165), UDim2.new(1, -20, 0, 20))
    timerLabel.TextXAlignment = Enum.TextXAlignment.Left
    timerLabel.Parent = droneFrame

    log("æ— äººæœºUIç•Œé¢åˆ›å»ºå®Œæˆ")
end

-- ==============================================
-- äº‹ä»¶å¤„ç†å‡½æ•°
-- ==============================================

-- è¿æ¥æŒ‰é’®äº‹ä»¶åˆ°æ§åˆ¶å™¨
local function connectButtonEvents()
    if not DroneController then
        warn("âŒ [DroneUI] DroneControlleræœªè®¾ç½®")
        return
    end

    -- æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
    if not spawnButton then
        warn("âŒ [DroneUI] spawnButtonæœªåˆ›å»º")
        return
    end
    if not recallButton then
        warn("âŒ [DroneUI] recallButtonæœªåˆ›å»º")
        return
    end
    if not modeButton then
        warn("âŒ [DroneUI] modeButtonæœªåˆ›å»º")
        return
    end

    spawnButton.MouseButton1Click:Connect(function()
        DroneController.handleDroneAction("spawn")
    end)

    recallButton.MouseButton1Click:Connect(function()
        DroneController.handleDroneAction("recall")
    end)

    modeButton.MouseButton1Click:Connect(function()
        DroneController.handleDroneAction("switch_mode")
    end)

    log("æŒ‰é’®äº‹ä»¶å·²è¿æ¥åˆ°æ§åˆ¶å™¨")
end

-- ==============================================
-- å…¬å…±æ¥å£
-- ==============================================

-- è®¾ç½®DroneControllerå¼•ç”¨
function DroneUI.setDroneController(controller)
    DroneController = controller
    log("DroneControllerå¼•ç”¨å·²è®¾ç½®")
end

-- è®¾ç½®æ§åˆ¶å™¨ï¼ˆä¸ºäº†ä¸å…¶ä»–UIæ¨¡å—ä¿æŒä¸€è‡´çš„æ¥å£ï¼‰
function DroneUI.setControllers(droneController)
    DroneUI.setDroneController(droneController)
    log("æ§åˆ¶å™¨å·²è®¾ç½®")
end

-- æ˜¾ç¤º/éšè—UI
function DroneUI.setVisible(visible)
    if screenGui then
        screenGui.Enabled = visible
        log("UIå¯è§æ€§è®¾ç½®ä¸º:", visible)
    end
end

-- è·å–UIå¯è§çŠ¶æ€
function DroneUI.isVisible()
    return screenGui and screenGui.Enabled or false
end

-- ==============================================
-- åˆå§‹åŒ–å‡½æ•°
-- ==============================================

function DroneUI.init()
    log("å¼€å§‹åˆå§‹åŒ–æ— äººæœºUI...")

    -- åˆ›å»ºUI
    createDroneUI()

    -- è¿æ¥æŒ‰é’®äº‹ä»¶ï¼ˆå¦‚æœæ§åˆ¶å™¨å·²è®¾ç½®ï¼‰
    if DroneController then
        connectButtonEvents()
    end

    log("æ— äººæœºUIåˆå§‹åŒ–å®Œæˆ")
end

-- è®¾ç½®æ§åˆ¶å™¨å¹¶è¿æ¥äº‹ä»¶ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
function DroneUI.initWithController(controller)
    log("å¼€å§‹åˆå§‹åŒ–æ— äººæœºUIï¼ˆå¸¦æ§åˆ¶å™¨ï¼‰...")

    -- åˆ›å»ºUIï¼ˆå¦‚æœè¿˜æ²¡åˆ›å»ºï¼‰
    if not screenGui then
        createDroneUI()
    end

    -- è®¾ç½®æ§åˆ¶å™¨
    DroneUI.setDroneController(controller)

    -- è¿æ¥æŒ‰é’®äº‹ä»¶
    connectButtonEvents()

    -- è·å–åˆå§‹çŠ¶æ€å¹¶æ›´æ–°UI
    local initialStatus = controller.getDroneStatus()
    DroneUI.updateStatus(initialStatus)

    log("æ— äººæœºUIä¸æ§åˆ¶å™¨è¿æ¥å®Œæˆ")
end

function DroneUI.cleanup()
    if screenGui then
        screenGui:Destroy()
        screenGui = nil
    end

    -- é‡ç½®æ‰€æœ‰UIå…ƒç´ å¼•ç”¨
    droneFrame = nil
    spawnButton = nil
    recallButton = nil
    modeButton = nil
    statusLabel = nil
    timerLabel = nil

    log("æ— äººæœºUIå·²æ¸…ç†")
end

-- åˆå§‹åŒ–æ— äººæœºç®¡ç†å™¨ï¼ˆç¦ç”¨åŸå§‹çš„ï¼‰
function DroneUI.initialize()
    log("æ— äººæœºç®¡ç†å™¨å·²ç¦ç”¨ï¼Œä½¿ç”¨æ–°çš„UIæ¶æ„")
    return
end

return DroneUI
