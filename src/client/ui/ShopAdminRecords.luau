-- ÂïÜÂ∫óÁÆ°ÁêÜÂëòÁïåÈù¢Ê®°Âùó - ÈÄÇÈÖçÂô®Ê®°Âºè
-- Áé∞Âú®‰ΩøÁî®Áªü‰∏ÄÁöÑShopAdminPanel

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Á≠âÂæÖÂÖ±‰∫´Ê®°Âùó
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopUtils = require(game:GetService("StarterPlayer").StarterPlayerScripts.Client.functions:WaitForChild("ShopUtils"))

-- ÂØºÂÖ•Áªü‰∏ÄÁöÑÁÆ°ÁêÜÈù¢Êùø
local ShopAdminPanel = require(game:GetService("StarterPlayer").StarterPlayerScripts.Client.ui:WaitForChild("ShopAdminPanel"))

local player = Players.LocalPlayer

local ShopAdminRecords = {}

-- Â≠òÂÇ®ÂæÖÂ§ÑÁêÜÁöÑÁÆ°ÁêÜÂëòÊü•ÁúãËÆ∞ÂΩïËØ∑Ê±ÇÔºà‰øùÊåÅÂêëÂêéÂÖºÂÆπÔºâ
ShopAdminRecords.pendingPlayerName = nil
ShopAdminRecords.pendingScreenGui = nil

-- ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø - Áé∞Âú®Áõ¥Êé•Ë∞ÉÁî®Áªü‰∏ÄÈù¢Êùø
function ShopAdminRecords.showAdminPanel(screenGui, showNotification)
    print("üîß [ÁÆ°ÁêÜÂëòÈù¢ÊùøÈÄÇÈÖçÂô®] Ë∞ÉÁî®Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø")

    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê - ‰ΩøÁî®AdminController
    local isAdmin = false
    local success, AdminController = pcall(function()
        local Players = game:GetService("Players")
        local StarterPlayer = game:GetService("StarterPlayer")
        return require(StarterPlayer.StarterPlayerScripts.Client.controller.AdminController)
    end)

    if success and AdminController then
        local adminCheckSuccess, adminResult = pcall(function()
            return AdminController.checkPermission()
        end)
        if adminCheckSuccess then
            isAdmin = adminResult
        end
    end

    if not isAdmin then
        print("‚ùå [ÁÆ°ÁêÜÂëòÈù¢ÊùøÈÄÇÈÖçÂô®] ÁÆ°ÁêÜÂëòÊùÉÈôêÊ£ÄÊü•Â§±Ë¥•")
        if showNotification then
            showNotification("‚ùå ÊÇ®Ê≤°ÊúâÁÆ°ÁêÜÂëòÊùÉÈôê", false)
        end
        return
    end

    -- Áõ¥Êé•Ë∞ÉÁî®Áªü‰∏ÄÁöÑÁÆ°ÁêÜÈù¢Êùø
    ShopAdminPanel.showAdminPanel(screenGui, showNotification)
end

-- ÊòæÁ§∫ÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑË¥≠‰π∞ËÆ∞ÂΩïÔºà‰øùÊåÅÂêëÂêéÂÖºÂÆπÊÄßÔºâ
function ShopAdminRecords.showPlayerRecords(playerName, records, screenGui)
    print("üìä [ÁÆ°ÁêÜÂëòËÆ∞ÂΩïÈÄÇÈÖçÂô®] ÊòæÁ§∫Áé©ÂÆ∂ËÆ∞ÂΩï:", playerName, "ËÆ∞ÂΩïÊï∞Èáè:", records and #records or 0)

    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê - ‰ΩøÁî®AdminController
    local isAdmin = false
    local success, AdminController = pcall(function()
        local Players = game:GetService("Players")
        local StarterPlayer = game:GetService("StarterPlayer")
        return require(StarterPlayer.StarterPlayerScripts.Client.controller.AdminController)
    end)

    if success and AdminController then
        local adminCheckSuccess, adminResult = pcall(function()
            return AdminController.checkPermission()
        end)
        if adminCheckSuccess then
            isAdmin = adminResult
        end
    end

    if not isAdmin then
        print("‚ùå [ÁÆ°ÁêÜÂëòËÆ∞ÂΩïÈÄÇÈÖçÂô®] ÊùÉÈôêÊ£ÄÊü•Â§±Ë¥•")
        return
    end

    print("‚úÖ [ÁÆ°ÁêÜÂëòËÆ∞ÂΩïÈÄÇÈÖçÂô®] ÊùÉÈôêÈ™åËØÅÈÄöËøáÔºå‰ΩøÁî®ÊôÆÈÄöÁî®Êà∑ËÆ∞ÂΩïÊ†ºÂºè")

    -- ÂàõÂª∫ËÆ∞ÂΩïÊü•ÁúãÁ™óÂè£ - ‰ΩøÁî®ÊôÆÈÄöÁî®Êà∑‰∫§ÊòìËÆ∞ÂΩïÁöÑÊ†∑Âºè
    local recordFrame = Instance.new("Frame")
    recordFrame.Name = "PlayerRecordFrame"
    recordFrame.Size = UDim2.new(0, 600, 0, 500)
    recordFrame.Position = UDim2.new(0.5, -300, 0.5, -250)
    recordFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    recordFrame.BorderSizePixel = 0
    recordFrame.ZIndex = 3100
    recordFrame.Parent = screenGui
    ShopUtils.createCorner(recordFrame, 12)

    -- Ê†áÈ¢òÊ†è
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 50)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = recordFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "üìä " .. playerName .. " ÁöÑ‰∫§ÊòìËÆ∞ÂΩï"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 18
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -50, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- ÂÖ≥Èó≠ÊåâÈíÆ
    local closeBtn = ShopUtils.createButton("‚úó", ShopUtils.COLORS.ERROR, titleBar, function()
        recordFrame:Destroy()
    end)
    closeBtn.Position = UDim2.new(1, -45, 0, 5)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 18

    -- ËÆ∞ÂΩïÊªöÂä®Âå∫Âüü
    local scrollArea = Instance.new("ScrollingFrame")
    scrollArea.Name = "ScrollArea"
    scrollArea.Size = UDim2.new(1, -20, 1, -70)
    scrollArea.Position = UDim2.new(0, 10, 0, 60)
    scrollArea.BackgroundTransparency = 1
    scrollArea.BorderSizePixel = 0
    scrollArea.ScrollBarThickness = 8
    scrollArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    scrollArea.Parent = recordFrame

    -- ÊòæÁ§∫ËÆ∞ÂΩï - ‰ΩøÁî®‰∏éÊôÆÈÄöÁî®Êà∑ËÆ∞ÂΩïÁõ∏ÂêåÁöÑÊ†ºÂºè
    local yPos = 10
    if records and #records > 0 then
        for i, record in ipairs(records) do
            local recordCard = Instance.new("Frame")
            recordCard.Name = "Record" .. i
            recordCard.Size = UDim2.new(1, -20, 0, 80)
            recordCard.Position = UDim2.new(0, 10, 0, yPos)
            recordCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
            recordCard.BorderSizePixel = 0
            recordCard.Parent = scrollArea
            ShopUtils.createCorner(recordCard, 8)

            -- Êó∂Èó¥Êà≥
            local timeLabel = Instance.new("TextLabel")

            -- Ë∞ÉËØïÊó∂Èó¥Êà≥ÈóÆÈ¢ò
            local timestamp = record.timestamp or record.createdAt or record.transactionDate
            print("üìä [AdminRecordsË∞ÉËØï] ‰∫§ÊòìËÆ∞ÂΩïÊó∂Èó¥Êà≥:",
                "timestamp=", record.timestamp,
                "createdAt=", record.createdAt,
                "transactionDate=", record.transactionDate,
                "‰ΩøÁî®=", timestamp)

            timeLabel.Text = ShopUtils.formatTimestamp(timestamp)
            timeLabel.Font = Enum.Font.SourceSans
            timeLabel.TextSize = 12
            timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
            timeLabel.Size = UDim2.new(0, 150, 0, 20)
            timeLabel.Position = UDim2.new(0, 10, 0, 5)
            timeLabel.BackgroundTransparency = 1
            timeLabel.TextXAlignment = Enum.TextXAlignment.Left
            timeLabel.Parent = recordCard

            -- ‰∫§ÊòìÁ±ªÂûãÂíåÁâ©ÂìÅ - ‰ΩøÁî®‰∏éÊôÆÈÄöÁî®Êà∑ËÆ∞ÂΩïÁõ∏ÂêåÁöÑÊ†ºÂºè
            local actionLabel = Instance.new("TextLabel")
            local actionText = ""
            if record.type == "buy" or record.action == "buy" then
                actionText = "üõí Ë¥≠‰π∞ " .. (record.itemName or record.item_name or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
            elseif record.type == "sell" or record.action == "sell" then
                actionText = "üí∞ ÂçñÂá∫ " .. (record.itemName or record.item_name or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
            elseif record.type == "admin" or record.action == "admin_edit" then
                actionText = "‚öôÔ∏è ÁÆ°ÁêÜÂëòÊìç‰Ωú x" .. (record.quantity or 1)
            elseif record.type == "daily_reward" then
                actionText = "üéÅ ÊØèÊó•Â•ñÂä± x" .. (record.quantity or 1)
            elseif record.type == "membership_purchase" then
                actionText = "üíé Ë¥≠‰π∞‰ºöÂëò " .. (record.itemName or record.item_name or "Êú™Áü•‰ºöÂëò") .. " x" .. (record.quantity or 1)
            end
            actionLabel.Text = actionText
            actionLabel.Font = Enum.Font.SourceSansBold
            actionLabel.TextSize = 16
            actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
            actionLabel.Size = UDim2.new(1, -20, 0, 25)
            actionLabel.Position = UDim2.new(0, 10, 0, 25)
            actionLabel.BackgroundTransparency = 1
            actionLabel.TextXAlignment = Enum.TextXAlignment.Left
            actionLabel.Parent = recordCard

            -- ÈáëÈ¢ù - ‰ΩøÁî®‰∏éÊôÆÈÄöÁî®Êà∑ËÆ∞ÂΩïÁõ∏ÂêåÁöÑÊ†ºÂºè
            local amountLabel = Instance.new("TextLabel")
            local amountText = ""
            local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
            if record.type == "buy" or record.action == "buy" then
                amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.ERROR
            elseif record.type == "sell" or record.action == "sell" then
                amountText = "+" .. (record.totalAmount or record.totalEarned or record.total_amount or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.type == "admin" or record.action == "admin_edit" then
                local coinChange = record.totalAmount or record.total_amount or 0
                if coinChange > 0 then
                    amountText = "+" .. coinChange .. " ÈáëÂ∏Å"
                    amountColor = ShopUtils.COLORS.SUCCESS
                elseif coinChange < 0 then
                    amountText = coinChange .. " ÈáëÂ∏Å"  -- Ë¥üÊï∞Â∑≤ÁªèÂåÖÂê´ÂáèÂè∑
                    amountColor = ShopUtils.COLORS.ERROR
                else
                    amountText = "0 ÈáëÂ∏Å"
                    amountColor = ShopUtils.COLORS.TEXT_MUTED
                end
            elseif record.type == "daily_reward" then
                amountText = "+" .. (record.totalAmount or record.total_amount or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.type == "membership_purchase" then
                amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.ERROR
            end
            amountLabel.Text = amountText
            amountLabel.Font = Enum.Font.SourceSansBold
            amountLabel.TextSize = 14
            amountLabel.TextColor3 = amountColor
            amountLabel.Size = UDim2.new(0, 120, 0, 20)
            amountLabel.Position = UDim2.new(1, -130, 0, 30)
            amountLabel.BackgroundTransparency = 1
            amountLabel.TextXAlignment = Enum.TextXAlignment.Right
            amountLabel.Parent = recordCard

            yPos = yPos + 90
        end
    else
        -- Êó†ËÆ∞ÂΩïÊèêÁ§∫
        local noRecordLabel = Instance.new("TextLabel")
        noRecordLabel.Text = "üìù ËØ•Áé©ÂÆ∂ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï"
        noRecordLabel.Font = Enum.Font.SourceSans
        noRecordLabel.TextSize = 16
        noRecordLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        noRecordLabel.Size = UDim2.new(1, 0, 0, 100)
        noRecordLabel.BackgroundTransparency = 1
        noRecordLabel.TextXAlignment = Enum.TextXAlignment.Center
        noRecordLabel.Parent = scrollArea
        yPos = yPos + 120
    end

    scrollArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- Â∫üÂºÉÁöÑÂáΩÊï∞‰øùÊåÅÂ≠òÂú®‰ª•‰øùËØÅÂÖºÂÆπÊÄßÔºå‰ΩÜÈáçÂÆöÂêëÂà∞Áªü‰∏ÄÈù¢Êùø
function ShopAdminRecords.displayAllPlayersData(parentFrame, allPlayersData, showNotification)
    print("‚ö†Ô∏è [Â∫üÂºÉÂáΩÊï∞] displayAllPlayersData Ë¢´Ë∞ÉÁî®ÔºåÂª∫ËÆÆ‰ΩøÁî®Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø")
    -- Ëøô‰∏™ÂáΩÊï∞‰øùÊåÅÂ≠òÂú®‰ΩÜ‰∏çÊâßË°å‰ªª‰ΩïÊìç‰ΩúÔºåÂõ†‰∏∫Áé∞Âú®‰ΩøÁî®Áªü‰∏ÄÈù¢Êùø
end

return ShopAdminRecords