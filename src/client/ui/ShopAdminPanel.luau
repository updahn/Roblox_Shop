-- Áªü‰∏ÄÁöÑÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø
-- Êï¥Âêà‰∫ÜÁî®Êà∑ÁÆ°ÁêÜ„ÄÅËÆ∞ÂΩïÊü•Áúã„ÄÅ‰ºöÂëòÁÆ°ÁêÜÁ≠âÂäüËÉΩ

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- Á≠âÂæÖÂÖ±‰∫´Ê®°Âùó
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopUtils = require(game:GetService("StarterPlayer").StarterPlayerScripts.Client.functions:WaitForChild("ShopUtils"))
local ShopRecords = require(game:GetService("StarterPlayer").StarterPlayerScripts.Client.ui:WaitForChild("ShopRecords"))

local player = Players.LocalPlayer

-- ÊéßÂà∂Âô®ÂºïÁî®ÔºàÂú®ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÔºâ
local AdminController = nil

local ShopAdminPanel = {}

-- ËÆæÁΩÆÊéßÂà∂Âô®
function ShopAdminPanel.setControllers(adminController)
    AdminController = adminController
    print("‚úÖ [ShopAdminPanel] ÊéßÂà∂Âô®Â∑≤ËÆæÁΩÆ")
end

-- UI ÂÖÉÁ¥†ÂºïÁî®
local adminFrame = nil
local contentArea = nil
local tabButtons = {}
local currentTab = "users"
local currentScreenGui = nil  -- Â≠òÂÇ®‰º†ÂÖ•ÁöÑscreenGuiÂºïÁî®

-- Êï∞ÊçÆÂ≠òÂÇ®
local allPlayersData = {}
local membershipData = {}
local currentViewingPlayer = nil  -- ÂΩìÂâçÊü•ÁúãÁöÑÁé©ÂÆ∂

-- Ê†áÁ≠æÈÖçÁΩÆ - ÈªòËÆ§Âè™ÊòæÁ§∫Áî®Êà∑ÁÆ°ÁêÜ
local tabs = {
    {id = "users", name = "üë§ Áî®Êà∑ÁÆ°ÁêÜ", icon = "üë§"}
}

-- ÊâÄÊúâÂèØÁî®Ê†áÁ≠æÔºàÁî®‰∫éÂä®ÊÄÅÊ∑ªÂä†Ôºâ
local allTabs = {
    {id = "users", name = "üë§ Áî®Êà∑ÁÆ°ÁêÜ", icon = "üë§"},
    {id = "records", name = "üìä ‰∫§ÊòìËÆ∞ÂΩï", icon = "üìä"},
    {id = "membership", name = "üë• ‰ºöÂëòÁÆ°ÁêÜ", icon = "üë•"}
}

-- ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø‰∏ªÂÖ•Âè£
function ShopAdminPanel.showAdminPanel(screenGui, showNotification)
    print("üîß [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø")

    -- ‰øùÂ≠òscreenGuiÂºïÁî®‰ª•‰æõÂêéÁª≠‰ΩøÁî®
    currentScreenGui = screenGui

    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê - ÈÄöËøáAdminController‰∏éÊúçÂä°ÈÄö‰ø°
    local isAdmin = false
    print("üîç [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÂºÄÂßãÊùÉÈôêÊ£ÄÊü• - Áé©ÂÆ∂:", player.Name)

    -- ÂØºÂÖ•AdminController
    local success, adminControllerModule = pcall(function()
        local Players = game:GetService("Players")
        local StarterPlayer = game:GetService("StarterPlayer")
        return require(StarterPlayer.StarterPlayerScripts.Client.controller.AdminController)
    end)

    if success and adminControllerModule then
        -- ËÆæÁΩÆÂÖ®Â±ÄAdminControllerÂèòÈáè
        AdminController = adminControllerModule
        -- ÂàùÂßãÂåñAdminController
        AdminController.initialize()
        -- ‰ΩøÁî®AdminControllerÊ£ÄÊü•ÊùÉÈôê
        local adminCheckSuccess, adminResult = pcall(function()
            return AdminController.checkPermission()
        end)

        if adminCheckSuccess then
            isAdmin = adminResult
            print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] AdminControllerÊùÉÈôêÊ£ÄÊü•ÊàêÂäü:", player.Name, "->", isAdmin)
        end
    else
        print("‚ùå [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Êó†Ê≥ïÂä†ËΩΩAdminController")
    end

    if not isAdmin then
        print("‚ùå [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÁÆ°ÁêÜÂëòÊùÉÈôêÊ£ÄÊü•Â§±Ë¥•")
        if showNotification then
            showNotification("‚ùå ÊÇ®Ê≤°ÊúâÁÆ°ÁêÜÂëòÊùÉÈôê", false)
        end
        return
    end

    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÁÆ°ÁêÜÂëòÊùÉÈôêÈ™åËØÅÈÄöËøáÔºåÂºÄÂßãÂàõÂª∫ÁÆ°ÁêÜÂëòÈù¢Êùø")

    -- Â¶ÇÊûúÈù¢ÊùøÂ∑≤Â≠òÂú®ÔºåÂÖàÈîÄÊØÅ
    if adminFrame then
        adminFrame:Destroy()
        adminFrame = nil
    end

    -- ÂàõÂª∫‰∏ªÁÆ°ÁêÜÈù¢Êùø
    adminFrame = Instance.new("Frame")
    adminFrame.Name = "AdminPanel"
    adminFrame.Size = UDim2.new(0, 900, 0, 650)
    adminFrame.Position = UDim2.new(0.5, -450, 0.5, -325)
    adminFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    adminFrame.BorderSizePixel = 0
    adminFrame.ZIndex = 3000
    adminFrame.Parent = screenGui
    ShopUtils.createCorner(adminFrame, 12)

    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ‰∏ªÈù¢ÊùøÂàõÂª∫ÊàêÂäü")

    -- ÂàõÂª∫Ê†áÈ¢òÊ†è
    ShopAdminPanel._createTitleBar(adminFrame)
    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Ê†áÈ¢òÊ†èÂàõÂª∫ÊàêÂäü")

    -- ÂàõÂª∫Ê†áÁ≠æÊ†è
    ShopAdminPanel._createTabBar(adminFrame)
    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Ê†áÁ≠æÊ†èÂàõÂª∫ÊàêÂäü")

    -- ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
    ShopAdminPanel._createContentArea(adminFrame)
    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÂÜÖÂÆπÂå∫ÂüüÂàõÂª∫ÊàêÂäü")

    -- Á≠âÂæÖ‰∏ÄÂ∏ßÔºåÁ°Æ‰øùUIÂÖÉÁ¥†ÂÆåÂÖ®ÂàõÂª∫
    wait()

    -- ÊòæÁ§∫ÈªòËÆ§Ê†áÁ≠æ
    print("üîÑ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÂáÜÂ§áÂàáÊç¢Âà∞Áî®Êà∑ÁÆ°ÁêÜÊ†áÁ≠æ")
    ShopAdminPanel.switchTab("users", showNotification)
end

-- ÂàõÂª∫Ê†áÈ¢òÊ†è
function ShopAdminPanel._createTitleBar(parentFrame)
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 60)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = parentFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "üëë ÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 20
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -100, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- ÂÖ≥Èó≠ÊåâÈíÆ
    local closeBtn = ShopUtils.createButton("‚úó", ShopUtils.COLORS.ERROR, titleBar, function()
        adminFrame:Destroy()
        adminFrame = nil
    end)
    closeBtn.Position = UDim2.new(1, -50, 0, 10)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 20
end

-- ÂàõÂª∫Ê†áÁ≠æÊ†è
function ShopAdminPanel._createTabBar(parentFrame)
    local tabBar = Instance.new("Frame")
    tabBar.Name = "TabBar"
    tabBar.Size = UDim2.new(1, -20, 0, 50)
    tabBar.Position = UDim2.new(0, 10, 0, 70)
    tabBar.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    tabBar.BorderSizePixel = 0
    tabBar.Parent = parentFrame
    ShopUtils.createCorner(tabBar, 8)

    ShopAdminPanel._updateTabBar()
end

-- Êõ¥Êñ∞Ê†áÁ≠æÊ†èÊòæÁ§∫
function ShopAdminPanel._updateTabBar()
    local tabBar = adminFrame and adminFrame:FindFirstChild("TabBar")
    if not tabBar then
        print("‚ö†Ô∏è [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Êú™ÊâæÂà∞TabBarÂÖÉÁ¥†")
        return
    end

    print("üîÑ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Êõ¥Êñ∞Ê†áÁ≠æÊ†èÔºåÊ†áÁ≠æÊï∞Èáè:", #tabs)

    -- Ê∏ÖÈô§Áé∞ÊúâÊåâÈíÆ
    for _, child in pairs(tabBar:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    local buttonWidth = 1 / #tabs
    tabButtons = {}

    for i, tab in ipairs(tabs) do
        print("üè∑Ô∏è [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÂàõÂª∫Ê†áÁ≠æÊåâÈíÆ:", tab.name, "ID:", tab.id)

        local tabButton = Instance.new("TextButton")
        tabButton.Name = "Tab_" .. tab.id
        tabButton.Size = UDim2.new(buttonWidth, -5, 1, -10)
        tabButton.Position = UDim2.new(buttonWidth * (i-1), 5, 0, 5)
        tabButton.BackgroundColor3 = tab.id == currentTab and ShopUtils.COLORS.ACCENT or ShopUtils.COLORS.PRIMARY
        tabButton.Text = tab.name
        tabButton.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        tabButton.TextSize = 14
        tabButton.Font = Enum.Font.SourceSansBold
        tabButton.BorderSizePixel = 0
        tabButton.Parent = tabBar
        ShopUtils.createCorner(tabButton, 6)

        tabButton.MouseButton1Click:Connect(function()
            print("üñ±Ô∏è [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÁÇπÂáªÊ†áÁ≠æ:", tab.id)
            ShopAdminPanel.switchTab(tab.id)
        end)

        tabButtons[tab.id] = tabButton
    end

    print("‚úÖ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Ê†áÁ≠æÊ†èÊõ¥Êñ∞ÂÆåÊàêÔºåÂàõÂª∫‰∫Ü", #tabs, "‰∏™ÊåâÈíÆ")
end

-- Ê∑ªÂä†Ê†áÁ≠æ
function ShopAdminPanel._addTab(tabId)
    -- Ê£ÄÊü•Ê†áÁ≠æÊòØÂê¶Â∑≤Â≠òÂú®
    for _, tab in ipairs(tabs) do
        if tab.id == tabId then
            return
        end
    end

    -- ‰ªéallTabs‰∏≠ÊâæÂà∞ÂØπÂ∫îÊ†áÁ≠æ
    for _, tab in ipairs(allTabs) do
        if tab.id == tabId then
            table.insert(tabs, tab)
            break
        end
    end

    ShopAdminPanel._updateTabBar()
end

-- ÁßªÈô§Ê†áÁ≠æÔºàÈô§‰∫ÜÁî®Êà∑ÁÆ°ÁêÜÔºâ
function ShopAdminPanel._removeTab(tabId)
    if tabId == "users" then return end

    for i, tab in ipairs(tabs) do
        if tab.id == tabId then
            table.remove(tabs, i)
            break
        end
    end

    ShopAdminPanel._updateTabBar()
end

-- ÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê†áÁ≠æÔºàÂè™ÊòæÁ§∫Áî®Êà∑ÁÆ°ÁêÜÔºâ
function ShopAdminPanel._resetToDefaultTabs()
    tabs = {{id = "users", name = "üë§ Áî®Êà∑ÁÆ°ÁêÜ", icon = "üë§"}}
    currentTab = "users"
    currentViewingPlayer = nil
    ShopAdminPanel._updateTabBar()
end

-- ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
function ShopAdminPanel._createContentArea(parentFrame)
    contentArea = Instance.new("ScrollingFrame")
    contentArea.Name = "ContentArea"
    contentArea.Size = UDim2.new(1, -20, 1, -140)
    contentArea.Position = UDim2.new(0, 10, 0, 130)
    contentArea.BackgroundTransparency = 1
    contentArea.BorderSizePixel = 0
    contentArea.ScrollBarThickness = 8
    contentArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    contentArea.Parent = parentFrame
end

-- ÂàáÊç¢Ê†áÁ≠æ
function ShopAdminPanel.switchTab(tabId, showNotification)
    -- ÂÖÅËÆ∏ÈáçÂ§çÂàáÊç¢Âà∞Âêå‰∏ÄÊ†áÁ≠æÔºå‰ª•ÊîØÊåÅÂà∑Êñ∞ÂäüËÉΩ
    print("üîÑ [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÂàáÊç¢Âà∞Ê†áÁ≠æ:", tabId)

    local wasFirstTime = (currentTab ~= tabId)
    currentTab = tabId

    -- Êõ¥Êñ∞Ê†áÁ≠æÊåâÈíÆÊ†∑Âºè
    for id, button in pairs(tabButtons) do
        if id == tabId then
            button.BackgroundColor3 = ShopUtils.COLORS.ACCENT
        else
            button.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
        end
    end

    -- Ê∏ÖÁ©∫ÂÜÖÂÆπÂå∫Âüü
    for _, child in pairs(contentArea:GetChildren()) do
        if child:IsA("GuiObject") then
            child:Destroy()
        end
    end

    -- Ê†πÊçÆÊ†áÁ≠æÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπ
    if tabId == "users" then
        -- È¶ñÊ¨°ÂàáÊç¢Âà∞Áî®Êà∑ÁÆ°ÁêÜÊó∂ÔºåÈáçÁΩÆ‰∏∫ÈªòËÆ§Ê†áÁ≠æ
        if wasFirstTime then
            ShopAdminPanel._resetToDefaultTabs()
        end
        ShopAdminPanel._showUsersPanel(showNotification)
    elseif tabId == "records" then
        ShopAdminPanel._showRecordsPanel(showNotification)
    elseif tabId == "membership" then
        ShopAdminPanel._showMembershipPanel(showNotification)
    end
end

-- ÊòæÁ§∫Áî®Êà∑ÁÆ°ÁêÜÈù¢Êùø
function ShopAdminPanel._showUsersPanel(showNotification)
    print("üë§ [Áî®Êà∑ÁÆ°ÁêÜ] Âä†ËΩΩÁî®Êà∑ÁÆ°ÁêÜÈù¢Êùø")

    -- ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "üì° Ê≠£Âú®Âä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ...\nËØ∑Á®çÂÄôÔºåÊ≠£Âú®ËøûÊé•ÊúçÂä°Âô®"
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 16
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 100)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.TextYAlignment = Enum.TextYAlignment.Center
    loadingLabel.TextWrapped = true
    loadingLabel.Parent = contentArea


    -- ËØ∑Ê±ÇÊâÄÊúâÁé©ÂÆ∂Êï∞ÊçÆ
    print("üì° [Áî®Êà∑ÁÆ°ÁêÜ] ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆ")
    print("üì° [Ë∞ÉËØï] ‰ΩøÁî®AdminController‰∫ã‰ª∂Á≥ªÁªü")

    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÊâÄÊúâÁî®Êà∑
    if AdminController then
        AdminController.getAllUsers()
        print("üì° [Ë∞ÉËØï] Â∑≤ÈÄöËøáÊéßÂà∂Âô®ËØ∑Ê±ÇÊâÄÊúâÁî®Êà∑Êï∞ÊçÆ")
    else
        print("‚ùå [ÈîôËØØ] AdminController Êú™ÂàùÂßãÂåñ")
        if showNotification then
            showNotification("‚ùå ‰∫ã‰ª∂Á≥ªÁªüÈîôËØØ", false)
        end
        return
    end

    -- ËÆæÁΩÆËæÉÁü≠ÁöÑË∂ÖÊó∂Êú∫Âà∂Ôºå‰æø‰∫éË∞ÉËØï
    local timeoutTime = 8  -- ÂáèÂ∞ëÂà∞8Áßí
    spawn(function()
        for i = 1, timeoutTime do
            wait(1)
            if not loadingLabel or not loadingLabel.Parent then
                return  -- Â∑≤ÁªèÊî∂Âà∞ÂìçÂ∫î
            end
            loadingLabel.Text = string.format("üì° Ê≠£Âú®Âä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ...\nÁ≠âÂæÖÊúçÂä°Âô®ÂìçÂ∫î (%d/%dÁßí)", i, timeoutTime)
        end

    end)

    -- ÁõëÂê¨ÊúçÂä°Âô®ÂìçÂ∫î
    local connection
    local hasReceivedData = false
    local eventReceived = false

    print("üë§ [Ë∞ÉËØï] ÂºÄÂßãÁõëÂê¨ÊúçÂä°Âô®ÂìçÂ∫î‰∫ã‰ª∂")

    if not AdminController.Events.AllUsersReceived then
        print("‚ùå [ÈîôËØØ] AdminController.Events.AllUsersReceived ‰∏çÂ≠òÂú®")
        if showNotification then
            showNotification("‚ùå ‰∫ã‰ª∂ÁõëÂê¨Âô®ÈîôËØØ", false)
        end
        return
    end

    connection = AdminController.Events.AllUsersReceived:Connect(function(success, message, allPlayersData)
        eventReceived = true
        print("üë§ [Ë∞ÉËØï] Êî∂Âà∞ÊúçÂä°Âô®ÂìçÂ∫î‰∫ã‰ª∂ÔºÅ")
        print("üë§ [Ë∞ÉËØï] ÂèÇÊï∞1 (success):", success)
        print("üë§ [Ë∞ÉËØï] ÂèÇÊï∞2 (message):", message)
        print("üë§ [Ë∞ÉËØï] ÂèÇÊï∞3 (allPlayersData) Á±ªÂûã:", type(allPlayersData))

        -- Ê∏ÖÁêÜUIÂÖÉÁ¥†
        if loadingLabel and loadingLabel.Parent then
            loadingLabel:Destroy()
        end
        if debugBtn and debugBtn.Parent then
            debugBtn:Destroy()
        end

        -- Â§ÑÁêÜÈîôËØØÊÉÖÂÜµ
        if not success then
            print("‚ùå [ÈîôËØØ] Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂ§±Ë¥•:", message)
            hasReceivedData = false

            -- ÂàõÂª∫ÈîôËØØÊòæÁ§∫
            local errorLabel = Instance.new("TextLabel")
            errorLabel.Text = "‚ùå ÊúçÂä°Âô®ÈîôËØØ:\n" .. (message or "Êú™Áü•ÈîôËØØ")
            errorLabel.Font = Enum.Font.SourceSans
            errorLabel.TextSize = 14
            errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
            errorLabel.Size = UDim2.new(1, -20, 0, 150)
            errorLabel.Position = UDim2.new(0, 10, 0, 10)
            errorLabel.BackgroundTransparency = 1
            errorLabel.TextXAlignment = Enum.TextXAlignment.Center
            errorLabel.TextYAlignment = Enum.TextYAlignment.Top
            errorLabel.TextWrapped = true
            errorLabel.Parent = contentArea

            -- Ê∑ªÂä†ÈáçËØïÊåâÈíÆ
            local retryBtn = ShopUtils.createButton("üîÑ ÈáçËØïËøûÊé•ÊúçÂä°Âô®", ShopUtils.COLORS.ACCENT, contentArea, function()
                for _, child in pairs(contentArea:GetChildren()) do
                    if child:IsA("GuiObject") then
                        child:Destroy()
                    end
                end
                ShopAdminPanel._showUsersPanel(showNotification)
            end)
            retryBtn.Position = UDim2.new(0.5, -80, 0, 170)
            retryBtn.Size = UDim2.new(0, 160, 0, 30)
            retryBtn.TextSize = 12

            if showNotification then
                showNotification("‚ùå ÊúçÂä°Âô®ËøûÊé•Â§±Ë¥•", false)
            end

        elseif allPlayersData and type(allPlayersData) == "table" then
            print("‚úÖ [ÊàêÂäü] Ëé∑ÂèñÂà∞Áî®Êà∑Êï∞ÊçÆÔºåÂáÜÂ§áÊòæÁ§∫")
            hasReceivedData = true

            -- Ê£ÄÊü•Êï∞ÊçÆÂÜÖÂÆπ
            if allPlayersData then
                print("üë§ [Ë∞ÉËØï] allPlayersDataÂÜÖÂÆπ:", allPlayersData)
                if type(allPlayersData) == "table" then
                    local count = 0
                    for k, v in pairs(allPlayersData) do
                        count = count + 1
                        print("üë§ [Ë∞ÉËØï] Êï∞ÊçÆÈ°π", count, ":", k, "->", v)
                    end
                    print("üë§ [Ë∞ÉËØï] ÊÄªÂÖ±Êúâ", count, "È°πÊï∞ÊçÆ")
                end
            end

            if showNotification then
                showNotification("‚úÖ Áî®Êà∑Êï∞ÊçÆÂä†ËΩΩÊàêÂäü", true)
            end

            ShopAdminPanel._displayAllPlayersData(allPlayersData, showNotification)
            if connection then
                connection:Disconnect()
            end
        else
            print("‚ùå [ÈîôËØØ] Êú™Êî∂Âà∞ÊúâÊïàÁöÑÁî®Êà∑Êï∞ÊçÆ")
            if not hasReceivedData then
                local noDataLabel = Instance.new("TextLabel")
                noDataLabel.Text = "‚ùå Êó†Ê≥ïÂä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ\n\nÂèØËÉΩÁöÑÂéüÂõ†Ôºö\n‚Ä¢ Êï∞ÊçÆÊúçÂä°Êú™ÂìçÂ∫î\n‚Ä¢ Êï∞ÊçÆÂ∫ìËøûÊé•ÈóÆÈ¢ò\n‚Ä¢ ÁΩëÁªúËøûÊé•ÂºÇÂ∏∏"
                noDataLabel.Font = Enum.Font.SourceSans
                noDataLabel.TextSize = 14
                noDataLabel.TextColor3 = ShopUtils.COLORS.ERROR
                noDataLabel.Size = UDim2.new(1, -20, 0, 200)
                noDataLabel.Position = UDim2.new(0, 10, 0, 10)
                noDataLabel.BackgroundTransparency = 1
                noDataLabel.TextXAlignment = Enum.TextXAlignment.Center
                noDataLabel.TextYAlignment = Enum.TextYAlignment.Top
                noDataLabel.TextWrapped = true
                noDataLabel.Parent = contentArea

                if showNotification then
                    showNotification("‚ùå Êó†Ê≥ïÂä†ËΩΩÁúüÂÆûÊï∞ÊçÆ", false)
                end


                if connection then
                    connection:Disconnect()
                end
            end
        end
    end)

    print("üë§ [Ë∞ÉËØï] ‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ËÆæÁΩÆ")
end

-- ÊòæÁ§∫ÊâÄÊúâÁé©ÂÆ∂Êï∞ÊçÆ
function ShopAdminPanel._displayAllPlayersData(allPlayersData, showNotification)
    print("üë§ [Áî®Êà∑ÁÆ°ÁêÜ] ÂºÄÂßãÊòæÁ§∫ÊâÄÊúâÁé©ÂÆ∂Êï∞ÊçÆ")
    print("üë§ [Ë∞ÉËØï] Êé•Êî∂Âà∞ÁöÑÊï∞ÊçÆÁ±ªÂûã:", type(allPlayersData))

    -- ËØ¶ÁªÜÁöÑÊï∞ÊçÆÊ£ÄÊü•ÂíåÊó•Âøó
    if not allPlayersData then
        print("‚ùå [ÈîôËØØ] allPlayersData ‰∏∫ nil")
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "‚ùå Êï∞ÊçÆ‰∏∫Á©∫\nÊú™Êî∂Âà∞‰ªª‰ΩïÁé©ÂÆ∂Êï∞ÊçÆ"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 16
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 100)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
        return
    end

    if type(allPlayersData) ~= "table" then
        print("‚ùå [ÈîôËØØ] allPlayersData ‰∏çÊòØË°®Ê†ºÁ±ªÂûã:", type(allPlayersData))
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "‚ùå Êï∞ÊçÆÊ†ºÂºèÈîôËØØ\nÊúüÊúõË°®Ê†ºÁ±ªÂûãÔºåÊî∂Âà∞:" .. type(allPlayersData)
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 16
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 100)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
        return
    end

    -- ÁªüËÆ°ÂíåË∞ÉËØï‰ø°ÊÅØ
    local count = 0
    for k, v in pairs(allPlayersData) do
        count = count + 1
        print("üë§ [Ë∞ÉËØï] Áé©ÂÆ∂", count, "- ÂêçÁß∞:", k)
        if type(v) == "table" then
            print("  ‚îî‚îÄ Áî®Êà∑ID:", v.userId or "Êú™Áü•")
            print("  ‚îî‚îÄ ÈáëÂ∏Å:", v.coins or "Êú™Áü•")
            print("  ‚îî‚îÄ ‰ºöÂëòÁä∂ÊÄÅ:", v.membership_status or "Êú™Áü•")
        else
            print("  ‚îî‚îÄ Êï∞ÊçÆÁ±ªÂûãÈîôËØØ:", type(v))
        end
    end
    print("üë§ [Ë∞ÉËØï] ÊÄªÂÖ±ÊâæÂà∞", count, "‰∏™Áé©ÂÆ∂")

    local yPos = 10

    -- Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆ
    if count == 0 then
        print("üë§ [Ë∞ÉËØï] Ê≤°ÊúâÁî®Êà∑Êï∞ÊçÆÔºåÊòæÁ§∫ÊèêÁ§∫")
        local noDataLabel = Instance.new("TextLabel")
        noDataLabel.Text = "üòî ÊöÇÊó†Áî®Êà∑Êï∞ÊçÆ\n\nÂèØËÉΩÁöÑÂéüÂõ†:\n‚Ä¢ Êï∞ÊçÆÊúçÂä°Êú™ÂêØÂä®\n‚Ä¢ Êï∞ÊçÆÂ∫ì‰∏≠Ê≤°ÊúâÁî®Êà∑Êï∞ÊçÆ\n‚Ä¢ ÁΩëÁªúËøûÊé•ÈóÆÈ¢ò"
        noDataLabel.Font = Enum.Font.SourceSans
        noDataLabel.TextSize = 16
        noDataLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        noDataLabel.Size = UDim2.new(1, -20, 0, 250)
        noDataLabel.Position = UDim2.new(0, 10, 0, yPos)
        noDataLabel.BackgroundTransparency = 1
        noDataLabel.TextXAlignment = Enum.TextXAlignment.Center
        noDataLabel.TextYAlignment = Enum.TextYAlignment.Top
        noDataLabel.TextWrapped = true
        noDataLabel.Parent = contentArea

        return
    end

    -- ÊòæÁ§∫Âä†ËΩΩÊàêÂäüÁöÑ‰ø°ÊÅØ
    print("‚úÖ [Áî®Êà∑ÁÆ°ÁêÜ] ÂºÄÂßãÂàõÂª∫Áî®Êà∑ÁïåÈù¢ÔºåÂÖ±", count, "‰∏™Áî®Êà∑")

    -- Âú®È°∂ÈÉ®ÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
    local statsLabel = Instance.new("TextLabel")
    statsLabel.Text = "üìä Áî®Êà∑ÁªüËÆ°: ÂÖ± " .. count .. " ‰∏™Áî®Êà∑"
    statsLabel.Font = Enum.Font.SourceSansBold
    statsLabel.TextSize = 14
    statsLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
    statsLabel.Size = UDim2.new(1, -20, 0, 25)
    statsLabel.Position = UDim2.new(0, 10, 0, yPos)
    statsLabel.BackgroundTransparency = 1
    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
    statsLabel.Parent = contentArea

    yPos = yPos + 35

    for playerName, data in pairs(allPlayersData) do
        print("üë§ [Ë∞ÉËØï] ÂàõÂª∫Áé©ÂÆ∂Âç°Áâá:", playerName)

        -- È™åËØÅÊï∞ÊçÆÂÆåÊï¥ÊÄß
        if not data or type(data) ~= "table" then
            print("‚ö†Ô∏è [Ë≠¶Âëä] Áé©ÂÆ∂", playerName, "ÁöÑÊï∞ÊçÆÊó†Êïà:", type(data))
            continue
        end

        -- Áé©ÂÆ∂Âç°Áâá
        local playerCard = Instance.new("Frame")
        playerCard.Name = "PlayerCard_" .. playerName
        playerCard.Size = UDim2.new(1, -20, 0, 120)
        playerCard.Position = UDim2.new(0, 10, 0, yPos)
        playerCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        playerCard.BorderSizePixel = 0
        playerCard.Parent = contentArea
        ShopUtils.createCorner(playerCard, 8)

        -- Áé©ÂÆ∂‰ø°ÊÅØ
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = "üë§ " .. playerName .. " (ID: " .. data.userId .. ")"
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 16
        nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        nameLabel.Size = UDim2.new(0.4, 0, 0, 25)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = playerCard

        -- ÈáëÂ∏ÅÊòæÁ§∫Âíå‰øÆÊîπ
        local coinsLabel = Instance.new("TextLabel")
        coinsLabel.Text = "üí∞ " .. data.coins .. " ÈáëÂ∏Å"
        coinsLabel.Font = Enum.Font.SourceSans
        coinsLabel.TextSize = 14
        coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
        coinsLabel.Size = UDim2.new(0.2, 0, 0, 20)
        coinsLabel.Position = UDim2.new(0, 10, 0, 30)
        coinsLabel.BackgroundTransparency = 1
        coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
        coinsLabel.Parent = playerCard

        -- ‰ºöÂëòÁä∂ÊÄÅÊòæÁ§∫
        local membershipStatus = data.membership_status or "none"
        local isMember = membershipStatus == "active"
        local membershipLabel = Instance.new("TextLabel")
        membershipLabel.Text = isMember and "üëë ‰ºöÂëò" or "üë§ ÊôÆÈÄöÁî®Êà∑"
        membershipLabel.Font = Enum.Font.SourceSansBold
        membershipLabel.TextSize = 12
        membershipLabel.TextColor3 = isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
        membershipLabel.Size = UDim2.new(0.15, 0, 0, 20)
        membershipLabel.Position = UDim2.new(0.25, 10, 0, 30)
        membershipLabel.BackgroundTransparency = 1
        membershipLabel.TextXAlignment = Enum.TextXAlignment.Left
        membershipLabel.Parent = playerCard

        -- ‰ºöÂëòÂà∞ÊúüÊó∂Èó¥ÊòæÁ§∫
        local expiryLabel = Instance.new("TextLabel")
        local expiryText = ""
        if isMember and data.end_date then
            expiryText = "‚è∞ " .. data.end_date:sub(1, 10)
        elseif isMember then
            expiryText = "‚è∞ Êú™Áü•"
        else
            expiryText = ""
        end
        expiryLabel.Text = expiryText
        expiryLabel.Font = Enum.Font.SourceSans
        expiryLabel.TextSize = 11
        expiryLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        expiryLabel.Size = UDim2.new(0.2, 0, 0, 20)
        expiryLabel.Position = UDim2.new(0.45, 10, 0, 30)
        expiryLabel.BackgroundTransparency = 1
        expiryLabel.TextXAlignment = Enum.TextXAlignment.Left
        expiryLabel.Parent = playerCard

        -- ÈáëÂ∏Å‰øÆÊîπËæìÂÖ•Ê°Ü
        local coinsInput = Instance.new("TextBox")
        coinsInput.Text = tostring(data.coins)
        coinsInput.Font = Enum.Font.SourceSans
        coinsInput.TextSize = 12
        coinsInput.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        coinsInput.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
        coinsInput.Size = UDim2.new(0, 80, 0, 25)
        coinsInput.Position = UDim2.new(0, 10, 0, 55)
        coinsInput.PlaceholderText = "Êñ∞ÈáëÂ∏ÅÊï∞"
        coinsInput.Parent = playerCard
        ShopUtils.createCorner(coinsInput, 4)

        -- ËÆæÁΩÆÈáëÂ∏ÅÊåâÈíÆ
        local setCoinsBtn = ShopUtils.createButton("ËÆæÁΩÆ", ShopUtils.COLORS.SUCCESS, playerCard, function()
            local newCoins = tonumber(coinsInput.Text)
            if newCoins and newCoins >= 0 and newCoins <= 999999 then
                -- ÂèëÈÄÅ‰øÆÊîπÈáëÂ∏ÅËØ∑Ê±Ç
                -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®ËÆæÁΩÆÁî®Êà∑ÈáëÂ∏Å
                if AdminController then
                    AdminController.setUserCoins(playerName, newCoins)

                    -- ÁõëÂê¨‰øÆÊîπÁªìÊûú
                    local connection
                    connection = AdminController.Events.UserCoinsSet:Connect(function(success, message)
                        connection:Disconnect()

                        if success then
                            print("‚úÖ ÈáëÂ∏Å‰øÆÊîπÊàêÂäü:", playerName, newCoins)
                            -- Á´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                            coinsLabel.Text = "üí∞ " .. newCoins .. " ÈáëÂ∏Å"
                            if showNotification then
                                showNotification("‚úÖ " .. message, true)
                            end

                            -- Âà∑Êñ∞Áî®Êà∑ÂàóË°®‰ª•Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•
                            task.wait(0.5)
                            print("üîÑ [ÁÆ°ÁêÜÂëòÈù¢Êùø] Á¨¨‰∏ÄÊ¨°Âà∑Êñ∞Áî®Êà∑Êï∞ÊçÆ")
                            ShopAdminPanel._refreshPlayerData()

                            -- ÂÜçÊ¨°Âà∑Êñ∞‰ª•Á°Æ‰øùÊï∞ÊçÆÂÆåÂÖ®ÂêåÊ≠•
                            task.wait(1.0)
                            print("üîÑ [ÁÆ°ÁêÜÂëòÈù¢Êùø] Á¨¨‰∫åÊ¨°Âà∑Êñ∞Áî®Êà∑Êï∞ÊçÆ")
                            ShopAdminPanel._refreshPlayerData()
                        else
                            print("‚ùå ÈáëÂ∏Å‰øÆÊîπÂ§±Ë¥•:", message)
                            if showNotification then
                                showNotification("‚ùå " .. message, false)
                            end
                        end
                    end)
                else
                    print("‚ùå SetUserCoins ‰∫ã‰ª∂‰∏çÂ≠òÂú®")
                end
            else
                if showNotification then
                    showNotification("‚ùå ÈáëÂ∏ÅÊï∞ÈáèÂøÖÈ°ªÂú® 0-999999 ‰πãÈó¥", false)
                end
            end
        end)
        setCoinsBtn.Position = UDim2.new(0, 100, 0, 55)
        setCoinsBtn.Size = UDim2.new(0, 60, 0, 25)
        setCoinsBtn.TextSize = 12

        -- Êü•ÁúãËÆ∞ÂΩïÊåâÈíÆ
        local viewRecordsBtn = ShopUtils.createButton("Êü•ÁúãËÆ∞ÂΩï", ShopUtils.COLORS.ACCENT, playerCard, function()
            print("üîß [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] Êü•ÁúãÁî®Êà∑ËÆ∞ÂΩï:", playerName)
            currentViewingPlayer = playerName
            ShopAdminPanel._addTab("records")
            ShopAdminPanel.switchTab("records")
        end)
        viewRecordsBtn.Position = UDim2.new(0, 170, 0, 55)
        viewRecordsBtn.Size = UDim2.new(0, 80, 0, 25)
        viewRecordsBtn.TextSize = 12

        -- ÁÆ°ÁêÜ‰ºöÂëòÊåâÈíÆ
        local manageMembershipBtn = ShopUtils.createButton("ÁÆ°ÁêÜ‰ºöÂëò", ShopUtils.COLORS.WARNING, playerCard, function()
            print("üîß [Áªü‰∏ÄÁÆ°ÁêÜÈù¢Êùø] ÁÆ°ÁêÜÁî®Êà∑‰ºöÂëò:", playerName)
            currentViewingPlayer = playerName
            ShopAdminPanel._addTab("membership")
            ShopAdminPanel.switchTab("membership")
        end)
        manageMembershipBtn.Position = UDim2.new(0, 260, 0, 55)
        manageMembershipBtn.Size = UDim2.new(0, 80, 0, 25)
        manageMembershipBtn.TextSize = 12

        -- ÁªüËÆ°‰ø°ÊÅØ
        local statsText = string.format(
            "üìä Ë¥≠‰π∞: %dÊ¨° | ÂçñÂá∫: %dÊ¨° | Ê∂àË¥π: %dÈáëÂ∏Å | Êî∂ÂÖ•: %dÈáëÂ∏Å | Â∫ìÂ≠ò: %d‰ª∂",
            data.totalPurchases or 0, data.totalSales or 0, data.totalSpent or 0, data.totalEarned or 0, data.inventoryCount or 0
        )
        local statsLabel = Instance.new("TextLabel")
        statsLabel.Text = statsText
        statsLabel.Font = Enum.Font.SourceSans
        statsLabel.TextSize = 12
        statsLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        statsLabel.Size = UDim2.new(1, -20, 0, 30)
        statsLabel.Position = UDim2.new(0, 10, 0, 85)
        statsLabel.BackgroundTransparency = 1
        statsLabel.TextXAlignment = Enum.TextXAlignment.Left
        statsLabel.TextWrapped = true
        statsLabel.Parent = playerCard

        yPos = yPos + 130
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- ÊòæÁ§∫‰∫§ÊòìËÆ∞ÂΩïÈù¢Êùø
function ShopAdminPanel._showRecordsPanel(showNotification)
    print("üìä [‰∫§ÊòìËÆ∞ÂΩï] Âä†ËΩΩ‰∫§ÊòìËÆ∞ÂΩïÈù¢ÊùøÔºåÊü•ÁúãÁî®Êà∑:", currentViewingPlayer)

    if not currentViewingPlayer then
        local noPlayerLabel = Instance.new("TextLabel")
        noPlayerLabel.Text = "‚ùå ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊü•ÁúãÁöÑÁî®Êà∑"
        noPlayerLabel.Font = Enum.Font.SourceSans
        noPlayerLabel.TextSize = 16
        noPlayerLabel.TextColor3 = ShopUtils.COLORS.ERROR
        noPlayerLabel.Size = UDim2.new(1, 0, 0, 100)
        noPlayerLabel.BackgroundTransparency = 1
        noPlayerLabel.TextXAlignment = Enum.TextXAlignment.Center
        noPlayerLabel.Parent = contentArea
        return
    end

    -- ÊòæÁ§∫ÂΩìÂâçÊü•ÁúãÁöÑÁî®Êà∑‰ø°ÊÅØ
    local userInfoLabel = Instance.new("TextLabel")
    userInfoLabel.Text = "üìä Ê≠£Âú®Êü•Áúã " .. currentViewingPlayer .. " ÁöÑ‰∫§ÊòìËÆ∞ÂΩï"
    userInfoLabel.Font = Enum.Font.SourceSansBold
    userInfoLabel.TextSize = 16
    userInfoLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    userInfoLabel.Size = UDim2.new(1, 0, 0, 30)
    userInfoLabel.BackgroundTransparency = 1
    userInfoLabel.TextXAlignment = Enum.TextXAlignment.Center
    userInfoLabel.Parent = contentArea

    -- ËøîÂõûÁî®Êà∑ÁÆ°ÁêÜÊåâÈíÆ
    local backBtn = ShopUtils.createButton("‚Üê ËøîÂõûÁî®Êà∑ÁÆ°ÁêÜ", ShopUtils.COLORS.ACCENT, contentArea, function()
        ShopAdminPanel._resetToDefaultTabs()
        ShopAdminPanel.switchTab("users")
    end)
    backBtn.Position = UDim2.new(0, 10, 0, 40)
    backBtn.Size = UDim2.new(0, 120, 0, 30)
    backBtn.TextSize = 12

    -- ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "üì° Ê≠£Âú®Âä†ËΩΩ " .. currentViewingPlayer .. " ÁöÑ‰∫§ÊòìËÆ∞ÂΩï..."
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 14
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 50)
    loadingLabel.Position = UDim2.new(0, 0, 0, 80)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.Parent = contentArea

    -- ËØ∑Ê±ÇÁâπÂÆöÁî®Êà∑ÁöÑÂéÜÂè≤ËÆ∞ÂΩï
    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÁî®Êà∑ÂéÜÂè≤ËÆ∞ÂΩï
    if AdminController then
        AdminController.getUserHistory(currentViewingPlayer)

        -- ÁõëÂê¨ÊúçÂä°Âô®ÂìçÂ∫î
        local connection
        connection = AdminController.Events.UserHistoryReceived:Connect(function(success, message, data)
            connection:Disconnect()
            loadingLabel:Destroy()

            if not success then
                local errorLabel = Instance.new("TextLabel")
                errorLabel.Text = "‚ùå " .. (message or "Ëé∑ÂèñÁî®Êà∑‰∫§ÊòìËÆ∞ÂΩïÂ§±Ë¥•")
                errorLabel.Font = Enum.Font.SourceSans
                errorLabel.TextSize = 14
                errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
                errorLabel.Size = UDim2.new(1, 0, 0, 50)
                errorLabel.Position = UDim2.new(0, 0, 0, 80)
                errorLabel.BackgroundTransparency = 1
                errorLabel.TextXAlignment = Enum.TextXAlignment.Center
                errorLabel.Parent = contentArea
            elseif data and data.transactions and #data.transactions > 0 then
                print("‚úÖ [‰∫§ÊòìËÆ∞ÂΩï] ÊàêÂäüËé∑ÂèñÂà∞", #data.transactions, "Êù°‰∫§ÊòìËÆ∞ÂΩï")
                ShopAdminPanel._displayUserRecords(data.transactions)
            else
                local noRecordsLabel = Instance.new("TextLabel")
                noRecordsLabel.Text = "üìù " .. currentViewingPlayer .. " ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï"
                noRecordsLabel.Font = Enum.Font.SourceSans
                noRecordsLabel.TextSize = 14
                noRecordsLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
                noRecordsLabel.Size = UDim2.new(1, 0, 0, 50)
                noRecordsLabel.Position = UDim2.new(0, 0, 0, 80)
                noRecordsLabel.BackgroundTransparency = 1
                noRecordsLabel.TextXAlignment = Enum.TextXAlignment.Center
                noRecordsLabel.Parent = contentArea
            end
        end)
    else
        loadingLabel:Destroy()
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "‚ùå Ëé∑ÂèñÁî®Êà∑ËÆ∞ÂΩïÂäüËÉΩ‰∏çÂèØÁî®"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 14
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 50)
        errorLabel.Position = UDim2.new(0, 0, 0, 80)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
    end
end

-- ÊòæÁ§∫Áî®Êà∑‰∫§ÊòìËÆ∞ÂΩï
function ShopAdminPanel._displayUserRecords(records)
    print("üìä [‰∫§ÊòìËÆ∞ÂΩï] ÊòæÁ§∫Áî®Êà∑ËÆ∞ÂΩïÔºåÂÖ±", #records, "Êù°")

    local yPos = 140  -- ‰ªéËøîÂõûÊåâÈíÆ‰∏ãÊñπÂºÄÂßã

    for i, record in ipairs(records) do
        local recordCard = Instance.new("Frame")
        recordCard.Name = "Record" .. i
        recordCard.Size = UDim2.new(1, -20, 0, 80)
        recordCard.Position = UDim2.new(0, 10, 0, yPos)
        recordCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        recordCard.BorderSizePixel = 0
        recordCard.Parent = contentArea
        ShopUtils.createCorner(recordCard, 8)

        -- Êó∂Èó¥Êà≥
        local timeLabel = Instance.new("TextLabel")

        -- Ë∞ÉËØïÊó∂Èó¥Êà≥ÈóÆÈ¢ò
        local timestamp = record.timestamp or record.createdAt or record.transactionDate
        print("üìä [Ë∞ÉËØï] ‰∫§ÊòìËÆ∞ÂΩïÊó∂Èó¥Êà≥:",
            "timestamp=", record.timestamp,
            "createdAt=", record.createdAt,
            "transactionDate=", record.transactionDate,
            "‰ΩøÁî®=", timestamp)

        timeLabel.Text = ShopUtils.formatTimestamp(timestamp)
        timeLabel.Font = Enum.Font.SourceSans
        timeLabel.TextSize = 12
        timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        timeLabel.Size = UDim2.new(0, 150, 0, 20)
        timeLabel.Position = UDim2.new(0, 10, 0, 5)
        timeLabel.BackgroundTransparency = 1
        timeLabel.TextXAlignment = Enum.TextXAlignment.Left
        timeLabel.Parent = recordCard

        -- ‰∫§ÊòìÁ±ªÂûãÂíåÁâ©ÂìÅ
        local actionLabel = Instance.new("TextLabel")
        local actionText = ""
        if record.type == "buy" or record.action == "buy" then
            actionText = "üõí Ë¥≠‰π∞ " .. (record.itemName or record.item_name or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
        elseif record.type == "sell" or record.action == "sell" then
            actionText = "üí∞ ÂçñÂá∫ " .. (record.itemName or record.item_name or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
        elseif record.type == "admin" or record.action == "admin_edit" then
            actionText = "‚öôÔ∏è ÁÆ°ÁêÜÂëòÊìç‰Ωú x" .. (record.quantity or 1)
        elseif record.type == "daily_reward" then
            actionText = "üéÅ ÊØèÊó•Â•ñÂä± x" .. (record.quantity or 1)
        elseif record.type == "membership_purchase" then
            actionText = "üíé Ë¥≠‰π∞‰ºöÂëò " .. (record.itemName or record.item_name or "Êú™Áü•‰ºöÂëò") .. " x" .. (record.quantity or 1)
        end
        actionLabel.Text = actionText
        actionLabel.Font = Enum.Font.SourceSansBold
        actionLabel.TextSize = 16
        actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        actionLabel.Size = UDim2.new(1, -20, 0, 25)
        actionLabel.Position = UDim2.new(0, 10, 0, 25)
        actionLabel.BackgroundTransparency = 1
        actionLabel.TextXAlignment = Enum.TextXAlignment.Left
        actionLabel.Parent = recordCard

        -- ÈáëÈ¢ù
        local amountLabel = Instance.new("TextLabel")
        local amountText = ""
        local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
        if record.type == "buy" or record.action == "buy" then
            amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " ÈáëÂ∏Å"
            amountColor = ShopUtils.COLORS.ERROR
        elseif record.type == "sell" or record.action == "sell" then
            amountText = "+" .. (record.totalAmount or record.totalEarned or record.total_amount or 0) .. " ÈáëÂ∏Å"
            amountColor = ShopUtils.COLORS.SUCCESS
        elseif record.type == "admin" or record.action == "admin_edit" then
            local amount = record.totalAmount or record.total_amount or 0
            if amount > 0 then
                amountText = "+" .. amount .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif amount < 0 then
                amountText = amount .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.ERROR
            else
                amountText = "0 ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.TEXT_SECONDARY
            end
        elseif record.type == "daily_reward" then
            amountText = "+" .. (record.totalAmount or record.total_amount or 0) .. " ÈáëÂ∏Å"
            amountColor = ShopUtils.COLORS.SUCCESS
        elseif record.type == "membership_purchase" then
            amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " ÈáëÂ∏Å"
            amountColor = ShopUtils.COLORS.ERROR
        end
        amountLabel.Text = amountText
        amountLabel.Font = Enum.Font.SourceSansBold
        amountLabel.TextSize = 14
        amountLabel.TextColor3 = amountColor
        amountLabel.Size = UDim2.new(0, 120, 0, 20)
        amountLabel.Position = UDim2.new(1, -130, 0, 30)
        amountLabel.BackgroundTransparency = 1
        amountLabel.TextXAlignment = Enum.TextXAlignment.Right
        amountLabel.Parent = recordCard

        yPos = yPos + 90
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- ÊòæÁ§∫‰ºöÂëòÁÆ°ÁêÜÈù¢Êùø
function ShopAdminPanel._showMembershipPanel(showNotification)
    print("üë• [‰ºöÂëòÁÆ°ÁêÜ] Âä†ËΩΩ‰ºöÂëòÁÆ°ÁêÜÈù¢ÊùøÔºåÊü•ÁúãÁî®Êà∑:", currentViewingPlayer)

    if not currentViewingPlayer then
        local noPlayerLabel = Instance.new("TextLabel")
        noPlayerLabel.Text = "‚ùå ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁÆ°ÁêÜÁöÑÁî®Êà∑"
        noPlayerLabel.Font = Enum.Font.SourceSans
        noPlayerLabel.TextSize = 16
        noPlayerLabel.TextColor3 = ShopUtils.COLORS.ERROR
        noPlayerLabel.Size = UDim2.new(1, 0, 0, 100)
        noPlayerLabel.BackgroundTransparency = 1
        noPlayerLabel.TextXAlignment = Enum.TextXAlignment.Center
        noPlayerLabel.Parent = contentArea
        return
    end

    -- ÊòæÁ§∫ÂΩìÂâçÁÆ°ÁêÜÁöÑÁî®Êà∑‰ø°ÊÅØ
    local userInfoLabel = Instance.new("TextLabel")
    userInfoLabel.Text = "üë• Ê≠£Âú®ÁÆ°ÁêÜ " .. currentViewingPlayer .. " ÁöÑ‰ºöÂëòÁä∂ÊÄÅ"
    userInfoLabel.Font = Enum.Font.SourceSansBold
    userInfoLabel.TextSize = 16
    userInfoLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    userInfoLabel.Size = UDim2.new(1, 0, 0, 30)
    userInfoLabel.BackgroundTransparency = 1
    userInfoLabel.TextXAlignment = Enum.TextXAlignment.Center
    userInfoLabel.Parent = contentArea

    -- ËøîÂõûÁî®Êà∑ÁÆ°ÁêÜÊåâÈíÆ
    local backBtn = ShopUtils.createButton("‚Üê ËøîÂõûÁî®Êà∑ÁÆ°ÁêÜ", ShopUtils.COLORS.ACCENT, contentArea, function()
        ShopAdminPanel._resetToDefaultTabs()
        ShopAdminPanel.switchTab("users")
    end)
    backBtn.Position = UDim2.new(0, 10, 0, 40)
    backBtn.Size = UDim2.new(0, 120, 0, 30)
    backBtn.TextSize = 12

    -- ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "üì° Ê≠£Âú®Âä†ËΩΩ " .. currentViewingPlayer .. " ÁöÑ‰ºöÂëò‰ø°ÊÅØ..."
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 14
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 50)
    loadingLabel.Position = UDim2.new(0, 0, 0, 80)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.Parent = contentArea

    -- ‰ªéÊúçÂä°Âô®Ëé∑ÂèñÁâπÂÆöÁî®Êà∑ÁöÑ‰ºöÂëòÁä∂ÊÄÅ
    local connection
        connection = AdminController.Events.AllUsersWithMembershipReceived:Connect(function(success, message, response)
        connection:Disconnect()
        loadingLabel:Destroy()

        if success and response and response.success then
            local users = response.data.users or {}
            local targetUser = nil

            -- Êü•ÊâæÁõÆÊ†áÁî®Êà∑
            for _, user in pairs(users) do
                if user.username == currentViewingPlayer then
                    targetUser = user
                    break
                end
            end

            if targetUser then
                ShopAdminPanel._displayUserMembership(targetUser)
            else
                local errorLabel = Instance.new("TextLabel")
                errorLabel.Text = "‚ùå Êú™ÊâæÂà∞Áî®Êà∑ " .. currentViewingPlayer .. " ÁöÑ‰ºöÂëò‰ø°ÊÅØ"
                errorLabel.Font = Enum.Font.SourceSans
                errorLabel.TextSize = 14
                errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
                errorLabel.Size = UDim2.new(1, 0, 0, 50)
                errorLabel.Position = UDim2.new(0, 0, 0, 80)
                errorLabel.BackgroundTransparency = 1
                errorLabel.TextXAlignment = Enum.TextXAlignment.Center
                errorLabel.Parent = contentArea
            end
        else
            local errorMsg = response and response.message or "Ëé∑Âèñ‰ºöÂëòÊï∞ÊçÆÂ§±Ë¥•"
            print("‚ùå Áî®Êà∑‰ºöÂëòÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:", errorMsg)
            local errorLabel = Instance.new("TextLabel")
            errorLabel.Text = "‚ùå " .. errorMsg
            errorLabel.Font = Enum.Font.SourceSans
            errorLabel.TextSize = 14
            errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
            errorLabel.Size = UDim2.new(1, 0, 0, 50)
            errorLabel.Position = UDim2.new(0, 0, 0, 80)
            errorLabel.BackgroundTransparency = 1
            errorLabel.TextXAlignment = Enum.TextXAlignment.Center
            errorLabel.Parent = contentArea
        end
    end)

    -- ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÊúçÂä°Âô®
    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÊâÄÊúâÁî®Êà∑‰ºöÂëò‰ø°ÊÅØ
    if AdminController then
        AdminController.getAllUsersWithMembership()
    else
        loadingLabel:Destroy()
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "‚ùå ‰ºöÂëòÁÆ°ÁêÜÂäüËÉΩ‰∏çÂèØÁî®"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 14
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 50)
        errorLabel.Position = UDim2.new(0, 0, 0, 80)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
    end
end

-- ÊòæÁ§∫Âçï‰∏™Áî®Êà∑ÁöÑ‰ºöÂëòÁÆ°ÁêÜ‰ø°ÊÅØ
function ShopAdminPanel._displayUserMembership(user)
    print("üë• [‰ºöÂëòÁÆ°ÁêÜ] ÊòæÁ§∫Áî®Êà∑‰ºöÂëò‰ø°ÊÅØ:", user.username)

    local membershipStatus = user.membership_status or "none"
    local isMember = membershipStatus == "active"
    local yPos = 140  -- ‰ªéËøîÂõûÊåâÈíÆ‰∏ãÊñπÂºÄÂßã

    -- Áî®Êà∑‰ø°ÊÅØÂç°Áâá
    local userCard = Instance.new("Frame")
    userCard.Name = "UserMembershipCard"
    userCard.Size = UDim2.new(1, -20, 0, 200)
    userCard.Position = UDim2.new(0, 10, 0, yPos)
    userCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    userCard.BorderSizePixel = 0
    userCard.Parent = contentArea
    ShopUtils.createCorner(userCard, 8)

    -- Áî®Êà∑ÂêçÁß∞
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Text = "üë§ " .. user.username .. " (ID: " .. user.user_id .. ")"
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextSize = 18
    nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    nameLabel.Size = UDim2.new(1, -20, 0, 25)
    nameLabel.Position = UDim2.new(0, 10, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = userCard

    -- ÈáëÂ∏ÅÊï∞Èáè
    local coinsLabel = Instance.new("TextLabel")
    coinsLabel.Text = "üí∞ " .. (user.coins or 0) .. " ÈáëÂ∏Å"
    coinsLabel.Font = Enum.Font.SourceSans
    coinsLabel.TextSize = 14
    coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
    coinsLabel.Size = UDim2.new(0.3, 0, 0, 20)
    coinsLabel.Position = UDim2.new(0, 10, 0, 40)
    coinsLabel.BackgroundTransparency = 1
    coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
    coinsLabel.Parent = userCard

    -- ‰ºöÂëòÁä∂ÊÄÅ
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Text = isMember and "üëë Ê¥ªË∑É‰ºöÂëò" or "üë§ ÊôÆÈÄöÁî®Êà∑"
    statusLabel.Font = Enum.Font.SourceSansBold
    statusLabel.TextSize = 14
    statusLabel.TextColor3 = isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
    statusLabel.Size = UDim2.new(0.3, 0, 0, 20)
    statusLabel.Position = UDim2.new(0.35, 10, 0, 40)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = userCard

    -- Ââ©‰ΩôÂ§©Êï∞
    local daysRemaining = tonumber(user.days_remaining) or 0
    local daysLabel = Instance.new("TextLabel")
    daysLabel.Text = "‚è∞ Ââ©‰Ωô " .. daysRemaining .. " Â§©"
    daysLabel.Font = Enum.Font.SourceSans
    daysLabel.TextSize = 12
    daysLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    daysLabel.Size = UDim2.new(0.3, 0, 0, 20)
    daysLabel.Position = UDim2.new(0.7, 10, 0, 40)
    daysLabel.BackgroundTransparency = 1
    daysLabel.TextXAlignment = Enum.TextXAlignment.Left
    daysLabel.Parent = userCard

    -- ‰ºöÂëòÂºÄÂßãÊó∂Èó¥
    if user.start_date then
        local startLabel = Instance.new("TextLabel")
        startLabel.Text = "üìÖ ÂºÄÂßãÊó∂Èó¥: " .. user.start_date:sub(1, 10)
        startLabel.Font = Enum.Font.SourceSans
        startLabel.TextSize = 12
        startLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        startLabel.Size = UDim2.new(0.4, 0, 0, 20)
        startLabel.Position = UDim2.new(0, 10, 0, 70)
        startLabel.BackgroundTransparency = 1
        startLabel.TextXAlignment = Enum.TextXAlignment.Left
        startLabel.Parent = userCard
    end

    -- ‰ºöÂëòÁªìÊùüÊó∂Èó¥
    if user.end_date then
        local endLabel = Instance.new("TextLabel")
        endLabel.Text = "üìÖ ÁªìÊùüÊó∂Èó¥: " .. user.end_date:sub(1, 10)
        endLabel.Font = Enum.Font.SourceSans
        endLabel.TextSize = 12
        endLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        endLabel.Size = UDim2.new(0.4, 0, 0, 20)
        endLabel.Position = UDim2.new(0.5, 10, 0, 70)
        endLabel.BackgroundTransparency = 1
        endLabel.TextXAlignment = Enum.TextXAlignment.Left
        endLabel.Parent = userCard
    end

    -- ÊØèÊó•Â•ñÂä±
    local dailyReward = tonumber(user.daily_reward_coins) or 100
    local rewardLabel = Instance.new("TextLabel")
    rewardLabel.Text = "üéÅ ÊØèÊó•Â•ñÂä±: " .. dailyReward .. " ÈáëÂ∏Å"
    rewardLabel.Font = Enum.Font.SourceSans
    rewardLabel.TextSize = 12
    rewardLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
    rewardLabel.Size = UDim2.new(0.4, 0, 0, 20)
    rewardLabel.Position = UDim2.new(0, 10, 0, 100)
    rewardLabel.BackgroundTransparency = 1
    rewardLabel.TextXAlignment = Enum.TextXAlignment.Left
    rewardLabel.Parent = userCard

    yPos = yPos + 220

    -- ÊéßÂà∂Èù¢Êùø
    local controlCard = Instance.new("Frame")
    controlCard.Name = "ControlCard"
    controlCard.Size = UDim2.new(1, -20, 0, 150)
    controlCard.Position = UDim2.new(0, 10, 0, yPos)
    controlCard.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    controlCard.BorderSizePixel = 0
    controlCard.Parent = contentArea
    ShopUtils.createCorner(controlCard, 8)

    -- ÊéßÂà∂Ê†áÈ¢ò
    local controlTitle = Instance.new("TextLabel")
    controlTitle.Text = "‚öôÔ∏è ‰ºöÂëòÊéßÂà∂"
    controlTitle.Font = Enum.Font.SourceSansBold
    controlTitle.TextSize = 16
    controlTitle.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    controlTitle.Size = UDim2.new(1, -20, 0, 25)
    controlTitle.Position = UDim2.new(0, 10, 0, 10)
    controlTitle.BackgroundTransparency = 1
    controlTitle.TextXAlignment = Enum.TextXAlignment.Left
    controlTitle.Parent = controlCard

    -- ÂàáÊç¢‰ºöÂëòÁä∂ÊÄÅÊåâÈíÆ
    local toggleBtn = ShopUtils.createButton(
        isMember and "üî¥ ÂÅúÁî®‰ºöÂëò" or "üü¢ ÊøÄÊ¥ª‰ºöÂëò",
        isMember and ShopUtils.COLORS.ERROR or ShopUtils.COLORS.SUCCESS,
        controlCard,
        function()
            ShopAdminPanel._toggleUserMembership(user)
        end
    )
    toggleBtn.Position = UDim2.new(0, 10, 0, 40)
    toggleBtn.Size = UDim2.new(0, 120, 0, 30)
    toggleBtn.TextSize = 12

    -- ËÆæÁΩÆÂà∞ÊúüÊó∂Èó¥
    local daysInput = Instance.new("TextBox")
    daysInput.Text = tostring(daysRemaining)
    daysInput.Font = Enum.Font.SourceSans
    daysInput.TextSize = 12
    daysInput.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    daysInput.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    daysInput.Size = UDim2.new(0, 80, 0, 25)
    daysInput.Position = UDim2.new(0, 150, 0, 40)
    daysInput.PlaceholderText = "Â§©Êï∞"
    daysInput.Parent = controlCard
    ShopUtils.createCorner(daysInput, 4)

    local setDaysBtn = ShopUtils.createButton("ËÆæÁΩÆÂ§©Êï∞", ShopUtils.COLORS.ACCENT, controlCard, function()
        local newDays = tonumber(daysInput.Text)
        if newDays and newDays >= 0 and newDays <= 365 then
            ShopAdminPanel._setMembershipDays(user, newDays)
        else
            print("‚ùå Â§©Êï∞ÂøÖÈ°ªÂú® 0-365 ‰πãÈó¥")
        end
    end)
    setDaysBtn.Position = UDim2.new(0, 240, 0, 40)
    setDaysBtn.Size = UDim2.new(0, 80, 0, 25)
    setDaysBtn.TextSize = 12

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 170)
end

-- ÊòæÁ§∫‰ºöÂëòÁÆ°ÁêÜÊï∞ÊçÆ
function ShopAdminPanel._displayMembershipData()
    print("üë• [‰ºöÂëòÁÆ°ÁêÜ] ÊòæÁ§∫‰ºöÂëòÊï∞ÊçÆ")

    local yPos = 10

    for playerName, membershipInfo in pairs(membershipData) do
        local entryFrame = Instance.new("Frame")
        entryFrame.Name = playerName .. "_Entry"
        entryFrame.Size = UDim2.new(1, -20, 0, 100)
        entryFrame.Position = UDim2.new(0, 10, 0, yPos)
        entryFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        entryFrame.BorderSizePixel = 0
        entryFrame.Parent = contentArea
        ShopUtils.createCorner(entryFrame, 8)

        -- Áé©ÂÆ∂ÂêçÁß∞
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = "üë§ " .. playerName
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 16
        nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        nameLabel.Size = UDim2.new(0.2, 0, 0, 25)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = entryFrame

        -- ÈáëÂ∏ÅÊï∞Èáè
        local coinsLabel = Instance.new("TextLabel")
        coinsLabel.Text = "üí∞ " .. membershipInfo.coins .. " ÈáëÂ∏Å"
        coinsLabel.Font = Enum.Font.SourceSans
        coinsLabel.TextSize = 12
        coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
        coinsLabel.Size = UDim2.new(0.15, 0, 0, 20)
        coinsLabel.Position = UDim2.new(0, 10, 0, 30)
        coinsLabel.BackgroundTransparency = 1
        coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
        coinsLabel.Parent = entryFrame

        -- ‰ºöÂëòÁä∂ÊÄÅ
        local statusLabel = Instance.new("TextLabel")
        statusLabel.Text = membershipInfo.isMember and "‚úì ‰ºöÂëò" or "ÊôÆÈÄöÁî®Êà∑"
        statusLabel.Font = Enum.Font.SourceSansBold
        statusLabel.TextSize = 12
        statusLabel.TextColor3 = membershipInfo.isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
        statusLabel.Size = UDim2.new(0.12, 0, 0, 20)
        statusLabel.Position = UDim2.new(0.2, 10, 0, 10)
        statusLabel.BackgroundTransparency = 1
        statusLabel.TextXAlignment = Enum.TextXAlignment.Left
        statusLabel.Parent = entryFrame

        -- Ââ©‰ΩôÂ§©Êï∞
        local daysLabel = Instance.new("TextLabel")
        local daysText = "Ââ©‰Ωô" .. membershipInfo.daysRemaining .. "Â§©"
        daysLabel.Text = daysText
        daysLabel.Font = Enum.Font.SourceSans
        daysLabel.TextSize = 12
        daysLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        daysLabel.Size = UDim2.new(0.12, 0, 0, 20)
        daysLabel.Position = UDim2.new(0.2, 10, 0, 30)
        daysLabel.BackgroundTransparency = 1
        daysLabel.TextXAlignment = Enum.TextXAlignment.Left
        daysLabel.Parent = entryFrame

        -- Êìç‰ΩúÊåâÈíÆ
        local quickButton = ShopUtils.createButton(
            membershipInfo.isMember and "üî¥ ÂÅúÁî®" or "üü¢ ÊøÄÊ¥ª",
            membershipInfo.isMember and ShopUtils.COLORS.ERROR or ShopUtils.COLORS.SUCCESS,
            entryFrame,
            function()
                ShopAdminPanel._toggleUserMembershipByName(playerName, membershipInfo)
            end
        )
        quickButton.Position = UDim2.new(0.8, 0, 0, 10)
        quickButton.Size = UDim2.new(0, 80, 0, 25)
        quickButton.TextSize = 12

        local manageButton = ShopUtils.createButton("‚öôÔ∏è ÁÆ°ÁêÜ", ShopUtils.COLORS.ACCENT, entryFrame, function()
            ShopAdminPanel._showPlayerMembership(playerName, membershipInfo)
        end)
        manageButton.Position = UDim2.new(0.8, 0, 0, 40)
        manageButton.Size = UDim2.new(0, 80, 0, 25)
        manageButton.TextSize = 12

        yPos = yPos + 110
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- ÈÄöËøáÁî®Êà∑ÂêçÂàáÊç¢‰ºöÂëòÁä∂ÊÄÅ
function ShopAdminPanel._toggleUserMembershipByName(playerName, membershipInfo)
    print("üîÑ [‰ºöÂëòÁÆ°ÁêÜ] ÈÄöËøáÁî®Êà∑ÂêçÂàáÊç¢‰ºöÂëòÁä∂ÊÄÅ:", playerName)

    local isMember = membershipInfo.isMember
    local action = isMember and "deactivate" or "activate"

    local requestData = {
        playerName = playerName,
        action = action,
        days = action == "activate" and 30 or nil,
        dailyReward = membershipInfo.dailyReward or 100
    }

    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®ÁÆ°ÁêÜÁî®Êà∑‰ºöÂëòÁä∂ÊÄÅ
    if AdminController then
        AdminController.manageUserMembership(requestData)

        local connection
        connection = AdminController.Events.UserMembershipManaged:Connect(function(success, message, response)
            connection:Disconnect()

            if success and response and response.success then
                print("‚úÖ", playerName, "‰ºöÂëòÁä∂ÊÄÅÂàáÊç¢ÊàêÂäü")
                -- ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂπ∂Âà∑Êñ∞ÁïåÈù¢
                -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                if AdminController then
                    AdminController.getMembershipStatus(playerName)
                end
                -- Âà∑Êñ∞Áî®Êà∑ÂàóË°®‰ª•Êõ¥Êñ∞ÊâÄÊúâÁõ∏ÂÖ≥Êï∞ÊçÆ
                ShopAdminPanel._refreshPlayerData()
            else
                local errorMsg = response and (response.message or response.error) or "Êìç‰ΩúÂ§±Ë¥•"
                print("‚ùå ‰ºöÂëòÁä∂ÊÄÅÂàáÊç¢Â§±Ë¥•:", errorMsg)
                ShopUtils.showNotification("‚ùå " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("‚ùå ManageUserMembership ‰∫ã‰ª∂‰∏çÂ≠òÂú®")
    end
end

-- ÂàáÊç¢Áî®Êà∑‰ºöÂëòÁä∂ÊÄÅ
function ShopAdminPanel._toggleUserMembership(user)
    print("üîÑ [‰ºöÂëòÁÆ°ÁêÜ] ÂàáÊç¢Áî®Êà∑‰ºöÂëòÁä∂ÊÄÅ:", user.username)

    local membershipStatus = user.membership_status or "none"
    local isMember = membershipStatus == "active"
    local action = isMember and "deactivate" or "activate"

    local requestData = {
        userId = tostring(user.user_id),
        playerName = user.username,
        action = action,
        days = action == "activate" and 30 or nil,
        dailyReward = tonumber(user.daily_reward_coins) or 100
    }

    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®ÁÆ°ÁêÜÁî®Êà∑‰ºöÂëòÁä∂ÊÄÅ
    if AdminController then
        AdminController.manageUserMembership(requestData)

        local connection
        connection = AdminController.Events.UserMembershipManaged:Connect(function(success, message, response)
            connection:Disconnect()

            if success and response and response.success then
                print("‚úÖ", user.username, "‰ºöÂëòÁä∂ÊÄÅÂàáÊç¢ÊàêÂäü")
                ShopUtils.showNotification("‚úÖ " .. user.username .. " ‰ºöÂëòÁä∂ÊÄÅÂàáÊç¢ÊàêÂäü", true, currentScreenGui)

                -- ÂºÇÊ≠•Âà∑Êñ∞Èù¢ÊùøÊï∞ÊçÆÔºåÈÅøÂÖçÈòªÂ°ûÁïåÈù¢
                spawn(function()
                    -- ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂπ∂Âà∑Êñ∞Èù¢Êùø
                    if currentViewingPlayer then
                        -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                        if AdminController then
                            AdminController.getMembershipStatus(currentViewingPlayer)
                        end
                        -- Á≠âÂæÖÊï∞ÊçÆÊõ¥Êñ∞ÁÑ∂ÂêéÂà∑Êñ∞Èù¢Êùø
                        task.wait(0.3)
                        ShopAdminPanel._showMembershipPanel()
                    end
                end)
            else
                local errorMsg = response and response.message or "Êìç‰ΩúÂ§±Ë¥•"
                print("‚ùå ‰ºöÂëòÁä∂ÊÄÅÂàáÊç¢Â§±Ë¥•:", errorMsg)
                ShopUtils.showNotification("‚ùå " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("‚ùå ManageUserMembership ‰∫ã‰ª∂‰∏çÂ≠òÂú®")
    end
end

-- ËÆæÁΩÆ‰ºöÂëòÂ§©Êï∞
function ShopAdminPanel._setMembershipDays(user, days)
    print("üìÖ [‰ºöÂëòÁÆ°ÁêÜ] ËÆæÁΩÆÁî®Êà∑‰ºöÂëòÂ§©Êï∞:", user.username, days)

    local requestData = {
        userId = tostring(user.user_id),
        playerName = user.username,
        action = "set_days",
        days = days,
        dailyReward = tonumber(user.daily_reward_coins) or 100
    }

    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®ÁÆ°ÁêÜÁî®Êà∑‰ºöÂëòÁä∂ÊÄÅ
    if AdminController then
        AdminController.manageUserMembership(requestData)

        local connection
        connection = AdminController.Events.UserMembershipManaged:Connect(function(success, message, response)
            connection:Disconnect()

            if success and response and response.success then
                local successMsg = response.message or "‰ºöÂëòÂ§©Êï∞ËÆæÁΩÆÊàêÂäü"
                print("‚úÖ", user.username, successMsg)
                ShopUtils.showNotification("‚úÖ " .. user.username .. " " .. successMsg, true, currentScreenGui)

                -- ÂºÇÊ≠•Âà∑Êñ∞Èù¢ÊùøÊï∞ÊçÆÔºåÈÅøÂÖçÈòªÂ°ûÁïåÈù¢
                spawn(function()
                    -- ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂπ∂Âà∑Êñ∞Èù¢Êùø
                    if currentViewingPlayer then
                        -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                        if AdminController then
                            AdminController.getMembershipStatus(currentViewingPlayer)
                        end
                        -- Á≠âÂæÖÊï∞ÊçÆÊõ¥Êñ∞ÁÑ∂ÂêéÂà∑Êñ∞Èù¢Êùø
                        task.wait(0.3)
                        ShopAdminPanel._showMembershipPanel()
                    end
                end)
            else
                local errorMsg = response and response.message or "Êìç‰ΩúÂ§±Ë¥•"
                print("‚ùå ‰ºöÂëòÂ§©Êï∞ËÆæÁΩÆÂ§±Ë¥•:", errorMsg)
                ShopUtils.showNotification("‚ùå " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("‚ùå ManageUserMembership ‰∫ã‰ª∂‰∏çÂ≠òÂú®")
    end
end

-- ËÆæÁΩÆÊØèÊó•Â•ñÂä±
function ShopAdminPanel._setDailyReward(user, reward)
    print("üéÅ [‰ºöÂëòÁÆ°ÁêÜ] ËÆæÁΩÆÁî®Êà∑ÊØèÊó•Â•ñÂä±:", user.username, reward)

    local requestData = {
        userId = tostring(user.user_id),
        playerName = user.username,
        action = "set_reward",
        days = tonumber(user.days_remaining) or 0,
        dailyReward = reward
    }

    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®ÁÆ°ÁêÜÁî®Êà∑‰ºöÂëòÁä∂ÊÄÅ
    if AdminController then
        AdminController.manageUserMembership(requestData)

        local connection
        connection = AdminController.Events.UserMembershipManaged:Connect(function(success, message, response)
            connection:Disconnect()

            if success and response and response.success then
                print("‚úÖ", user.username, "ÊØèÊó•Â•ñÂä±ËÆæÁΩÆÊàêÂäü")
                -- ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆÂπ∂Âà∑Êñ∞Èù¢Êùø
                if currentViewingPlayer then
                    -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                    if AdminController then
                        AdminController.getMembershipStatus(currentViewingPlayer)
                    end
                    -- Á®çÁ≠âÁâáÂàªËÆ©Êï∞ÊçÆÊõ¥Êñ∞ÔºåÁÑ∂ÂêéÂà∑Êñ∞Èù¢Êùø
                    task.wait(0.5)
                    ShopAdminPanel._showMembershipPanel()
                end
            else
                local errorMsg = response and response.message or "Êìç‰ΩúÂ§±Ë¥•"
                print("‚ùå ÊØèÊó•Â•ñÂä±ËÆæÁΩÆÂ§±Ë¥•:", errorMsg)
            end
        end)
    else
        print("‚ùå ManageUserMembership ‰∫ã‰ª∂‰∏çÂ≠òÂú®")
    end
end

-- Âà∑Êñ∞Áé©ÂÆ∂Êï∞ÊçÆ
function ShopAdminPanel._refreshPlayerData()
    print("üîÑ [ÁÆ°ÁêÜÈù¢Êùø] Âà∑Êñ∞Áé©ÂÆ∂Êï∞ÊçÆ")

    if currentTab == "players" then
        -- ÈáçÊñ∞Ëé∑ÂèñÁî®Êà∑ÂàóË°®
        -- ÈÄöËøáÁÆ°ÁêÜÂëòÊéßÂà∂Âô®Âà∑Êñ∞Áî®Êà∑ÂàóË°®
        if AdminController then
            AdminController.getAllUsers()
        end
    elseif currentTab == "membership" then
        -- ÈáçÊñ∞Ëé∑Âèñ‰ºöÂëòÊï∞ÊçÆ
        ShopAdminPanel._showMembershipPanel()
    end
end

return ShopAdminPanel
