-- å•†åº—ç³»ç»Ÿå®¢æˆ·ç«¯é€»è¾‘ - é‡æ„ç‰ˆæœ¬
-- æ•´åˆäº†UserController, AdminController, DroneControlleræ¶æ„

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- è·å–å®¢æˆ·ç«¯æ¨¡å—çš„è¾…åŠ©å‡½æ•°
local function getClientModule(path)
    local playerScripts = player:WaitForChild("PlayerScripts")
    local clientFolder = playerScripts:FindFirstChild("Client")
    if not clientFolder then
        error("âŒ æ‰¾ä¸åˆ°Clientæ–‡ä»¶å¤¹")
    end

    local parts = string.split(path, "/")
    local module = clientFolder
    for _, part in ipairs(parts) do
        module = module:FindFirstChild(part)
        if not module then
            error("âŒ æ‰¾ä¸åˆ°æ¨¡å—è·¯å¾„: " .. path)
        end
    end
    return module
end

-- å¯¼å…¥æ–°æ¶æ„çš„æ§åˆ¶å™¨
local UserController, AdminController, DroneController, TargetController
local success, result = pcall(function()
    UserController = require(getClientModule("controller/UserController"))
    AdminController = require(getClientModule("controller/AdminController"))
    DroneController = require(getClientModule("controller/DroneController"))
    TargetController = require(getClientModule("controller/TargetController"))
    return true
end)

if not success then
    warn("âŒ [å®¢æˆ·ç«¯] æ§åˆ¶å™¨æ¨¡å—åŠ è½½å¤±è´¥:", result)
    warn("âš ï¸ [å®¢æˆ·ç«¯] å°†ä½¿ç”¨ç®€åŒ–æ¨¡å¼å¯åŠ¨")
end

-- å¯¼å…¥UIæ¨¡å—
local ShopUI, TutorialUI, DroneUI, ShopRecords, ShopAdminPanel, TargetUI
local uiSuccess, uiResult = pcall(function()
    ShopUI = require(getClientModule("ui/ShopUI"))
    TutorialUI = require(getClientModule("ui/TutorialUI"))
    DroneUI = require(getClientModule("ui/DroneUI"))
    ShopRecords = require(getClientModule("ui/ShopRecords"))
    ShopAdminPanel = require(getClientModule("ui/ShopAdminPanel"))
    TargetUI = require(getClientModule("ui/TargetUI"))
    return true
end)

if not uiSuccess then
    warn("âŒ [å®¢æˆ·ç«¯] UIæ¨¡å—åŠ è½½å¤±è´¥:", uiResult)
    warn("âš ï¸ [å®¢æˆ·ç«¯] æŸäº›UIåŠŸèƒ½å¯èƒ½ä¸å¯ç”¨")
end

-- UIçŠ¶æ€ç®¡ç†
local uiState = {
    shopVisible = false,
    tutorialVisible = false,
    droneUIVisible = false
}

-- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®
local function waitForServerData()
    print("ğŸ”„ å•†åº—å®¢æˆ·ç«¯åŠ è½½ä¸­...")

    local success, sharedModules = pcall(function()
        local sharedModules = ReplicatedStorage:WaitForChild("SharedModules", 15)
        sharedModules:WaitForChild("ShopEvents", 10)
        return sharedModules
    end)

    if not success or not sharedModules then
        warn("âŒ å®¢æˆ·ç«¯: ç­‰å¾…æœåŠ¡ç«¯æ•°æ®è¶…æ—¶")
        warn("ğŸ’¡ æç¤º: ç¡®ä¿æœåŠ¡ç«¯å·²æ­£ç¡®å¯åŠ¨å¹¶è®¾ç½®äº†å…±äº«æ¨¡å—")
        return false
    end

    print("âœ… å®¢æˆ·ç«¯: æœåŠ¡ç«¯æ•°æ®åŠ è½½æˆåŠŸ")
    return true
end

-- è®¾ç½®æ§åˆ¶å™¨äº‹ä»¶ç»‘å®š
local function setupControllerBindings()
    if not UserController then return end

    -- ç»‘å®šç”¨æˆ·æ•°æ®å˜åŒ–åˆ°UIæ›´æ–°
    UserController.Events.PlayerDataChanged:Connect(function(newData)
        print("ğŸ“Š [å®¢æˆ·ç«¯] ç©å®¶æ•°æ®å·²å˜åŒ–")
        if ShopUI and ShopUI.updatePlayerData then
            ShopUI.updatePlayerData(newData)
        end
    end)

    UserController.Events.ShopDataChanged:Connect(function(newData)
        print("ğŸª [å®¢æˆ·ç«¯] å•†åº—æ•°æ®å·²å˜åŒ–")
        if ShopUI and ShopUI.updateShopData then
            ShopUI.updateShopData(newData)
        end
    end)

    UserController.Events.LoadingStateChanged:Connect(function(isLoading)
        print("â³ [å®¢æˆ·ç«¯] åŠ è½½çŠ¶æ€:", isLoading and "åŠ è½½ä¸­" or "å·²å®Œæˆ")
    end)

    -- ç»‘å®šè´­ä¹°å’Œå‡ºå”®ç»“æœ
    UserController.Events.BuyResult:Connect(function(success, message, newData)
        if success then
            print("âœ… [å®¢æˆ·ç«¯] è´­ä¹°æˆåŠŸ:", message)
        else
            print("âŒ [å®¢æˆ·ç«¯] è´­ä¹°å¤±è´¥:", message)
        end
    end)

    UserController.Events.SellResult:Connect(function(success, message, newData)
        if success then
            print("âœ… [å®¢æˆ·ç«¯] å‡ºå”®æˆåŠŸ:", message)
        else
            print("âŒ [å®¢æˆ·ç«¯] å‡ºå”®å¤±è´¥:", message)
        end
    end)

    print("âœ… æ§åˆ¶å™¨äº‹ä»¶ç»‘å®šå®Œæˆ")
end

-- è®¾ç½®æ— äººæœºæ§åˆ¶å™¨ç»‘å®š
local function setupDroneBindings()
    if not DroneController then return end

    DroneController.Events.DroneStatusChanged:Connect(function(status)
        print("ğŸ¤– [å®¢æˆ·ç«¯] æ— äººæœºçŠ¶æ€å˜åŒ–:", status.isActive and "æ¿€æ´»" or "å¾…å‘½")
        if DroneUI and DroneUI.updateStatus then
            DroneUI.updateStatus(status)
        end
    end)

    DroneController.Events.DroneSpawned:Connect(function(success)
        if success then
            print("âœ… [å®¢æˆ·ç«¯] æ— äººæœºå¬å”¤æˆåŠŸ")
        else
            print("âŒ [å®¢æˆ·ç«¯] æ— äººæœºå¬å”¤å¤±è´¥")
        end
    end)

    print("âœ… æ— äººæœºäº‹ä»¶ç»‘å®šå®Œæˆ")
end

-- UIæ§åˆ¶åŠŸèƒ½
local function toggleShop()
    uiState.shopVisible = not uiState.shopVisible
    if ShopUI then
        if uiState.shopVisible then
            if ShopUI.openShop then
                ShopUI.openShop()
            end
        else
            if ShopUI.closeShop then
                ShopUI.closeShop()
            end
        end
    end
end

local function toggleTutorial()
    uiState.tutorialVisible = not uiState.tutorialVisible
    if TutorialUI then
        if uiState.tutorialVisible then
            if TutorialUI.showTutorial then
                TutorialUI.showTutorial()
            end
        else
            if TutorialUI.hideTutorial then
                TutorialUI.hideTutorial()
            end
        end
    end
end

local function handleDroneAction(action)
    if DroneController then
        DroneController.handleDroneAction(action)
    else
        warn("âš ï¸ [å®¢æˆ·ç«¯] æ— äººæœºæ§åˆ¶å™¨ä¸å¯ç”¨")
    end
end

-- è®¾ç½®é”®ç›˜è¾“å…¥å¤„ç†
local function setupInputHandling()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end

        if input.KeyCode == Enum.KeyCode.E then
            -- Eé”®åˆ‡æ¢å•†åº—æ˜¾ç¤º
            toggleShop()

        elseif input.KeyCode == Enum.KeyCode.H then
            -- Hé”®åˆ‡æ¢æ•™ç¨‹æ˜¾ç¤º
            toggleTutorial()

        elseif input.KeyCode == Enum.KeyCode.B then
            -- Bé”®å¬å”¤æ— äººæœº
            handleDroneAction("spawn")

        elseif input.KeyCode == Enum.KeyCode.N then
            -- Né”®æ”¶å›æ— äººæœº
            handleDroneAction("recall")

        elseif input.KeyCode == Enum.KeyCode.M then
            -- Mé”®åˆ‡æ¢æ— äººæœºæ¨¡å¼
            handleDroneAction("switch_mode")
        end
    end)

    print("âœ… é”®ç›˜è¾“å…¥å¤„ç†è®¾ç½®å®Œæˆ")
end

-- åˆå§‹åŒ–æ§åˆ¶å™¨
local function initializeControllers()
    local initSuccess = true

    -- åˆå§‹åŒ–UserController
    if UserController and UserController.initialize then
        local success, error = pcall(function()
            UserController.initialize()
        end)
        if not success then
            warn("âŒ [å®¢æˆ·ç«¯] UserControlleråˆå§‹åŒ–å¤±è´¥:", error)
            initSuccess = false
        else
            print("âœ… [å®¢æˆ·ç«¯] UserControlleråˆå§‹åŒ–æˆåŠŸ")
        end
    end

    -- åˆå§‹åŒ–AdminController
    if AdminController and AdminController.initialize then
        local success, error = pcall(function()
            AdminController.initialize()
        end)
        if not success then
            warn("âŒ [å®¢æˆ·ç«¯] AdminControlleråˆå§‹åŒ–å¤±è´¥:", error)
        else
            print("âœ… [å®¢æˆ·ç«¯] AdminControlleråˆå§‹åŒ–æˆåŠŸ")
        end
    end

    -- åˆå§‹åŒ–DroneController
    if DroneController and DroneController.initialize then
        local success, error = pcall(function()
            DroneController.initialize()
        end)
        if not success then
            warn("âŒ [å®¢æˆ·ç«¯] DroneControlleråˆå§‹åŒ–å¤±è´¥:", error)
        else
            print("âœ… [å®¢æˆ·ç«¯] DroneControlleråˆå§‹åŒ–æˆåŠŸ")
        end
    end

    -- åˆå§‹åŒ–TargetController
    if TargetController and TargetController.initialize then
        local success, error = pcall(function()
            TargetController.initialize()
        end)
        if not success then
            warn("âŒ [å®¢æˆ·ç«¯] TargetControlleråˆå§‹åŒ–å¤±è´¥:", error)
            initSuccess = false
        else
            print("âœ… [å®¢æˆ·ç«¯] TargetControlleråˆå§‹åŒ–æˆåŠŸ")
        end
    end

    return initSuccess
end

-- åˆå§‹åŒ–UIæ¨¡å—
local function initializeUI()
    -- åˆå§‹åŒ–ShopUIï¼ˆä½¿ç”¨æ–°çš„æ§åˆ¶å™¨æ¶æ„ï¼‰
    if ShopUI and ShopUI.initWithControllers then
        local shopSuccess, shopError = pcall(function()
            ShopUI.initWithControllers(UserController, AdminController)
        end)
        if shopSuccess then
            print("âœ… [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–æˆåŠŸ")
        else
            warn("âŒ [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–å¤±è´¥:", shopError)
        end
    elseif ShopUI and ShopUI.init then
        -- åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„åˆå§‹åŒ–æ–¹æ³•
        local shopSuccess, shopError = pcall(function()
            ShopUI.init()
        end)
        if shopSuccess then
            print("âœ… [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–æˆåŠŸï¼ˆä½¿ç”¨å…¼å®¹æ¨¡å¼ï¼‰")
        else
            warn("âŒ [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–å¤±è´¥:", shopError)
        end
    end

    -- ä¸ºå…¶ä»–UIæ¨¡å—è®¾ç½®æ§åˆ¶å™¨
    if ShopRecords and ShopRecords.setControllers then
        pcall(function()
            ShopRecords.setControllers(UserController, AdminController)
        end)
    end

    if ShopAdminPanel and ShopAdminPanel.setControllers then
        pcall(function()
            ShopAdminPanel.setControllers(AdminController)
        end)
    end

    if DroneUI and DroneUI.setControllers then
        pcall(function()
            DroneUI.setControllers(DroneController)
        end)
    end

    if TutorialUI and TutorialUI.setControllers then
        pcall(function()
            TutorialUI.setControllers()
        end)
    end

    -- åˆå§‹åŒ–TutorialUI
    if TutorialUI and TutorialUI.initialize then
        local tutSuccess, tutError = pcall(function()
            TutorialUI.initialize()
        end)
        if not tutSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] TutorialUIåˆå§‹åŒ–å¤±è´¥:", tutError)
        else
            print("âœ… [å®¢æˆ·ç«¯] TutorialUIåˆå§‹åŒ–æˆåŠŸ")
        end
    end

    -- åˆå§‹åŒ–TargetUI
    if TargetUI and TargetUI.initialize then
        local targetSuccess, targetError = pcall(function()
            TargetUI.initialize()
        end)
        if not targetSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] TargetUIåˆå§‹åŒ–å¤±è´¥:", targetError)
        else
            print("âœ… [å®¢æˆ·ç«¯] TargetUIåˆå§‹åŒ–æˆåŠŸ")
        end
    end

    -- åˆå§‹åŒ–DroneUIï¼ˆä½¿ç”¨æ§åˆ¶å™¨è¿æ¥ï¼‰
    if DroneUI and DroneController then
        if DroneUI.initWithController then
            local droneSuccess, droneError = pcall(function()
                DroneUI.initWithController(DroneController)
            end)
            if not droneSuccess then
                warn("âŒ [å®¢æˆ·ç«¯] DroneUIåˆå§‹åŒ–å¤±è´¥:", droneError)
            else
                print("âœ… [å®¢æˆ·ç«¯] DroneUIåˆå§‹åŒ–æˆåŠŸ")
            end
        elseif DroneUI.init then
            -- åå¤‡æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šåˆå§‹åŒ–
            local droneSuccess, droneError = pcall(function()
                DroneUI.init()
                if DroneUI.setDroneController then
                    DroneUI.setDroneController(DroneController)
                end
            end)
            if not droneSuccess then
                warn("âŒ [å®¢æˆ·ç«¯] DroneUIåˆå§‹åŒ–å¤±è´¥:", droneError)
            else
                print("âœ… [å®¢æˆ·ç«¯] DroneUIåˆå§‹åŒ–æˆåŠŸ")
            end
        end
    end
end

-- åŠ è½½åˆå§‹æ•°æ®
local function loadInitialData()
    if UserController and UserController.loadInitialData then
        local dataSuccess, dataError = pcall(function()
            UserController.loadInitialData()
        end)
        if not dataSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:", dataError)
        else
            print("âœ… [å®¢æˆ·ç«¯] åˆå§‹æ•°æ®åŠ è½½æˆåŠŸ")
        end
    end
end

-- åˆå§‹åŒ–å®¢æˆ·ç«¯
local function initializeClient()
    -- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®åŠ è½½
    if not waitForServerData() then
        warn("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: æ— æ³•è·å–æœåŠ¡ç«¯æ•°æ®")
        return
    end

    -- åˆå§‹åŒ–æ§åˆ¶å™¨
    if not initializeControllers() then
        warn("âš ï¸ [å®¢æˆ·ç«¯] éƒ¨åˆ†æ§åˆ¶å™¨åˆå§‹åŒ–å¤±è´¥")
    end

    -- è®¾ç½®æ§åˆ¶å™¨äº‹ä»¶ç»‘å®š
    local bindingSuccess, bindingError = pcall(function()
        setupControllerBindings()
        setupDroneBindings()
    end)
    if not bindingSuccess then
        warn("âŒ [å®¢æˆ·ç«¯] æ§åˆ¶å™¨ç»‘å®šè®¾ç½®å¤±è´¥:", bindingError)
    end

    -- åˆå§‹åŒ–UIæ¨¡å—
    local uiInitSuccess, uiInitError = pcall(function()
        initializeUI()
    end)
    if not uiInitSuccess then
        warn("âŒ [å®¢æˆ·ç«¯] UIåˆå§‹åŒ–å¤±è´¥:", uiInitError)
    end

    -- è®¾ç½®é”®ç›˜è¾“å…¥å¤„ç†
    local inputSuccess, inputError = pcall(function()
        setupInputHandling()
    end)
    if not inputSuccess then
        warn("âŒ [å®¢æˆ·ç«¯] é”®ç›˜è¾“å…¥å¤„ç†è®¾ç½®å¤±è´¥:", inputError)
    end

    -- åŠ è½½åˆå§‹æ•°æ®
    local dataLoadSuccess, dataLoadError = pcall(function()
        loadInitialData()
    end)
    if not dataLoadSuccess then
        warn("âŒ [å®¢æˆ·ç«¯] åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:", dataLoadError)
    end

    print("âœ… å•†åº—ç³»ç»Ÿå·²å°±ç»ªï¼")
    print("âŒ¨ï¸  æŒ‰ E é”®æ‰“å¼€/å…³é—­å•†åº—")
    if TutorialUI then
        print("âŒ¨ï¸  æŒ‰ H é”®æ‰“å¼€/å…³é—­å¸®åŠ©")
    end
    if DroneController then
        print("ğŸ¤– æŒ‰ B é”®å¬å”¤æ— äººæœº")
        print("ğŸ¤– æŒ‰ N é”®æ”¶å›æ— äººæœº")
        print("ğŸ¤– æŒ‰ M é”®åˆ‡æ¢æ— äººæœºæ¨¡å¼")
    end
end

-- å¯åŠ¨å®¢æˆ·ç«¯
initializeClient()