-- å•†åº—ç³»ç»Ÿå®¢æˆ·ç«¯é€»è¾‘

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®
local function waitForServerData()
    print("ğŸ”„ å•†åº—å®¢æˆ·ç«¯åŠ è½½ä¸­...")

    local success, data = pcall(function()
        local sharedModules = ReplicatedStorage:WaitForChild("SharedModules", 15)
        sharedModules:WaitForChild("ShopData", 5)
        sharedModules:WaitForChild("ShopEvents", 5)
        return sharedModules
    end)

    if not success then
        warn("âŒ å®¢æˆ·ç«¯: ç­‰å¾…æœåŠ¡ç«¯æ•°æ®è¶…æ—¶")
        return false
    end

    return true
end

-- åˆå§‹åŒ–å®¢æˆ·ç«¯
local function initializeClient()
    -- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®åŠ è½½
    if not waitForServerData() then
        warn("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: æ— æ³•è·å–æœåŠ¡ç«¯æ•°æ®")
        return
    end

    -- å¯¼å…¥å…±äº«æ¨¡å—ï¼ˆç”±å„å­æ¨¡å—ä½¿ç”¨ï¼Œè¿™é‡Œåªæ˜¯é¢„åŠ è½½ï¼‰
    require(ReplicatedStorage.SharedModules.ShopData)
    require(ReplicatedStorage.SharedModules.ShopEvents)

    -- å¯¼å…¥å•†åº—UI
    local ShopUI = require(script.user:WaitForChild("ShopUI"))
    local TutorialUI = require(script.user:WaitForChild("TutorialUI"))
    local DroneManager = require(script.user:WaitForChild("DroneManager"))

    -- åˆå§‹åŒ–å•†åº—UI
    ShopUI.init()

    -- åˆå§‹åŒ–æ•™ç¨‹UIï¼ˆä¸å¯ç”¨é”®ç›˜ç›‘å¬ï¼‰
    TutorialUI.initialize()

    -- åˆå§‹åŒ–æ— äººæœºç®¡ç†å™¨
    DroneManager.init()

    -- ç»Ÿä¸€é”®ç›˜è¾“å…¥å¤„ç†
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end

        if input.KeyCode == Enum.KeyCode.H then
            -- Hé”®ä¼˜å…ˆå¤„ç†æ•™ç¨‹UI
            if TutorialUI.isShowing() then
                TutorialUI.hideTutorial()
            else
                -- å¦‚æœæ•™ç¨‹æœªæ˜¾ç¤ºï¼Œåˆ™æ˜¾ç¤ºæ•™ç¨‹
                TutorialUI.showTutorial()
            end
        end
    end)

    print("âœ… å•†åº—ç³»ç»Ÿå·²å°±ç»ªï¼")
    print("âŒ¨ï¸  æŒ‰ E é”®æ‰“å¼€/å…³é—­å•†åº—")
    print("âŒ¨ï¸  æŒ‰ H é”®æ‰“å¼€/å…³é—­å¸®åŠ©")
    print("ğŸ¤– æŒ‰ B é”®å¬å”¤æ— äººæœº")
    print("ğŸ¤– æŒ‰ N é”®æ”¶å›æ— äººæœº")
    print("ğŸ¤– æŒ‰ M é”®åˆ‡æ¢æ— äººæœºæ¨¡å¼")
end

-- å¯åŠ¨å®¢æˆ·ç«¯
initializeClient()