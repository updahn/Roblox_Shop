-- å•†åº—ç³»ç»Ÿå®¢æˆ·ç«¯é€»è¾‘ - æ–°æ¶æ„ç‰ˆæœ¬

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- è·å–å®¢æˆ·ç«¯æ¨¡å—çš„è¾…åŠ©å‡½æ•°
local function getClientModule(path)
    local playerScripts = player:WaitForChild("PlayerScripts")
    local clientFolder = playerScripts:FindFirstChild("Client")
    if not clientFolder then
        error("âŒ æ‰¾ä¸åˆ°Clientæ–‡ä»¶å¤¹")
    end

    local parts = string.split(path, "/")
    local module = clientFolder
    for _, part in ipairs(parts) do
        module = module:FindFirstChild(part)
        if not module then
            error("âŒ æ‰¾ä¸åˆ°æ¨¡å—è·¯å¾„: " .. path)
        end
    end
    return module
end

-- å¯¼å…¥æ–°æ¶æ„çš„æ¨¡å—
local ClientServiceCoordinator, UIController, DataController
local success, result = pcall(function()
    ClientServiceCoordinator = require(getClientModule("controller/ClientServiceCoordinator"))
    UIController = require(getClientModule("controller/UIController"))
    DataController = require(getClientModule("controller/DataController"))
    return true
end)

if not success then
    warn("âŒ [å®¢æˆ·ç«¯] æ§åˆ¶å™¨æ¨¡å—åŠ è½½å¤±è´¥:", result)
    warn("âš ï¸ [å®¢æˆ·ç«¯] å°†ä½¿ç”¨ç®€åŒ–æ¨¡å¼å¯åŠ¨")
end

-- å¯¼å…¥UIæ¨¡å—
local ShopUI, TutorialUI, DroneManager
local uiSuccess, uiResult = pcall(function()
    ShopUI = require(getClientModule("ui/ShopUI"))
    TutorialUI = require(getClientModule("ui/TutorialUI"))
    DroneManager = require(getClientModule("ui/DroneManager"))
    return true
end)

if not uiSuccess then
    warn("âŒ [å®¢æˆ·ç«¯] UIæ¨¡å—åŠ è½½å¤±è´¥:", uiResult)
    warn("âš ï¸ [å®¢æˆ·ç«¯] æŸäº›UIåŠŸèƒ½å¯èƒ½ä¸å¯ç”¨")
end

-- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®
local function waitForServerData()
    print("ğŸ”„ å•†åº—å®¢æˆ·ç«¯åŠ è½½ä¸­...")

    local success, sharedModules = pcall(function()
        local sharedModules = ReplicatedStorage:WaitForChild("SharedModules", 15)
        sharedModules:WaitForChild("ShopEvents", 10)
        return sharedModules
    end)

    if not success or not sharedModules then
        warn("âŒ å®¢æˆ·ç«¯: ç­‰å¾…æœåŠ¡ç«¯æ•°æ®è¶…æ—¶")
        warn("ğŸ’¡ æç¤º: ç¡®ä¿æœåŠ¡ç«¯å·²æ­£ç¡®å¯åŠ¨å¹¶è®¾ç½®äº†å…±äº«æ¨¡å—")
        return false
    end

    print("âœ… å®¢æˆ·ç«¯: æœåŠ¡ç«¯æ•°æ®åŠ è½½æˆåŠŸ")
    return true
end

-- è®¾ç½®UIäº‹ä»¶ç»‘å®š
local function setupUIBindings()
    -- ç»‘å®šUIæ˜¾ç¤º/éšè—äº‹ä»¶åˆ°å®é™…çš„UIæ¨¡å—
    UIController.Events.ShopVisibilityChanged:Connect(function(visible)
        if ShopUI.setVisible then
            ShopUI.setVisible(visible)
        end
    end)

    UIController.Events.TutorialVisibilityChanged:Connect(function(visible)
        if visible then
            if TutorialUI.showTutorial then
                TutorialUI.showTutorial()
            end
        else
            if TutorialUI.hideTutorial then
                TutorialUI.hideTutorial()
            end
        end
    end)

    -- ç»‘å®šæ•°æ®å˜åŒ–äº‹ä»¶åˆ°UIæ›´æ–°
    DataController.Events.PlayerDataChanged:Connect(function(newData)
        if ShopUI.updatePlayerData then
            ShopUI.updatePlayerData(newData)
        end
    end)

    DataController.Events.ShopDataChanged:Connect(function(newData)
        if ShopUI.updateShopData then
            ShopUI.updateShopData(newData)
        end
    end)

    print("âœ… UIäº‹ä»¶ç»‘å®šå®Œæˆ")
end

-- è®¾ç½®é”®ç›˜è¾“å…¥å¤„ç†
local function setupInputHandling()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end

        if input.KeyCode == Enum.KeyCode.E then
            -- Eé”®åˆ‡æ¢å•†åº—æ˜¾ç¤º
            UIController.toggleShop()

        elseif input.KeyCode == Enum.KeyCode.H then
            -- Hé”®åˆ‡æ¢æ•™ç¨‹æ˜¾ç¤º
            UIController.toggleTutorial()

        elseif input.KeyCode == Enum.KeyCode.B then
            -- Bé”®å¬å”¤æ— äººæœº
            UIController.triggerDroneAction("spawn")

        elseif input.KeyCode == Enum.KeyCode.N then
            -- Né”®æ”¶å›æ— äººæœº
            UIController.triggerDroneAction("recall")

        elseif input.KeyCode == Enum.KeyCode.M then
            -- Mé”®åˆ‡æ¢æ— äººæœºæ¨¡å¼
            UIController.triggerDroneAction("switch_mode")
        end
    end)

    print("âœ… é”®ç›˜è¾“å…¥å¤„ç†è®¾ç½®å®Œæˆ")
end

-- åˆå§‹åŒ–å®¢æˆ·ç«¯
local function initializeClient()
    -- ç­‰å¾…æœåŠ¡ç«¯æ•°æ®åŠ è½½
    if not waitForServerData() then
        warn("âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥: æ— æ³•è·å–æœåŠ¡ç«¯æ•°æ®")
        return
    end

    -- åˆå§‹åŒ–æœåŠ¡åè°ƒå™¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if ClientServiceCoordinator and ClientServiceCoordinator.initialize then
        local coordSuccess, coordError = pcall(function()
            ClientServiceCoordinator.initialize()
        end)
        if not coordSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] æœåŠ¡åè°ƒå™¨åˆå§‹åŒ–å¤±è´¥:", coordError)
        end
    end

    -- åˆå§‹åŒ–UIæ¨¡å—ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰
    if ShopUI and ShopUI.init then
        local shopSuccess, shopError = pcall(function()
            ShopUI.init()
        end)
        if shopSuccess then
            print("âœ… [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–æˆåŠŸ")
        else
            warn("âŒ [å®¢æˆ·ç«¯] ShopUIåˆå§‹åŒ–å¤±è´¥:", shopError)
        end
    end

    if TutorialUI and TutorialUI.initialize then
        local tutSuccess, tutError = pcall(function()
            TutorialUI.initialize()
        end)
        if not tutSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] TutorialUIåˆå§‹åŒ–å¤±è´¥:", tutError)
        end
    end

    if DroneManager and DroneManager.init then
        local droneSuccess, droneError = pcall(function()
            DroneManager.init()
        end)
        if not droneSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] DroneManageråˆå§‹åŒ–å¤±è´¥:", droneError)
        end
    end

    -- è®¾ç½®UIç»‘å®šï¼ˆå¦‚æœæ¨¡å—å¯ç”¨ï¼‰
    if UIController and DataController then
        local bindingSuccess, bindingError = pcall(function()
            setupUIBindings()
        end)
        if not bindingSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] UIç»‘å®šè®¾ç½®å¤±è´¥:", bindingError)
        end
    end

    -- è®¾ç½®é”®ç›˜è¾“å…¥å¤„ç†
    local inputSuccess, inputError = pcall(function()
        setupInputHandling()
    end)
    if not inputSuccess then
        warn("âŒ [å®¢æˆ·ç«¯] é”®ç›˜è¾“å…¥å¤„ç†è®¾ç½®å¤±è´¥:", inputError)
    end

    -- åŠ è½½åˆå§‹æ•°æ®ï¼ˆå¦‚æœåè°ƒå™¨å¯ç”¨ï¼‰
    if ClientServiceCoordinator and ClientServiceCoordinator.loadInitialData then
        local dataSuccess, dataError = pcall(function()
            ClientServiceCoordinator.loadInitialData()
        end)
        if not dataSuccess then
            warn("âŒ [å®¢æˆ·ç«¯] åˆå§‹æ•°æ®åŠ è½½å¤±è´¥:", dataError)
        end
    end

    print("âœ… å•†åº—ç³»ç»Ÿå·²å°±ç»ªï¼")
    print("âŒ¨ï¸  æŒ‰ E é”®æ‰“å¼€/å…³é—­å•†åº—")
    if TutorialUI then
        print("âŒ¨ï¸  æŒ‰ H é”®æ‰“å¼€/å…³é—­å¸®åŠ©")
    end
    if DroneManager then
        print("ğŸ¤– æŒ‰ B é”®å¬å”¤æ— äººæœº")
        print("ğŸ¤– æŒ‰ N é”®æ”¶å›æ— äººæœº")
        print("ğŸ¤– æŒ‰ M é”®åˆ‡æ¢æ— äººæœºæ¨¡å¼")
    end
end

-- å¯åŠ¨å®¢æˆ·ç«¯
initializeClient()