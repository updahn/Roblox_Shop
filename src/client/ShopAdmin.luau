-- ÂïÜÂ∫óÁÆ°ÁêÜÂëòÁïåÈù¢Ê®°Âùó

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Á≠âÂæÖÂÖ±‰∫´Ê®°Âùó
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))
local ShopUtils = require(script.Parent:WaitForChild("ShopUtils"))

local player = Players.LocalPlayer

local ShopAdmin = {}

-- ÊòæÁ§∫ÁÆ°ÁêÜÂëòÈù¢Êùø
function ShopAdmin.showAdminPanel(screenGui, showNotification)
    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê
    if not Config.isValidAdmin(player) then
        if showNotification then
            showNotification("‚ùå ÊÇ®Ê≤°ÊúâÁÆ°ÁêÜÂëòÊùÉÈôê", false)
        end
        return
    end

    -- ÂàõÂª∫ÁÆ°ÁêÜÂëòÈù¢Êùø
    local adminFrame = Instance.new("Frame")
    adminFrame.Name = "AdminPanel"
    adminFrame.Size = UDim2.new(0, 800, 0, 600)
    adminFrame.Position = UDim2.new(0.5, -400, 0.5, -300)
    adminFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    adminFrame.BorderSizePixel = 0
    adminFrame.ZIndex = 3000
    adminFrame.Parent = screenGui
    ShopUtils.createCorner(adminFrame, 12)

    -- ËÉåÊôØÈÅÆÁΩ©
    local overlay = Instance.new("Frame")
    overlay.Name = "Overlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = ShopUtils.COLORS.OVERLAY
    overlay.BackgroundTransparency = 0.3
    overlay.BorderSizePixel = 0
    overlay.ZIndex = 2999
    overlay.Parent = screenGui

    -- Ê†áÈ¢òÊ†è
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 60)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = adminFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "üëë ÁÆ°ÁêÜÂëòÊéßÂà∂Èù¢Êùø"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 20
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -100, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- ÂÖ≥Èó≠ÊåâÈíÆ
    local closeBtn = ShopUtils.createButton("‚úó", ShopUtils.COLORS.ERROR, titleBar, function()
        adminFrame:Destroy()
        overlay:Destroy()
    end)
    closeBtn.Position = UDim2.new(1, -50, 0, 10)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 20

    -- ÂÜÖÂÆπÂå∫Âüü
    local contentArea = Instance.new("ScrollingFrame")
    contentArea.Name = "ContentArea"
    contentArea.Size = UDim2.new(1, -20, 1, -80)
    contentArea.Position = UDim2.new(0, 10, 0, 70)
    contentArea.BackgroundTransparency = 1
    contentArea.BorderSizePixel = 0
    contentArea.ScrollBarThickness = 8
    contentArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    contentArea.Parent = adminFrame

    -- ËØ∑Ê±ÇÊâÄÊúâÁé©ÂÆ∂Êï∞ÊçÆ
    ShopEvents.RemoteEvents.GetAllPlayersData:FireServer()

    -- ÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "üì° Ê≠£Âú®Âä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ..."
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 16
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 100)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.Parent = contentArea

    -- ÁõëÂê¨ÊúçÂä°Âô®ÂìçÂ∫î
    local connection
    connection = ShopEvents.RemoteEvents.GetAllPlayersData.OnClientEvent:Connect(function(allPlayersData, errorMsg)
        connection:Disconnect()
        loadingLabel:Destroy()

        if errorMsg then
            -- ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
            showNotification("‚ùå " .. errorMsg)
        elseif allPlayersData then
            ShopAdmin.displayAllPlayersData(contentArea, allPlayersData, showNotification)
        else
            showNotification("‚ùå Êó†Ê≥ïÂä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ")
        end
    end)
end

-- ÊòæÁ§∫ÊâÄÊúâÁé©ÂÆ∂Êï∞ÊçÆ
function ShopAdmin.displayAllPlayersData(parentFrame, allPlayersData, showNotification)
    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê
    if not Config.isValidAdmin(player) then
        return
    end

    local yPos = 10

    for playerName, data in pairs(allPlayersData) do
        -- Áé©ÂÆ∂Âç°Áâá
        local playerCard = Instance.new("Frame")
        playerCard.Name = "PlayerCard_" .. playerName
        playerCard.Size = UDim2.new(1, -20, 0, 120)
        playerCard.Position = UDim2.new(0, 10, 0, yPos)
        playerCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        playerCard.BorderSizePixel = 0
        playerCard.Parent = parentFrame
        ShopUtils.createCorner(playerCard, 8)

        -- Áé©ÂÆ∂‰ø°ÊÅØ
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = "üë§ " .. playerName .. " (ID: " .. data.userId .. ")"
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 16
        nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        nameLabel.Size = UDim2.new(0.4, 0, 0, 25)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = playerCard

        -- ÈáëÂ∏ÅÊòæÁ§∫Âíå‰øÆÊîπ
        local coinsLabel = Instance.new("TextLabel")
        coinsLabel.Text = "üí∞ " .. data.coins .. " ÈáëÂ∏Å"
        coinsLabel.Font = Enum.Font.SourceSans
        coinsLabel.TextSize = 14
        coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
        coinsLabel.Size = UDim2.new(0.2, 0, 0, 20)
        coinsLabel.Position = UDim2.new(0, 10, 0, 30)
        coinsLabel.BackgroundTransparency = 1
        coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
        coinsLabel.Parent = playerCard

        -- ÈáëÂ∏Å‰øÆÊîπËæìÂÖ•Ê°Ü
        local coinsInput = Instance.new("TextBox")
        coinsInput.Text = tostring(data.coins)
        coinsInput.Font = Enum.Font.SourceSans
        coinsInput.TextSize = 12
        coinsInput.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        coinsInput.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
        coinsInput.Size = UDim2.new(0, 80, 0, 25)
        coinsInput.Position = UDim2.new(0, 10, 0, 55)
        coinsInput.PlaceholderText = "Êñ∞ÈáëÂ∏ÅÊï∞"
        coinsInput.Parent = playerCard
        ShopUtils.createCorner(coinsInput, 4)

        -- ËÆæÁΩÆÈáëÂ∏ÅÊåâÈíÆ
        local setCoinsBtn = ShopUtils.createButton("ËÆæÁΩÆ", ShopUtils.COLORS.SUCCESS, playerCard, function()
            local newCoins = tonumber(coinsInput.Text)
            if newCoins and newCoins >= 0 and newCoins <= 999999 then
                ShopEvents.RemoteEvents.SetPlayerCoins:FireServer(playerName, newCoins)
            else
                showNotification("‚ùå ÈáëÂ∏ÅÊï∞ÈáèÂøÖÈ°ªÂú® 0-999999 ‰πãÈó¥", false)
            end
        end)
        setCoinsBtn.Position = UDim2.new(0, 100, 0, 55)
        setCoinsBtn.Size = UDim2.new(0, 60, 0, 25)
        setCoinsBtn.TextSize = 12

        -- Êü•ÁúãËÆ∞ÂΩïÊåâÈíÆ
        local viewRecordsBtn = ShopUtils.createButton("Êü•ÁúãËÆ∞ÂΩï", ShopUtils.COLORS.ACCENT, playerCard, function()
            ShopEvents.RemoteEvents.GetPlayerPurchaseHistory:FireServer(playerName)
        end)
        viewRecordsBtn.Position = UDim2.new(0, 170, 0, 55)
        viewRecordsBtn.Size = UDim2.new(0, 80, 0, 25)
        viewRecordsBtn.TextSize = 12

        -- ÁªüËÆ°‰ø°ÊÅØ
        local statsText = string.format(
            "üìä Ë¥≠‰π∞: %dÊ¨° | Ê∂àË¥π: %dÈáëÂ∏Å | ÂçñÂá∫: %dÊ¨° | Êî∂ÂÖ•: %dÈáëÂ∏Å | Â∫ìÂ≠ò: %d‰ª∂",
            data.totalPurchases, data.totalSpent, data.totalSales, data.totalEarned, data.inventoryCount
        )
        local statsLabel = Instance.new("TextLabel")
        statsLabel.Text = statsText
        statsLabel.Font = Enum.Font.SourceSans
        statsLabel.TextSize = 12
        statsLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        statsLabel.Size = UDim2.new(1, -20, 0, 30)
        statsLabel.Position = UDim2.new(0, 10, 0, 85)
        statsLabel.BackgroundTransparency = 1
        statsLabel.TextXAlignment = Enum.TextXAlignment.Left
        statsLabel.TextWrapped = true
        statsLabel.Parent = playerCard

        yPos = yPos + 130
    end

    parentFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- ÊòæÁ§∫ÂÖ∂‰ªñÁé©ÂÆ∂ÁöÑË¥≠‰π∞ËÆ∞ÂΩï
function ShopAdmin.showPlayerRecords(playerName, records, screenGui)
    -- Ê£ÄÊü•ÁÆ°ÁêÜÂëòÊùÉÈôê
    if not Config.isValidAdmin(player) then
        return
    end

    -- ÂàõÂª∫ËÆ∞ÂΩïÊü•ÁúãÁ™óÂè£
    local recordFrame = Instance.new("Frame")
    recordFrame.Name = "PlayerRecordFrame"
    recordFrame.Size = UDim2.new(0, 600, 0, 500)
    recordFrame.Position = UDim2.new(0.5, -300, 0.5, -250)
    recordFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    recordFrame.BorderSizePixel = 0
    recordFrame.ZIndex = 3100
    recordFrame.Parent = screenGui
    ShopUtils.createCorner(recordFrame, 12)

    -- ËÉåÊôØÈÅÆÁΩ©
    local overlay = Instance.new("Frame")
    overlay.Name = "RecordOverlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = ShopUtils.COLORS.OVERLAY
    overlay.BackgroundTransparency = 0.3
    overlay.BorderSizePixel = 0
    overlay.ZIndex = 3099
    overlay.Parent = screenGui

    -- Ê†áÈ¢òÊ†è
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 50)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = recordFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "üìä " .. playerName .. " ÁöÑ‰∫§ÊòìËÆ∞ÂΩï"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 18
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -50, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- ÂÖ≥Èó≠ÊåâÈíÆ
    local closeBtn = ShopUtils.createButton("‚úó", ShopUtils.COLORS.ERROR, titleBar, function()
        recordFrame:Destroy()
        overlay:Destroy()
    end)
    closeBtn.Position = UDim2.new(1, -45, 0, 5)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 18

    -- ËÆ∞ÂΩïÊªöÂä®Âå∫Âüü
    local scrollArea = Instance.new("ScrollingFrame")
    scrollArea.Name = "ScrollArea"
    scrollArea.Size = UDim2.new(1, -20, 1, -70)
    scrollArea.Position = UDim2.new(0, 10, 0, 60)
    scrollArea.BackgroundTransparency = 1
    scrollArea.BorderSizePixel = 0
    scrollArea.ScrollBarThickness = 8
    scrollArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    scrollArea.Parent = recordFrame

    -- ÊòæÁ§∫ËÆ∞ÂΩï
    local yPos = 10
    if records and #records > 0 then
        for i, record in ipairs(records) do
            local recordCard = Instance.new("Frame")
            recordCard.Name = "Record" .. i
            recordCard.Size = UDim2.new(1, -20, 0, 80)
            recordCard.Position = UDim2.new(0, 10, 0, yPos)
            recordCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
            recordCard.BorderSizePixel = 0
            recordCard.Parent = scrollArea
            ShopUtils.createCorner(recordCard, 8)

            -- Êó∂Èó¥Êà≥
            local timeLabel = Instance.new("TextLabel")
            timeLabel.Text = ShopUtils.formatTimestamp(record.timestamp)
            timeLabel.Font = Enum.Font.SourceSans
            timeLabel.TextSize = 11
            timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
            timeLabel.Size = UDim2.new(1, -10, 0, 15)
            timeLabel.Position = UDim2.new(0, 5, 0, 5)
            timeLabel.BackgroundTransparency = 1
            timeLabel.TextXAlignment = Enum.TextXAlignment.Left
            timeLabel.Parent = recordCard

            -- ‰∫§ÊòìÁ±ªÂûãÂíåÁâ©ÂìÅ
            local actionLabel = Instance.new("TextLabel")
            local actionText = ""
            if record.action == "buy" then
                actionText = "üõí Ë¥≠‰π∞ " .. (record.itemName or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
            elseif record.action == "sell" then
                actionText = "üí∞ ÂçñÂá∫ " .. (record.itemName or "Êú™Áü•Áâ©ÂìÅ") .. " x" .. (record.quantity or 1)
            elseif record.action == "admin_edit" then
                actionText = "‰øÆÊîπ ÁÆ°ÁêÜÂëòÈáëÂ∏ÅË∞ÉÊï¥x" .. (record.quantity or 1)
            end
            actionLabel.Text = actionText
            actionLabel.Font = Enum.Font.SourceSansBold
            actionLabel.TextSize = 14
            actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
            actionLabel.Size = UDim2.new(0.7, 0, 0, 25)
            actionLabel.Position = UDim2.new(0, 5, 0, 25)
            actionLabel.BackgroundTransparency = 1
            actionLabel.TextXAlignment = Enum.TextXAlignment.Left
            actionLabel.Parent = recordCard

            -- ÈáëÈ¢ù
            local amountLabel = Instance.new("TextLabel")
            local amountText = ""
            local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
            if record.action == "buy" then
                amountText = "-" .. (record.totalCost or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.ERROR
            elseif record.action == "sell" then
                amountText = "+" .. (record.totalEarned or 0) .. " ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.action == "admin_edit" then
                amountText = "now" .. (record.balanceAfter or 0) .. "ÈáëÂ∏Å"
                amountColor = ShopUtils.COLORS.TEXT_PRIMARY
            end
            amountLabel.Text = amountText
            amountLabel.Font = Enum.Font.SourceSansBold
            amountLabel.TextSize = 13
            amountLabel.TextColor3 = amountColor
            amountLabel.Size = UDim2.new(0.25, 0, 0, 20)
            amountLabel.Position = UDim2.new(0.75, 0, 0, 30)
            amountLabel.BackgroundTransparency = 1
            amountLabel.TextXAlignment = Enum.TextXAlignment.Right
            amountLabel.Parent = recordCard

            -- ‰ΩôÈ¢ù
            local balanceLabel = Instance.new("TextLabel")
            balanceLabel.Text = "‰ΩôÈ¢ù: " .. (record.balanceAfter or 0)
            balanceLabel.Font = Enum.Font.SourceSans
            balanceLabel.TextSize = 11
            balanceLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
            balanceLabel.Size = UDim2.new(1, -10, 0, 15)
            balanceLabel.Position = UDim2.new(0, 5, 0, 60)
            balanceLabel.BackgroundTransparency = 1
            balanceLabel.TextXAlignment = Enum.TextXAlignment.Left
            balanceLabel.Parent = recordCard

            yPos = yPos + 90
        end
    else
        -- Êó†ËÆ∞ÂΩïÊèêÁ§∫
        local noRecordLabel = Instance.new("TextLabel")
        noRecordLabel.Text = "üìù ËØ•Áé©ÂÆ∂ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï"
        noRecordLabel.Font = Enum.Font.SourceSans
        noRecordLabel.TextSize = 16
        noRecordLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        noRecordLabel.Size = UDim2.new(1, 0, 0, 100)
        noRecordLabel.BackgroundTransparency = 1
        noRecordLabel.TextXAlignment = Enum.TextXAlignment.Center
        noRecordLabel.Parent = scrollArea
        yPos = yPos + 120
    end

    scrollArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

return ShopAdmin
