-- é¶å­ç³»ç»Ÿæ§åˆ¶å™¨
-- ç®¡ç†é¶å­ç³»ç»Ÿçš„å®¢æˆ·ç«¯é€»è¾‘å’ŒæœåŠ¡ç«¯é€šä¿¡

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local TargetController = {}

-- ç­‰å¾…æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local Events = require(SharedModules:WaitForChild("ShopEvents"))

-- ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®
local TargetConfig = Config.TARGETS

-- é¶å­çŠ¶æ€ç®¡ç†
local targetStatus = {}

-- å†…éƒ¨äº‹ä»¶ç³»ç»Ÿ
local internalEvents = {
    TargetCreated = Instance.new("BindableEvent"),
    TargetDestroyed = Instance.new("BindableEvent"),
    TargetDamaged = Instance.new("BindableEvent"),
    TargetRespawned = Instance.new("BindableEvent"),
    TargetStatusChanged = Instance.new("BindableEvent")
}

-- å¯¼å‡ºäº‹ä»¶
TargetController.Events = {}
for eventName, event in pairs(internalEvents) do
    TargetController.Events[eventName] = event.Event
end

-- ==============================================
-- çŠ¶æ€ç®¡ç†
-- ==============================================

-- è·å–é¶å­çŠ¶æ€
function TargetController.getTargetStatus(targetId)
    return targetStatus[targetId]
end

-- è·å–æ‰€æœ‰é¶å­çŠ¶æ€
function TargetController.getAllTargetStatus()
    return targetStatus
end

-- è®¾ç½®é¶å­çŠ¶æ€
function TargetController.setTargetStatus(targetId, newStatus)
    local oldStatus = targetStatus[targetId]
    targetStatus[targetId] = newStatus

    internalEvents.TargetStatusChanged:Fire(targetId, newStatus, oldStatus)
    print("ğŸ¯ [TargetController] é¶å­çŠ¶æ€å·²æ›´æ–°:", targetId, newStatus.health and ("è¡€é‡: " .. newStatus.health .. "/" .. newStatus.maxHealth) or "")
end

-- æ›´æ–°é¶å­è¡€é‡
function TargetController.updateTargetHealth(targetId, health, maxHealth)
    if targetStatus[targetId] then
        targetStatus[targetId].health = health
        targetStatus[targetId].maxHealth = maxHealth

        internalEvents.TargetStatusChanged:Fire(targetId, targetStatus[targetId], targetStatus[targetId])
        print("ğŸ©¸ [TargetController] é¶å­è¡€é‡æ›´æ–°:", targetId, health .. "/" .. maxHealth)
    end
end

-- æ£€æŸ¥é¶å­æ˜¯å¦å­˜æ´»
function TargetController.isTargetAlive(targetId)
    local status = targetStatus[targetId]
    return status and status.alive == true
end

-- è·å–é¶å­æ•°é‡
function TargetController.getTargetCount()
    local count = 0
    for _ in pairs(targetStatus) do
        count = count + 1
    end
    return count
end

-- è·å–æ´»è·ƒé¶å­æ•°é‡
function TargetController.getActiveTargetCount()
    local count = 0
    for _, status in pairs(targetStatus) do
        if status.alive then
            count = count + 1
        end
    end
    return count
end

-- ==============================================
-- è¿œç¨‹é€šä¿¡åŠŸèƒ½
-- ==============================================

-- è¯·æ±‚é¶å­çŠ¶æ€æ›´æ–°
function TargetController.requestTargetStatus()
    if Events.Target.RequestTargetStatus then
        Events.Target.RequestTargetStatus:FireServer()
        print("ğŸ”„ [TargetController] è¯·æ±‚é¶å­çŠ¶æ€æ›´æ–°")
        return true
    else
        warn("âš ï¸ [TargetController] é¶å­çŠ¶æ€è¯·æ±‚äº‹ä»¶ä¸å¯ç”¨")
        return false
    end
end

-- ==============================================
-- äº‹ä»¶ç›‘å¬å’Œå¤„ç†
-- ==============================================

local eventConnections = {}

-- æœåŠ¡ç«¯äº‹ä»¶å¤„ç†å‡½æ•°
local function handleTargetCreated(targetId, targetData)
    -- æ›´æ–°æœ¬åœ°çŠ¶æ€
    TargetController.setTargetStatus(targetId, {
        id = targetId,
        position = targetData.position,
        height = targetData.height,
        health = targetData.health,
        maxHealth = targetData.maxHealth,
        alive = true
    })

    print("âœ… [TargetController] é¶å­å·²åˆ›å»º:", targetId)
    internalEvents.TargetCreated:Fire(targetId, targetData)
end

local function handleTargetDestroyed(targetId, destroyerId)
    -- æ›´æ–°æœ¬åœ°çŠ¶æ€
    if targetStatus[targetId] then
        targetStatus[targetId].alive = false
        targetStatus[targetId].health = 0

        print("ğŸ’¥ [TargetController] é¶å­å·²æ‘§æ¯:", targetId, "æ‘§æ¯è€…:", destroyerId or "æœªçŸ¥")
        internalEvents.TargetDestroyed:Fire(targetId, destroyerId)
        internalEvents.TargetStatusChanged:Fire(targetId, targetStatus[targetId], targetStatus[targetId])
    end
end

local function handleTargetDamaged(targetId, health, maxHealth, attackerId)
    -- æ›´æ–°æœ¬åœ°çŠ¶æ€
    TargetController.updateTargetHealth(targetId, health, maxHealth)

    print("âš”ï¸ [TargetController] é¶å­å—åˆ°ä¼¤å®³:", targetId, "è¡€é‡:", health .. "/" .. maxHealth, "æ”»å‡»è€…:", attackerId or "æœªçŸ¥")
    internalEvents.TargetDamaged:Fire(targetId, health, maxHealth, attackerId)
end

local function handleTargetRespawned(targetId, targetData)
    -- æ›´æ–°æœ¬åœ°çŠ¶æ€
    TargetController.setTargetStatus(targetId, {
        id = targetId,
        position = targetData.position,
        height = targetData.height,
        health = targetData.health,
        maxHealth = targetData.maxHealth,
        alive = true
    })

    print("ğŸ”„ [TargetController] é¶å­å·²é‡ç”Ÿ:", targetId)
    internalEvents.TargetRespawned:Fire(targetId, targetData)
end

local function handleTargetStatusUpdate(activeTargets)
    -- æ›´æ–°æ‰€æœ‰é¶å­çŠ¶æ€
    targetStatus = {}
    for targetId, targetData in pairs(activeTargets) do
        targetStatus[targetId] = {
            id = targetId,
            position = targetData.position,
            height = targetData.height,
            health = targetData.health,
            maxHealth = targetData.maxHealth,
            alive = true
        }
    end

    local activeCount = 0
    for _ in pairs(activeTargets) do
        activeCount = activeCount + 1
    end

    print("ğŸ“Š [TargetController] é¶å­çŠ¶æ€å·²åŒæ­¥ï¼Œæ´»è·ƒé¶å­æ•°é‡:", activeCount)
    internalEvents.TargetStatusChanged:Fire("all", targetStatus, {})
end

-- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function TargetController.initializeEventListeners()
    -- è¿æ¥æœåŠ¡ç«¯äº‹ä»¶
    if Events and Events.Target then
        eventConnections.targetCreated = Events.Target.TargetCreated.OnClientEvent:Connect(handleTargetCreated)
        eventConnections.targetDestroyed = Events.Target.TargetDestroyed.OnClientEvent:Connect(handleTargetDestroyed)
        eventConnections.targetDamaged = Events.Target.TargetDamaged.OnClientEvent:Connect(handleTargetDamaged)
        eventConnections.targetRespawned = Events.Target.TargetRespawned.OnClientEvent:Connect(handleTargetRespawned)
        eventConnections.targetStatusUpdate = Events.Target.TargetStatusUpdate.OnClientEvent:Connect(handleTargetStatusUpdate)

        print("âœ… [TargetController] æœåŠ¡ç«¯äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
    else
        warn("âŒ [TargetController] æ— æ³•è¿æ¥æœåŠ¡ç«¯äº‹ä»¶")
    end

    print("âœ… [TargetController] äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- é«˜çº§åŠŸèƒ½
-- ==============================================

-- è·å–é¶å­èƒ½åŠ›æè¿°
function TargetController.getTargetCapabilities()
    return {
        count = TargetConfig.COUNT,
        maxHealth = TargetConfig.MAX_HEALTH,
        respawnTime = TargetConfig.RESPAWN_TIME,
        features = {
            "åŠ¨æ€ç”Ÿæˆä½ç½®",
            "è¡€é‡ç³»ç»Ÿ",
            "è‡ªåŠ¨é‡ç”Ÿ",
            "å®æ—¶çŠ¶æ€åŒæ­¥"
        }
    }
end

-- è·å–é¶å­ç»Ÿè®¡ä¿¡æ¯
function TargetController.getTargetStats()
    local stats = {
        totalTargets = 0,
        aliveTargets = 0,
        destroyedTargets = 0,
        totalHealth = 0,
        maxTotalHealth = 0
    }

    for _, status in pairs(targetStatus) do
        stats.totalTargets = stats.totalTargets + 1
        if status.alive then
            stats.aliveTargets = stats.aliveTargets + 1
            stats.totalHealth = stats.totalHealth + status.health
        else
            stats.destroyedTargets = stats.destroyedTargets + 1
        end
        stats.maxTotalHealth = stats.maxTotalHealth + status.maxHealth
    end

    return stats
end

-- æ ¼å¼åŒ–é¶å­çŠ¶æ€ä¿¡æ¯
function TargetController.getFormattedTargetInfo(targetId)
    local status = targetStatus[targetId]
    if not status then
        return "é¶å­ä¸å­˜åœ¨"
    end

    local healthPercent = status.health / status.maxHealth * 100
    local statusText = status.alive and "å­˜æ´»" or "å·²æ‘§æ¯"

    return string.format("é¶å­ %s: %s (è¡€é‡: %.1f%%)", targetId, statusText, healthPercent)
end

-- ==============================================
-- åˆå§‹åŒ–å’Œæ¸…ç†
-- ==============================================

-- åˆå§‹åŒ–é¶å­æ§åˆ¶å™¨
function TargetController.initialize()
    print("ğŸš€ [TargetController] å¼€å§‹åˆå§‹åŒ–...")

    -- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    TargetController.initializeEventListeners()

    -- è¯·æ±‚åˆå§‹é¶å­çŠ¶æ€
    wait(0.5) -- ç­‰å¾…æœåŠ¡ç«¯å‡†å¤‡å°±ç»ª
    TargetController.requestTargetStatus()

    print("âœ… [TargetController] åˆå§‹åŒ–å®Œæˆ")
end

-- æ¸…ç†èµ„æº
function TargetController.cleanup()
    -- æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥
    for _, connection in pairs(eventConnections) do
        if connection then
            connection:Disconnect()
        end
    end
    eventConnections = {}

    -- é‡ç½®çŠ¶æ€
    targetStatus = {}

    print("ğŸ§¹ [TargetController] èµ„æºå·²æ¸…ç†")
end

return TargetController
