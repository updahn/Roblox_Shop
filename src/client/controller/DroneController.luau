-- æ— äººæœºæ§åˆ¶å™¨
-- æ•´åˆæ— äººæœºç›¸å…³çš„è¿œç¨‹é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†åŠŸèƒ½

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local DroneController = {}

-- ç­‰å¾…æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local Events = require(SharedModules:WaitForChild("ShopEvents"))

-- ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®
local DroneConfig = Config.DRONE_CONFIG

-- ç¼“å­˜è¿œç¨‹äº‹ä»¶
local RemoteEvents = {}

-- æ— äººæœºçŠ¶æ€ç®¡ç†
local droneStatus = {
    isActive = false,
    mode = DroneConfig.MODES.FOLLOW,
    timeRemaining = 0
}

-- å†…éƒ¨äº‹ä»¶ç³»ç»Ÿ
local internalEvents = {
    DroneSpawned = Instance.new("BindableEvent"),
    DroneRecalled = Instance.new("BindableEvent"),
    DroneModeChanged = Instance.new("BindableEvent"),
    DroneDestroyed = Instance.new("BindableEvent"),
    DroneAttack = Instance.new("BindableEvent"),
    DroneStatusChanged = Instance.new("BindableEvent")
}

-- å¯¼å‡ºäº‹ä»¶
DroneController.Events = {}
for eventName, event in pairs(internalEvents) do
    DroneController.Events[eventName] = event.Event
end

-- åˆå§‹åŒ–è¿œç¨‹äº‹ä»¶
local function initializeEvents()
    if Events and Events.Drone then
        RemoteEvents = {
            SpawnDrone = Events.Drone.SpawnDrone,
            RecallDrone = Events.Drone.RecallDrone,
            SwitchDroneMode = Events.Drone.SwitchDroneMode
        }
        print("âœ… [DroneController] æ— äººæœºè¿œç¨‹äº‹ä»¶åˆå§‹åŒ–æˆåŠŸ")
    else
        warn("âŒ [DroneController] æ— äººæœºè¿œç¨‹äº‹ä»¶åˆå§‹åŒ–å¤±è´¥")
    end
end

-- ==============================================
-- çŠ¶æ€ç®¡ç†
-- ==============================================

-- è·å–æ— äººæœºçŠ¶æ€
function DroneController.getDroneStatus()
    return {
        isActive = droneStatus.isActive,
        mode = droneStatus.mode,
        timeRemaining = droneStatus.timeRemaining
    }
end

-- è®¾ç½®æ— äººæœºçŠ¶æ€
function DroneController.setDroneStatus(newStatus)
    local oldStatus = {
        isActive = droneStatus.isActive,
        mode = droneStatus.mode,
        timeRemaining = droneStatus.timeRemaining
    }

    if newStatus.isActive ~= nil then
        droneStatus.isActive = newStatus.isActive
    end

    if newStatus.mode ~= nil then
        droneStatus.mode = newStatus.mode
    end

    if newStatus.timeRemaining ~= nil then
        droneStatus.timeRemaining = newStatus.timeRemaining
    end

    internalEvents.DroneStatusChanged:Fire(droneStatus, oldStatus)
    print("ğŸ¤– [DroneController] æ— äººæœºçŠ¶æ€å·²æ›´æ–°:", droneStatus.isActive and "æ¿€æ´»" or "å¾…å‘½", "æ¨¡å¼:", droneStatus.mode)
end

-- æ£€æŸ¥æ— äººæœºæ˜¯å¦æ¿€æ´»
function DroneController.isDroneActive()
    return droneStatus.isActive
end

-- è·å–æ— äººæœºæ¨¡å¼
function DroneController.getDroneMode()
    return droneStatus.mode
end

-- è·å–å‰©ä½™æ—¶é—´
function DroneController.getTimeRemaining()
    return droneStatus.timeRemaining
end

-- ==============================================
-- è¿œç¨‹é€šä¿¡åŠŸèƒ½
-- ==============================================

-- å¬å”¤æ— äººæœº
function DroneController.spawnDrone()
    initializeEvents()
    if RemoteEvents.SpawnDrone and not droneStatus.isActive then
        RemoteEvents.SpawnDrone:FireServer()
        print("ğŸ¤– [DroneController] å‘é€å¬å”¤æ— äººæœºè¯·æ±‚")
        return true
    else
        warn("âš ï¸ [DroneController] æ— äººæœºå·²æ¿€æ´»æˆ–è¿œç¨‹äº‹ä»¶ä¸å¯ç”¨")
        return false
    end
end

-- æ”¶å›æ— äººæœº
function DroneController.recallDrone()
    initializeEvents()
    if RemoteEvents.RecallDrone and droneStatus.isActive then
        RemoteEvents.RecallDrone:FireServer()
        print("ğŸ¤– [DroneController] å‘é€æ”¶å›æ— äººæœºè¯·æ±‚")
        return true
    else
        warn("âš ï¸ [DroneController] æ— äººæœºæœªæ¿€æ´»æˆ–è¿œç¨‹äº‹ä»¶ä¸å¯ç”¨")
        return false
    end
end

-- åˆ‡æ¢æ— äººæœºæ¨¡å¼
function DroneController.switchDroneMode(newMode)
    initializeEvents()
    if RemoteEvents.SwitchDroneMode and droneStatus.isActive then
        local targetMode = newMode or (droneStatus.mode == DroneConfig.MODES.FOLLOW and DroneConfig.MODES.GUARD or DroneConfig.MODES.FOLLOW)
        RemoteEvents.SwitchDroneMode:FireServer(targetMode)
        print("ğŸ¤– [DroneController] å‘é€åˆ‡æ¢æ¨¡å¼è¯·æ±‚:", targetMode)
        return true
    else
        warn("âš ï¸ [DroneController] æ— äººæœºæœªæ¿€æ´»æˆ–è¿œç¨‹äº‹ä»¶ä¸å¯ç”¨")
        return false
    end
end

-- ==============================================
-- äº‹ä»¶ç›‘å¬å’Œå¤„ç†
-- ==============================================

local eventConnections = {}
local timerConnection = nil

-- æœåŠ¡ç«¯äº‹ä»¶å¤„ç†å‡½æ•°
local function handleDroneSpawned(success)
    if success then
        DroneController.setDroneStatus({
            isActive = true,
            mode = DroneConfig.MODES.FOLLOW,
            timeRemaining = DroneConfig.LIFETIME
        })
        print("âœ… [DroneController] æ— äººæœºå·²å¬å”¤")
    else
        print("âŒ [DroneController] æ— äººæœºå¬å”¤å¤±è´¥")
    end
    internalEvents.DroneSpawned:Fire(success)
end

local function handleDroneRecalled(success)
    if success then
        DroneController.setDroneStatus({
            isActive = false,
            timeRemaining = 0
        })
        print("âœ… [DroneController] æ— äººæœºå·²æ”¶å›")
    end
    internalEvents.DroneRecalled:Fire(success)
end

local function handleDroneModeChanged(newMode, oldMode)
    DroneController.setDroneStatus({
        mode = newMode
    })
    print("ğŸ”„ [DroneController] æ— äººæœºæ¨¡å¼å·²ä»", oldMode, "åˆ‡æ¢åˆ°", newMode)
    internalEvents.DroneModeChanged:Fire(newMode, oldMode)
end

local function handleDroneDestroyed(reason)
    DroneController.setDroneStatus({
        isActive = false,
        timeRemaining = 0
    })
    print("ğŸ’¥ [DroneController] æ— äººæœºå·²é”€æ¯ï¼ŒåŸå› :", reason)
    internalEvents.DroneDestroyed:Fire(reason)
end

local function handleDroneAttack(targetName)
    print("âš”ï¸ [DroneController] æ— äººæœºæ”»å‡»äº†ç›®æ ‡:", targetName)
    internalEvents.DroneAttack:Fire(targetName)
end

-- å¯åŠ¨è®¡æ—¶å™¨
local function startTimer()
    if timerConnection then
        timerConnection:Disconnect()
    end

    local lastUpdateTime = 0
    timerConnection = game:GetService("RunService").Heartbeat:Connect(function(deltaTime)
        if droneStatus.isActive and droneStatus.timeRemaining > 0 then
            droneStatus.timeRemaining = droneStatus.timeRemaining - deltaTime
            lastUpdateTime = lastUpdateTime + deltaTime

            -- æ¯0.1ç§’æ›´æ–°ä¸€æ¬¡UIæ˜¾ç¤ºï¼ˆå¹³è¡¡æ€§èƒ½å’Œæµç•…åº¦ï¼‰
            if lastUpdateTime >= 0.1 then
                lastUpdateTime = 0
                internalEvents.DroneStatusChanged:Fire(droneStatus, {
                    isActive = droneStatus.isActive,
                    mode = droneStatus.mode,
                    timeRemaining = droneStatus.timeRemaining + deltaTime
                })
            end

            if droneStatus.timeRemaining <= 0 then
                -- æ—¶é—´åˆ°ï¼Œé‡ç½®çŠ¶æ€
                DroneController.setDroneStatus({
                    isActive = false,
                    timeRemaining = 0
                })
                print("â° [DroneController] æ— äººæœºæ—¶é—´åˆ°æœŸï¼Œè‡ªåŠ¨é”€æ¯")
            end
        end
    end)
end

-- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function DroneController.initializeEventListeners()
    initializeEvents()

    -- è¿æ¥æœåŠ¡ç«¯äº‹ä»¶
    if Events and Events.Drone then
        eventConnections.droneSpawned = Events.Drone.DroneSpawned.OnClientEvent:Connect(handleDroneSpawned)
        eventConnections.droneRecalled = Events.Drone.DroneRecalled.OnClientEvent:Connect(handleDroneRecalled)
        eventConnections.droneModeChanged = Events.Drone.DroneModeChanged.OnClientEvent:Connect(handleDroneModeChanged)
        eventConnections.droneDestroyed = Events.Drone.DroneDestroyed.OnClientEvent:Connect(handleDroneDestroyed)
        eventConnections.droneAttack = Events.Drone.DroneAttack.OnClientEvent:Connect(handleDroneAttack)

        print("âœ… [DroneController] æœåŠ¡ç«¯äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
    else
        warn("âŒ [DroneController] æ— æ³•è¿æ¥æœåŠ¡ç«¯äº‹ä»¶")
    end

    -- å¯åŠ¨è®¡æ—¶å™¨
    startTimer()

    print("âœ… [DroneController] äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- é«˜çº§æ§åˆ¶åŠŸèƒ½
-- ==============================================

-- å¤„ç†æ— äººæœºæ“ä½œ
function DroneController.handleDroneAction(action, data)
    if action == "spawn" then
        return DroneController.spawnDrone()

    elseif action == "recall" then
        return DroneController.recallDrone()

    elseif action == "switch_mode" then
        local newMode = data and data.mode or nil
        return DroneController.switchDroneMode(newMode)

    else
        warn("âŒ [DroneController] æœªçŸ¥æ— äººæœºæ“ä½œ:", action)
        return false
    end
end

-- è·å–æ— äººæœºèƒ½åŠ›æè¿°
function DroneController.getDroneCapabilities()
    return {
        modes = {
            follow = DroneConfig.MODES.FOLLOW,
            guard = DroneConfig.MODES.GUARD
        },
        lifetime = DroneConfig.LIFETIME,
        features = {
            "è‡ªåŠ¨è·Ÿéšç©å®¶",
            "å®šç‚¹é©»å®ˆ",
            "æ”»å‡»æ•Œå¯¹ç›®æ ‡",
            "è‡ªåŠ¨é”€æ¯è¶…æ—¶"
        }
    }
end

-- æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
function DroneController.getFormattedTimeRemaining()
    if not droneStatus.isActive or droneStatus.timeRemaining <= 0 then
        return "æœªæ¿€æ´»"
    end

    local minutes = math.floor(droneStatus.timeRemaining / 60)
    local seconds = math.floor(droneStatus.timeRemaining % 60)

    if minutes > 0 then
        return string.format("%d:%02d", minutes, seconds)
    else
        return string.format("%.1fç§’", droneStatus.timeRemaining)
    end
end

-- è·å–æ— äººæœºæ¨¡å¼æè¿°
function DroneController.getModeDescription()
    if droneStatus.mode == DroneConfig.MODES.FOLLOW then
        return "è·Ÿéšæ¨¡å¼"
    elseif droneStatus.mode == DroneConfig.MODES.GUARD then
        return "é©»å®ˆæ¨¡å¼"
    else
        return "æœªçŸ¥æ¨¡å¼"
    end
end

-- ==============================================
-- åˆå§‹åŒ–å’Œæ¸…ç†
-- ==============================================

-- åˆå§‹åŒ–æ— äººæœºæ§åˆ¶å™¨
function DroneController.initialize()
    print("ğŸš€ [DroneController] å¼€å§‹åˆå§‹åŒ–...")

    -- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    DroneController.initializeEventListeners()

    -- é‡ç½®æ— äººæœºçŠ¶æ€
    DroneController.setDroneStatus({
        isActive = false,
        mode = DroneConfig.MODES.FOLLOW,
        timeRemaining = 0
    })

    print("âœ… [DroneController] åˆå§‹åŒ–å®Œæˆ")
end

-- æ¸…ç†èµ„æº
function DroneController.cleanup()
    -- æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥
    for _, connection in pairs(eventConnections) do
        if connection then
            connection:Disconnect()
        end
    end
    eventConnections = {}

    -- åœæ­¢è®¡æ—¶å™¨
    if timerConnection then
        timerConnection:Disconnect()
        timerConnection = nil
    end

    -- é‡ç½®çŠ¶æ€
    droneStatus.isActive = false
    droneStatus.timeRemaining = 0

    print("ğŸ§¹ [DroneController] èµ„æºå·²æ¸…ç†")
end

return DroneController
