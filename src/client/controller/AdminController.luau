-- ç®¡ç†å‘˜æ§åˆ¶å™¨ - é‡æ„ç‰ˆæœ¬
-- è´Ÿè´£ç®¡ç†å‘˜ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä¸ç›´æ¥è®¿é—®UI
-- é€šè¿‡äº‹ä»¶ç³»ç»Ÿä¸UIå±‚é€šä¿¡ï¼Œå®ç°åˆ†å±‚æ¶æ„

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AdminController = {}

-- ç¼“å­˜è¿œç¨‹äº‹ä»¶
local Events = nil
local RemoteEvents = {}

-- ç®¡ç†å‘˜æ•°æ®äº‹ä»¶ç³»ç»Ÿï¼ˆä¾›UIç›‘å¬ï¼‰
local AdminDataEvents = {
    AllUsersReceived = Instance.new("BindableEvent"),
    UserCoinsSet = Instance.new("BindableEvent"),
    UserHistoryReceived = Instance.new("BindableEvent"),
    MembersListReceived = Instance.new("BindableEvent"),
    AllUsersWithMembershipReceived = Instance.new("BindableEvent"),
    MembershipStatusReceived = Instance.new("BindableEvent"),
    MembershipUpdated = Instance.new("BindableEvent"),
    MembershipAdded = Instance.new("BindableEvent"),
    MembershipCancelled = Instance.new("BindableEvent"),
    MembershipExtended = Instance.new("BindableEvent"),
    BatchMembershipOpCompleted = Instance.new("BindableEvent"),
    UserMembershipManaged = Instance.new("BindableEvent"),
    PermissionChecked = Instance.new("BindableEvent")
}

-- å¯¼å‡ºäº‹ä»¶ä¾›UIå±‚ç›‘å¬
AdminController.Events = {}
for eventName, event in pairs(AdminDataEvents) do
    AdminController.Events[eventName] = event.Event
end

-- åˆå§‹åŒ–è¿œç¨‹äº‹ä»¶
local function initializeEvents()
    if not Events then
        local success, result = pcall(function()
            local SharedModules = ReplicatedStorage:WaitForChild("SharedModules", 10)
            if not SharedModules then
                error("âŒ æ— æ³•æ‰¾åˆ°SharedModulesæ–‡ä»¶å¤¹")
            end
            local EventsModule = SharedModules:WaitForChild("ShopEvents", 10)
            if not EventsModule then
                error("âŒ æ— æ³•æ‰¾åˆ°ShopEventsæ¨¡å—")
            end
            return require(EventsModule)
        end)

        if success then
            Events = result
            RemoteEvents = {
                GetAllUsers = Events.Admin.GetAllUsers,
                SetUserCoins = Events.Admin.SetUserCoins,
                GetUserHistory = Events.Admin.GetUserHistory,
                GetMembersList = Events.Admin.GetMembersList,
                GetAllUsersWithMembership = Events.Admin.GetAllUsersWithMembership,
                GetMembershipStatus = Events.Admin.GetMembershipStatus,
                UpdateMembership = Events.Admin.UpdateMembership,
                AddMembership = Events.Admin.AddMembership,
                CancelMembership = Events.Admin.CancelMembership,
                ExtendMembership = Events.Admin.ExtendMembership,
                BatchMembershipOp = Events.Admin.BatchMembershipOp,
                ManageUserMembership = Events.Admin.ManageUserMembership,
                CheckPermission = Events.Admin.CheckPermission
            }
            print("âœ… [AdminController] ç®¡ç†å‘˜è¿œç¨‹äº‹ä»¶åˆå§‹åŒ–æˆåŠŸ")
        else
            warn("âŒ [AdminController] ç®¡ç†å‘˜è¿œç¨‹äº‹ä»¶åˆå§‹åŒ–å¤±è´¥:", result)
        end
    end
end

-- ==============================================
-- æƒé™ç®¡ç†
-- ==============================================

-- æƒé™æ£€æŸ¥
function AdminController.checkPermission()
    initializeEvents()
    if RemoteEvents.CheckPermission then
        local success, result = pcall(function()
            return RemoteEvents.CheckPermission:InvokeServer()
        end)
        local hasPermission = success and result or false
        AdminDataEvents.PermissionChecked:Fire(hasPermission)
        return hasPermission
    end
    return false
end

-- ==============================================
-- ç”¨æˆ·ç®¡ç†åŠŸèƒ½
-- ==============================================

-- è·å–æ‰€æœ‰ç”¨æˆ·
function AdminController.getAllUsers()
    initializeEvents()
    if RemoteEvents.GetAllUsers then
        RemoteEvents.GetAllUsers:FireServer()
        print("ğŸ“¡ [AdminController] è¯·æ±‚è·å–æ‰€æœ‰ç”¨æˆ·")
    end
end

-- è®¾ç½®ç”¨æˆ·é‡‘å¸
function AdminController.setUserCoins(userId, newCoins)
    initializeEvents()
    if RemoteEvents.SetUserCoins then
        RemoteEvents.SetUserCoins:FireServer(userId, newCoins)
        print("ğŸ’° [AdminController] è®¾ç½®ç”¨æˆ·é‡‘å¸:", userId, newCoins)
    end
end

-- è·å–ç”¨æˆ·å†å²è®°å½•
function AdminController.getUserHistory(userId)
    initializeEvents()
    if RemoteEvents.GetUserHistory then
        RemoteEvents.GetUserHistory:FireServer(userId)
        print("ğŸ“Š [AdminController] è¯·æ±‚ç”¨æˆ·å†å²è®°å½•:", userId)
    end
end

-- ==============================================
-- ä¼šå‘˜ç®¡ç†åŠŸèƒ½
-- ==============================================

-- è·å–ä¼šå‘˜åˆ—è¡¨
function AdminController.getMembersList()
    initializeEvents()
    if RemoteEvents.GetMembersList then
        RemoteEvents.GetMembersList:FireServer()
        print("ğŸ‘‘ [AdminController] è¯·æ±‚è·å–ä¼šå‘˜åˆ—è¡¨")
    end
end

-- è·å–æ‰€æœ‰ç”¨æˆ·çš„ä¼šå‘˜ä¿¡æ¯
function AdminController.getAllUsersWithMembership()
    initializeEvents()
    if RemoteEvents.GetAllUsersWithMembership then
        RemoteEvents.GetAllUsersWithMembership:FireServer()
        print("ğŸ‘‘ [AdminController] è¯·æ±‚è·å–æ‰€æœ‰ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯")
    end
end

-- è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
function AdminController.getMembershipStatus(userId)
    initializeEvents()
    if RemoteEvents.GetMembershipStatus then
        RemoteEvents.GetMembershipStatus:FireServer(userId)
        print("ğŸ‘‘ [AdminController] è¯·æ±‚ç”¨æˆ·ä¼šå‘˜çŠ¶æ€:", userId)
    end
end

-- æ›´æ–°ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯
function AdminController.updateMembership(userId, membershipData)
    initializeEvents()
    if RemoteEvents.UpdateMembership then
        RemoteEvents.UpdateMembership:FireServer(userId, membershipData)
        print("ğŸ‘‘ [AdminController] æ›´æ–°ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯:", userId)
    end
end

-- æ·»åŠ ç”¨æˆ·ä¼šå‘˜
function AdminController.addMembership(userId, membershipType, duration)
    initializeEvents()
    if RemoteEvents.AddMembership then
        RemoteEvents.AddMembership:FireServer(userId, membershipType, duration)
        print("ğŸ‘‘ [AdminController] æ·»åŠ ç”¨æˆ·ä¼šå‘˜:", userId, membershipType, duration)
    end
end

-- å–æ¶ˆç”¨æˆ·ä¼šå‘˜
function AdminController.cancelMembership(userId)
    initializeEvents()
    if RemoteEvents.CancelMembership then
        RemoteEvents.CancelMembership:FireServer(userId)
        print("ğŸ‘‘ [AdminController] å–æ¶ˆç”¨æˆ·ä¼šå‘˜:", userId)
    end
end

-- å»¶é•¿ç”¨æˆ·ä¼šå‘˜
function AdminController.extendMembership(userId, days)
    initializeEvents()
    if RemoteEvents.ExtendMembership then
        RemoteEvents.ExtendMembership:FireServer(userId, days)
        print("ğŸ‘‘ [AdminController] å»¶é•¿ç”¨æˆ·ä¼šå‘˜:", userId, days, "å¤©")
    end
end

-- æ‰¹é‡ä¼šå‘˜æ“ä½œ
function AdminController.batchMembershipOperation(operation, userIds)
    initializeEvents()
    if RemoteEvents.BatchMembershipOp then
        RemoteEvents.BatchMembershipOp:FireServer(operation, userIds)
        print("ğŸ‘‘ [AdminController] æ‰¹é‡ä¼šå‘˜æ“ä½œ:", operation, "ç”¨æˆ·æ•°é‡:", #userIds)
    end
end

-- ç®¡ç†ç”¨æˆ·ä¼šå‘˜
function AdminController.manageUserMembership(requestData)
    initializeEvents()
    if RemoteEvents.ManageUserMembership then
        RemoteEvents.ManageUserMembership:FireServer(requestData)
        print("ğŸ‘‘ [AdminController] ç®¡ç†ç”¨æˆ·ä¼šå‘˜:", requestData.userId or requestData.playerName, requestData.action)
    end
end

-- ==============================================
-- äº‹ä»¶ç›‘å¬å’Œå¤„ç†
-- ==============================================

local eventConnections = {}

-- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
function AdminController.initializeEventListeners()
    initializeEvents()

    -- ç›‘å¬æ‰€æœ‰ç”¨æˆ·å“åº”
    if RemoteEvents.GetAllUsers then
        eventConnections.getAllUsers = RemoteEvents.GetAllUsers.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] è·å–æ‰€æœ‰ç”¨æˆ·æˆåŠŸ")
                AdminDataEvents.AllUsersReceived:Fire(success, message, data)
            else
                warn("âŒ [AdminController] è·å–æ‰€æœ‰ç”¨æˆ·å¤±è´¥:", message)
                AdminDataEvents.AllUsersReceived:Fire(success, message, nil)
            end
        end)
    end

    -- ç›‘å¬è®¾ç½®ç”¨æˆ·é‡‘å¸å“åº”
    if RemoteEvents.SetUserCoins then
        eventConnections.setUserCoins = RemoteEvents.SetUserCoins.OnClientEvent:Connect(function(success, message)
            if success then
                print("âœ… [AdminController] è®¾ç½®ç”¨æˆ·é‡‘å¸æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] è®¾ç½®ç”¨æˆ·é‡‘å¸å¤±è´¥:", message)
            end
            AdminDataEvents.UserCoinsSet:Fire(success, message)
        end)
    end

    -- ç›‘å¬ç”¨æˆ·å†å²è®°å½•å“åº”
    if RemoteEvents.GetUserHistory then
        eventConnections.getUserHistory = RemoteEvents.GetUserHistory.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] è·å–ç”¨æˆ·å†å²è®°å½•æˆåŠŸ")
                AdminDataEvents.UserHistoryReceived:Fire(success, message, data)
            else
                warn("âŒ [AdminController] è·å–ç”¨æˆ·å†å²è®°å½•å¤±è´¥:", message)
                AdminDataEvents.UserHistoryReceived:Fire(success, message, nil)
            end
        end)
    end

    -- ç›‘å¬ä¼šå‘˜åˆ—è¡¨å“åº”
    if RemoteEvents.GetMembersList then
        eventConnections.getMembersList = RemoteEvents.GetMembersList.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] è·å–ä¼šå‘˜åˆ—è¡¨æˆåŠŸ")
                AdminDataEvents.MembersListReceived:Fire(success, message, data)
            else
                warn("âŒ [AdminController] è·å–ä¼šå‘˜åˆ—è¡¨å¤±è´¥:", message)
                AdminDataEvents.MembersListReceived:Fire(success, message, nil)
            end
        end)
    end

    -- ç›‘å¬æ‰€æœ‰ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯å“åº”
    if RemoteEvents.GetAllUsersWithMembership then
        eventConnections.getAllUsersWithMembership = RemoteEvents.GetAllUsersWithMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] è·å–æ‰€æœ‰ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯æˆåŠŸ")
                AdminDataEvents.AllUsersWithMembershipReceived:Fire(success, message, data)
            else
                warn("âŒ [AdminController] è·å–æ‰€æœ‰ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯å¤±è´¥:", message)
                AdminDataEvents.AllUsersWithMembershipReceived:Fire(success, message, nil)
            end
        end)
    end

    -- ç›‘å¬ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å“åº”
    if RemoteEvents.GetMembershipStatus then
        eventConnections.getMembershipStatus = RemoteEvents.GetMembershipStatus.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€æˆåŠŸ")
                AdminDataEvents.MembershipStatusReceived:Fire(success, message, data)
            else
                warn("âŒ [AdminController] è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å¤±è´¥:", message)
                AdminDataEvents.MembershipStatusReceived:Fire(success, message, nil)
            end
        end)
    end

    -- ç›‘å¬æ›´æ–°ä¼šå‘˜å“åº”
    if RemoteEvents.UpdateMembership then
        eventConnections.updateMembership = RemoteEvents.UpdateMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] æ›´æ–°ç”¨æˆ·ä¼šå‘˜æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] æ›´æ–°ç”¨æˆ·ä¼šå‘˜å¤±è´¥:", message)
            end
            AdminDataEvents.MembershipUpdated:Fire(success, message, data)
        end)
    end

    -- ç›‘å¬æ·»åŠ ä¼šå‘˜å“åº”
    if RemoteEvents.AddMembership then
        eventConnections.addMembership = RemoteEvents.AddMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] æ·»åŠ ç”¨æˆ·ä¼šå‘˜æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] æ·»åŠ ç”¨æˆ·ä¼šå‘˜å¤±è´¥:", message)
            end
            AdminDataEvents.MembershipAdded:Fire(success, message, data)
        end)
    end

    -- ç›‘å¬å–æ¶ˆä¼šå‘˜å“åº”
    if RemoteEvents.CancelMembership then
        eventConnections.cancelMembership = RemoteEvents.CancelMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] å–æ¶ˆç”¨æˆ·ä¼šå‘˜æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] å–æ¶ˆç”¨æˆ·ä¼šå‘˜å¤±è´¥:", message)
            end
            AdminDataEvents.MembershipCancelled:Fire(success, message, data)
        end)
    end

    -- ç›‘å¬å»¶é•¿ä¼šå‘˜å“åº”
    if RemoteEvents.ExtendMembership then
        eventConnections.extendMembership = RemoteEvents.ExtendMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] å»¶é•¿ç”¨æˆ·ä¼šå‘˜æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] å»¶é•¿ç”¨æˆ·ä¼šå‘˜å¤±è´¥:", message)
            end
            AdminDataEvents.MembershipExtended:Fire(success, message, data)
        end)
    end

    -- ç›‘å¬æ‰¹é‡ä¼šå‘˜æ“ä½œå“åº”
    if RemoteEvents.BatchMembershipOp then
        eventConnections.batchMembershipOp = RemoteEvents.BatchMembershipOp.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] æ‰¹é‡ä¼šå‘˜æ“ä½œæˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] æ‰¹é‡ä¼šå‘˜æ“ä½œå¤±è´¥:", message)
            end
            AdminDataEvents.BatchMembershipOpCompleted:Fire(success, message, data)
        end)
    end

    -- ç›‘å¬ç”¨æˆ·ä¼šå‘˜ç®¡ç†å“åº”
    if RemoteEvents.ManageUserMembership then
        eventConnections.manageUserMembership = RemoteEvents.ManageUserMembership.OnClientEvent:Connect(function(success, message, data)
            if success then
                print("âœ… [AdminController] ç”¨æˆ·ä¼šå‘˜ç®¡ç†æˆåŠŸ:", message)
            else
                warn("âŒ [AdminController] ç”¨æˆ·ä¼šå‘˜ç®¡ç†å¤±è´¥:", message)
            end
            AdminDataEvents.UserMembershipManaged:Fire(success, message, data)
        end)
    end

    print("âœ… [AdminController] äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- é«˜çº§ç®¡ç†åŠŸèƒ½
-- ==============================================

-- å¤„ç†ç®¡ç†å‘˜æ“ä½œ
function AdminController.handleAdminAction(action, data)
    if action == "check_permission" then
        return AdminController.checkPermission()

    elseif action == "get_all_users" then
        AdminController.getAllUsers()

    elseif action == "set_user_coins" then
        AdminController.setUserCoins(data.userId, data.coins)

    elseif action == "get_user_history" then
        AdminController.getUserHistory(data.userId)

    elseif action == "get_members_list" then
        AdminController.getMembersList()

    elseif action == "add_membership" then
        AdminController.addMembership(data.userId, data.membershipType, data.duration)

    elseif action == "cancel_membership" then
        AdminController.cancelMembership(data.userId)

    elseif action == "extend_membership" then
        AdminController.extendMembership(data.userId, data.days)

    else
        warn("âŒ [AdminController] æœªçŸ¥ç®¡ç†å‘˜æ“ä½œ:", action)
    end
end

-- ==============================================
-- åˆå§‹åŒ–å’Œæ¸…ç†
-- ==============================================

-- åˆå§‹åŒ–ç®¡ç†å‘˜æ§åˆ¶å™¨
function AdminController.initialize()
    print("ğŸš€ [AdminController] å¼€å§‹åˆå§‹åŒ–...")

    -- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    AdminController.initializeEventListeners()

    print("âœ… [AdminController] åˆå§‹åŒ–å®Œæˆ")
end

-- æ¸…ç†èµ„æº
function AdminController.cleanup()
    -- æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥
    for _, connection in pairs(eventConnections) do
        if connection then
            connection:Disconnect()
        end
    end
    eventConnections = {}

    print("ğŸ§¹ [AdminController] èµ„æºå·²æ¸…ç†")
end

return AdminController
