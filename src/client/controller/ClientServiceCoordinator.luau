-- å®¢æˆ·ç«¯æœåŠ¡åè°ƒå™¨
-- åè°ƒè¿œç¨‹æœåŠ¡ã€æœ¬åœ°æ§åˆ¶å™¨å’ŒUIä¹‹é—´çš„é€šä¿¡

local ClientServiceCoordinator = {}

-- å¼•å…¥ä¾èµ–æ¨¡å—
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ä½¿ç”¨ç»å¯¹è·¯å¾„è·å–æ¨¡å—
local function getClientModule(path)
    local player = Players.LocalPlayer
    local playerScripts = player:WaitForChild("PlayerScripts")
    local clientFolder = playerScripts:FindFirstChild("Client")
    if not clientFolder then
        error("âŒ æ‰¾ä¸åˆ°Clientæ–‡ä»¶å¤¹")
    end

    local parts = string.split(path, "/")
    local module = clientFolder
    for _, part in ipairs(parts) do
        module = module:FindFirstChild(part)
        if not module then
            error("âŒ æ‰¾ä¸åˆ°æ¨¡å—è·¯å¾„: " .. path)
        end
    end
    return module
end

local UserRemoteService = require(getClientModule("remote/UserRemoteService"))
local AdminRemoteService = require(getClientModule("remote/AdminRemoteService"))
local DataController = require(getClientModule("controller/DataController"))
local UIController = require(getClientModule("controller/UIController"))

-- åˆå§‹åŒ–æ ‡å¿—
local isInitialized = false

-- å‰ç½®å£°æ˜æœ¬åœ°å‡½æ•°
local setupRemoteServiceBindings, setupUIInteractionBindings, setupDataChangeBindings, handleAdminAction

-- åˆå§‹åŒ–æœåŠ¡åè°ƒå™¨
function ClientServiceCoordinator.initialize()
    if isInitialized then
        print("âš ï¸ [ClientServiceCoordinator] å·²ç»åˆå§‹åŒ–è¿‡äº†")
        return
    end

    print("ğŸš€ [ClientServiceCoordinator] å¼€å§‹åˆå§‹åŒ–...")

    -- ç»‘å®šè¿œç¨‹æœåŠ¡äº‹ä»¶åˆ°æ•°æ®æ§åˆ¶å™¨
    setupRemoteServiceBindings()

    -- ç»‘å®šUIäº¤äº’äº‹ä»¶åˆ°è¿œç¨‹æœåŠ¡
    setupUIInteractionBindings()

    -- ç»‘å®šæ•°æ®å˜åŒ–äº‹ä»¶åˆ°UIæ›´æ–°
    setupDataChangeBindings()

    isInitialized = true
    print("âœ… [ClientServiceCoordinator] åˆå§‹åŒ–å®Œæˆ")
end

-- è®¾ç½®è¿œç¨‹æœåŠ¡ç»‘å®š
function setupRemoteServiceBindings()
    -- ç»‘å®šç”¨æˆ·æ•°æ®æ¥æ”¶
    UserRemoteService.onPlayerDataReceived(function(success, data)
        DataController.setLoadingState(false)
        if success and data then
            DataController.updatePlayerData(data)
        else
            warn("âŒ [ClientServiceCoordinator] è·å–ç©å®¶æ•°æ®å¤±è´¥:", data)
        end
    end)

    -- ç»‘å®šå•†åº—æ•°æ®æ¥æ”¶
    UserRemoteService.onShopDataReceived(function(success, data)
        if success and data then
            DataController.updateShopData(data)
        else
            warn("âŒ [ClientServiceCoordinator] è·å–å•†åº—æ•°æ®å¤±è´¥:", data)
        end
    end)

    -- ç»‘å®šäº¤æ˜“è®°å½•æ¥æ”¶
    UserRemoteService.onTransactionsReceived(function(success, data)
        if success and data then
            DataController.updateTransactions(data)
        else
            warn("âŒ [ClientServiceCoordinator] è·å–äº¤æ˜“è®°å½•å¤±è´¥:", data)
        end
    end)

    -- ç»‘å®šè´­ä¹°ç»“æœ
    UserRemoteService.onBuyResult(function(success, message, newData)
        if success then
            print("âœ… [ClientServiceCoordinator] è´­ä¹°æˆåŠŸ:", message)
            if newData then
                DataController.updatePlayerData(newData)
            end
        else
            warn("âŒ [ClientServiceCoordinator] è´­ä¹°å¤±è´¥:", message)
        end
    end)

    -- ç»‘å®šå‡ºå”®ç»“æœ
    UserRemoteService.onSellResult(function(success, message, newData)
        if success then
            print("âœ… [ClientServiceCoordinator] å‡ºå”®æˆåŠŸ:", message)
            if newData then
                DataController.updatePlayerData(newData)
            end
        else
            warn("âŒ [ClientServiceCoordinator] å‡ºå”®å¤±è´¥:", message)
        end
    end)

    -- ç»‘å®šæ•°æ®åˆ·æ–°
    UserRemoteService.onDataRefreshed(function(success, data)
        if success and data then
            print("ğŸ”„ [ClientServiceCoordinator] æ•°æ®å·²åˆ·æ–°")
            DataController.updatePlayerData(data.playerData)
            DataController.updateShopData(data.shopData)
            DataController.updateTransactions(data.transactions)
        end
    end)

    print("âœ… [ClientServiceCoordinator] è¿œç¨‹æœåŠ¡ç»‘å®šå®Œæˆ")
end

-- è®¾ç½®UIäº¤äº’ç»‘å®š
function setupUIInteractionBindings()
    UIController.Events.UIInteraction:Connect(function(interaction)
        local interactionType = interaction.type
        local data = interaction.data

        if interactionType == UIController.InteractionTypes.BUY_ITEM then
            DataController.setLoadingState(true)
            UserRemoteService.buyItem(data.itemId, data.quantity)

        elseif interactionType == UIController.InteractionTypes.SELL_ITEM then
            DataController.setLoadingState(true)
            UserRemoteService.sellItem(data.itemId, data.quantity)

        elseif interactionType == UIController.InteractionTypes.REFRESH_DATA then
            DataController.setLoadingState(true)
            UserRemoteService.refreshData()

        elseif interactionType == UIController.InteractionTypes.ADMIN_ACTION then
            handleAdminAction(data.action, data.data)

        end
    end)

    print("âœ… [ClientServiceCoordinator] UIäº¤äº’ç»‘å®šå®Œæˆ")
end

-- è®¾ç½®æ•°æ®å˜åŒ–ç»‘å®š
function setupDataChangeBindings()
    -- å½“ç©å®¶æ•°æ®å˜åŒ–æ—¶ï¼Œé€šçŸ¥ç›¸å…³UIæ›´æ–°
    DataController.Events.PlayerDataChanged:Connect(function(newData, oldData)
        -- è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥UIæ›´æ–°çš„é€»è¾‘
        print("ğŸ“Š [ClientServiceCoordinator] ç©å®¶æ•°æ®å·²å˜åŒ–")
    end)

    -- å½“å•†åº—æ•°æ®å˜åŒ–æ—¶ï¼Œé€šçŸ¥ç›¸å…³UIæ›´æ–°
    DataController.Events.ShopDataChanged:Connect(function(newData, oldData)
        print("ğŸª [ClientServiceCoordinator] å•†åº—æ•°æ®å·²å˜åŒ–")
    end)

    -- å½“äº¤æ˜“è®°å½•å˜åŒ–æ—¶ï¼Œé€šçŸ¥ç›¸å…³UIæ›´æ–°
    DataController.Events.TransactionsChanged:Connect(function(newData, oldData)
        print("ğŸ“ [ClientServiceCoordinator] äº¤æ˜“è®°å½•å·²å˜åŒ–")
    end)

    -- å½“åŠ è½½çŠ¶æ€å˜åŒ–æ—¶ï¼Œé€šçŸ¥UIæ›´æ–°
    DataController.Events.LoadingStateChanged:Connect(function(isLoading)
        print("â³ [ClientServiceCoordinator] åŠ è½½çŠ¶æ€:", isLoading and "åŠ è½½ä¸­" or "å·²å®Œæˆ")
    end)

    print("âœ… [ClientServiceCoordinator] æ•°æ®å˜åŒ–ç»‘å®šå®Œæˆ")
end

-- å¤„ç†ç®¡ç†å‘˜æ“ä½œ
function handleAdminAction(action, data)
    if action == "check_permission" then
        local hasPermission = AdminRemoteService.checkPermission()
        if hasPermission then
            print("âœ… [ClientServiceCoordinator] ç®¡ç†å‘˜æƒé™éªŒè¯æˆåŠŸ")
        else
            warn("âŒ [ClientServiceCoordinator] ç®¡ç†å‘˜æƒé™éªŒè¯å¤±è´¥")
        end

    elseif action == "get_all_users" then
        AdminRemoteService.getAllUsers()

    elseif action == "set_user_coins" then
        AdminRemoteService.setUserCoins(data.userId, data.coins)

    -- å¯ä»¥æ·»åŠ æ›´å¤šç®¡ç†å‘˜æ“ä½œ
    end
end

-- åˆå§‹åŒ–æ•°æ®åŠ è½½
function ClientServiceCoordinator.loadInitialData()
    if not isInitialized then
        warn("âŒ [ClientServiceCoordinator] æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ•°æ®")
        return
    end

    print("ğŸ“¡ [ClientServiceCoordinator] å¼€å§‹åŠ è½½åˆå§‹æ•°æ®...")
    DataController.setLoadingState(true)

    -- è¯·æ±‚ç©å®¶æ•°æ®
    UserRemoteService.getPlayerData()

    -- è¯·æ±‚å•†åº—æ•°æ®
    UserRemoteService.getShopData()

    -- è¯·æ±‚äº¤æ˜“è®°å½•
    UserRemoteService.getTransactions()
end

-- è·å–æœåŠ¡çŠ¶æ€
function ClientServiceCoordinator.getStatus()
    return {
        isInitialized = isInitialized,
        dataStats = DataController.getStats(),
        uiState = UIController.getUIState()
    }
end

-- æ¸…ç†èµ„æº
function ClientServiceCoordinator.cleanup()
    DataController.clearData()
    UIController.closeAllUI()
    isInitialized = false
    print("ğŸ§¹ [ClientServiceCoordinator] èµ„æºå·²æ¸…ç†")
end

return ClientServiceCoordinator
