-- æ•°æ®æ§åˆ¶å™¨
-- ç®¡ç†å®¢æˆ·ç«¯æœ¬åœ°æ•°æ®çŠ¶æ€å’Œç¼“å­˜

local BindableEvent = Instance.new("BindableEvent")

local DataController = {}

-- æœ¬åœ°æ•°æ®ç¼“å­˜
local localData = {
    playerData = nil,
    shopData = nil,
    transactions = nil,
    isLoading = false
}

-- äº‹ä»¶ç³»ç»Ÿ
DataController.Events = {
    PlayerDataChanged = BindableEvent.Event,
    ShopDataChanged = BindableEvent.Event,
    TransactionsChanged = BindableEvent.Event,
    LoadingStateChanged = BindableEvent.Event
}

-- å†…éƒ¨äº‹ä»¶å¯¹è±¡
local internalEvents = {
    PlayerDataChanged = Instance.new("BindableEvent"),
    ShopDataChanged = Instance.new("BindableEvent"),
    TransactionsChanged = Instance.new("BindableEvent"),
    LoadingStateChanged = Instance.new("BindableEvent")
}

-- é‡æ–°åˆ†é…äº‹ä»¶
for eventName, event in pairs(internalEvents) do
    DataController.Events[eventName] = event.Event
end

-- è®¾ç½®åŠ è½½çŠ¶æ€
function DataController.setLoadingState(isLoading)
    if localData.isLoading ~= isLoading then
        localData.isLoading = isLoading
        internalEvents.LoadingStateChanged:Fire(isLoading)
        print("ğŸ”„ [DataController] åŠ è½½çŠ¶æ€:", isLoading and "åŠ è½½ä¸­" or "å·²å®Œæˆ")
    end
end

-- è·å–åŠ è½½çŠ¶æ€
function DataController.isLoading()
    return localData.isLoading
end

-- æ›´æ–°ç©å®¶æ•°æ®
function DataController.updatePlayerData(newData)
    if newData then
        local oldData = localData.playerData
        localData.playerData = newData
        internalEvents.PlayerDataChanged:Fire(newData, oldData)
        print("âœ… [DataController] ç©å®¶æ•°æ®å·²æ›´æ–°")
    end
end

-- è·å–ç©å®¶æ•°æ®
function DataController.getPlayerData()
    return localData.playerData
end

-- æ›´æ–°å•†åº—æ•°æ®
function DataController.updateShopData(newData)
    if newData then
        local oldData = localData.shopData
        localData.shopData = newData
        internalEvents.ShopDataChanged:Fire(newData, oldData)
        print("âœ… [DataController] å•†åº—æ•°æ®å·²æ›´æ–°")
    end
end

-- è·å–å•†åº—æ•°æ®
function DataController.getShopData()
    return localData.shopData
end

-- æ›´æ–°äº¤æ˜“è®°å½•
function DataController.updateTransactions(newData)
    if newData then
        local oldData = localData.transactions
        localData.transactions = newData
        internalEvents.TransactionsChanged:Fire(newData, oldData)
        print("âœ… [DataController] äº¤æ˜“è®°å½•å·²æ›´æ–°")
    end
end

-- è·å–äº¤æ˜“è®°å½•
function DataController.getTransactions()
    return localData.transactions
end

-- è·å–ç©å®¶é‡‘å¸
function DataController.getPlayerCoins()
    if localData.playerData then
        return localData.playerData.coins or 0
    end
    return 0
end

-- è·å–ç©å®¶åº“å­˜
function DataController.getPlayerInventory()
    if localData.playerData then
        return localData.playerData.inventory or {}
    end
    return {}
end

-- è·å–ä¼šå‘˜çŠ¶æ€
function DataController.getMembershipStatus()
    if localData.playerData then
        return localData.playerData.membership
    end
    return nil
end

-- æ ¹æ®IDè·å–ç‰©å“ä¿¡æ¯
function DataController.getItemById(itemId)
    if localData.shopData and localData.shopData.items then
        return localData.shopData.items[itemId]
    end
    return nil
end

-- æ£€æŸ¥æ˜¯å¦å¯ä»¥è´­ä¹°ç‰©å“
function DataController.canBuyItem(itemId, quantity)
    local item = DataController.getItemById(itemId)
    if not item then
        return false, "ç‰©å“ä¸å­˜åœ¨"
    end

    local playerCoins = DataController.getPlayerCoins()
    local totalCost = item.price * quantity

    if playerCoins < totalCost then
        return false, "é‡‘å¸ä¸è¶³"
    end

    if item.maxQuantity and item.maxQuantity > 0 and item.currentStock < quantity then
        return false, "åº“å­˜ä¸è¶³"
    end

    return true, "å¯ä»¥è´­ä¹°"
end

-- æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡ºå”®ç‰©å“
function DataController.canSellItem(itemId, quantity)
    local item = DataController.getItemById(itemId)
    if not item then
        return false, "ç‰©å“ä¸å­˜åœ¨"
    end

    if not item.canSell then
        return false, "è¯¥ç‰©å“ä¸å¯å‡ºå”®"
    end

    local inventory = DataController.getPlayerInventory()
    local ownedQuantity = inventory[itemId] or 0

    if ownedQuantity < quantity then
        return false, "åº“å­˜ä¸è¶³"
    end

    return true, "å¯ä»¥å‡ºå”®"
end

-- æ¸…ç©ºæœ¬åœ°æ•°æ®
function DataController.clearData()
    localData.playerData = nil
    localData.shopData = nil
    localData.transactions = nil
    localData.isLoading = false
    print("ğŸ§¹ [DataController] æœ¬åœ°æ•°æ®å·²æ¸…ç©º")
end

-- è·å–ç»Ÿè®¡ä¿¡æ¯
function DataController.getStats()
    return {
        hasPlayerData = localData.playerData ~= nil,
        hasShopData = localData.shopData ~= nil,
        hasTransactions = localData.transactions ~= nil,
        isLoading = localData.isLoading,
        itemCount = localData.shopData and #localData.shopData.items or 0,
        transactionCount = localData.transactions and #localData.transactions or 0
    }
end

return DataController
