-- ç”¨æˆ·æ§åˆ¶å™¨
-- æ•´åˆç”¨æˆ·ç›¸å…³çš„è¿œç¨‹é€šä¿¡å’Œæœ¬åœ°æ•°æ®ç®¡ç†åŠŸèƒ½

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local UserController = {}

-- æœ¬åœ°æ•°æ®ç¼“å­˜
local localData = {
    playerData = nil,
    shopData = nil,
    transactions = nil,
    isLoading = false
}

-- ç¼“å­˜è¿œç¨‹äº‹ä»¶
local Events = nil
local RemoteEvents = {}

-- å†…éƒ¨äº‹ä»¶ç³»ç»Ÿ
local internalEvents = {
    PlayerDataChanged = Instance.new("BindableEvent"),
    ShopDataChanged = Instance.new("BindableEvent"),
    TransactionsChanged = Instance.new("BindableEvent"),
    LoadingStateChanged = Instance.new("BindableEvent"),
    BuyResult = Instance.new("BindableEvent"),
    SellResult = Instance.new("BindableEvent"),
    DataRefreshed = Instance.new("BindableEvent")
}

-- å¯¼å‡ºäº‹ä»¶
UserController.Events = {}
for eventName, event in pairs(internalEvents) do
    UserController.Events[eventName] = event.Event
end

-- åˆå§‹åŒ–è¿œç¨‹äº‹ä»¶
local function initializeEvents()
    if not Events then
        local success, result = pcall(function()
            local SharedModules = ReplicatedStorage:WaitForChild("SharedModules", 10)
            if not SharedModules then
                error("âŒ æ— æ³•æ‰¾åˆ°SharedModulesæ–‡ä»¶å¤¹")
            end
            local EventsModule = SharedModules:WaitForChild("ShopEvents", 10)
            if not EventsModule then
                error("âŒ æ— æ³•æ‰¾åˆ°ShopEventsæ¨¡å—")
            end
            return require(EventsModule)
        end)

        if success then
            Events = result
            RemoteEvents = {
                GetPlayerData = Events.User.GetPlayerData,
                GetShopData = Events.User.GetShopData,
                GetTransactions = Events.User.GetTransactions,
                BuyItem = Events.User.BuyItem,
                SellItem = Events.User.SellItem,
                RefreshData = Events.User.RefreshData
            }
            print("âœ… [UserController] è¿œç¨‹äº‹ä»¶åˆå§‹åŒ–æˆåŠŸ")
        else
            warn("âŒ [UserController] è¿œç¨‹äº‹ä»¶åˆå§‹åŒ–å¤±è´¥:", result)
        end
    end
end

-- ==============================================
-- æ•°æ®çŠ¶æ€ç®¡ç†
-- ==============================================

-- è®¾ç½®åŠ è½½çŠ¶æ€
function UserController.setLoadingState(isLoading)
    if localData.isLoading ~= isLoading then
        localData.isLoading = isLoading
        internalEvents.LoadingStateChanged:Fire(isLoading)
        print("ğŸ”„ [UserController] åŠ è½½çŠ¶æ€:", isLoading and "åŠ è½½ä¸­" or "å·²å®Œæˆ")
    end
end

-- è·å–åŠ è½½çŠ¶æ€
function UserController.isLoading()
    return localData.isLoading
end

-- æ›´æ–°ç©å®¶æ•°æ®
function UserController.updatePlayerData(newData)
    if newData then
        local oldData = localData.playerData
        localData.playerData = newData
        internalEvents.PlayerDataChanged:Fire(newData, oldData)
        print("âœ… [UserController] ç©å®¶æ•°æ®å·²æ›´æ–°")
    end
end

-- è·å–ç©å®¶æ•°æ®
function UserController.getPlayerData()
    return localData.playerData
end

-- æ›´æ–°å•†åº—æ•°æ®
function UserController.updateShopData(newData)
    if newData then
        local oldData = localData.shopData
        localData.shopData = newData
        internalEvents.ShopDataChanged:Fire(newData, oldData)
        print("âœ… [UserController] å•†åº—æ•°æ®å·²æ›´æ–°")
    end
end

-- è·å–å•†åº—æ•°æ®
function UserController.getShopData()
    return localData.shopData
end

-- æ›´æ–°äº¤æ˜“è®°å½•
function UserController.updateTransactions(newData)
    if newData then
        local oldData = localData.transactions
        localData.transactions = newData
        internalEvents.TransactionsChanged:Fire(newData, oldData)
        print("âœ… [UserController] äº¤æ˜“è®°å½•å·²æ›´æ–°")
    end
end

-- è·å–äº¤æ˜“è®°å½•
function UserController.getTransactions()
    return localData.transactions
end

-- è·å–ç©å®¶é‡‘å¸
function UserController.getPlayerCoins()
    if localData.playerData then
        return localData.playerData.coins or 0
    end
    return 0
end

-- è·å–ç©å®¶åº“å­˜
function UserController.getPlayerInventory()
    if localData.playerData then
        return localData.playerData.inventory or {}
    end
    return {}
end

-- è·å–ä¼šå‘˜çŠ¶æ€
function UserController.getMembershipStatus()
    if localData.playerData then
        return localData.playerData.membership
    end
    return nil
end

-- æ ¹æ®IDè·å–ç‰©å“ä¿¡æ¯
function UserController.getItemById(itemId)
    if localData.shopData and localData.shopData[itemId] then
        return localData.shopData[itemId]
    end
    return nil
end

-- æ£€æŸ¥æ˜¯å¦å¯ä»¥è´­ä¹°ç‰©å“
function UserController.canBuyItem(itemId, quantity)
    local item = UserController.getItemById(itemId)
    if not item then
        return false, "ç‰©å“ä¸å­˜åœ¨"
    end

    local playerCoins = UserController.getPlayerCoins()
    local totalCost = item.price * quantity

    if playerCoins < totalCost then
        return false, "é‡‘å¸ä¸è¶³"
    end

    if item.maxQuantity and item.maxQuantity > 0 and item.currentStock < quantity then
        return false, "åº“å­˜ä¸è¶³"
    end

    return true, "å¯ä»¥è´­ä¹°"
end

-- æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡ºå”®ç‰©å“
function UserController.canSellItem(itemId, quantity)
    local item = UserController.getItemById(itemId)
    if not item then
        return false, "ç‰©å“ä¸å­˜åœ¨"
    end

    if not item.canSell then
        return false, "è¯¥ç‰©å“ä¸å¯å‡ºå”®"
    end

    local inventory = UserController.getPlayerInventory()
    local ownedQuantity = inventory[itemId] or 0

    if ownedQuantity < quantity then
        return false, "åº“å­˜ä¸è¶³"
    end

    return true, "å¯ä»¥å‡ºå”®"
end

-- ==============================================
-- è¿œç¨‹é€šä¿¡åŠŸèƒ½
-- ==============================================

-- è·å–ç©å®¶æ•°æ®
function UserController.requestPlayerData()
    initializeEvents()
    if RemoteEvents.GetPlayerData then
        RemoteEvents.GetPlayerData:FireServer()
        print("ğŸ“¡ [UserController] è¯·æ±‚ç©å®¶æ•°æ®")
    end
end

-- è·å–å•†åº—æ•°æ®
function UserController.requestShopData()
    initializeEvents()
    if RemoteEvents.GetShopData then
        RemoteEvents.GetShopData:FireServer()
        print("ğŸ“¡ [UserController] è¯·æ±‚å•†åº—æ•°æ®")
    end
end

-- è·å–äº¤æ˜“è®°å½•
function UserController.requestTransactions()
    initializeEvents()
    if RemoteEvents.GetTransactions then
        RemoteEvents.GetTransactions:FireServer()
        print("ğŸ“¡ [UserController] è¯·æ±‚äº¤æ˜“è®°å½•")
    end
end

-- è´­ä¹°ç‰©å“
function UserController.buyItem(itemId, quantity)
    initializeEvents()
    if RemoteEvents.BuyItem then
        UserController.setLoadingState(true)
        RemoteEvents.BuyItem:FireServer(itemId, quantity)
        print("ğŸ›’ [UserController] å‘é€è´­ä¹°è¯·æ±‚:", itemId, "æ•°é‡:", quantity)
    end
end

-- å‡ºå”®ç‰©å“
function UserController.sellItem(itemId, quantity)
    initializeEvents()
    if RemoteEvents.SellItem then
        UserController.setLoadingState(true)
        RemoteEvents.SellItem:FireServer(itemId, quantity)
        print("ğŸ’° [UserController] å‘é€å‡ºå”®è¯·æ±‚:", itemId, "æ•°é‡:", quantity)
    end
end

-- åˆ·æ–°æ•°æ®
function UserController.refreshData()
    initializeEvents()
    if RemoteEvents.RefreshData then
        UserController.setLoadingState(true)
        RemoteEvents.RefreshData:FireServer()
        print("ğŸ”„ [UserController] è¯·æ±‚åˆ·æ–°æ•°æ®")
    end
end

-- ==============================================
-- äº‹ä»¶ç›‘å¬å’Œå¤„ç†
-- ==============================================

-- ç›‘å¬æœåŠ¡ç«¯æ•°æ®æ›´æ–°çš„å›è°ƒå‡½æ•°
local eventConnections = {}

-- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
function UserController.initializeEventListeners()
    initializeEvents()

    -- ç›‘å¬ç©å®¶æ•°æ®å“åº”
    if RemoteEvents.GetPlayerData then
        eventConnections.getPlayerData = RemoteEvents.GetPlayerData.OnClientEvent:Connect(function(success, data)
            UserController.setLoadingState(false)
            if success and data then
                UserController.updatePlayerData(data)
            else
                warn("âŒ [UserController] è·å–ç©å®¶æ•°æ®å¤±è´¥:", data)
            end
        end)
    end

    -- ç›‘å¬å•†åº—æ•°æ®å“åº”
    if RemoteEvents.GetShopData then
        eventConnections.getShopData = RemoteEvents.GetShopData.OnClientEvent:Connect(function(success, data)
            if success and data then
                UserController.updateShopData(data)
            else
                warn("âŒ [UserController] è·å–å•†åº—æ•°æ®å¤±è´¥:", data)
            end
        end)
    end

    -- ç›‘å¬äº¤æ˜“è®°å½•å“åº”
    if RemoteEvents.GetTransactions then
        eventConnections.getTransactions = RemoteEvents.GetTransactions.OnClientEvent:Connect(function(success, errorMsg, responseData)
            if success and responseData then
                UserController.updateTransactions(responseData.transactions)
            else
                warn("âŒ [UserController] è·å–äº¤æ˜“è®°å½•å¤±è´¥:", errorMsg)
            end
        end)
    end

    -- ç›‘å¬è´­ä¹°ç»“æœ
    if RemoteEvents.BuyItem then
        eventConnections.buyItem = RemoteEvents.BuyItem.OnClientEvent:Connect(function(success, message, newData)
            UserController.setLoadingState(false)
            if success then
                print("âœ… [UserController] è´­ä¹°æˆåŠŸ:", message)
                if newData then
                    UserController.updatePlayerData(newData)
                end
            else
                warn("âŒ [UserController] è´­ä¹°å¤±è´¥:", message)
            end
            internalEvents.BuyResult:Fire(success, message, newData)
        end)
    end

    -- ç›‘å¬å‡ºå”®ç»“æœ
    if RemoteEvents.SellItem then
        eventConnections.sellItem = RemoteEvents.SellItem.OnClientEvent:Connect(function(success, message, newData)
            UserController.setLoadingState(false)
            if success then
                print("âœ… [UserController] å‡ºå”®æˆåŠŸ:", message)
                if newData then
                    UserController.updatePlayerData(newData)
                end
            else
                warn("âŒ [UserController] å‡ºå”®å¤±è´¥:", message)
            end
            internalEvents.SellResult:Fire(success, message, newData)
        end)
    end

    -- ç›‘å¬æ•°æ®åˆ·æ–°
    if RemoteEvents.RefreshData then
        eventConnections.refreshData = RemoteEvents.RefreshData.OnClientEvent:Connect(function(success, data)
            UserController.setLoadingState(false)
            if success and data then
                print("ğŸ”„ [UserController] æ•°æ®å·²åˆ·æ–°")
                UserController.updatePlayerData(data.playerData)
                UserController.updateShopData(data.shopData)
                if data.transactions then
                    UserController.updateTransactions(data.transactions)
                end
            end
            internalEvents.DataRefreshed:Fire(success, data)
        end)
    end

    print("âœ… [UserController] äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- åˆå§‹åŒ–å’Œæ¸…ç†
-- ==============================================

-- åˆå§‹åŒ–ç”¨æˆ·æ§åˆ¶å™¨
function UserController.initialize()
    print("ğŸš€ [UserController] å¼€å§‹åˆå§‹åŒ–...")

    -- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    UserController.initializeEventListeners()

    print("âœ… [UserController] åˆå§‹åŒ–å®Œæˆ")
end

-- åŠ è½½åˆå§‹æ•°æ®
function UserController.loadInitialData()
    print("ğŸ“¡ [UserController] å¼€å§‹åŠ è½½åˆå§‹æ•°æ®...")
    UserController.setLoadingState(true)

    -- è¯·æ±‚ç©å®¶æ•°æ®
    UserController.requestPlayerData()

    -- è¯·æ±‚å•†åº—æ•°æ®
    UserController.requestShopData()

    -- è¯·æ±‚äº¤æ˜“è®°å½•
    UserController.requestTransactions()
end

-- æ¸…ç©ºæœ¬åœ°æ•°æ®
function UserController.clearData()
    localData.playerData = nil
    localData.shopData = nil
    localData.transactions = nil
    localData.isLoading = false
    print("ğŸ§¹ [UserController] æœ¬åœ°æ•°æ®å·²æ¸…ç©º")
end

-- è·å–ç»Ÿè®¡ä¿¡æ¯
function UserController.getStats()
    return {
        hasPlayerData = localData.playerData ~= nil,
        hasShopData = localData.shopData ~= nil,
        hasTransactions = localData.transactions ~= nil,
        isLoading = localData.isLoading,
        itemCount = localData.shopData and #localData.shopData or 0,
        transactionCount = localData.transactions and #localData.transactions or 0
    }
end

-- æ¸…ç†èµ„æº
function UserController.cleanup()
    -- æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥
    for _, connection in pairs(eventConnections) do
        if connection then
            connection:Disconnect()
        end
    end
    eventConnections = {}

    UserController.clearData()
    print("ğŸ§¹ [UserController] èµ„æºå·²æ¸…ç†")
end

return UserController
