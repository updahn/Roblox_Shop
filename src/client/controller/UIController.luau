-- UIæ§åˆ¶å™¨
-- ç®¡ç†UIçŠ¶æ€å’Œé€»è¾‘ï¼Œåˆ†ç¦»æ•°æ®å¤„ç†

local UIController = {}

-- UIçŠ¶æ€ç®¡ç†
local uiState = {
    shopVisible = false,
    tutorialVisible = false,
    adminPanelVisible = false,
    droneUIVisible = false
}

-- å†…éƒ¨äº‹ä»¶ç³»ç»Ÿ
local uiEvents = {
    ShopVisibilityChanged = Instance.new("BindableEvent"),
    TutorialVisibilityChanged = Instance.new("BindableEvent"),
    AdminPanelVisibilityChanged = Instance.new("BindableEvent"),
    DroneUIVisibilityChanged = Instance.new("BindableEvent"),
    UIInteraction = Instance.new("BindableEvent")
}

-- å¯¼å‡ºäº‹ä»¶
UIController.Events = {
    ShopVisibilityChanged = uiEvents.ShopVisibilityChanged.Event,
    TutorialVisibilityChanged = uiEvents.TutorialVisibilityChanged.Event,
    AdminPanelVisibilityChanged = uiEvents.AdminPanelVisibilityChanged.Event,
    DroneUIVisibilityChanged = uiEvents.DroneUIVisibilityChanged.Event,
    UIInteraction = uiEvents.UIInteraction.Event
}

-- å•†åº—UIæ§åˆ¶
function UIController.setShopVisible(visible)
    if uiState.shopVisible ~= visible then
        uiState.shopVisible = visible
        uiEvents.ShopVisibilityChanged:Fire(visible)
        print("ğŸª [UIController] å•†åº—UI:", visible and "æ˜¾ç¤º" or "éšè—")
    end
end

function UIController.toggleShop()
    UIController.setShopVisible(not uiState.shopVisible)
end

function UIController.isShopVisible()
    return uiState.shopVisible
end

-- æ•™ç¨‹UIæ§åˆ¶
function UIController.setTutorialVisible(visible)
    if uiState.tutorialVisible ~= visible then
        uiState.tutorialVisible = visible
        uiEvents.TutorialVisibilityChanged:Fire(visible)
        print("ğŸ“– [UIController] æ•™ç¨‹UI:", visible and "æ˜¾ç¤º" or "éšè—")
    end
end

function UIController.toggleTutorial()
    UIController.setTutorialVisible(not uiState.tutorialVisible)
end

function UIController.isTutorialVisible()
    return uiState.tutorialVisible
end

-- ç®¡ç†å‘˜é¢æ¿æ§åˆ¶
function UIController.setAdminPanelVisible(visible)
    if uiState.adminPanelVisible ~= visible then
        uiState.adminPanelVisible = visible
        uiEvents.AdminPanelVisibilityChanged:Fire(visible)
        print("ğŸ‘‘ [UIController] ç®¡ç†å‘˜é¢æ¿:", visible and "æ˜¾ç¤º" or "éšè—")
    end
end

function UIController.toggleAdminPanel()
    UIController.setAdminPanelVisible(not uiState.adminPanelVisible)
end

function UIController.isAdminPanelVisible()
    return uiState.adminPanelVisible
end

-- æ— äººæœºUIæ§åˆ¶
function UIController.setDroneUIVisible(visible)
    if uiState.droneUIVisible ~= visible then
        uiState.droneUIVisible = visible
        uiEvents.DroneUIVisibilityChanged:Fire(visible)
        print("ğŸ¤– [UIController] æ— äººæœºUI:", visible and "æ˜¾ç¤º" or "éšè—")
    end
end

function UIController.toggleDroneUI()
    UIController.setDroneUIVisible(not uiState.droneUIVisible)
end

function UIController.isDroneUIVisible()
    return uiState.droneUIVisible
end

-- å…³é—­æ‰€æœ‰UI
function UIController.closeAllUI()
    UIController.setShopVisible(false)
    UIController.setTutorialVisible(false)
    UIController.setAdminPanelVisible(false)
    UIController.setDroneUIVisible(false)
    print("âŒ [UIController] æ‰€æœ‰UIå·²å…³é—­")
end

-- UIäº¤äº’äº‹ä»¶è§¦å‘
function UIController.fireInteractionEvent(eventType, data)
    uiEvents.UIInteraction:Fire({
        type = eventType,
        data = data,
        timestamp = tick()
    })
end

-- é¢„å®šä¹‰çš„UIäº¤äº’ç±»å‹
UIController.InteractionTypes = {
    BUY_ITEM = "buy_item",
    SELL_ITEM = "sell_item",
    SPAWN_DRONE = "spawn_drone",
    RECALL_DRONE = "recall_drone",
    SWITCH_DRONE_MODE = "switch_drone_mode",
    ADMIN_ACTION = "admin_action",
    REFRESH_DATA = "refresh_data"
}

-- è§¦å‘è´­ä¹°ç‰©å“äº‹ä»¶
function UIController.triggerBuyItem(itemId, quantity)
    UIController.fireInteractionEvent(UIController.InteractionTypes.BUY_ITEM, {
        itemId = itemId,
        quantity = quantity
    })
end

-- è§¦å‘å‡ºå”®ç‰©å“äº‹ä»¶
function UIController.triggerSellItem(itemId, quantity)
    UIController.fireInteractionEvent(UIController.InteractionTypes.SELL_ITEM, {
        itemId = itemId,
        quantity = quantity
    })
end

-- è§¦å‘æ— äººæœºç›¸å…³äº‹ä»¶
function UIController.triggerDroneAction(action, data)
    local actionType = nil
    if action == "spawn" then
        actionType = UIController.InteractionTypes.SPAWN_DRONE
    elseif action == "recall" then
        actionType = UIController.InteractionTypes.RECALL_DRONE
    elseif action == "switch_mode" then
        actionType = UIController.InteractionTypes.SWITCH_DRONE_MODE
    end

    if actionType then
        UIController.fireInteractionEvent(actionType, data or {})
    end
end

-- è§¦å‘ç®¡ç†å‘˜æ“ä½œäº‹ä»¶
function UIController.triggerAdminAction(action, data)
    UIController.fireInteractionEvent(UIController.InteractionTypes.ADMIN_ACTION, {
        action = action,
        data = data
    })
end

-- è§¦å‘æ•°æ®åˆ·æ–°äº‹ä»¶
function UIController.triggerRefreshData()
    UIController.fireInteractionEvent(UIController.InteractionTypes.REFRESH_DATA, {})
end

-- è·å–å½“å‰UIçŠ¶æ€
function UIController.getUIState()
    return {
        shopVisible = uiState.shopVisible,
        tutorialVisible = uiState.tutorialVisible,
        adminPanelVisible = uiState.adminPanelVisible,
        droneUIVisible = uiState.droneUIVisible
    }
end

-- æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•UIæ˜¾ç¤º
function UIController.hasVisibleUI()
    return uiState.shopVisible or uiState.tutorialVisible or
           uiState.adminPanelVisible or uiState.droneUIVisible
end

return UIController
