-- ç»Ÿä¸€çš„ç®¡ç†å‘˜æ§åˆ¶é¢æ¿
-- æ•´åˆäº†ç”¨æˆ·ç®¡ç†ã€è®°å½•æŸ¥çœ‹ã€ä¼šå‘˜ç®¡ç†ç­‰åŠŸèƒ½

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))
local ShopUtils = require(script.Parent.Parent:WaitForChild("ShopUtils"))
local ShopRecords = require(script.Parent.Parent.user:WaitForChild("ShopRecords"))

local player = Players.LocalPlayer

local ShopAdminPanel = {}

-- UI å…ƒç´ å¼•ç”¨
local adminFrame = nil
local contentArea = nil
local tabButtons = {}
local currentTab = "users"
local currentScreenGui = nil  -- å­˜å‚¨ä¼ å…¥çš„screenGuiå¼•ç”¨

-- æ•°æ®å­˜å‚¨
local allPlayersData = {}
local membershipData = {}
local currentViewingPlayer = nil  -- å½“å‰æŸ¥çœ‹çš„ç©å®¶

-- æ ‡ç­¾é…ç½® - é»˜è®¤åªæ˜¾ç¤ºç”¨æˆ·ç®¡ç†
local tabs = {
    {id = "users", name = "ğŸ‘¤ ç”¨æˆ·ç®¡ç†", icon = "ğŸ‘¤"}
}

-- æ‰€æœ‰å¯ç”¨æ ‡ç­¾ï¼ˆç”¨äºåŠ¨æ€æ·»åŠ ï¼‰
local allTabs = {
    {id = "users", name = "ğŸ‘¤ ç”¨æˆ·ç®¡ç†", icon = "ğŸ‘¤"},
    {id = "records", name = "ğŸ“Š äº¤æ˜“è®°å½•", icon = "ğŸ“Š"},
    {id = "membership", name = "ğŸ‘¥ ä¼šå‘˜ç®¡ç†", icon = "ğŸ‘¥"}
}

-- æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿ä¸»å…¥å£
function ShopAdminPanel.showAdminPanel(screenGui, showNotification)
    print("ğŸ”§ [ç»Ÿä¸€ç®¡ç†é¢æ¿] æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿")

    -- ä¿å­˜screenGuiå¼•ç”¨ä»¥ä¾›åç»­ä½¿ç”¨
    currentScreenGui = screenGui

    -- æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - å¢åŠ å®¹é”™æœºåˆ¶
    local isAdmin = false
    print("ğŸ” [ç»Ÿä¸€ç®¡ç†é¢æ¿] å¼€å§‹æƒé™æ£€æŸ¥ - ç©å®¶:", player.Name)
    local adminCheckSuccess, adminResult = pcall(function()
        return Config.isValidAdmin(player)
    end)

    if adminCheckSuccess then
        isAdmin = adminResult
        print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] Configæƒé™æ£€æŸ¥æˆåŠŸ:", player.Name, "->", isAdmin)
    end

    if not isAdmin then
        print("âŒ [ç»Ÿä¸€ç®¡ç†é¢æ¿] ç®¡ç†å‘˜æƒé™æ£€æŸ¥å¤±è´¥")
        if showNotification then
            showNotification("âŒ æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™", false)
        end
        return
    end

    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡ï¼Œå¼€å§‹åˆ›å»ºç®¡ç†å‘˜é¢æ¿")

    -- å¦‚æœé¢æ¿å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
    if adminFrame then
        adminFrame:Destroy()
        adminFrame = nil
    end

    -- åˆ›å»ºä¸»ç®¡ç†é¢æ¿
    adminFrame = Instance.new("Frame")
    adminFrame.Name = "AdminPanel"
    adminFrame.Size = UDim2.new(0, 900, 0, 650)
    adminFrame.Position = UDim2.new(0.5, -450, 0.5, -325)
    adminFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    adminFrame.BorderSizePixel = 0
    adminFrame.ZIndex = 3000
    adminFrame.Parent = screenGui
    ShopUtils.createCorner(adminFrame, 12)

    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] ä¸»é¢æ¿åˆ›å»ºæˆåŠŸ")

    -- åˆ›å»ºæ ‡é¢˜æ 
    ShopAdminPanel._createTitleBar(adminFrame)
    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] æ ‡é¢˜æ åˆ›å»ºæˆåŠŸ")

    -- åˆ›å»ºæ ‡ç­¾æ 
    ShopAdminPanel._createTabBar(adminFrame)
    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] æ ‡ç­¾æ åˆ›å»ºæˆåŠŸ")

    -- åˆ›å»ºå†…å®¹åŒºåŸŸ
    ShopAdminPanel._createContentArea(adminFrame)
    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] å†…å®¹åŒºåŸŸåˆ›å»ºæˆåŠŸ")

    -- ç­‰å¾…ä¸€å¸§ï¼Œç¡®ä¿UIå…ƒç´ å®Œå…¨åˆ›å»º
    wait()

    -- æ˜¾ç¤ºé»˜è®¤æ ‡ç­¾
    print("ğŸ”„ [ç»Ÿä¸€ç®¡ç†é¢æ¿] å‡†å¤‡åˆ‡æ¢åˆ°ç”¨æˆ·ç®¡ç†æ ‡ç­¾")
    ShopAdminPanel.switchTab("users", showNotification)
end

-- åˆ›å»ºæ ‡é¢˜æ 
function ShopAdminPanel._createTitleBar(parentFrame)
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 60)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = parentFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "ğŸ‘‘ ç®¡ç†å‘˜æ§åˆ¶é¢æ¿"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 20
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -100, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- å…³é—­æŒ‰é’®
    local closeBtn = ShopUtils.createButton("âœ—", ShopUtils.COLORS.ERROR, titleBar, function()
        adminFrame:Destroy()
        adminFrame = nil
    end)
    closeBtn.Position = UDim2.new(1, -50, 0, 10)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 20
end

-- åˆ›å»ºæ ‡ç­¾æ 
function ShopAdminPanel._createTabBar(parentFrame)
    local tabBar = Instance.new("Frame")
    tabBar.Name = "TabBar"
    tabBar.Size = UDim2.new(1, -20, 0, 50)
    tabBar.Position = UDim2.new(0, 10, 0, 70)
    tabBar.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    tabBar.BorderSizePixel = 0
    tabBar.Parent = parentFrame
    ShopUtils.createCorner(tabBar, 8)

    ShopAdminPanel._updateTabBar()
end

-- æ›´æ–°æ ‡ç­¾æ æ˜¾ç¤º
function ShopAdminPanel._updateTabBar()
    local tabBar = adminFrame and adminFrame:FindFirstChild("TabBar")
    if not tabBar then
        print("âš ï¸ [ç»Ÿä¸€ç®¡ç†é¢æ¿] æœªæ‰¾åˆ°TabBarå…ƒç´ ")
        return
    end

    print("ğŸ”„ [ç»Ÿä¸€ç®¡ç†é¢æ¿] æ›´æ–°æ ‡ç­¾æ ï¼Œæ ‡ç­¾æ•°é‡:", #tabs)

    -- æ¸…é™¤ç°æœ‰æŒ‰é’®
    for _, child in pairs(tabBar:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    local buttonWidth = 1 / #tabs
    tabButtons = {}

    for i, tab in ipairs(tabs) do
        print("ğŸ·ï¸ [ç»Ÿä¸€ç®¡ç†é¢æ¿] åˆ›å»ºæ ‡ç­¾æŒ‰é’®:", tab.name, "ID:", tab.id)

        local tabButton = Instance.new("TextButton")
        tabButton.Name = "Tab_" .. tab.id
        tabButton.Size = UDim2.new(buttonWidth, -5, 1, -10)
        tabButton.Position = UDim2.new(buttonWidth * (i-1), 5, 0, 5)
        tabButton.BackgroundColor3 = tab.id == currentTab and ShopUtils.COLORS.ACCENT or ShopUtils.COLORS.PRIMARY
        tabButton.Text = tab.name
        tabButton.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        tabButton.TextSize = 14
        tabButton.Font = Enum.Font.SourceSansBold
        tabButton.BorderSizePixel = 0
        tabButton.Parent = tabBar
        ShopUtils.createCorner(tabButton, 6)

        tabButton.MouseButton1Click:Connect(function()
            print("ğŸ–±ï¸ [ç»Ÿä¸€ç®¡ç†é¢æ¿] ç‚¹å‡»æ ‡ç­¾:", tab.id)
            ShopAdminPanel.switchTab(tab.id)
        end)

        tabButtons[tab.id] = tabButton
    end

    print("âœ… [ç»Ÿä¸€ç®¡ç†é¢æ¿] æ ‡ç­¾æ æ›´æ–°å®Œæˆï¼Œåˆ›å»ºäº†", #tabs, "ä¸ªæŒ‰é’®")
end

-- æ·»åŠ æ ‡ç­¾
function ShopAdminPanel._addTab(tabId)
    -- æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
    for _, tab in ipairs(tabs) do
        if tab.id == tabId then
            return
        end
    end

    -- ä»allTabsä¸­æ‰¾åˆ°å¯¹åº”æ ‡ç­¾
    for _, tab in ipairs(allTabs) do
        if tab.id == tabId then
            table.insert(tabs, tab)
            break
        end
    end

    ShopAdminPanel._updateTabBar()
end

-- ç§»é™¤æ ‡ç­¾ï¼ˆé™¤äº†ç”¨æˆ·ç®¡ç†ï¼‰
function ShopAdminPanel._removeTab(tabId)
    if tabId == "users" then return end

    for i, tab in ipairs(tabs) do
        if tab.id == tabId then
            table.remove(tabs, i)
            break
        end
    end

    ShopAdminPanel._updateTabBar()
end

-- é‡ç½®ä¸ºé»˜è®¤æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºç”¨æˆ·ç®¡ç†ï¼‰
function ShopAdminPanel._resetToDefaultTabs()
    tabs = {{id = "users", name = "ğŸ‘¤ ç”¨æˆ·ç®¡ç†", icon = "ğŸ‘¤"}}
    currentTab = "users"
    currentViewingPlayer = nil
    ShopAdminPanel._updateTabBar()
end

-- åˆ›å»ºå†…å®¹åŒºåŸŸ
function ShopAdminPanel._createContentArea(parentFrame)
    contentArea = Instance.new("ScrollingFrame")
    contentArea.Name = "ContentArea"
    contentArea.Size = UDim2.new(1, -20, 1, -140)
    contentArea.Position = UDim2.new(0, 10, 0, 130)
    contentArea.BackgroundTransparency = 1
    contentArea.BorderSizePixel = 0
    contentArea.ScrollBarThickness = 8
    contentArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    contentArea.Parent = parentFrame
end

-- åˆ‡æ¢æ ‡ç­¾
function ShopAdminPanel.switchTab(tabId, showNotification)
    -- å…è®¸é‡å¤åˆ‡æ¢åˆ°åŒä¸€æ ‡ç­¾ï¼Œä»¥æ”¯æŒåˆ·æ–°åŠŸèƒ½
    print("ğŸ”„ [ç»Ÿä¸€ç®¡ç†é¢æ¿] åˆ‡æ¢åˆ°æ ‡ç­¾:", tabId)

    local wasFirstTime = (currentTab ~= tabId)
    currentTab = tabId

    -- æ›´æ–°æ ‡ç­¾æŒ‰é’®æ ·å¼
    for id, button in pairs(tabButtons) do
        if id == tabId then
            button.BackgroundColor3 = ShopUtils.COLORS.ACCENT
        else
            button.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
        end
    end

    -- æ¸…ç©ºå†…å®¹åŒºåŸŸ
    for _, child in pairs(contentArea:GetChildren()) do
        if child:IsA("GuiObject") then
            child:Destroy()
        end
    end

    -- æ ¹æ®æ ‡ç­¾æ˜¾ç¤ºå¯¹åº”å†…å®¹
    if tabId == "users" then
        -- é¦–æ¬¡åˆ‡æ¢åˆ°ç”¨æˆ·ç®¡ç†æ—¶ï¼Œé‡ç½®ä¸ºé»˜è®¤æ ‡ç­¾
        if wasFirstTime then
            ShopAdminPanel._resetToDefaultTabs()
        end
        ShopAdminPanel._showUsersPanel(showNotification)
    elseif tabId == "records" then
        ShopAdminPanel._showRecordsPanel(showNotification)
    elseif tabId == "membership" then
        ShopAdminPanel._showMembershipPanel(showNotification)
    end
end

-- æ˜¾ç¤ºç”¨æˆ·ç®¡ç†é¢æ¿
function ShopAdminPanel._showUsersPanel(showNotification)
    print("ğŸ‘¤ [ç”¨æˆ·ç®¡ç†] åŠ è½½ç”¨æˆ·ç®¡ç†é¢æ¿")

    -- æ˜¾ç¤ºåŠ è½½æç¤º
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "ğŸ“¡ æ­£åœ¨åŠ è½½ç©å®¶æ•°æ®...\nè¯·ç¨å€™ï¼Œæ­£åœ¨è¿æ¥æœåŠ¡å™¨"
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 16
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 100)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.TextYAlignment = Enum.TextYAlignment.Center
    loadingLabel.TextWrapped = true
    loadingLabel.Parent = contentArea

    -- æ·»åŠ è°ƒè¯•æŒ‰é’®
    local debugBtn = ShopUtils.createButton("ğŸ”§ æ˜¾ç¤ºæµ‹è¯•æ•°æ®", ShopUtils.COLORS.WARNING, contentArea, function()
        print("ğŸ”§ [è°ƒè¯•] æ‰‹åŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®")
        if loadingLabel and loadingLabel.Parent then
            loadingLabel:Destroy()
        end

        local testData = {
            [player.Name] = {
                userId = player.UserId,
                name = player.Name,
                coins = 1000,
                totalPurchases = 5,
                totalSpent = 500,
                totalSales = 3,
                totalEarned = 300,
                inventoryCount = 10,
                membership_status = "active",
                end_date = "2024-12-31",
                days_remaining = 30,
                daily_reward_coins = 100
            },
            ["æµ‹è¯•ç”¨æˆ·1"] = {
                userId = 12345,
                name = "æµ‹è¯•ç”¨æˆ·1",
                coins = 500,
                totalPurchases = 2,
                totalSpent = 200,
                totalSales = 1,
                totalEarned = 100,
                inventoryCount = 5,
                membership_status = "none",
                end_date = nil,
                days_remaining = 0,
                daily_reward_coins = 100
            },
            ["æµ‹è¯•ç”¨æˆ·2"] = {
                userId = 67890,
                name = "æµ‹è¯•ç”¨æˆ·2",
                coins = 2000,
                totalPurchases = 10,
                totalSpent = 1000,
                totalSales = 8,
                totalEarned = 800,
                inventoryCount = 15,
                membership_status = "active",
                end_date = "2024-10-15",
                days_remaining = 15,
                daily_reward_coins = 150
            }
        }

        ShopAdminPanel._displayAllPlayersData(testData, showNotification)
        if showNotification then
            showNotification("ğŸ”§ æ‰‹åŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®", true)
        end
    end)
    debugBtn.Position = UDim2.new(0.5, -80, 0, 120)
    debugBtn.Size = UDim2.new(0, 160, 0, 30)
    debugBtn.TextSize = 12

    -- è¯·æ±‚æ‰€æœ‰ç©å®¶æ•°æ®
    print("ğŸ“¡ [ç”¨æˆ·ç®¡ç†] å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨è·å–ç”¨æˆ·æ•°æ®")
    print("ğŸ“¡ [è°ƒè¯•] æ£€æŸ¥ShopEvents.Admin.GetAllUsersæ˜¯å¦å­˜åœ¨:", ShopEvents.Admin.GetAllUsers ~= nil)

    if ShopEvents.Admin.GetAllUsers then
        ShopEvents.Admin.GetAllUsers:FireServer()
        print("ğŸ“¡ [è°ƒè¯•] å·²å‘é€GetAllUsersè¯·æ±‚åˆ°æœåŠ¡å™¨")
    else
        print("âŒ [é”™è¯¯] ShopEvents.Admin.GetAllUsers ä¸å­˜åœ¨")
        if showNotification then
            showNotification("âŒ äº‹ä»¶ç³»ç»Ÿé”™è¯¯", false)
        end
        return
    end

    -- è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æœºåˆ¶ï¼Œä¾¿äºè°ƒè¯•
    local timeoutTime = 8  -- å‡å°‘åˆ°8ç§’
    spawn(function()
        for i = 1, timeoutTime do
            wait(1)
            if not loadingLabel or not loadingLabel.Parent then
                return  -- å·²ç»æ”¶åˆ°å“åº”
            end
            loadingLabel.Text = string.format("ğŸ“¡ æ­£åœ¨åŠ è½½ç©å®¶æ•°æ®...\nç­‰å¾…æœåŠ¡å™¨å“åº” (%d/%dç§’)", i, timeoutTime)
        end

        if loadingLabel and loadingLabel.Parent then
            print("âš ï¸ [ç”¨æˆ·ç®¡ç†] è¯·æ±‚è¶…æ—¶ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º")
            loadingLabel.Text = "âš ï¸ æœåŠ¡å™¨å“åº”è¶…æ—¶\nå¯èƒ½åŸå› ï¼šæ•°æ®æœåŠ¡ç¦»çº¿æˆ–ç½‘ç»œé—®é¢˜"
            loadingLabel.TextColor3 = ShopUtils.COLORS.WARNING

            -- 5ç§’åè‡ªåŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®
            spawn(function()
                wait(5)
                if loadingLabel and loadingLabel.Parent then
                    loadingLabel:Destroy()
                    debugBtn:Destroy()

                    local testData = {
                        [player.Name] = {
                            userId = player.UserId,
                            name = player.Name,
                            coins = 1000,
                            totalPurchases = 5,
                            totalSpent = 500,
                            totalSales = 3,
                            totalEarned = 300,
                            inventoryCount = 10,
                            membership_status = "active",
                            end_date = "2024-12-31",
                            days_remaining = 30,
                            daily_reward_coins = 100
                        },
                        ["æµ‹è¯•ç”¨æˆ·1"] = {
                            userId = 12345,
                            name = "æµ‹è¯•ç”¨æˆ·1",
                            coins = 500,
                            totalPurchases = 2,
                            totalSpent = 200,
                            totalSales = 1,
                            totalEarned = 100,
                            inventoryCount = 5,
                            membership_status = "none",
                            end_date = nil,
                            days_remaining = 0,
                            daily_reward_coins = 100
                        }
                    }

                    print("ğŸ§ª [æµ‹è¯•] è‡ªåŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®")
                    ShopAdminPanel._displayAllPlayersData(testData, showNotification)
                    if showNotification then
                        showNotification("ğŸ§ª è‡ªåŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®ï¼ˆæœåŠ¡å™¨è¶…æ—¶ï¼‰", true)
                    end
                end
            end)
        end
    end)

    -- ç›‘å¬æœåŠ¡å™¨å“åº”
    local connection
    local hasReceivedData = false
    local eventReceived = false

    print("ğŸ‘¤ [è°ƒè¯•] å¼€å§‹ç›‘å¬æœåŠ¡å™¨å“åº”äº‹ä»¶")

    if not ShopEvents.Admin.GetAllUsers.OnClientEvent then
        print("âŒ [é”™è¯¯] ShopEvents.Admin.GetAllUsers.OnClientEvent ä¸å­˜åœ¨")
        if showNotification then
            showNotification("âŒ äº‹ä»¶ç›‘å¬å™¨é”™è¯¯", false)
        end
        return
    end

    connection = ShopEvents.Admin.GetAllUsers.OnClientEvent:Connect(function(allPlayersData, errorMsg)
        eventReceived = true
        print("ğŸ‘¤ [è°ƒè¯•] æ”¶åˆ°æœåŠ¡å™¨å“åº”äº‹ä»¶ï¼")
        print("ğŸ‘¤ [è°ƒè¯•] å‚æ•°1 (allPlayersData) ç±»å‹:", type(allPlayersData))
        print("ğŸ‘¤ [è°ƒè¯•] å‚æ•°2 (errorMsg):", errorMsg)

        -- æ¸…ç†UIå…ƒç´ 
        if loadingLabel and loadingLabel.Parent then
            loadingLabel:Destroy()
        end
        if debugBtn and debugBtn.Parent then
            debugBtn:Destroy()
        end

        -- å¤„ç†é”™è¯¯æƒ…å†µ
        if errorMsg then
            print("âŒ [é”™è¯¯] è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:", errorMsg)
            hasReceivedData = false

            -- åˆ›å»ºé”™è¯¯æ˜¾ç¤º
            local errorLabel = Instance.new("TextLabel")
            errorLabel.Text = "âŒ æœåŠ¡å™¨é”™è¯¯:\n" .. errorMsg .. "\n\nè¯·ç¨å€™ï¼Œå°†è‡ªåŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®..."
            errorLabel.Font = Enum.Font.SourceSans
            errorLabel.TextSize = 14
            errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
            errorLabel.Size = UDim2.new(1, -20, 0, 150)
            errorLabel.Position = UDim2.new(0, 10, 0, 10)
            errorLabel.BackgroundTransparency = 1
            errorLabel.TextXAlignment = Enum.TextXAlignment.Center
            errorLabel.TextYAlignment = Enum.TextYAlignment.Top
            errorLabel.TextWrapped = true
            errorLabel.Parent = contentArea

            -- æ·»åŠ é‡è¯•æŒ‰é’®
            local retryBtn = ShopUtils.createButton("ğŸ”„ é‡è¯•è¿æ¥æœåŠ¡å™¨", ShopUtils.COLORS.ACCENT, contentArea, function()
                for _, child in pairs(contentArea:GetChildren()) do
                    if child:IsA("GuiObject") then
                        child:Destroy()
                    end
                end
                ShopAdminPanel._showUsersPanel(showNotification)
            end)
            retryBtn.Position = UDim2.new(0.5, -80, 0, 170)
            retryBtn.Size = UDim2.new(0, 160, 0, 30)
            retryBtn.TextSize = 12

            if showNotification then
                showNotification("âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥", false)
            end

            -- å¦‚æœæ˜¯æ¨¡æ‹Ÿæ•°æ®é€šçŸ¥ï¼Œä¸æ–­å¼€è¿æ¥
            if string.find(errorMsg, "æ¨¡æ‹Ÿæ•°æ®") or string.find(errorMsg, "æ³¨æ„") then
                print("ğŸ“ [é€šçŸ¥] ç­‰å¾…æ¨¡æ‹Ÿæ•°æ®...")
                if showNotification then
                    showNotification("ğŸ“ æ­£åœ¨å‡†å¤‡æ¨¡æ‹Ÿæ•°æ®...", true)
                end
                return -- ä¸æ–­å¼€è¿æ¥ï¼Œç­‰å¾…æ¨¡æ‹Ÿæ•°æ®
            end

        elseif allPlayersData and type(allPlayersData) == "table" then
            print("âœ… [æˆåŠŸ] è·å–åˆ°ç”¨æˆ·æ•°æ®ï¼Œå‡†å¤‡æ˜¾ç¤º")
            hasReceivedData = true

            -- æ£€æŸ¥æ•°æ®å†…å®¹
            if allPlayersData then
                print("ğŸ‘¤ [è°ƒè¯•] allPlayersDataå†…å®¹:", allPlayersData)
                if type(allPlayersData) == "table" then
                    local count = 0
                    for k, v in pairs(allPlayersData) do
                        count = count + 1
                        print("ğŸ‘¤ [è°ƒè¯•] æ•°æ®é¡¹", count, ":", k, "->", v)
                    end
                    print("ğŸ‘¤ [è°ƒè¯•] æ€»å…±æœ‰", count, "é¡¹æ•°æ®")
                end
            end

            -- æ£€æŸ¥æ˜¯å¦æ˜¯æ¨¡æ‹Ÿæ•°æ®
            local isSimulatedData = false
            for playerName, data in pairs(allPlayersData) do
                if string.find(playerName, "æ¨¡æ‹Ÿ") then
                    isSimulatedData = true
                    break
                end
            end

            if isSimulatedData and showNotification then
                showNotification("âš ï¸ æ˜¾ç¤ºæ¨¡æ‹Ÿæ•°æ®ï¼ˆæ•°æ®æœåŠ¡ç¦»çº¿ï¼‰", true)
            else
                if showNotification then
                    showNotification("âœ… ç”¨æˆ·æ•°æ®åŠ è½½æˆåŠŸ", true)
                end
            end

            ShopAdminPanel._displayAllPlayersData(allPlayersData, showNotification)
            if connection then
                connection:Disconnect()
            end
        else
            print("âŒ [é”™è¯¯] æœªæ”¶åˆ°æœ‰æ•ˆçš„ç”¨æˆ·æ•°æ®")
            if not hasReceivedData then
                local noDataLabel = Instance.new("TextLabel")
                noDataLabel.Text = "âŒ æ— æ³•åŠ è½½ç©å®¶æ•°æ®\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ æ•°æ®æœåŠ¡æœªå“åº”\nâ€¢ æ•°æ®åº“è¿æ¥é—®é¢˜\nâ€¢ ç½‘ç»œè¿æ¥å¼‚å¸¸\n\nå°†è‡ªåŠ¨æ˜¾ç¤ºæµ‹è¯•æ•°æ®ä¾›å‚è€ƒ"
                noDataLabel.Font = Enum.Font.SourceSans
                noDataLabel.TextSize = 14
                noDataLabel.TextColor3 = ShopUtils.COLORS.ERROR
                noDataLabel.Size = UDim2.new(1, -20, 0, 200)
                noDataLabel.Position = UDim2.new(0, 10, 0, 10)
                noDataLabel.BackgroundTransparency = 1
                noDataLabel.TextXAlignment = Enum.TextXAlignment.Center
                noDataLabel.TextYAlignment = Enum.TextYAlignment.Top
                noDataLabel.TextWrapped = true
                noDataLabel.Parent = contentArea

                if showNotification then
                    showNotification("âŒ æ— æ³•åŠ è½½çœŸå®æ•°æ®", false)
                end

                -- 3ç§’åæ˜¾ç¤ºæµ‹è¯•æ•°æ®
                spawn(function()
                    wait(3)
                    if noDataLabel and noDataLabel.Parent then
                        noDataLabel:Destroy()

                        local testData = {
                            [player.Name] = {
                                userId = player.UserId,
                                name = player.Name,
                                coins = 1000,
                                totalPurchases = 5,
                                totalSpent = 500,
                                totalSales = 3,
                                totalEarned = 300,
                                inventoryCount = 10,
                                membership_status = "active",
                                end_date = "2024-12-31",
                                days_remaining = 30,
                                daily_reward_coins = 100
                            }
                        }

                        ShopAdminPanel._displayAllPlayersData(testData, showNotification)
                        if showNotification then
                            showNotification("ğŸ”§ æ˜¾ç¤ºåŸºç¡€æµ‹è¯•æ•°æ®", true)
                        end
                    end
                end)

                if connection then
                    connection:Disconnect()
                end
            end
        end
    end)

    print("ğŸ‘¤ [è°ƒè¯•] äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®")
end

-- æ˜¾ç¤ºæ‰€æœ‰ç©å®¶æ•°æ®
function ShopAdminPanel._displayAllPlayersData(allPlayersData, showNotification)
    print("ğŸ‘¤ [ç”¨æˆ·ç®¡ç†] å¼€å§‹æ˜¾ç¤ºæ‰€æœ‰ç©å®¶æ•°æ®")
    print("ğŸ‘¤ [è°ƒè¯•] æ¥æ”¶åˆ°çš„æ•°æ®ç±»å‹:", type(allPlayersData))

    -- è¯¦ç»†çš„æ•°æ®æ£€æŸ¥å’Œæ—¥å¿—
    if not allPlayersData then
        print("âŒ [é”™è¯¯] allPlayersData ä¸º nil")
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "âŒ æ•°æ®ä¸ºç©º\næœªæ”¶åˆ°ä»»ä½•ç©å®¶æ•°æ®"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 16
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 100)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
        return
    end

    if type(allPlayersData) ~= "table" then
        print("âŒ [é”™è¯¯] allPlayersData ä¸æ˜¯è¡¨æ ¼ç±»å‹:", type(allPlayersData))
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "âŒ æ•°æ®æ ¼å¼é”™è¯¯\næœŸæœ›è¡¨æ ¼ç±»å‹ï¼Œæ”¶åˆ°:" .. type(allPlayersData)
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 16
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 100)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
        return
    end

    -- ç»Ÿè®¡å’Œè°ƒè¯•ä¿¡æ¯
    local count = 0
    for k, v in pairs(allPlayersData) do
        count = count + 1
        print("ğŸ‘¤ [è°ƒè¯•] ç©å®¶", count, "- åç§°:", k)
        if type(v) == "table" then
            print("  â””â”€ ç”¨æˆ·ID:", v.userId or "æœªçŸ¥")
            print("  â””â”€ é‡‘å¸:", v.coins or "æœªçŸ¥")
            print("  â””â”€ ä¼šå‘˜çŠ¶æ€:", v.membership_status or "æœªçŸ¥")
        else
            print("  â””â”€ æ•°æ®ç±»å‹é”™è¯¯:", type(v))
        end
    end
    print("ğŸ‘¤ [è°ƒè¯•] æ€»å…±æ‰¾åˆ°", count, "ä¸ªç©å®¶")

    local yPos = 10

    -- æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
    if count == 0 then
        print("ğŸ‘¤ [è°ƒè¯•] æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º")
        local noDataLabel = Instance.new("TextLabel")
        noDataLabel.Text = "ğŸ˜” æš‚æ— ç”¨æˆ·æ•°æ®\n\nå¯èƒ½çš„åŸå› :\nâ€¢ æ•°æ®æœåŠ¡æœªå¯åŠ¨\nâ€¢ æ•°æ®åº“ä¸­æ²¡æœ‰ç”¨æˆ·æ•°æ®\nâ€¢ ç½‘ç»œè¿æ¥é—®é¢˜\n\nå»ºè®®ï¼šç‚¹å‡»\"ğŸ”§ æ˜¾ç¤ºæµ‹è¯•æ•°æ®\"æŒ‰é’®æŸ¥çœ‹ç¤ºä¾‹"
        noDataLabel.Font = Enum.Font.SourceSans
        noDataLabel.TextSize = 16
        noDataLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        noDataLabel.Size = UDim2.new(1, -20, 0, 250)
        noDataLabel.Position = UDim2.new(0, 10, 0, yPos)
        noDataLabel.BackgroundTransparency = 1
        noDataLabel.TextXAlignment = Enum.TextXAlignment.Center
        noDataLabel.TextYAlignment = Enum.TextYAlignment.Top
        noDataLabel.TextWrapped = true
        noDataLabel.Parent = contentArea

        -- æ·»åŠ æ˜¾ç¤ºæµ‹è¯•æ•°æ®æŒ‰é’®
        local showTestBtn = ShopUtils.createButton("ğŸ”§ æ˜¾ç¤ºæµ‹è¯•æ•°æ®", ShopUtils.COLORS.ACCENT, contentArea, function()
            noDataLabel:Destroy()
            local testData = {
                [player.Name] = {
                    userId = player.UserId,
                    name = player.Name,
                    coins = 1000,
                    totalPurchases = 5,
                    totalSpent = 500,
                    totalSales = 3,
                    totalEarned = 300,
                    inventoryCount = 10,
                    membership_status = "active",
                    end_date = "2024-12-31",
                    days_remaining = 30,
                    daily_reward_coins = 100
                }
            }
            ShopAdminPanel._displayAllPlayersData(testData, showNotification)
        end)
        showTestBtn.Position = UDim2.new(0.5, -80, 0, yPos + 200)
        showTestBtn.Size = UDim2.new(0, 160, 0, 30)
        showTestBtn.TextSize = 12
        return
    end

    -- æ˜¾ç¤ºåŠ è½½æˆåŠŸçš„ä¿¡æ¯
    print("âœ… [ç”¨æˆ·ç®¡ç†] å¼€å§‹åˆ›å»ºç”¨æˆ·ç•Œé¢ï¼Œå…±", count, "ä¸ªç”¨æˆ·")

    -- åœ¨é¡¶éƒ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    local statsLabel = Instance.new("TextLabel")
    statsLabel.Text = "ğŸ“Š ç”¨æˆ·ç»Ÿè®¡: å…± " .. count .. " ä¸ªç”¨æˆ·"
    statsLabel.Font = Enum.Font.SourceSansBold
    statsLabel.TextSize = 14
    statsLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
    statsLabel.Size = UDim2.new(1, -20, 0, 25)
    statsLabel.Position = UDim2.new(0, 10, 0, yPos)
    statsLabel.BackgroundTransparency = 1
    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
    statsLabel.Parent = contentArea

    yPos = yPos + 35

    for playerName, data in pairs(allPlayersData) do
        print("ğŸ‘¤ [è°ƒè¯•] åˆ›å»ºç©å®¶å¡ç‰‡:", playerName)

        -- éªŒè¯æ•°æ®å®Œæ•´æ€§
        if not data or type(data) ~= "table" then
            print("âš ï¸ [è­¦å‘Š] ç©å®¶", playerName, "çš„æ•°æ®æ— æ•ˆ:", type(data))
            continue
        end

        -- ç©å®¶å¡ç‰‡
        local playerCard = Instance.new("Frame")
        playerCard.Name = "PlayerCard_" .. playerName
        playerCard.Size = UDim2.new(1, -20, 0, 120)
        playerCard.Position = UDim2.new(0, 10, 0, yPos)
        playerCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        playerCard.BorderSizePixel = 0
        playerCard.Parent = contentArea
        ShopUtils.createCorner(playerCard, 8)

        -- ç©å®¶ä¿¡æ¯
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = "ğŸ‘¤ " .. playerName .. " (ID: " .. data.userId .. ")"
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 16
        nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        nameLabel.Size = UDim2.new(0.4, 0, 0, 25)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = playerCard

        -- é‡‘å¸æ˜¾ç¤ºå’Œä¿®æ”¹
        local coinsLabel = Instance.new("TextLabel")
        coinsLabel.Text = "ğŸ’° " .. data.coins .. " é‡‘å¸"
        coinsLabel.Font = Enum.Font.SourceSans
        coinsLabel.TextSize = 14
        coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
        coinsLabel.Size = UDim2.new(0.2, 0, 0, 20)
        coinsLabel.Position = UDim2.new(0, 10, 0, 30)
        coinsLabel.BackgroundTransparency = 1
        coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
        coinsLabel.Parent = playerCard

        -- ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º
        local membershipStatus = data.membership_status or "none"
        local isMember = membershipStatus == "active"
        local membershipLabel = Instance.new("TextLabel")
        membershipLabel.Text = isMember and "ğŸ‘‘ ä¼šå‘˜" or "ğŸ‘¤ æ™®é€šç”¨æˆ·"
        membershipLabel.Font = Enum.Font.SourceSansBold
        membershipLabel.TextSize = 12
        membershipLabel.TextColor3 = isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
        membershipLabel.Size = UDim2.new(0.15, 0, 0, 20)
        membershipLabel.Position = UDim2.new(0.25, 10, 0, 30)
        membershipLabel.BackgroundTransparency = 1
        membershipLabel.TextXAlignment = Enum.TextXAlignment.Left
        membershipLabel.Parent = playerCard

        -- ä¼šå‘˜åˆ°æœŸæ—¶é—´æ˜¾ç¤º
        local expiryLabel = Instance.new("TextLabel")
        local expiryText = ""
        if isMember and data.end_date then
            expiryText = "â° " .. data.end_date:sub(1, 10)
        elseif isMember then
            expiryText = "â° æœªçŸ¥"
        else
            expiryText = ""
        end
        expiryLabel.Text = expiryText
        expiryLabel.Font = Enum.Font.SourceSans
        expiryLabel.TextSize = 11
        expiryLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        expiryLabel.Size = UDim2.new(0.2, 0, 0, 20)
        expiryLabel.Position = UDim2.new(0.45, 10, 0, 30)
        expiryLabel.BackgroundTransparency = 1
        expiryLabel.TextXAlignment = Enum.TextXAlignment.Left
        expiryLabel.Parent = playerCard

        -- é‡‘å¸ä¿®æ”¹è¾“å…¥æ¡†
        local coinsInput = Instance.new("TextBox")
        coinsInput.Text = tostring(data.coins)
        coinsInput.Font = Enum.Font.SourceSans
        coinsInput.TextSize = 12
        coinsInput.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        coinsInput.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
        coinsInput.Size = UDim2.new(0, 80, 0, 25)
        coinsInput.Position = UDim2.new(0, 10, 0, 55)
        coinsInput.PlaceholderText = "æ–°é‡‘å¸æ•°"
        coinsInput.Parent = playerCard
        ShopUtils.createCorner(coinsInput, 4)

        -- è®¾ç½®é‡‘å¸æŒ‰é’®
        local setCoinsBtn = ShopUtils.createButton("è®¾ç½®", ShopUtils.COLORS.SUCCESS, playerCard, function()
            local newCoins = tonumber(coinsInput.Text)
            if newCoins and newCoins >= 0 and newCoins <= 999999 then
                -- å‘é€ä¿®æ”¹é‡‘å¸è¯·æ±‚
                if ShopEvents.Admin.SetUserCoins then
                    ShopEvents.Admin.SetUserCoins:FireServer(playerName, newCoins)

                    -- ç›‘å¬ä¿®æ”¹ç»“æœ
                    local connection
                    connection = ShopEvents.Admin.SetUserCoins.OnClientEvent:Connect(function(success, message)
                        connection:Disconnect()

                        if success then
                            print("âœ… é‡‘å¸ä¿®æ”¹æˆåŠŸ:", playerName, newCoins)
                            -- ç«‹å³æ›´æ–°æ˜¾ç¤º
                            coinsLabel.Text = "ğŸ’° " .. newCoins .. " é‡‘å¸"
                            if showNotification then
                                showNotification("âœ… " .. message, true)
                            end

                            -- åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
                            task.wait(0.5)
                            ShopAdminPanel._refreshPlayerData()

                            -- å†æ¬¡åˆ·æ–°ä»¥ç¡®ä¿æ•°æ®å®Œå…¨åŒæ­¥
                            task.wait(1.0)
                            ShopAdminPanel._refreshPlayerData()
                        else
                            print("âŒ é‡‘å¸ä¿®æ”¹å¤±è´¥:", message)
                            if showNotification then
                                showNotification("âŒ " .. message, false)
                            end
                        end
                    end)
                else
                    print("âŒ SetUserCoins äº‹ä»¶ä¸å­˜åœ¨")
                end
            else
                if showNotification then
                    showNotification("âŒ é‡‘å¸æ•°é‡å¿…é¡»åœ¨ 0-999999 ä¹‹é—´", false)
                end
            end
        end)
        setCoinsBtn.Position = UDim2.new(0, 100, 0, 55)
        setCoinsBtn.Size = UDim2.new(0, 60, 0, 25)
        setCoinsBtn.TextSize = 12

        -- æŸ¥çœ‹è®°å½•æŒ‰é’®
        local viewRecordsBtn = ShopUtils.createButton("æŸ¥çœ‹è®°å½•", ShopUtils.COLORS.ACCENT, playerCard, function()
            print("ğŸ”§ [ç»Ÿä¸€ç®¡ç†é¢æ¿] æŸ¥çœ‹ç”¨æˆ·è®°å½•:", playerName)
            currentViewingPlayer = playerName
            ShopAdminPanel._addTab("records")
            ShopAdminPanel.switchTab("records")
        end)
        viewRecordsBtn.Position = UDim2.new(0, 170, 0, 55)
        viewRecordsBtn.Size = UDim2.new(0, 80, 0, 25)
        viewRecordsBtn.TextSize = 12

        -- ç®¡ç†ä¼šå‘˜æŒ‰é’®
        local manageMembershipBtn = ShopUtils.createButton("ç®¡ç†ä¼šå‘˜", ShopUtils.COLORS.WARNING, playerCard, function()
            print("ğŸ”§ [ç»Ÿä¸€ç®¡ç†é¢æ¿] ç®¡ç†ç”¨æˆ·ä¼šå‘˜:", playerName)
            currentViewingPlayer = playerName
            ShopAdminPanel._addTab("membership")
            ShopAdminPanel.switchTab("membership")
        end)
        manageMembershipBtn.Position = UDim2.new(0, 260, 0, 55)
        manageMembershipBtn.Size = UDim2.new(0, 80, 0, 25)
        manageMembershipBtn.TextSize = 12

        -- ç»Ÿè®¡ä¿¡æ¯
        local statsText = string.format(
            "ğŸ“Š è´­ä¹°: %dæ¬¡ | å–å‡º: %dæ¬¡ | æ¶ˆè´¹: %dé‡‘å¸ | æ”¶å…¥: %dé‡‘å¸ | åº“å­˜: %dä»¶",
            data.totalPurchases or 0, data.totalSales or 0, data.totalSpent or 0, data.totalEarned or 0, data.inventoryCount or 0
        )
        local statsLabel = Instance.new("TextLabel")
        statsLabel.Text = statsText
        statsLabel.Font = Enum.Font.SourceSans
        statsLabel.TextSize = 12
        statsLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        statsLabel.Size = UDim2.new(1, -20, 0, 30)
        statsLabel.Position = UDim2.new(0, 10, 0, 85)
        statsLabel.BackgroundTransparency = 1
        statsLabel.TextXAlignment = Enum.TextXAlignment.Left
        statsLabel.TextWrapped = true
        statsLabel.Parent = playerCard

        yPos = yPos + 130
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- æ˜¾ç¤ºäº¤æ˜“è®°å½•é¢æ¿
function ShopAdminPanel._showRecordsPanel(showNotification)
    print("ğŸ“Š [äº¤æ˜“è®°å½•] åŠ è½½äº¤æ˜“è®°å½•é¢æ¿ï¼ŒæŸ¥çœ‹ç”¨æˆ·:", currentViewingPlayer)

    if not currentViewingPlayer then
        local noPlayerLabel = Instance.new("TextLabel")
        noPlayerLabel.Text = "âŒ è¯·å…ˆé€‰æ‹©è¦æŸ¥çœ‹çš„ç”¨æˆ·"
        noPlayerLabel.Font = Enum.Font.SourceSans
        noPlayerLabel.TextSize = 16
        noPlayerLabel.TextColor3 = ShopUtils.COLORS.ERROR
        noPlayerLabel.Size = UDim2.new(1, 0, 0, 100)
        noPlayerLabel.BackgroundTransparency = 1
        noPlayerLabel.TextXAlignment = Enum.TextXAlignment.Center
        noPlayerLabel.Parent = contentArea
        return
    end

    -- æ˜¾ç¤ºå½“å‰æŸ¥çœ‹çš„ç”¨æˆ·ä¿¡æ¯
    local userInfoLabel = Instance.new("TextLabel")
    userInfoLabel.Text = "ğŸ“Š æ­£åœ¨æŸ¥çœ‹ " .. currentViewingPlayer .. " çš„äº¤æ˜“è®°å½•"
    userInfoLabel.Font = Enum.Font.SourceSansBold
    userInfoLabel.TextSize = 16
    userInfoLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    userInfoLabel.Size = UDim2.new(1, 0, 0, 30)
    userInfoLabel.BackgroundTransparency = 1
    userInfoLabel.TextXAlignment = Enum.TextXAlignment.Center
    userInfoLabel.Parent = contentArea

    -- è¿”å›ç”¨æˆ·ç®¡ç†æŒ‰é’®
    local backBtn = ShopUtils.createButton("â† è¿”å›ç”¨æˆ·ç®¡ç†", ShopUtils.COLORS.ACCENT, contentArea, function()
        ShopAdminPanel._resetToDefaultTabs()
        ShopAdminPanel.switchTab("users")
    end)
    backBtn.Position = UDim2.new(0, 10, 0, 40)
    backBtn.Size = UDim2.new(0, 120, 0, 30)
    backBtn.TextSize = 12

    -- æ˜¾ç¤ºåŠ è½½æç¤º
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "ğŸ“¡ æ­£åœ¨åŠ è½½ " .. currentViewingPlayer .. " çš„äº¤æ˜“è®°å½•..."
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 14
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 50)
    loadingLabel.Position = UDim2.new(0, 0, 0, 80)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.Parent = contentArea

    -- è¯·æ±‚ç‰¹å®šç”¨æˆ·çš„å†å²è®°å½•
    if ShopEvents.Admin.GetUserHistory then
        ShopEvents.Admin.GetUserHistory:FireServer(currentViewingPlayer)

        -- ç›‘å¬æœåŠ¡å™¨å“åº”
        local connection
        connection = ShopEvents.Admin.GetUserHistory.OnClientEvent:Connect(function(success, message, data)
            connection:Disconnect()
            loadingLabel:Destroy()

            if not success then
                local errorLabel = Instance.new("TextLabel")
                errorLabel.Text = "âŒ " .. (message or "è·å–ç”¨æˆ·äº¤æ˜“è®°å½•å¤±è´¥")
                errorLabel.Font = Enum.Font.SourceSans
                errorLabel.TextSize = 14
                errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
                errorLabel.Size = UDim2.new(1, 0, 0, 50)
                errorLabel.Position = UDim2.new(0, 0, 0, 80)
                errorLabel.BackgroundTransparency = 1
                errorLabel.TextXAlignment = Enum.TextXAlignment.Center
                errorLabel.Parent = contentArea
            elseif data and data.transactions and #data.transactions > 0 then
                print("âœ… [äº¤æ˜“è®°å½•] æˆåŠŸè·å–åˆ°", #data.transactions, "æ¡äº¤æ˜“è®°å½•")
                ShopAdminPanel._displayUserRecords(data.transactions)
            else
                local noRecordsLabel = Instance.new("TextLabel")
                noRecordsLabel.Text = "ğŸ“ " .. currentViewingPlayer .. " æš‚æ— äº¤æ˜“è®°å½•"
                noRecordsLabel.Font = Enum.Font.SourceSans
                noRecordsLabel.TextSize = 14
                noRecordsLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
                noRecordsLabel.Size = UDim2.new(1, 0, 0, 50)
                noRecordsLabel.Position = UDim2.new(0, 0, 0, 80)
                noRecordsLabel.BackgroundTransparency = 1
                noRecordsLabel.TextXAlignment = Enum.TextXAlignment.Center
                noRecordsLabel.Parent = contentArea
            end
        end)
    else
        loadingLabel:Destroy()
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "âŒ è·å–ç”¨æˆ·è®°å½•åŠŸèƒ½ä¸å¯ç”¨"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 14
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 50)
        errorLabel.Position = UDim2.new(0, 0, 0, 80)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
    end
end

-- æ˜¾ç¤ºç”¨æˆ·äº¤æ˜“è®°å½•
function ShopAdminPanel._displayUserRecords(records)
    print("ğŸ“Š [äº¤æ˜“è®°å½•] æ˜¾ç¤ºç”¨æˆ·è®°å½•ï¼Œå…±", #records, "æ¡")

    local yPos = 140  -- ä»è¿”å›æŒ‰é’®ä¸‹æ–¹å¼€å§‹

    for i, record in ipairs(records) do
        local recordCard = Instance.new("Frame")
        recordCard.Name = "Record" .. i
        recordCard.Size = UDim2.new(1, -20, 0, 80)
        recordCard.Position = UDim2.new(0, 10, 0, yPos)
        recordCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        recordCard.BorderSizePixel = 0
        recordCard.Parent = contentArea
        ShopUtils.createCorner(recordCard, 8)

        -- æ—¶é—´æˆ³
        local timeLabel = Instance.new("TextLabel")

        -- è°ƒè¯•æ—¶é—´æˆ³é—®é¢˜
        local timestamp = record.timestamp or record.createdAt or record.transactionDate
        print("ğŸ“Š [è°ƒè¯•] äº¤æ˜“è®°å½•æ—¶é—´æˆ³:",
            "timestamp=", record.timestamp,
            "createdAt=", record.createdAt,
            "transactionDate=", record.transactionDate,
            "ä½¿ç”¨=", timestamp)

        timeLabel.Text = ShopUtils.formatTimestamp(timestamp)
        timeLabel.Font = Enum.Font.SourceSans
        timeLabel.TextSize = 12
        timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        timeLabel.Size = UDim2.new(0, 150, 0, 20)
        timeLabel.Position = UDim2.new(0, 10, 0, 5)
        timeLabel.BackgroundTransparency = 1
        timeLabel.TextXAlignment = Enum.TextXAlignment.Left
        timeLabel.Parent = recordCard

        -- äº¤æ˜“ç±»å‹å’Œç‰©å“
        local actionLabel = Instance.new("TextLabel")
        local actionText = ""
        if record.type == "buy" or record.action == "buy" then
            actionText = "ğŸ›’ è´­ä¹° " .. (record.itemName or record.item_name or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
        elseif record.type == "sell" or record.action == "sell" then
            actionText = "ğŸ’° å–å‡º " .. (record.itemName or record.item_name or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
        elseif record.type == "admin" or record.action == "admin_edit" then
            actionText = "âš™ï¸ ç®¡ç†å‘˜æ“ä½œ x" .. (record.quantity or 1)
        elseif record.type == "daily_reward" then
            actionText = "ğŸ æ¯æ—¥å¥–åŠ± x" .. (record.quantity or 1)
        elseif record.type == "membership_purchase" then
            actionText = "ğŸ’ è´­ä¹°ä¼šå‘˜ " .. (record.itemName or record.item_name or "æœªçŸ¥ä¼šå‘˜") .. " x" .. (record.quantity or 1)
        end
        actionLabel.Text = actionText
        actionLabel.Font = Enum.Font.SourceSansBold
        actionLabel.TextSize = 16
        actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        actionLabel.Size = UDim2.new(1, -20, 0, 25)
        actionLabel.Position = UDim2.new(0, 10, 0, 25)
        actionLabel.BackgroundTransparency = 1
        actionLabel.TextXAlignment = Enum.TextXAlignment.Left
        actionLabel.Parent = recordCard

        -- é‡‘é¢
        local amountLabel = Instance.new("TextLabel")
        local amountText = ""
        local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
        if record.type == "buy" or record.action == "buy" then
            amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " é‡‘å¸"
            amountColor = ShopUtils.COLORS.ERROR
        elseif record.type == "sell" or record.action == "sell" then
            amountText = "+" .. (record.totalAmount or record.totalEarned or record.total_amount or 0) .. " é‡‘å¸"
            amountColor = ShopUtils.COLORS.SUCCESS
        elseif record.type == "admin" or record.action == "admin_edit" then
            amountText = (record.totalAmount or record.total_amount or 0) .. " é‡‘å¸"
            amountColor = ShopUtils.COLORS.TEXT_PRIMARY
        elseif record.type == "daily_reward" then
            amountText = "+" .. (record.totalAmount or record.total_amount or 0) .. " é‡‘å¸"
            amountColor = ShopUtils.COLORS.SUCCESS
        elseif record.type == "membership_purchase" then
            amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " é‡‘å¸"
            amountColor = ShopUtils.COLORS.ERROR
        end
        amountLabel.Text = amountText
        amountLabel.Font = Enum.Font.SourceSansBold
        amountLabel.TextSize = 14
        amountLabel.TextColor3 = amountColor
        amountLabel.Size = UDim2.new(0, 120, 0, 20)
        amountLabel.Position = UDim2.new(1, -130, 0, 30)
        amountLabel.BackgroundTransparency = 1
        amountLabel.TextXAlignment = Enum.TextXAlignment.Right
        amountLabel.Parent = recordCard

        yPos = yPos + 90
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- æ˜¾ç¤ºä¼šå‘˜ç®¡ç†é¢æ¿
function ShopAdminPanel._showMembershipPanel(showNotification)
    print("ğŸ‘¥ [ä¼šå‘˜ç®¡ç†] åŠ è½½ä¼šå‘˜ç®¡ç†é¢æ¿ï¼ŒæŸ¥çœ‹ç”¨æˆ·:", currentViewingPlayer)

    if not currentViewingPlayer then
        local noPlayerLabel = Instance.new("TextLabel")
        noPlayerLabel.Text = "âŒ è¯·å…ˆé€‰æ‹©è¦ç®¡ç†çš„ç”¨æˆ·"
        noPlayerLabel.Font = Enum.Font.SourceSans
        noPlayerLabel.TextSize = 16
        noPlayerLabel.TextColor3 = ShopUtils.COLORS.ERROR
        noPlayerLabel.Size = UDim2.new(1, 0, 0, 100)
        noPlayerLabel.BackgroundTransparency = 1
        noPlayerLabel.TextXAlignment = Enum.TextXAlignment.Center
        noPlayerLabel.Parent = contentArea
        return
    end

    -- æ˜¾ç¤ºå½“å‰ç®¡ç†çš„ç”¨æˆ·ä¿¡æ¯
    local userInfoLabel = Instance.new("TextLabel")
    userInfoLabel.Text = "ğŸ‘¥ æ­£åœ¨ç®¡ç† " .. currentViewingPlayer .. " çš„ä¼šå‘˜çŠ¶æ€"
    userInfoLabel.Font = Enum.Font.SourceSansBold
    userInfoLabel.TextSize = 16
    userInfoLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    userInfoLabel.Size = UDim2.new(1, 0, 0, 30)
    userInfoLabel.BackgroundTransparency = 1
    userInfoLabel.TextXAlignment = Enum.TextXAlignment.Center
    userInfoLabel.Parent = contentArea

    -- è¿”å›ç”¨æˆ·ç®¡ç†æŒ‰é’®
    local backBtn = ShopUtils.createButton("â† è¿”å›ç”¨æˆ·ç®¡ç†", ShopUtils.COLORS.ACCENT, contentArea, function()
        ShopAdminPanel._resetToDefaultTabs()
        ShopAdminPanel.switchTab("users")
    end)
    backBtn.Position = UDim2.new(0, 10, 0, 40)
    backBtn.Size = UDim2.new(0, 120, 0, 30)
    backBtn.TextSize = 12

    -- æ˜¾ç¤ºåŠ è½½æç¤º
    local loadingLabel = Instance.new("TextLabel")
    loadingLabel.Text = "ğŸ“¡ æ­£åœ¨åŠ è½½ " .. currentViewingPlayer .. " çš„ä¼šå‘˜ä¿¡æ¯..."
    loadingLabel.Font = Enum.Font.SourceSans
    loadingLabel.TextSize = 14
    loadingLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    loadingLabel.Size = UDim2.new(1, 0, 0, 50)
    loadingLabel.Position = UDim2.new(0, 0, 0, 80)
    loadingLabel.BackgroundTransparency = 1
    loadingLabel.TextXAlignment = Enum.TextXAlignment.Center
    loadingLabel.Parent = contentArea

    -- ä»æœåŠ¡å™¨è·å–ç‰¹å®šç”¨æˆ·çš„ä¼šå‘˜çŠ¶æ€
    local connection
    connection = ShopEvents.Admin.GetAllUsersWithMembership.OnClientEvent:Connect(function(success, response)
        connection:Disconnect()
        loadingLabel:Destroy()

        if success and response and response.success then
            local users = response.data.users or {}
            local targetUser = nil

            -- æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
            for _, user in pairs(users) do
                if user.username == currentViewingPlayer then
                    targetUser = user
                    break
                end
            end

            if targetUser then
                ShopAdminPanel._displayUserMembership(targetUser)
            else
                local errorLabel = Instance.new("TextLabel")
                errorLabel.Text = "âŒ æœªæ‰¾åˆ°ç”¨æˆ· " .. currentViewingPlayer .. " çš„ä¼šå‘˜ä¿¡æ¯"
                errorLabel.Font = Enum.Font.SourceSans
                errorLabel.TextSize = 14
                errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
                errorLabel.Size = UDim2.new(1, 0, 0, 50)
                errorLabel.Position = UDim2.new(0, 0, 0, 80)
                errorLabel.BackgroundTransparency = 1
                errorLabel.TextXAlignment = Enum.TextXAlignment.Center
                errorLabel.Parent = contentArea
            end
        else
            local errorMsg = response and response.message or "è·å–ä¼šå‘˜æ•°æ®å¤±è´¥"
            print("âŒ ç”¨æˆ·ä¼šå‘˜æ•°æ®åŠ è½½å¤±è´¥:", errorMsg)
            local errorLabel = Instance.new("TextLabel")
            errorLabel.Text = "âŒ " .. errorMsg
            errorLabel.Font = Enum.Font.SourceSans
            errorLabel.TextSize = 14
            errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
            errorLabel.Size = UDim2.new(1, 0, 0, 50)
            errorLabel.Position = UDim2.new(0, 0, 0, 80)
            errorLabel.BackgroundTransparency = 1
            errorLabel.TextXAlignment = Enum.TextXAlignment.Center
            errorLabel.Parent = contentArea
        end
    end)

    -- å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
    if ShopEvents.Admin.GetAllUsersWithMembership then
        ShopEvents.Admin.GetAllUsersWithMembership:FireServer(1, 50, "all")
    else
        loadingLabel:Destroy()
        local errorLabel = Instance.new("TextLabel")
        errorLabel.Text = "âŒ ä¼šå‘˜ç®¡ç†åŠŸèƒ½ä¸å¯ç”¨"
        errorLabel.Font = Enum.Font.SourceSans
        errorLabel.TextSize = 14
        errorLabel.TextColor3 = ShopUtils.COLORS.ERROR
        errorLabel.Size = UDim2.new(1, 0, 0, 50)
        errorLabel.Position = UDim2.new(0, 0, 0, 80)
        errorLabel.BackgroundTransparency = 1
        errorLabel.TextXAlignment = Enum.TextXAlignment.Center
        errorLabel.Parent = contentArea
    end
end

-- æ˜¾ç¤ºå•ä¸ªç”¨æˆ·çš„ä¼šå‘˜ç®¡ç†ä¿¡æ¯
function ShopAdminPanel._displayUserMembership(user)
    print("ğŸ‘¥ [ä¼šå‘˜ç®¡ç†] æ˜¾ç¤ºç”¨æˆ·ä¼šå‘˜ä¿¡æ¯:", user.username)

    local membershipStatus = user.membership_status or "none"
    local isMember = membershipStatus == "active"
    local yPos = 140  -- ä»è¿”å›æŒ‰é’®ä¸‹æ–¹å¼€å§‹

    -- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
    local userCard = Instance.new("Frame")
    userCard.Name = "UserMembershipCard"
    userCard.Size = UDim2.new(1, -20, 0, 200)
    userCard.Position = UDim2.new(0, 10, 0, yPos)
    userCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    userCard.BorderSizePixel = 0
    userCard.Parent = contentArea
    ShopUtils.createCorner(userCard, 8)

    -- ç”¨æˆ·åç§°
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Text = "ğŸ‘¤ " .. user.username .. " (ID: " .. user.user_id .. ")"
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.TextSize = 18
    nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    nameLabel.Size = UDim2.new(1, -20, 0, 25)
    nameLabel.Position = UDim2.new(0, 10, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = userCard

    -- é‡‘å¸æ•°é‡
    local coinsLabel = Instance.new("TextLabel")
    coinsLabel.Text = "ğŸ’° " .. (user.coins or 0) .. " é‡‘å¸"
    coinsLabel.Font = Enum.Font.SourceSans
    coinsLabel.TextSize = 14
    coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
    coinsLabel.Size = UDim2.new(0.3, 0, 0, 20)
    coinsLabel.Position = UDim2.new(0, 10, 0, 40)
    coinsLabel.BackgroundTransparency = 1
    coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
    coinsLabel.Parent = userCard

    -- ä¼šå‘˜çŠ¶æ€
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Text = isMember and "ğŸ‘‘ æ´»è·ƒä¼šå‘˜" or "ğŸ‘¤ æ™®é€šç”¨æˆ·"
    statusLabel.Font = Enum.Font.SourceSansBold
    statusLabel.TextSize = 14
    statusLabel.TextColor3 = isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
    statusLabel.Size = UDim2.new(0.3, 0, 0, 20)
    statusLabel.Position = UDim2.new(0.35, 10, 0, 40)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = userCard

    -- å‰©ä½™å¤©æ•°
    local daysRemaining = tonumber(user.days_remaining) or 0
    local daysLabel = Instance.new("TextLabel")
    daysLabel.Text = "â° å‰©ä½™ " .. daysRemaining .. " å¤©"
    daysLabel.Font = Enum.Font.SourceSans
    daysLabel.TextSize = 12
    daysLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    daysLabel.Size = UDim2.new(0.3, 0, 0, 20)
    daysLabel.Position = UDim2.new(0.7, 10, 0, 40)
    daysLabel.BackgroundTransparency = 1
    daysLabel.TextXAlignment = Enum.TextXAlignment.Left
    daysLabel.Parent = userCard

    -- ä¼šå‘˜å¼€å§‹æ—¶é—´
    if user.start_date then
        local startLabel = Instance.new("TextLabel")
        startLabel.Text = "ğŸ“… å¼€å§‹æ—¶é—´: " .. user.start_date:sub(1, 10)
        startLabel.Font = Enum.Font.SourceSans
        startLabel.TextSize = 12
        startLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        startLabel.Size = UDim2.new(0.4, 0, 0, 20)
        startLabel.Position = UDim2.new(0, 10, 0, 70)
        startLabel.BackgroundTransparency = 1
        startLabel.TextXAlignment = Enum.TextXAlignment.Left
        startLabel.Parent = userCard
    end

    -- ä¼šå‘˜ç»“æŸæ—¶é—´
    if user.end_date then
        local endLabel = Instance.new("TextLabel")
        endLabel.Text = "ğŸ“… ç»“æŸæ—¶é—´: " .. user.end_date:sub(1, 10)
        endLabel.Font = Enum.Font.SourceSans
        endLabel.TextSize = 12
        endLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        endLabel.Size = UDim2.new(0.4, 0, 0, 20)
        endLabel.Position = UDim2.new(0.5, 10, 0, 70)
        endLabel.BackgroundTransparency = 1
        endLabel.TextXAlignment = Enum.TextXAlignment.Left
        endLabel.Parent = userCard
    end

    -- æ¯æ—¥å¥–åŠ±
    local dailyReward = tonumber(user.daily_reward_coins) or 100
    local rewardLabel = Instance.new("TextLabel")
    rewardLabel.Text = "ğŸ æ¯æ—¥å¥–åŠ±: " .. dailyReward .. " é‡‘å¸"
    rewardLabel.Font = Enum.Font.SourceSans
    rewardLabel.TextSize = 12
    rewardLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
    rewardLabel.Size = UDim2.new(0.4, 0, 0, 20)
    rewardLabel.Position = UDim2.new(0, 10, 0, 100)
    rewardLabel.BackgroundTransparency = 1
    rewardLabel.TextXAlignment = Enum.TextXAlignment.Left
    rewardLabel.Parent = userCard

    yPos = yPos + 220

    -- æ§åˆ¶é¢æ¿
    local controlCard = Instance.new("Frame")
    controlCard.Name = "ControlCard"
    controlCard.Size = UDim2.new(1, -20, 0, 150)
    controlCard.Position = UDim2.new(0, 10, 0, yPos)
    controlCard.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    controlCard.BorderSizePixel = 0
    controlCard.Parent = contentArea
    ShopUtils.createCorner(controlCard, 8)

    -- æ§åˆ¶æ ‡é¢˜
    local controlTitle = Instance.new("TextLabel")
    controlTitle.Text = "âš™ï¸ ä¼šå‘˜æ§åˆ¶"
    controlTitle.Font = Enum.Font.SourceSansBold
    controlTitle.TextSize = 16
    controlTitle.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    controlTitle.Size = UDim2.new(1, -20, 0, 25)
    controlTitle.Position = UDim2.new(0, 10, 0, 10)
    controlTitle.BackgroundTransparency = 1
    controlTitle.TextXAlignment = Enum.TextXAlignment.Left
    controlTitle.Parent = controlCard

    -- åˆ‡æ¢ä¼šå‘˜çŠ¶æ€æŒ‰é’®
    local toggleBtn = ShopUtils.createButton(
        isMember and "ğŸ”´ åœç”¨ä¼šå‘˜" or "ğŸŸ¢ æ¿€æ´»ä¼šå‘˜",
        isMember and ShopUtils.COLORS.ERROR or ShopUtils.COLORS.SUCCESS,
        controlCard,
        function()
            ShopAdminPanel._toggleUserMembership(user)
        end
    )
    toggleBtn.Position = UDim2.new(0, 10, 0, 40)
    toggleBtn.Size = UDim2.new(0, 120, 0, 30)
    toggleBtn.TextSize = 12

    -- è®¾ç½®åˆ°æœŸæ—¶é—´
    local daysInput = Instance.new("TextBox")
    daysInput.Text = tostring(daysRemaining)
    daysInput.Font = Enum.Font.SourceSans
    daysInput.TextSize = 12
    daysInput.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    daysInput.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    daysInput.Size = UDim2.new(0, 80, 0, 25)
    daysInput.Position = UDim2.new(0, 150, 0, 40)
    daysInput.PlaceholderText = "å¤©æ•°"
    daysInput.Parent = controlCard
    ShopUtils.createCorner(daysInput, 4)

    local setDaysBtn = ShopUtils.createButton("è®¾ç½®å¤©æ•°", ShopUtils.COLORS.ACCENT, controlCard, function()
        local newDays = tonumber(daysInput.Text)
        if newDays and newDays >= 0 and newDays <= 365 then
            ShopAdminPanel._setMembershipDays(user, newDays)
        else
            print("âŒ å¤©æ•°å¿…é¡»åœ¨ 0-365 ä¹‹é—´")
        end
    end)
    setDaysBtn.Position = UDim2.new(0, 240, 0, 40)
    setDaysBtn.Size = UDim2.new(0, 80, 0, 25)
    setDaysBtn.TextSize = 12

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 170)
end

-- æ˜¾ç¤ºä¼šå‘˜ç®¡ç†æ•°æ®
function ShopAdminPanel._displayMembershipData()
    print("ğŸ‘¥ [ä¼šå‘˜ç®¡ç†] æ˜¾ç¤ºä¼šå‘˜æ•°æ®")

    local yPos = 10

    for playerName, membershipInfo in pairs(membershipData) do
        local entryFrame = Instance.new("Frame")
        entryFrame.Name = playerName .. "_Entry"
        entryFrame.Size = UDim2.new(1, -20, 0, 100)
        entryFrame.Position = UDim2.new(0, 10, 0, yPos)
        entryFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
        entryFrame.BorderSizePixel = 0
        entryFrame.Parent = contentArea
        ShopUtils.createCorner(entryFrame, 8)

        -- ç©å®¶åç§°
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Text = "ğŸ‘¤ " .. playerName
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 16
        nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
        nameLabel.Size = UDim2.new(0.2, 0, 0, 25)
        nameLabel.Position = UDim2.new(0, 10, 0, 5)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.Parent = entryFrame

        -- é‡‘å¸æ•°é‡
        local coinsLabel = Instance.new("TextLabel")
        coinsLabel.Text = "ğŸ’° " .. membershipInfo.coins .. " é‡‘å¸"
        coinsLabel.Font = Enum.Font.SourceSans
        coinsLabel.TextSize = 12
        coinsLabel.TextColor3 = ShopUtils.COLORS.WARNING
        coinsLabel.Size = UDim2.new(0.15, 0, 0, 20)
        coinsLabel.Position = UDim2.new(0, 10, 0, 30)
        coinsLabel.BackgroundTransparency = 1
        coinsLabel.TextXAlignment = Enum.TextXAlignment.Left
        coinsLabel.Parent = entryFrame

        -- ä¼šå‘˜çŠ¶æ€
        local statusLabel = Instance.new("TextLabel")
        statusLabel.Text = membershipInfo.isMember and "âœ“ ä¼šå‘˜" or "æ™®é€šç”¨æˆ·"
        statusLabel.Font = Enum.Font.SourceSansBold
        statusLabel.TextSize = 12
        statusLabel.TextColor3 = membershipInfo.isMember and ShopUtils.COLORS.SUCCESS or ShopUtils.COLORS.TEXT_MUTED
        statusLabel.Size = UDim2.new(0.12, 0, 0, 20)
        statusLabel.Position = UDim2.new(0.2, 10, 0, 10)
        statusLabel.BackgroundTransparency = 1
        statusLabel.TextXAlignment = Enum.TextXAlignment.Left
        statusLabel.Parent = entryFrame

        -- å‰©ä½™å¤©æ•°
        local daysLabel = Instance.new("TextLabel")
        local daysText = "å‰©ä½™" .. membershipInfo.daysRemaining .. "å¤©"
        daysLabel.Text = daysText
        daysLabel.Font = Enum.Font.SourceSans
        daysLabel.TextSize = 12
        daysLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
        daysLabel.Size = UDim2.new(0.12, 0, 0, 20)
        daysLabel.Position = UDim2.new(0.2, 10, 0, 30)
        daysLabel.BackgroundTransparency = 1
        daysLabel.TextXAlignment = Enum.TextXAlignment.Left
        daysLabel.Parent = entryFrame

        -- æ“ä½œæŒ‰é’®
        local quickButton = ShopUtils.createButton(
            membershipInfo.isMember and "ğŸ”´ åœç”¨" or "ğŸŸ¢ æ¿€æ´»",
            membershipInfo.isMember and ShopUtils.COLORS.ERROR or ShopUtils.COLORS.SUCCESS,
            entryFrame,
            function()
                ShopAdminPanel._toggleUserMembershipByName(playerName, membershipInfo)
            end
        )
        quickButton.Position = UDim2.new(0.8, 0, 0, 10)
        quickButton.Size = UDim2.new(0, 80, 0, 25)
        quickButton.TextSize = 12

        local manageButton = ShopUtils.createButton("âš™ï¸ ç®¡ç†", ShopUtils.COLORS.ACCENT, entryFrame, function()
            ShopAdminPanel._showPlayerMembership(playerName, membershipInfo)
        end)
        manageButton.Position = UDim2.new(0.8, 0, 0, 40)
        manageButton.Size = UDim2.new(0, 80, 0, 25)
        manageButton.TextSize = 12

        yPos = yPos + 110
    end

    contentArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- é€šè¿‡ç”¨æˆ·ååˆ‡æ¢ä¼šå‘˜çŠ¶æ€
function ShopAdminPanel._toggleUserMembershipByName(playerName, membershipInfo)
    print("ğŸ”„ [ä¼šå‘˜ç®¡ç†] é€šè¿‡ç”¨æˆ·ååˆ‡æ¢ä¼šå‘˜çŠ¶æ€:", playerName)

    local isMember = membershipInfo.isMember
    local action = isMember and "deactivate" or "activate"

    local requestData = {
        playerName = playerName,
        action = action,
        days = action == "activate" and 30 or nil,
        dailyReward = membershipInfo.dailyReward or 100
    }

    if ShopEvents.Admin.ManageUserMembership then
        ShopEvents.Admin.ManageUserMembership:FireServer(requestData)

        local connection
        connection = ShopEvents.Admin.ManageUserMembership.OnClientEvent:Connect(function(success, response)
            connection:Disconnect()

            if success and response and response.success then
                print("âœ…", playerName, "ä¼šå‘˜çŠ¶æ€åˆ‡æ¢æˆåŠŸ")
                -- é‡æ–°è·å–ç”¨æˆ·æ•°æ®å¹¶åˆ·æ–°ç•Œé¢
                if ShopEvents.Admin.GetUserInfo then
                    ShopEvents.Admin.GetUserInfo:FireServer(playerName)
                end
                -- åˆ·æ–°ç”¨æˆ·åˆ—è¡¨ä»¥æ›´æ–°æ‰€æœ‰ç›¸å…³æ•°æ®
                ShopAdminPanel._refreshPlayerData()
            else
                local errorMsg = response and (response.message or response.error) or "æ“ä½œå¤±è´¥"
                print("âŒ ä¼šå‘˜çŠ¶æ€åˆ‡æ¢å¤±è´¥:", errorMsg)
                ShopUtils.showNotification("âŒ " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("âŒ ManageUserMembership äº‹ä»¶ä¸å­˜åœ¨")
    end
end

-- åˆ‡æ¢ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
function ShopAdminPanel._toggleUserMembership(user)
    print("ğŸ”„ [ä¼šå‘˜ç®¡ç†] åˆ‡æ¢ç”¨æˆ·ä¼šå‘˜çŠ¶æ€:", user.username)

    local membershipStatus = user.membership_status or "none"
    local isMember = membershipStatus == "active"
    local action = isMember and "deactivate" or "activate"

    local requestData = {
        userId = tostring(user.user_id),
        action = action,
        days = action == "activate" and 30 or nil,
        dailyReward = tonumber(user.daily_reward_coins) or 100
    }

    if ShopEvents.Admin.ManageUserMembership then
        ShopEvents.Admin.ManageUserMembership:FireServer(requestData)

        local connection
        connection = ShopEvents.Admin.ManageUserMembership.OnClientEvent:Connect(function(success, response)
            connection:Disconnect()

            if success and response and response.success then
                print("âœ…", user.username, "ä¼šå‘˜çŠ¶æ€åˆ‡æ¢æˆåŠŸ")
                ShopUtils.showNotification("âœ… " .. user.username .. " ä¼šå‘˜çŠ¶æ€åˆ‡æ¢æˆåŠŸ", true, currentScreenGui)

                -- å¼‚æ­¥åˆ·æ–°é¢æ¿æ•°æ®ï¼Œé¿å…é˜»å¡ç•Œé¢
                spawn(function()
                    -- é‡æ–°è·å–ç”¨æˆ·æ•°æ®å¹¶åˆ·æ–°é¢æ¿
                    if currentViewingPlayer then
                        if ShopEvents.Admin.GetUserInfo then
                            ShopEvents.Admin.GetUserInfo:FireServer(currentViewingPlayer)
                        end
                        -- ç­‰å¾…æ•°æ®æ›´æ–°ç„¶ååˆ·æ–°é¢æ¿
                        task.wait(0.3)
                        ShopAdminPanel._showMembershipPanel()
                    end
                end)
            else
                local errorMsg = response and response.message or "æ“ä½œå¤±è´¥"
                print("âŒ ä¼šå‘˜çŠ¶æ€åˆ‡æ¢å¤±è´¥:", errorMsg)
                ShopUtils.showNotification("âŒ " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("âŒ ManageUserMembership äº‹ä»¶ä¸å­˜åœ¨")
    end
end

-- è®¾ç½®ä¼šå‘˜å¤©æ•°
function ShopAdminPanel._setMembershipDays(user, days)
    print("ğŸ“… [ä¼šå‘˜ç®¡ç†] è®¾ç½®ç”¨æˆ·ä¼šå‘˜å¤©æ•°:", user.username, days)

    local requestData = {
        userId = tostring(user.user_id),
        action = "set_days",
        days = days,
        dailyReward = tonumber(user.daily_reward_coins) or 100
    }

    if ShopEvents.Admin.ManageUserMembership then
        ShopEvents.Admin.ManageUserMembership:FireServer(requestData)

        local connection
        connection = ShopEvents.Admin.ManageUserMembership.OnClientEvent:Connect(function(success, response)
            connection:Disconnect()

            if success and response and response.success then
                local successMsg = response.message or "ä¼šå‘˜å¤©æ•°è®¾ç½®æˆåŠŸ"
                print("âœ…", user.username, successMsg)
                ShopUtils.showNotification("âœ… " .. user.username .. " " .. successMsg, true, currentScreenGui)

                -- å¼‚æ­¥åˆ·æ–°é¢æ¿æ•°æ®ï¼Œé¿å…é˜»å¡ç•Œé¢
                spawn(function()
                    -- é‡æ–°è·å–ç”¨æˆ·æ•°æ®å¹¶åˆ·æ–°é¢æ¿
                    if currentViewingPlayer then
                        if ShopEvents.Admin.GetUserInfo then
                            ShopEvents.Admin.GetUserInfo:FireServer(currentViewingPlayer)
                        end
                        -- ç­‰å¾…æ•°æ®æ›´æ–°ç„¶ååˆ·æ–°é¢æ¿
                        task.wait(0.3)
                        ShopAdminPanel._showMembershipPanel()
                    end
                end)
            else
                local errorMsg = response and response.message or "æ“ä½œå¤±è´¥"
                print("âŒ ä¼šå‘˜å¤©æ•°è®¾ç½®å¤±è´¥:", errorMsg)
                ShopUtils.showNotification("âŒ " .. errorMsg, false, currentScreenGui)
            end
        end)
    else
        print("âŒ ManageUserMembership äº‹ä»¶ä¸å­˜åœ¨")
    end
end

-- è®¾ç½®æ¯æ—¥å¥–åŠ±
function ShopAdminPanel._setDailyReward(user, reward)
    print("ğŸ [ä¼šå‘˜ç®¡ç†] è®¾ç½®ç”¨æˆ·æ¯æ—¥å¥–åŠ±:", user.username, reward)

    local requestData = {
        userId = tostring(user.user_id),
        action = "set_reward",
        days = tonumber(user.days_remaining) or 0,
        dailyReward = reward
    }

    if ShopEvents.Admin.ManageUserMembership then
        ShopEvents.Admin.ManageUserMembership:FireServer(requestData)

        local connection
        connection = ShopEvents.Admin.ManageUserMembership.OnClientEvent:Connect(function(success, response)
            connection:Disconnect()

            if success and response and response.success then
                print("âœ…", user.username, "æ¯æ—¥å¥–åŠ±è®¾ç½®æˆåŠŸ")
                -- é‡æ–°è·å–ç”¨æˆ·æ•°æ®å¹¶åˆ·æ–°é¢æ¿
                if currentViewingPlayer then
                    if ShopEvents.Admin.GetUserInfo then
                        ShopEvents.Admin.GetUserInfo:FireServer(currentViewingPlayer)
                    end
                    -- ç¨ç­‰ç‰‡åˆ»è®©æ•°æ®æ›´æ–°ï¼Œç„¶ååˆ·æ–°é¢æ¿
                    task.wait(0.5)
                    ShopAdminPanel._showMembershipPanel()
                end
            else
                local errorMsg = response and response.message or "æ“ä½œå¤±è´¥"
                print("âŒ æ¯æ—¥å¥–åŠ±è®¾ç½®å¤±è´¥:", errorMsg)
            end
        end)
    else
        print("âŒ ManageUserMembership äº‹ä»¶ä¸å­˜åœ¨")
    end
end

-- åˆ·æ–°ç©å®¶æ•°æ®
function ShopAdminPanel._refreshPlayerData()
    print("ğŸ”„ [ç®¡ç†é¢æ¿] åˆ·æ–°ç©å®¶æ•°æ®")

    if currentTab == "players" then
        -- é‡æ–°è·å–ç”¨æˆ·åˆ—è¡¨
        if ShopEvents.Admin.GetAllUsers then
            ShopEvents.Admin.GetAllUsers:FireServer()
        end
    elseif currentTab == "membership" then
        -- é‡æ–°è·å–ä¼šå‘˜æ•°æ®
        ShopAdminPanel._showMembershipPanel()
    end
end

return ShopAdminPanel
