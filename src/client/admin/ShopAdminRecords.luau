-- å•†åº—ç®¡ç†å‘˜ç•Œé¢æ¨¡å— - é€‚é…å™¨æ¨¡å¼
-- ç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„ShopAdminPanel

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopUtils = require(script.Parent.Parent:WaitForChild("ShopUtils"))

-- å¯¼å…¥ç»Ÿä¸€çš„ç®¡ç†é¢æ¿
local ShopAdminPanel = require(script.Parent:WaitForChild("ShopAdminPanel"))

local player = Players.LocalPlayer

local ShopAdminRecords = {}

-- å­˜å‚¨å¾…å¤„ç†çš„ç®¡ç†å‘˜æŸ¥çœ‹è®°å½•è¯·æ±‚ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
ShopAdminRecords.pendingPlayerName = nil
ShopAdminRecords.pendingScreenGui = nil

-- æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿ - ç°åœ¨ç›´æ¥è°ƒç”¨ç»Ÿä¸€é¢æ¿
function ShopAdminRecords.showAdminPanel(screenGui, showNotification)
    print("ğŸ”§ [ç®¡ç†å‘˜é¢æ¿é€‚é…å™¨] è°ƒç”¨ç»Ÿä¸€ç®¡ç†é¢æ¿")

    -- æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if not Config.isValidAdmin(player) then
        print("âŒ [ç®¡ç†å‘˜é¢æ¿é€‚é…å™¨] ç®¡ç†å‘˜æƒé™æ£€æŸ¥å¤±è´¥")
        if showNotification then
            showNotification("âŒ æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™", false)
        end
        return
    end

    -- ç›´æ¥è°ƒç”¨ç»Ÿä¸€çš„ç®¡ç†é¢æ¿
    ShopAdminPanel.showAdminPanel(screenGui, showNotification)
end

-- æ˜¾ç¤ºå…¶ä»–ç©å®¶çš„è´­ä¹°è®°å½•ï¼ˆä¿æŒå‘åå…¼å®¹æ€§ï¼‰
function ShopAdminRecords.showPlayerRecords(playerName, records, screenGui)
    print("ğŸ“Š [ç®¡ç†å‘˜è®°å½•é€‚é…å™¨] æ˜¾ç¤ºç©å®¶è®°å½•:", playerName, "è®°å½•æ•°é‡:", records and #records or 0)

    -- æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    if not Config.isValidAdmin(player) then
        print("âŒ [ç®¡ç†å‘˜è®°å½•é€‚é…å™¨] æƒé™æ£€æŸ¥å¤±è´¥")
        return
    end

    print("âœ… [ç®¡ç†å‘˜è®°å½•é€‚é…å™¨] æƒé™éªŒè¯é€šè¿‡ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ™®é€šç”¨æˆ·è®°å½•æ ¼å¼")

    -- åˆ›å»ºè®°å½•æŸ¥çœ‹çª—å£ - æ¨¡ä»¿æ™®é€šç”¨æˆ·äº¤æ˜“è®°å½•çš„æ ·å¼
    local recordFrame = Instance.new("Frame")
    recordFrame.Name = "PlayerRecordFrame"
    recordFrame.Size = UDim2.new(0, 600, 0, 500)
    recordFrame.Position = UDim2.new(0.5, -300, 0.5, -250)
    recordFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    recordFrame.BorderSizePixel = 0
    recordFrame.ZIndex = 3100
    recordFrame.Parent = screenGui
    ShopUtils.createCorner(recordFrame, 12)

    -- æ ‡é¢˜æ 
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 50)
    titleBar.BackgroundColor3 = ShopUtils.COLORS.ACCENT
    titleBar.BorderSizePixel = 0
    titleBar.Parent = recordFrame
    ShopUtils.createCorner(titleBar, 12)

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "ğŸ“Š " .. playerName .. " çš„äº¤æ˜“è®°å½•"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 18
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(1, -50, 1, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Center
    titleLabel.Parent = titleBar

    -- å…³é—­æŒ‰é’®
    local closeBtn = ShopUtils.createButton("âœ—", ShopUtils.COLORS.ERROR, titleBar, function()
        recordFrame:Destroy()
    end)
    closeBtn.Position = UDim2.new(1, -45, 0, 5)
    closeBtn.Size = UDim2.new(0, 40, 0, 40)
    closeBtn.TextSize = 18

    -- è®°å½•æ»šåŠ¨åŒºåŸŸ
    local scrollArea = Instance.new("ScrollingFrame")
    scrollArea.Name = "ScrollArea"
    scrollArea.Size = UDim2.new(1, -20, 1, -70)
    scrollArea.Position = UDim2.new(0, 10, 0, 60)
    scrollArea.BackgroundTransparency = 1
    scrollArea.BorderSizePixel = 0
    scrollArea.ScrollBarThickness = 8
    scrollArea.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    scrollArea.Parent = recordFrame

    -- æ˜¾ç¤ºè®°å½• - ä½¿ç”¨ä¸æ™®é€šç”¨æˆ·è®°å½•ç›¸åŒçš„æ ¼å¼
    local yPos = 10
    if records and #records > 0 then
        for i, record in ipairs(records) do
            local recordCard = Instance.new("Frame")
            recordCard.Name = "Record" .. i
            recordCard.Size = UDim2.new(1, -20, 0, 80)
            recordCard.Position = UDim2.new(0, 10, 0, yPos)
            recordCard.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
            recordCard.BorderSizePixel = 0
            recordCard.Parent = scrollArea
            ShopUtils.createCorner(recordCard, 8)

            -- æ—¶é—´æˆ³
            local timeLabel = Instance.new("TextLabel")
            timeLabel.Text = ShopUtils.formatTimestamp(record.timestamp or record.createdAt)
            timeLabel.Font = Enum.Font.SourceSans
            timeLabel.TextSize = 12
            timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
            timeLabel.Size = UDim2.new(0, 150, 0, 20)
            timeLabel.Position = UDim2.new(0, 10, 0, 5)
            timeLabel.BackgroundTransparency = 1
            timeLabel.TextXAlignment = Enum.TextXAlignment.Left
            timeLabel.Parent = recordCard

            -- äº¤æ˜“ç±»å‹å’Œç‰©å“ - ä½¿ç”¨ä¸æ™®é€šç”¨æˆ·è®°å½•ç›¸åŒçš„æ ¼å¼
            local actionLabel = Instance.new("TextLabel")
            local actionText = ""
            if record.type == "buy" or record.action == "buy" then
                actionText = "ğŸ›’ è´­ä¹° " .. (record.itemName or record.item_name or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
            elseif record.type == "sell" or record.action == "sell" then
                actionText = "ğŸ’° å–å‡º " .. (record.itemName or record.item_name or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
            elseif record.type == "admin" or record.action == "admin_edit" then
                actionText = "âš™ï¸ ç®¡ç†å‘˜æ“ä½œ x" .. (record.quantity or 1)
            elseif record.type == "daily_reward" then
                actionText = "ğŸ æ¯æ—¥å¥–åŠ± x" .. (record.quantity or 1)
            end
            actionLabel.Text = actionText
            actionLabel.Font = Enum.Font.SourceSansBold
            actionLabel.TextSize = 16
            actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
            actionLabel.Size = UDim2.new(1, -20, 0, 25)
            actionLabel.Position = UDim2.new(0, 10, 0, 25)
            actionLabel.BackgroundTransparency = 1
            actionLabel.TextXAlignment = Enum.TextXAlignment.Left
            actionLabel.Parent = recordCard

            -- é‡‘é¢ - ä½¿ç”¨ä¸æ™®é€šç”¨æˆ·è®°å½•ç›¸åŒçš„æ ¼å¼
            local amountLabel = Instance.new("TextLabel")
            local amountText = ""
            local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
            if record.type == "buy" or record.action == "buy" then
                amountText = "-" .. (record.totalAmount or record.totalCost or record.total_amount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.ERROR
            elseif record.type == "sell" or record.action == "sell" then
                amountText = "+" .. (record.totalAmount or record.totalEarned or record.total_amount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.type == "admin" or record.action == "admin_edit" then
                amountText = (record.totalAmount or record.total_amount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.TEXT_PRIMARY
            elseif record.type == "daily_reward" then
                amountText = "+" .. (record.totalAmount or record.total_amount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.SUCCESS
            end
            amountLabel.Text = amountText
            amountLabel.Font = Enum.Font.SourceSansBold
            amountLabel.TextSize = 14
            amountLabel.TextColor3 = amountColor
            amountLabel.Size = UDim2.new(0, 120, 0, 20)
            amountLabel.Position = UDim2.new(1, -130, 0, 30)
            amountLabel.BackgroundTransparency = 1
            amountLabel.TextXAlignment = Enum.TextXAlignment.Right
            amountLabel.Parent = recordCard

            yPos = yPos + 90
        end
    else
        -- æ— è®°å½•æç¤º
        local noRecordLabel = Instance.new("TextLabel")
        noRecordLabel.Text = "ğŸ“ è¯¥ç©å®¶æš‚æ— äº¤æ˜“è®°å½•"
        noRecordLabel.Font = Enum.Font.SourceSans
        noRecordLabel.TextSize = 16
        noRecordLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
        noRecordLabel.Size = UDim2.new(1, 0, 0, 100)
        noRecordLabel.BackgroundTransparency = 1
        noRecordLabel.TextXAlignment = Enum.TextXAlignment.Center
        noRecordLabel.Parent = scrollArea
        yPos = yPos + 120
    end

    scrollArea.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- åºŸå¼ƒçš„å‡½æ•°ä¿æŒå­˜åœ¨ä»¥ä¿è¯å…¼å®¹æ€§ï¼Œä½†é‡å®šå‘åˆ°ç»Ÿä¸€é¢æ¿
function ShopAdminRecords.displayAllPlayersData(parentFrame, allPlayersData, showNotification)
    print("âš ï¸ [åºŸå¼ƒå‡½æ•°] displayAllPlayersData è¢«è°ƒç”¨ï¼Œå»ºè®®ä½¿ç”¨ç»Ÿä¸€ç®¡ç†é¢æ¿")
    -- è¿™ä¸ªå‡½æ•°ä¿æŒå­˜åœ¨ä½†ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œå› ä¸ºç°åœ¨ä½¿ç”¨ç»Ÿä¸€é¢æ¿
end

return ShopAdminRecords