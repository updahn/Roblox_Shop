-- å•†åº—UIç³»ç»Ÿä¸»æ–‡ä»¶ - æ¨¡å—åŒ–æ¶æ„

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopData = require(SharedModules:WaitForChild("ShopData"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))

-- å¯¼å…¥æ‹†åˆ†çš„æ¨¡å—
local ShopUtils = require(script.Parent.Parent:WaitForChild("ShopUtils"))
local ShopBuy = require(script.Parent:WaitForChild("ShopBuy"))
local ShopSell = require(script.Parent:WaitForChild("ShopSell"))
local ShopRecords = require(script.Parent:WaitForChild("ShopRecords"))
local ShopAdminRecords = require(script.Parent.Parent.admin:WaitForChild("ShopAdminRecords"))

local ShopUI = {}
ShopUI.__index = ShopUI

-- UIçŠ¶æ€
local currentTab = "buy" -- "buy", "sell", "records"
local playerData = nil
local shopData = nil -- å­˜å‚¨ä»æœåŠ¡å™¨è·å–çš„å•†åº—æ•°æ®ï¼ˆåŒ…å«å®æ—¶åº“å­˜ï¼‰
local lastAdminStatus = false -- è®°å½•ä¸Šæ¬¡çš„ç®¡ç†å‘˜çŠ¶æ€ï¼Œç”¨äºæ£€æµ‹å˜åŒ–
local isShopOpen = false

-- UIå…ƒç´ 
local screenGui = nil
local mainFrame = nil
local coinLabel = nil
local membershipLabel = nil
local tabButtons = {}
local contentFrame = nil
local scrollFrame = nil
local titleLabel = nil
local membershipData = nil

-- äº‹ä»¶è¿æ¥ç®¡ç†
local eventConnections = {}
local eventsConnected = false

-- åˆ›å»ºæ•°é‡é€‰æ‹©å¯¹è¯æ¡†
function ShopUI.showQuantityDialog(itemId, action, item)
    -- å¦‚æœæ²¡æœ‰ä¼ é€’itemå‚æ•°ï¼Œå°è¯•ä»shopDataè·å–
    if not item then
        item = shopData and shopData[itemId]
    end
    if not item then
        warn("ShopUI: æ— æ³•æ‰¾åˆ°ç‰©å“æ•°æ® " .. tostring(itemId))
        return
    end

    -- åˆ›å»ºå¯¹è¯æ¡†èƒŒæ™¯
    local dialogBg = Instance.new("Frame")
    dialogBg.Name = "QuantityDialogBg"
    dialogBg.Size = UDim2.new(1, 0, 1, 0)
    dialogBg.Position = UDim2.new(0, 0, 0, 0)
    dialogBg.BackgroundColor3 = ShopUtils.COLORS.OVERLAY
    dialogBg.BackgroundTransparency = 0.5
    dialogBg.BorderSizePixel = 0
    dialogBg.ZIndex = 1000
    dialogBg.Parent = screenGui

    -- å¯¹è¯æ¡†ä¸»ä½“
    local dialog = Instance.new("Frame")
    dialog.Name = "QuantityDialog"
    dialog.Size = UDim2.new(0, 400, 0, 300)
    dialog.Position = UDim2.new(0.5, -200, 0.5, -150)
    dialog.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    dialog.BorderSizePixel = 0
    dialog.ZIndex = 1001
    dialog.Parent = dialogBg

    ShopUtils.createCorner(dialog, 16)

    -- æ¯›ç»ç’ƒæ•ˆæœ
    local glassBg = Instance.new("Frame")
    glassBg.Size = UDim2.new(1, 0, 1, 0)
    glassBg.BackgroundColor3 = ShopUtils.COLORS.GLASS_BG
    glassBg.BackgroundTransparency = 0.2
    glassBg.BorderSizePixel = 0
    glassBg.ZIndex = 1001
    glassBg.Parent = dialog
    ShopUtils.createCorner(glassBg, 16)

    -- æ ‡é¢˜
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Text = action == "buy" and "è´­ä¹°å•†å“" or "å–å‡ºå•†å“"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 24
    title.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    title.Size = UDim2.new(1, -40, 0, 50)
    title.Position = UDim2.new(0, 20, 0, 20)
    title.BackgroundTransparency = 1
    title.ZIndex = 1002
    title.Parent = dialog

    -- å•†å“ä¿¡æ¯
    local itemInfo = Instance.new("TextLabel")
    local sellPrice = math.floor(item.price * 0.8) -- ä½¿ç”¨é»˜è®¤sell rate
    itemInfo.Text = "ğŸ“¦ " .. item.name .. "\nğŸ’° " .. (action == "buy" and item.price or sellPrice) .. " é‡‘å¸/ä¸ª"
    itemInfo.Font = Enum.Font.SourceSans
    itemInfo.TextSize = 16
    itemInfo.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    itemInfo.Size = UDim2.new(1, -40, 0, 50)
    itemInfo.Position = UDim2.new(0, 20, 0, 80)
    itemInfo.BackgroundTransparency = 1
    itemInfo.ZIndex = 1002
    itemInfo.Parent = dialog

    -- æ•°é‡æ§åˆ¶åŒºåŸŸ
    local quantityFrame = Instance.new("Frame")
    quantityFrame.Size = UDim2.new(0, 200, 0, 60)
    quantityFrame.Position = UDim2.new(0.5, -100, 0, 140)
    quantityFrame.BackgroundTransparency = 1
    quantityFrame.ZIndex = 1002
    quantityFrame.Parent = dialog

    -- å‡å°‘æŒ‰é’®
    local minusButton = ShopUtils.createButton("-", ShopUtils.COLORS.ERROR, quantityFrame, nil)
    minusButton.Size = UDim2.new(0, 50, 0, 50)
    minusButton.Position = UDim2.new(0, 0, 0, 0)
    minusButton.TextSize = 24
    minusButton.ZIndex = 1002

    -- æ•°é‡è¾“å…¥æ¡†
    local quantityBox = Instance.new("TextBox")
    quantityBox.Name = "QuantityBox"
    quantityBox.Text = "1"
    quantityBox.Font = Enum.Font.SourceSansBold
    quantityBox.TextSize = 20
    quantityBox.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    quantityBox.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    quantityBox.BorderSizePixel = 0
    quantityBox.Size = UDim2.new(0, 100, 0, 50)
    quantityBox.Position = UDim2.new(0, 50, 0, 0)
    quantityBox.PlaceholderText = "æ•°é‡"
    quantityBox.ZIndex = 1002
    quantityBox.Parent = quantityFrame

    ShopUtils.createCorner(quantityBox, 8)

    -- å¢åŠ æŒ‰é’®
    local plusButton = ShopUtils.createButton("+", ShopUtils.COLORS.SUCCESS, quantityFrame, nil)
    plusButton.Size = UDim2.new(0, 50, 0, 50)
    plusButton.Position = UDim2.new(0, 150, 0, 0)
    plusButton.TextSize = 24
    plusButton.ZIndex = 1002

    -- æ•°é‡æ§åˆ¶é€»è¾‘
    local currentQuantity = 1
    local maxQuantity

    if action == "buy" then
        -- è´­ä¹°æ—¶çš„æœ€å¤§æ•°é‡é™åˆ¶
        if shopData and shopData[itemId] and shopData[itemId].currentStock ~= nil then
            maxQuantity = shopData[itemId].currentStock == -1 and 999 or shopData[itemId].currentStock
        elseif item.maxQuantity ~= nil then
            maxQuantity = item.maxQuantity == -1 and 999 or item.maxQuantity
        else
            maxQuantity = 999
        end
    else
        -- å–å‡ºæ—¶çš„æœ€å¤§æ•°é‡é™åˆ¶ï¼ˆç©å®¶æ‹¥æœ‰çš„æ•°é‡ï¼‰
        maxQuantity = (playerData and playerData.inventory[itemId]) or 0
    end

    local function updateQuantity(newQuantity)
        currentQuantity = math.max(1, math.min(maxQuantity, newQuantity))
        quantityBox.Text = tostring(currentQuantity)

        local sellPrice = math.floor(item.price * 0.8) -- ä½¿ç”¨é»˜è®¤sell rate
        local totalPrice = currentQuantity * (action == "buy" and item.price or sellPrice)
        itemInfo.Text = "ğŸ“¦ " .. item.name .. "\nğŸ’° æ€»è®¡: " .. totalPrice .. " é‡‘å¸"
    end

    minusButton.MouseButton1Click:Connect(function()
        updateQuantity(currentQuantity - 1)
    end)

    plusButton.MouseButton1Click:Connect(function()
        updateQuantity(currentQuantity + 1)
    end)

    quantityBox.FocusLost:Connect(function()
        local newQuantity = tonumber(quantityBox.Text) or 1
        updateQuantity(newQuantity)
    end)

    -- æŒ‰é’®åŒºåŸŸ
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Size = UDim2.new(1, -40, 0, 50)
    buttonFrame.Position = UDim2.new(0, 20, 0, 220)
    buttonFrame.BackgroundTransparency = 1
    buttonFrame.ZIndex = 1002
    buttonFrame.Parent = dialog

    -- ç¡®è®¤æŒ‰é’®
    local confirmButton = ShopUtils.createButton("âœ“ ç¡®è®¤", ShopUtils.COLORS.SUCCESS, buttonFrame, function()
        if action == "buy" then
            ShopEvents.User.BuyItem:FireServer(itemId, currentQuantity)
        else
            ShopEvents.User.SellItem:FireServer(itemId, currentQuantity)
        end

        dialogBg:Destroy()
    end)
    confirmButton.Position = UDim2.new(0, 0, 0, 0)
    confirmButton.Size = UDim2.new(0, 150, 0, 40)
    confirmButton.ZIndex = 1002

    -- å–æ¶ˆæŒ‰é’®
    local cancelButton = ShopUtils.createButton("âœ— å–æ¶ˆ", ShopUtils.COLORS.ERROR, buttonFrame, function()
        dialogBg:Destroy()
    end)
    cancelButton.Position = UDim2.new(1, -150, 0, 0)
    cancelButton.Size = UDim2.new(0, 150, 0, 40)
    cancelButton.ZIndex = 1002

    -- å¼¹å‡ºåŠ¨ç”»
    dialog.Size = UDim2.new(0, 0, 0, 0)
    dialog.Position = UDim2.new(0.5, 0, 0.5, 0)

    local openTween = TweenService:Create(dialog, TweenInfo.new(0.3, Enum.EasingStyle.Back), {
        Size = UDim2.new(0, 400, 0, 300),
        Position = UDim2.new(0.5, -200, 0.5, -150)
    })
    openTween:Play()

    updateQuantity(1)
end

-- æ›´æ–°ä¼šå‘˜çŠ¶æ€æ•°æ®
function ShopUI.updateMembershipStatus()
    if not playerData then return end

    -- ç›´æ¥ä»playerDataä¸­è·å–ä¼šå‘˜çŠ¶æ€ä¿¡æ¯
    if playerData.membership then
        membershipData = playerData.membership
        print("âœ… [ä¼šå‘˜çŠ¶æ€] å·²æ›´æ–°ä¼šå‘˜ä¿¡æ¯:", membershipData.hasMembership and "æœ‰ä¼šå‘˜" or "æ— ä¼šå‘˜", membershipData.daysRemaining and ("å‰©ä½™" .. membershipData.daysRemaining .. "å¤©") or "")
    else
        membershipData = {
            hasMembership = false,
            isValid = false,
            daysRemaining = 0,
            membershipType = nil
        }
        print("â„¹ï¸ [ä¼šå‘˜çŠ¶æ€] ç”¨æˆ·æ— ä¼šå‘˜çŠ¶æ€")
    end

    -- ç«‹å³æ›´æ–°UIæ˜¾ç¤º
    ShopUI.updateUI()
end

-- ä¸Šæ¬¡æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€çš„æ—¶é—´
local lastAdminCheckTime = 0
local ADMIN_CHECK_INTERVAL = 30 -- 30ç§’æ£€æŸ¥ä¸€æ¬¡

-- æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å˜åŒ–å¹¶æ›´æ–°UIï¼ˆä¼˜åŒ–ç‰ˆï¼‰
local function checkAdminStatusChange()
    local currentTime = tick()

    -- å¦‚æœè·ç¦»ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´å°äºé—´éš”ï¼Œè·³è¿‡æ£€æŸ¥
    if (currentTime - lastAdminCheckTime) < ADMIN_CHECK_INTERVAL then
        return false
    end

    lastAdminCheckTime = currentTime
    local currentAdminStatus = Config.isValidAdmin(player)

    if currentAdminStatus ~= lastAdminStatus then
        print("ğŸ”„ [è°ƒè¯•] ç®¡ç†å‘˜çŠ¶æ€å‘ç”Ÿå˜åŒ–:", lastAdminStatus, "â†’", currentAdminStatus)
        lastAdminStatus = currentAdminStatus

        -- æ¸…ç©ºç®¡ç†å‘˜æƒé™ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°æ£€æŸ¥
        Config.refreshAdminCache(player)

        return true
    end
    return false
end

-- æ›´æ–°UIæ˜¾ç¤º
function ShopUI.updateUI()
    if not screenGui or not mainFrame then return end

    -- æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€æ˜¯å¦å˜åŒ–
    local adminStatusChanged = checkAdminStatusChange()

    -- æ›´æ–°é‡‘å¸æ˜¾ç¤º
    if coinLabel and playerData then
        coinLabel.Text = "ğŸ’° " .. (playerData.coins or 0) .. " é‡‘å¸"
    elseif coinLabel then
        coinLabel.Text = "ğŸ’° è¿æ¥ä¸­..."
    end

    -- æ›´æ–°ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º
    if membershipLabel then
        if membershipData and membershipData.hasMembership and membershipData.isValid then
            local daysRemaining = membershipData.daysRemaining or 0
            membershipLabel.Text = "ğŸ‘‘ ä¼šå‘˜å‰©ä½™: " .. daysRemaining .. "å¤©"
            membershipLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
            membershipLabel.Visible = true
        else
            membershipLabel.Text = "æ™®é€šç”¨æˆ·"
            membershipLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
            membershipLabel.Visible = true
        end
    end

    -- æ›´æ–°æ ‡é¢˜
    if titleLabel then
        if currentTab == "buy" then
            titleLabel.Text = "ğŸ›’ å•†åº—è´­ä¹°"
        elseif currentTab == "sell" then
            titleLabel.Text = "ğŸ’° ç‰©å“å–å‡º"
        elseif currentTab == "records" then
            titleLabel.Text = "ğŸ“Š è´­ä¹°è®°å½•"
        end
    end

    -- æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
    for tabName, button in pairs(tabButtons) do
        ShopUtils.setButtonActive(button, tabName == currentTab)
    end

    -- æ¸…ç©ºæ»šåŠ¨æ¡†å†…å®¹ï¼Œé˜²æ­¢ç•Œé¢å…ƒç´ æ··åˆ
    if scrollFrame then
        for _, child in pairs(scrollFrame:GetChildren()) do
            if child:IsA("Frame") then
                child:Destroy()
            end
        end
    end

    -- æ ¹æ®å½“å‰æ ‡ç­¾é¡µæ˜¾ç¤ºå†…å®¹
    if currentTab == "buy" then
        ShopBuy.showBuyItems(scrollFrame, shopData, playerData, ShopUI.showQuantityDialog)
    elseif currentTab == "sell" then
        ShopSell.showSellItems(scrollFrame, shopData, playerData, ShopUI.showQuantityDialog)
    elseif currentTab == "records" then
        -- å¦‚æœç®¡ç†å‘˜çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¼ºåˆ¶åˆ·æ–°è®°å½•é¡µé¢
        if adminStatusChanged then
            print("ğŸ”„ [è°ƒè¯•] ç”±äºç®¡ç†å‘˜çŠ¶æ€å˜åŒ–ï¼Œå¼ºåˆ¶åˆ·æ–°è®°å½•é¡µé¢")
        end

        -- æ€»æ˜¯å…ˆè°ƒç”¨ showPurchaseRecords æ¥è®¾ç½®ç•Œé¢ï¼Œç„¶åå¤„ç†æ•°æ®
        ShopRecords.showPurchaseRecords(scrollFrame, playerData, function()
            ShopAdminRecords.showAdminPanel(screenGui, function(message, isSuccess)
                ShopUtils.showNotification(message, isSuccess, screenGui)
            end)
        end)

        -- å¦‚æœå·²æœ‰äº¤æ˜“è®°å½•æ•°æ®ï¼Œä½¿ç”¨å·²æœ‰æ•°æ®ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
        if playerData and playerData.transactionHistory then
            print("ğŸ“Š [äº¤æ˜“è®°å½•] ä½¿ç”¨å·²æœ‰æ•°æ®æ˜¾ç¤ºè®°å½•ï¼Œé¿å…é‡å¤è¯·æ±‚")
            ShopRecords.handleTransactionResponse(true, nil, {
                transactions = playerData.transactionHistory,
                stats = playerData.transactionStats
            })
        end
    end
end

-- åˆ›å»ºä¸»ç•Œé¢
function ShopUI.createUI()
    if screenGui then
        screenGui:Destroy()
    end

    -- åˆ›å»ºScreenGui
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ShopUI"
    screenGui.ResetOnSpawn = false
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.IgnoreGuiInset = false
    screenGui.Parent = playerGui

    -- ä¸»æ¡†æ¶
    mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = Config.UI.SIZES.MAIN_FRAME
    mainFrame.Position = UDim2.new(0.5, -Config.UI.SIZES.MAIN_FRAME.X.Offset/2, 0.5, -Config.UI.SIZES.MAIN_FRAME.Y.Offset/2)
    mainFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.BorderSizePixel = 0
    mainFrame.Visible = false
    mainFrame.ClipsDescendants = true
    mainFrame.Parent = screenGui

    ShopUtils.createCorner(mainFrame, 20)

    -- é¡¶éƒ¨æ 
    local topBar = Instance.new("Frame")
    topBar.Name = "TopBar"
    topBar.Size = UDim2.new(1, -4, 0, 90)
    topBar.Position = UDim2.new(0, 2, 0, 2)
    topBar.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    topBar.BorderSizePixel = 0
    topBar.ClipsDescendants = true
    topBar.Parent = mainFrame

    ShopUtils.createCorner(topBar, 20)

    -- é®ç½©åº•éƒ¨åœ†è§’
    local topBarMask = Instance.new("Frame")
    topBarMask.Size = UDim2.new(1, 0, 0, 20)
    topBarMask.Position = UDim2.new(0, 0, 1, -20)
    topBarMask.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    topBarMask.BorderSizePixel = 0
    topBarMask.Parent = topBar

    -- æ ‡é¢˜
    titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Text = "ğŸ›’ å•†åº—è´­ä¹°"
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 28
    titleLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleLabel.Size = UDim2.new(0, 350, 0, 90)
    titleLabel.Position = UDim2.new(0, 40, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = topBar

    -- é‡‘å¸æ˜¾ç¤º
    coinLabel = Instance.new("TextLabel")
    coinLabel.Name = "CoinLabel"
    coinLabel.Text = "ğŸ’° åŠ è½½ä¸­..."
    coinLabel.Font = Enum.Font.GothamBold
    coinLabel.TextSize = 16
    coinLabel.TextColor3 = ShopUtils.COLORS.WARNING
    coinLabel.Size = UDim2.new(0, 150, 0, 20)
    coinLabel.Position = UDim2.new(1, -210, 0, 15)
    coinLabel.BackgroundTransparency = 1
    coinLabel.TextXAlignment = Enum.TextXAlignment.Right
    coinLabel.TextTruncate = Enum.TextTruncate.AtEnd
    coinLabel.TextScaled = true
    coinLabel.Parent = topBar

    -- ä¼šå‘˜çŠ¶æ€æ˜¾ç¤º
    membershipLabel = Instance.new("TextLabel")
    membershipLabel.Name = "MembershipLabel"
    membershipLabel.Text = "æ£€æŸ¥ä¼šå‘˜çŠ¶æ€ä¸­..."
    membershipLabel.Font = Enum.Font.Gotham
    membershipLabel.TextSize = 12
    membershipLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    membershipLabel.Size = UDim2.new(0, 150, 0, 18)
    membershipLabel.Position = UDim2.new(1, -210, 0, 40)
    membershipLabel.BackgroundTransparency = 1
    membershipLabel.TextXAlignment = Enum.TextXAlignment.Right
    membershipLabel.TextTruncate = Enum.TextTruncate.AtEnd
    membershipLabel.TextScaled = true
    membershipLabel.Parent = topBar


    -- æ¯æ—¥å¥–åŠ±æŒ‰é’®
    local rewardButton = ShopUtils.createButton("ğŸ é¢†å–å¥–åŠ±", ShopUtils.COLORS.SUCCESS, topBar, function()
        ShopUI.claimDailyRewards()
    end)
    rewardButton.Name = "RewardButton"
    rewardButton.Size = UDim2.new(0, 90, 0, 25)
    rewardButton.Position = UDim2.new(1, -210, 0, 55)
    rewardButton.TextSize = 12
    rewardButton.Visible = false

    -- åˆ›å»ºæŒ‰é’®å®¹å™¨æ¡†æ¶ä»¥ç¡®ä¿ä¸€è‡´çš„å¸ƒå±€
    local tabContainer = Instance.new("Frame")
    tabContainer.Name = "TabContainer"
    tabContainer.Size = UDim2.new(0, 320, 0, 50)
    tabContainer.Position = UDim2.new(1, -540, 0, 20)
    tabContainer.BackgroundTransparency = 1
    tabContainer.Parent = topBar

    -- æ·»åŠ UIListLayoutä»¥ç¡®ä¿æŒ‰é’®é—´è·ä¸€è‡´
    local listLayout = Instance.new("UIListLayout")
    listLayout.FillDirection = Enum.FillDirection.Horizontal
    listLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    listLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    listLayout.Padding = UDim.new(0, 8) -- 8åƒç´ çš„ç»Ÿä¸€é—´è·
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Parent = tabContainer

    -- æ ‡ç­¾æŒ‰é’®æ•°æ® - æŒ‰æ­£ç¡®é¡ºåºæ’åˆ—ï¼šè´­ä¹°ã€å–å‡ºã€è®°å½•
    local tabData = {
        {name = "buy", text = "ğŸ›’ è´­ä¹°", order = 1},
        {name = "sell", text = "ğŸ’° å–å‡º", order = 2},
        {name = "records", text = "ğŸ“Š è®°å½•", order = 3}
    }

    for _, tab in ipairs(tabData) do
        local button = ShopUtils.createButton(tab.text, ShopUtils.COLORS.SECONDARY, tabContainer, function()
            currentTab = tab.name
            -- åˆ‡æ¢æ ‡ç­¾æ—¶é‡æ–°è·å–æœ€æ–°æ•°æ®
            ShopEvents.User.GetPlayerData:FireServer()
            ShopEvents.User.GetShopData:FireServer()
            ShopUI.updateUI()
        end)

        -- ç¡®ä¿æ‰€æœ‰æŒ‰é’®å®Œå…¨ä¸€è‡´çš„å¤§å°å’Œæ ·å¼
        button.Size = UDim2.new(0, 100, 0, 40)
        button.TextSize = 14
        button.Font = Enum.Font.SourceSansBold
        button.TextScaled = false
        button.TextWrapped = false
        button.TextTruncate = Enum.TextTruncate.None
        button.LayoutOrder = tab.order

        tabButtons[tab.name] = button
    end

    -- å…³é—­æŒ‰é’®
    local closeButton = ShopUtils.createButton("âœ—", ShopUtils.COLORS.ERROR, topBar, function()
        ShopUI.closeShop()
    end)
    closeButton.Position = UDim2.new(1, -50, 0, 10)
    closeButton.Size = UDim2.new(0, 40, 0, 40)
    closeButton.TextSize = 20

    -- æ»šåŠ¨åŒºåŸŸ
    scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollFrame"
    scrollFrame.Size = UDim2.new(1, -70, 1, -140)
    scrollFrame.Position = UDim2.new(0, 25, 0, 115)
    scrollFrame.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    scrollFrame.BackgroundTransparency = 0
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 8
    scrollFrame.ScrollBarImageColor3 = ShopUtils.COLORS.ACCENT
    scrollFrame.ClipsDescendants = true
    scrollFrame.Parent = mainFrame

    -- æ·»åŠ åœ†è§’åˆ°æ»šåŠ¨æ¡†æ¶
    ShopUtils.createCorner(scrollFrame, 12)

    return screenGui
end

-- æ‰“å¼€å•†åº—
function ShopUI.openShop()
    if isShopOpen then return end
    isShopOpen = true

    if not screenGui then
        ShopUI.createUI()
    end

    -- é‡æ–°åŠ è½½å•†å“ä¿¡æ¯
    ShopEvents.User.RefreshData:FireServer()

    -- è·å–ç©å®¶æ•°æ®
    ShopEvents.User.GetPlayerData:FireServer()

    -- æ›´æ–°ä¼šå‘˜çŠ¶æ€
    ShopUI.updateMembershipStatus()

    mainFrame.Visible = true

    -- å¼€å¯åŠ¨ç”»
    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    mainFrame.BackgroundTransparency = 1

    local openTween = TweenService:Create(mainFrame,
        TweenInfo.new(Config.UI.ANIMATIONS.DURATION.SLOW, Config.UI.ANIMATIONS.EASING.BOUNCE, Enum.EasingDirection.Out), {
        Size = Config.UI.SIZES.MAIN_FRAME,
        Position = UDim2.new(0.5, -Config.UI.SIZES.MAIN_FRAME.X.Offset/2, 0.5, -Config.UI.SIZES.MAIN_FRAME.Y.Offset/2),
        BackgroundTransparency = 0
    })

    -- æ·»åŠ æ—‹è½¬æ•ˆæœ
    local rotationTween = TweenService:Create(mainFrame,
        TweenInfo.new(Config.UI.ANIMATIONS.DURATION.SLOW, Config.UI.ANIMATIONS.EASING.BOUNCE, Enum.EasingDirection.Out), {
        Rotation = 0
    })

    -- è®¾ç½®åˆå§‹æ—‹è½¬
    mainFrame.Rotation = -5

    openTween:Play()
    rotationTween:Play()
end

-- å…³é—­å•†åº—
function ShopUI.closeShop()
    if not isShopOpen then return end
    isShopOpen = false

    if mainFrame then
        -- ç®€åŒ–çš„å…³é—­åŠ¨ç”»ï¼šåªç¼©æ”¾å’Œæ·¡å‡º
        local closeTween = TweenService:Create(mainFrame,
            TweenInfo.new(Config.UI.ANIMATIONS.DURATION.NORMAL, Config.UI.ANIMATIONS.EASING.DEFAULT, Enum.EasingDirection.In), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 1
        })

        closeTween:Play()

        closeTween.Completed:Connect(function()
            -- ç¡®ä¿ç•Œé¢å®Œå…¨éšè—
            mainFrame.Visible = false

            -- é‡ç½®ä¸»æ¡†æ¶å±æ€§ä¸ºåˆå§‹çŠ¶æ€
            mainFrame.BackgroundTransparency = 0.1
            mainFrame.Size = Config.UI.SIZES.MAIN_FRAME
            mainFrame.Position = UDim2.new(0.5, -Config.UI.SIZES.MAIN_FRAME.X.Offset/2, 0.5, -Config.UI.SIZES.MAIN_FRAME.Y.Offset/2)
            mainFrame.Rotation = 0
        end)
    end

    ShopUtils.SOUNDS.click:Play()
end

-- é¢†å–æ¯æ—¥å¥–åŠ±
function ShopUI.claimDailyRewards()
    if not playerData or not playerData.id then
        ShopUtils.showNotification("âŒ ç©å®¶æ•°æ®æœªåŠ è½½", false, screenGui)
        return
    end

    local success, message, rewardData = nil, nil, nil
    local callSuccess, callResult = pcall(function()
        return false, "åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨"
    end)

    if callSuccess then
        success, message, rewardData = callResult
    else
        success = false
        message = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆæˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥"
    end

    if success then
        if rewardData and rewardData.totalRewards > 0 then
            ShopUtils.showNotification("âœ… " .. message .. " è·å¾— " .. rewardData.totalRewards .. " é‡‘å¸", true, screenGui)
            -- åˆ·æ–°ç©å®¶æ•°æ®
            ShopEvents.User.GetPlayerData:FireServer()
        else
            ShopUtils.showNotification("â„¹ï¸ ä»Šæ—¥å¥–åŠ±å·²é¢†å–å®Œæ¯•", true, screenGui)
        end
    else
        ShopUtils.showNotification("âŒ " .. (message or "é¢†å–å¤±è´¥"), false, screenGui)
    end
end

-- æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥
function ShopUI.disconnectEvents()
    for _, connection in pairs(eventConnections) do
        if connection then
            connection:Disconnect()
        end
    end
    eventConnections = {}
    eventsConnected = false
    print("ğŸ”Œ [äº‹ä»¶ç®¡ç†] å·²æ–­å¼€æ‰€æœ‰äº‹ä»¶è¿æ¥")
end

-- äº‹ä»¶è¿æ¥
function ShopUI.connectEvents()
    -- å¦‚æœå·²ç»è¿æ¥è¿‡äº‹ä»¶ï¼Œå…ˆæ–­å¼€æ—§è¿æ¥
    if eventsConnected then
        print("ğŸ”„ [äº‹ä»¶ç®¡ç†] æ£€æµ‹åˆ°é‡å¤è¿æ¥ï¼Œæ­£åœ¨æ¸…ç†æ—§è¿æ¥...")
        ShopUI.disconnectEvents()
    end

    -- è·å–ç©å®¶æ•°æ®å“åº”
    eventConnections.getPlayerData = ShopEvents.User.GetPlayerData.OnClientEvent:Connect(function(data)
        if data then
            playerData = data
            print("âœ… [æ•°æ®åŒæ­¥] ç©å®¶æ•°æ®å·²æ›´æ–° | é‡‘å¸: " .. (data.coins or 0))

            -- æ›´æ–°ä¼šå‘˜çŠ¶æ€
            ShopUI.updateMembershipStatus()

            -- æ›´æ–°UI
            ShopUI.updateUI()
        else
            warn("âš ï¸ [æ•°æ®åŒæ­¥] ç©å®¶æ•°æ®ä¸ºç©ºï¼Œå¯èƒ½å­˜åœ¨ç½‘ç»œè¿æ¥é—®é¢˜")
            -- è®¾ç½®é»˜è®¤æ•°æ®é˜²æ­¢ç©ºæŒ‡é’ˆé”™è¯¯
            playerData = {
                coins = 0,
                inventory = {},
                membership = {
                    hasMembership = false,
                    isValid = false,
                    daysRemaining = 0,
                    membershipType = nil
                },
                stats = {
                    totalPurchases = 0,
                    totalSales = 0,
                    totalSpent = 0,
                    totalEarned = 0
                }
            }
            ShopUI.updateMembershipStatus()
            ShopUI.updateUI()
        end
    end)

    -- è·å–å•†åº—æ•°æ®å“åº”
    eventConnections.getShopData = ShopEvents.User.GetShopData.OnClientEvent:Connect(function(data)
        shopData = data
        local itemCount = 0
        if data then
            for _ in pairs(data) do
                itemCount = itemCount + 1
            end
        end
        print("âœ… [æ•°æ®åŒæ­¥] å•†åº—æ•°æ®å·²æ›´æ–° | å•†å“ç§ç±»: " .. itemCount)
        ShopUI.updateUI()
    end)

    -- è´­ä¹°å“åº”
    eventConnections.buyItem = ShopEvents.User.BuyItem.OnClientEvent:Connect(function(success, message, newData)
        if success then
            playerData = newData

            -- ç«‹å³æ›´æ–°ä¼šå‘˜çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯è´­ä¹°ä¼šå‘˜å•†å“åï¼‰
            ShopUI.updateMembershipStatus()

            -- åˆ·æ–°å•†åº—æ•°æ®
            ShopEvents.User.RefreshData:FireServer()
            ShopUI.updateUI()

            ShopUtils.showNotification("âœ… " .. message, true, screenGui)

            -- å®æ—¶åˆ·æ–°äº¤æ˜“è®°å½•
            ShopRecords.forceRefreshTransactions()
        else
            ShopUtils.showNotification("âŒ " .. message, false, screenGui)
        end
    end)

    -- å–å‡ºå“åº”
    eventConnections.sellItem = ShopEvents.User.SellItem.OnClientEvent:Connect(function(success, message, newData)
        if success then
            playerData = newData
            -- åˆ·æ–°å•†åº—æ•°æ®
            ShopEvents.User.RefreshData:FireServer()
            ShopUI.updateUI()
            ShopUtils.showNotification("âœ… " .. message, true, screenGui)

            -- å®æ—¶åˆ·æ–°äº¤æ˜“è®°å½•
            ShopRecords.forceRefreshTransactions()
        else
            ShopUtils.showNotification("âŒ " .. message, false, screenGui)
        end
    end)

    -- ç®¡ç†å‘˜åŠŸèƒ½å“åº”
    eventConnections.setPlayerCoins = ShopEvents.Admin.SetUserCoins.OnClientEvent:Connect(function(success, message)
        if success then
            ShopUtils.showNotification("âœ… " .. message, true, screenGui)
        else
            ShopUtils.showNotification("âŒ " .. message, false, screenGui)
        end
    end)

    eventConnections.getPlayerPurchaseHistory = ShopEvents.Admin.GetUserHistory.OnClientEvent:Connect(function(success, message, data)
        print("ğŸ“Š [ShopUI] GetUserHistoryäº‹ä»¶å“åº”:", success, message, data and "æœ‰æ•°æ®" or "æ— æ•°æ®")

        if not success then
            -- å½“å¤±è´¥æ—¶ï¼Œmessage åŒ…å«é”™è¯¯ä¿¡æ¯
            local errorMsg = message or "è·å–ç”¨æˆ·å†å²è®°å½•å¤±è´¥"
            ShopUtils.showNotification("âŒ " .. errorMsg, false, screenGui)
            ShopRecords.handleAdminHistoryResponse(success, errorMsg, nil)
        elseif data then
            -- å½“æˆåŠŸæ—¶ï¼Œä½¿ç”¨ç»Ÿä¸€çš„å¤„ç†å‡½æ•°
            ShopRecords.handleAdminHistoryResponse(success, message, data)
        end
    end)

    -- ç”¨æˆ·äº¤æ˜“è®°å½•å“åº”
    eventConnections.getTransactions = ShopEvents.User.GetTransactions.OnClientEvent:Connect(function(success, errorMsg, responseData)
        print("ğŸ“Š [äº¤æ˜“è®°å½•] äº‹ä»¶å“åº”:", success, errorMsg, responseData and "æœ‰æ•°æ®" or "æ— æ•°æ®")

        if success and responseData then
            -- æ›´æ–° playerData ä»¥åŒ…å«äº¤æ˜“è®°å½•
            if playerData then
                playerData.transactionHistory = responseData.transactions
                playerData.transactionStats = responseData.stats

                print("ğŸ“Š [äº¤æ˜“è®°å½•] å·²è·å– " .. #responseData.transactions .. " æ¡äº¤æ˜“è®°å½•")

                -- é€šçŸ¥ShopRecordsæ¨¡å—æ›´æ–°UI
                ShopRecords.handleTransactionResponse(success, errorMsg, responseData)

                -- åˆ·æ–°å…¶ä»–UIæ˜¾ç¤º
                ShopUI.updateUI()
            end
        else
            local error = errorMsg or "è·å–äº¤æ˜“è®°å½•å¤±è´¥"
            print("âŒ [äº¤æ˜“è®°å½•] å¤±è´¥:", error)

            -- é€šçŸ¥ShopRecordsæ¨¡å—æ˜¾ç¤ºé”™è¯¯
            ShopRecords.handleTransactionResponse(success, error, responseData)

            ShopUtils.showNotification("âŒ " .. tostring(error), false, screenGui)
        end
    end)

    -- é”®ç›˜è¾“å…¥
    eventConnections.keyboardInput = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end

        if input.KeyCode == Enum.KeyCode.E then
            if isShopOpen then
                ShopUI.closeShop()
            else
                ShopUI.openShop()
            end
        end
    end)

    -- æ ‡è®°äº‹ä»¶å·²è¿æ¥
    eventsConnected = true
    print("ğŸ”— [äº‹ä»¶ç®¡ç†] æ‰€æœ‰äº‹ä»¶å·²æˆåŠŸè¿æ¥")
end

-- åˆå§‹åŒ–
function ShopUI.init()
    ShopUI.connectEvents()

    -- è·å–ç³»ç»Ÿé…ç½®ï¼ˆåŒ…æ‹¬sell_rateï¼‰
    -- ç³»ç»Ÿé…ç½®å°†ç”±æœåŠ¡å™¨ç«¯ç®¡ç†
    print("ğŸ“¡ [å®¢æˆ·ç«¯] æ­£åœ¨è·å–ç³»ç»Ÿé…ç½®...")

    -- è¯·æ±‚ç©å®¶æ•°æ®
    if ShopEvents.User.GetPlayerData then
        ShopEvents.User.GetPlayerData:FireServer()
        print("ğŸ“¡ [å®¢æˆ·ç«¯] æ­£åœ¨åŒæ­¥ç©å®¶æ•°æ®...")
    else
        warn("âš ï¸ GetPlayerData è¿œç¨‹äº‹ä»¶æœªæ‰¾åˆ°")
    end

    -- è¯·æ±‚å•†åº—æ•°æ®
    if ShopEvents.User.GetShopData then
        ShopEvents.User.GetShopData:FireServer()
        print("ğŸ“¡ [å®¢æˆ·ç«¯] æ­£åœ¨åŒæ­¥å•†åº—æ•°æ®...")
    else
        warn("âš ï¸ GetShopData è¿œç¨‹äº‹ä»¶æœªæ‰¾åˆ°")
    end

    print("ğŸ¨ [å•†åº—UI] å•†åº—ç³»ç»Ÿå·²å°±ç»ª")
    print("ğŸ”§ [æ§åˆ¶] æŒ‰ E é”®æ‰“å¼€å•†åº—")
end

return ShopUI