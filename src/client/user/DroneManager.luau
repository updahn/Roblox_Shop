-- æ— äººæœºç³»ç»Ÿå®¢æˆ·ç«¯ç®¡ç†å™¨
-- å¤„ç†æ— äººæœºUIã€æŽ§åˆ¶å’Œè§†è§‰æ•ˆæžœ

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local DroneManager = {}
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- ç­‰å¾…æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local Events = require(SharedModules:WaitForChild("ShopEvents"))

-- ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®
local DroneConfig = Config.DRONE_CONFIG

-- UIå…ƒç´ 
local screenGui
local droneFrame
local spawnButton
local recallButton
local modeButton
local statusLabel
local timerLabel

-- æ— äººæœºçŠ¶æ€
local droneStatus = {
    isActive = false,
    mode = DroneConfig.MODES.FOLLOW,
    timeRemaining = 0
}

-- ==============================================
-- å†…éƒ¨å·¥å…·å‡½æ•°
-- ==============================================

local function log(message, ...)
    Config.log("INFO", "[å®¢æˆ·ç«¯] " .. message, {...})
end

-- åˆ›å»ºæŒ‰é’®
local function createButton(name, text, position, size, color)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Text = text
    button.Position = position
    button.Size = size
    button.BackgroundColor3 = color
    button.BorderSizePixel = 0
    button.Font = Enum.Font.GothamBold
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextScaled = true

    -- æ·»åŠ åœ†è§’
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button

    -- æ·»åŠ é˜´å½±æ•ˆæžœ
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 4, 1, 4)
    shadow.Position = UDim2.new(0, -2, 0, 2)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.7
    shadow.BorderSizePixel = 0
    shadow.ZIndex = button.ZIndex - 1
    shadow.Parent = button

    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 6)
    shadowCorner.Parent = shadow

    -- ç‚¹å‡»åŠ¨ç”»
    button.MouseButton1Down:Connect(function()
        local pressedSize = UDim2.new(size.X.Scale * 0.95, size.X.Offset * 0.95, size.Y.Scale * 0.95, size.Y.Offset * 0.95)
        local tween = TweenService:Create(button, TweenInfo.new(0.1), {Size = pressedSize})
        tween:Play()
    end)

    button.MouseButton1Up:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.1), {Size = size})
        tween:Play()
    end)

    return button
end

-- åˆ›å»ºæ ‡ç­¾
local function createLabel(name, text, position, size)
    local label = Instance.new("TextLabel")
    label.Name = name
    label.Text = text
    label.Position = position
    label.Size = size
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextScaled = true
    label.TextStrokeTransparency = 0.5

    return label
end

-- ==============================================
-- UIåˆ›å»ºå‡½æ•°
-- ==============================================

-- æ›´æ–°æŒ‰é’®çŠ¶æ€
local function updateButtonStates()
    if droneStatus.isActive then
        spawnButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        spawnButton.Text = "æ— äººæœºæ´»è·ƒ"

        recallButton.BackgroundColor3 = DroneConfig.UI.COLORS.RECALL_BUTTON
        recallButton.Text = DroneConfig.UI.TEXT.RECALL

        modeButton.BackgroundColor3 = DroneConfig.UI.COLORS.MODE_BUTTON
        if droneStatus.mode == DroneConfig.MODES.FOLLOW then
            modeButton.Text = DroneConfig.UI.TEXT.SWITCH_TO_GUARD
        else
            modeButton.Text = DroneConfig.UI.TEXT.SWITCH_TO_FOLLOW
        end

        statusLabel.Text = "çŠ¶æ€: " .. (droneStatus.mode == DroneConfig.MODES.FOLLOW and "è·Ÿéšæ¨¡å¼" or "é©»å®ˆæ¨¡å¼")
    else
        spawnButton.BackgroundColor3 = DroneConfig.UI.COLORS.SPAWN_BUTTON
        spawnButton.Text = DroneConfig.UI.TEXT.SPAWN

        recallButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        recallButton.Text = "æ— æ— äººæœº"

        modeButton.BackgroundColor3 = DroneConfig.UI.COLORS.DISABLED
        modeButton.Text = "æ¨¡å¼åˆ‡æ¢"

        statusLabel.Text = "çŠ¶æ€: å¾…å‘½"
        timerLabel.Text = "å‰©ä½™æ—¶é—´: --"
    end
end

local function createDroneUI()
    -- åˆ›å»ºScreenGuiï¼ˆä½†è®¾ç½®ä¸ºéšè—çŠ¶æ€ï¼‰
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "DroneUI"
    screenGui.ResetOnSpawn = false
    screenGui.Enabled = false  -- éšè—UI
    screenGui.Parent = playerGui

    -- ä¸»æ¡†æž¶
    droneFrame = Instance.new("Frame")
    droneFrame.Name = "DroneFrame"
    droneFrame.Size = UDim2.new(0, 280, 0, 200)
    droneFrame.Position = UDim2.new(1, -300, 1, -220)
    droneFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    droneFrame.BackgroundTransparency = 0.1
    droneFrame.BorderSizePixel = 0
    droneFrame.Parent = screenGui

    -- æ·»åŠ åœ†è§’å’Œé˜´å½±
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = droneFrame

    -- æ ‡é¢˜
    local titleLabel = createLabel("TitleLabel", "ðŸ¤– æ— äººæœºæŽ§åˆ¶", UDim2.new(0, 0, 0, 0), UDim2.new(1, 0, 0, 30))
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.Parent = droneFrame

    -- å¬å”¤æŒ‰é’®
    spawnButton = createButton("SpawnButton", DroneConfig.UI.TEXT.SPAWN,
        UDim2.new(0, 10, 0, 40), UDim2.new(0.45, -7.5, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.SPAWN_BUTTON)
    spawnButton.Parent = droneFrame

    -- æ”¶å›žæŒ‰é’®
    recallButton = createButton("RecallButton", DroneConfig.UI.TEXT.RECALL,
        UDim2.new(0.55, 7.5, 0, 40), UDim2.new(0.45, -7.5, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.RECALL_BUTTON)
    recallButton.Parent = droneFrame

    -- æ¨¡å¼åˆ‡æ¢æŒ‰é’®
    modeButton = createButton("ModeButton", DroneConfig.UI.TEXT.MODE_FOLLOW,
        UDim2.new(0, 10, 0, 90), UDim2.new(1, -20, 0, DroneConfig.UI.BUTTON_SIZE.Y.Offset),
        DroneConfig.UI.COLORS.MODE_BUTTON)
    modeButton.Parent = droneFrame

    -- çŠ¶æ€æ ‡ç­¾
    statusLabel = createLabel("StatusLabel", "çŠ¶æ€: å¾…å‘½",
        UDim2.new(0, 10, 0, 140), UDim2.new(1, -20, 0, 20))
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = droneFrame

    -- è®¡æ—¶å™¨æ ‡ç­¾
    timerLabel = createLabel("TimerLabel", "å‰©ä½™æ—¶é—´: --",
        UDim2.new(0, 10, 0, 165), UDim2.new(1, -20, 0, 20))
    timerLabel.TextXAlignment = Enum.TextXAlignment.Left
    timerLabel.Parent = droneFrame

    -- åˆå§‹åŒ–æŒ‰é’®çŠ¶æ€
    updateButtonStates()
end

-- æ›´æ–°è®¡æ—¶å™¨
local function updateTimer()
    if droneStatus.isActive and droneStatus.timeRemaining > 0 then
        timerLabel.Text = string.format("å‰©ä½™æ—¶é—´: %.1fç§’", droneStatus.timeRemaining)
    else
        timerLabel.Text = "å‰©ä½™æ—¶é—´: --"
    end
end

-- ==============================================
-- äº‹ä»¶å¤„ç†å‡½æ•°
-- ==============================================

local function handleSpawnButtonClick()
    if not droneStatus.isActive then
        log("è¯·æ±‚å¬å”¤æ— äººæœº")
        Events.Drone.SpawnDrone:FireServer()
    end
end

local function handleRecallButtonClick()
    if droneStatus.isActive then
        log("è¯·æ±‚æ”¶å›žæ— äººæœº")
        Events.Drone.RecallDrone:FireServer()
    end
end

local function handleModeButtonClick()
    if droneStatus.isActive then
        local newMode = droneStatus.mode == DroneConfig.MODES.FOLLOW and DroneConfig.MODES.GUARD or DroneConfig.MODES.FOLLOW
        log("è¯·æ±‚åˆ‡æ¢æ— äººæœºæ¨¡å¼åˆ°:", newMode)
        Events.Drone.SwitchDroneMode:FireServer(newMode)
    end
end

-- æœåŠ¡ç«¯äº‹ä»¶å¤„ç†
local function handleDroneSpawned(success)
    if success then
        droneStatus.isActive = true
        droneStatus.mode = DroneConfig.MODES.FOLLOW
        droneStatus.timeRemaining = DroneConfig.LIFETIME

        updateButtonStates()
        log("æ— äººæœºå·²å¬å”¤")
    else
        log("æ— äººæœºå¬å”¤å¤±è´¥")
    end
end

local function handleDroneRecalled(success)
    if success then
        droneStatus.isActive = false
        droneStatus.timeRemaining = 0

        updateButtonStates()
        log("æ— äººæœºå·²æ”¶å›ž")
    end
end

local function handleDroneModeChanged(newMode, oldMode)
    droneStatus.mode = newMode
    updateButtonStates()
    log("æ— äººæœºæ¨¡å¼å·²ä»Ž", oldMode, "åˆ‡æ¢åˆ°", newMode)
end

local function handleDroneDestroyed(reason)
    droneStatus.isActive = false
    droneStatus.timeRemaining = 0

    updateButtonStates()
    log("æ— äººæœºå·²é”€æ¯ï¼ŒåŽŸå› :", reason)

    -- å¯ä»¥åœ¨è¿™é‡Œæ˜¾ç¤ºé€šçŸ¥
end

local function handleDroneAttack(targetName)
    log("æ— äººæœºæ”»å‡»äº†ç›®æ ‡:", targetName)
    -- å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ”»å‡»æŒ‡ç¤ºå™¨æˆ–éŸ³æ•ˆ
end

-- ==============================================
-- åˆå§‹åŒ–å‡½æ•°
-- ==============================================

function DroneManager.init()
    -- åˆ›å»ºUI
    createDroneUI()

    -- è¿žæŽ¥æŒ‰é’®äº‹ä»¶
    spawnButton.MouseButton1Click:Connect(handleSpawnButtonClick)
    recallButton.MouseButton1Click:Connect(handleRecallButtonClick)
    modeButton.MouseButton1Click:Connect(handleModeButtonClick)

    -- è¿žæŽ¥æœåŠ¡ç«¯äº‹ä»¶
    Events.Drone.DroneSpawned.OnClientEvent:Connect(handleDroneSpawned)
    Events.Drone.DroneRecalled.OnClientEvent:Connect(handleDroneRecalled)
    Events.Drone.DroneModeChanged.OnClientEvent:Connect(handleDroneModeChanged)
    Events.Drone.DroneDestroyed.OnClientEvent:Connect(handleDroneDestroyed)
    Events.Drone.DroneAttack.OnClientEvent:Connect(handleDroneAttack)

    -- å¯åŠ¨è®¡æ—¶å™¨æ›´æ–°å¾ªçŽ¯
    spawn(function()
        while true do
            if droneStatus.isActive and droneStatus.timeRemaining > 0 then
                droneStatus.timeRemaining = droneStatus.timeRemaining - 0.1
                updateTimer()

                if droneStatus.timeRemaining <= 0 then
                    -- æ—¶é—´åˆ°ï¼Œé‡ç½®çŠ¶æ€
                    droneStatus.isActive = false
                    updateButtonStates()
                end
            end
            wait(0.1)
        end
    end)

    -- åˆå§‹åŒ–æ— äººæœºç®¡ç†å™¨ï¼ˆå·²ç¦ç”¨ï¼‰
function DroneManager.initialize()
    log("æ— äººæœºç®¡ç†å™¨å·²ç¦ç”¨ï¼Œä¸åˆ›å»ºUIç•Œé¢")
    -- å®Œå…¨ç¦ç”¨æ— äººæœºåŠŸèƒ½ä»¥é¿å…ç•Œé¢æ··ä¹±
    return
end

log("æ— äººæœºç®¡ç†å™¨åˆå§‹åŒ–å‡½æ•°å·²ç¦ç”¨")
end

function DroneManager.cleanup()
    if screenGui then
        screenGui:Destroy()
        screenGui = nil
    end

    log("æ— äººæœºç®¡ç†å™¨å·²æ¸…ç†")
end

-- æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    if input.KeyCode == Enum.KeyCode.B then
        -- Bé”®å¬å”¤æ— äººæœº
        if not droneStatus.isActive then
            handleSpawnButtonClick()
        end
    elseif input.KeyCode == Enum.KeyCode.N then
        -- Né”®æ”¶å›žæ— äººæœº
        if droneStatus.isActive then
            handleRecallButtonClick()
        end
    elseif input.KeyCode == Enum.KeyCode.M then
        -- Mé”®åˆ‡æ¢æ¨¡å¼
        if droneStatus.isActive then
            handleModeButtonClick()
        end
    end
end)

log("æ— äººæœºå®¢æˆ·ç«¯ç®¡ç†å™¨å·²åŠ è½½")

return DroneManager
