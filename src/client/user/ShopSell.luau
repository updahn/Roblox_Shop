-- å•†åº—å–å‡ºç•Œé¢æ¨¡å—

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local ShopData = require(SharedModules:WaitForChild("ShopData"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))
local ShopUtils = require(script.Parent.Parent:WaitForChild("ShopUtils"))

local ShopSell = {}

-- åˆ›å»ºå•†å“å¡ç‰‡ï¼ˆå–å‡ºæ¨¡å¼ï¼‰
function ShopSell.createItemCard(item, itemId, shopData, playerData, showQuantityDialog)
    local card = Instance.new("Frame")
    card.Name = itemId .. "Card"
    card.Size = UDim2.new(1, -50, 0, 120)
    card.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    card.BorderSizePixel = 0
    card.ClipsDescendants = true

    ShopUtils.createCorner(card, 16)

    -- æ·»åŠ æ¸å˜èƒŒæ™¯
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, ShopUtils.COLORS.SECONDARY),
        ColorSequenceKeypoint.new(1, ShopUtils.COLORS.TERTIARY)
    }
    gradient.Rotation = 135
    gradient.Parent = card

    -- æ·»åŠ è¾¹æ¡†å‘å…‰
    local stroke = Instance.new("UIStroke")
    stroke.Color = ShopUtils.COLORS.ACCENT
    stroke.Transparency = 0.8
    stroke.Thickness = 2
    stroke.Parent = card

    -- æ‚¬åœæ•ˆæœ
    card.MouseEnter:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {
            Transparency = 0.3,
            Thickness = 3
        }):Play()
    end)

    card.MouseLeave:Connect(function()
        TweenService:Create(stroke, TweenInfo.new(0.3), {
            Transparency = 0.8,
            Thickness = 2
        }):Play()
    end)

    -- å•†å“å›¾ç‰‡å®¹å™¨
    local imageContainer = Instance.new("Frame")
    imageContainer.Name = "ImageContainer"
    imageContainer.Size = UDim2.new(0, 90, 0, 90)
    imageContainer.Position = UDim2.new(0, 20, 0, 20)
    imageContainer.BackgroundColor3 = ShopUtils.COLORS.PRIMARY
    imageContainer.BorderSizePixel = 0
    imageContainer.Parent = card
    ShopUtils.createCorner(imageContainer, 12)

    -- æ·»åŠ å›¾ç‰‡å®¹å™¨çš„å‘å…‰è¾¹æ¡†
    local imageStroke = Instance.new("UIStroke")
    imageStroke.Color = ShopUtils.COLORS.ACCENT
    imageStroke.Transparency = 0.7
    imageStroke.Thickness = 2
    imageStroke.Parent = imageContainer

    -- å•†å“å›¾ç‰‡
    local imageLabel = Instance.new("ImageLabel")
    imageLabel.Name = "ItemImage"
    imageLabel.Size = UDim2.new(1, -4, 1, -4)
    imageLabel.Position = UDim2.new(0, 2, 0, 2)
    imageLabel.Image = item.imageId or ""
    imageLabel.BackgroundTransparency = 1
    imageLabel.BorderSizePixel = 0
    imageLabel.Parent = imageContainer
    ShopUtils.createCorner(imageLabel, 10)

    -- å•†å“åç§°
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "ItemName"
    nameLabel.Text = item.name
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.TextSize = 18
    nameLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    nameLabel.Size = UDim2.new(0, 300, 0, 25)
    nameLabel.Position = UDim2.new(0, 120, 0, 10)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
    nameLabel.Parent = card

    -- å•†å“æè¿°
    local descLabel = Instance.new("TextLabel")
    descLabel.Name = "ItemDesc"
    descLabel.Text = item.description
    descLabel.Font = Enum.Font.Gotham
    descLabel.TextSize = 13
    descLabel.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    descLabel.Size = UDim2.new(0, 300, 0, 20)
    descLabel.Position = UDim2.new(0, 120, 0, 35)
    descLabel.BackgroundTransparency = 1
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.TextWrapped = true
    descLabel.TextTruncate = Enum.TextTruncate.AtEnd
    descLabel.Parent = card

    -- å–å‡ºä»·æ ¼æ ‡ç­¾
    local sellPrice = math.floor(item.price * 0.8) -- ä½¿ç”¨é»˜è®¤sell rate
    local priceLabel = Instance.new("TextLabel")
    priceLabel.Name = "PriceLabel"
    priceLabel.Text = "ğŸ’° " .. sellPrice .. " é‡‘å¸"
    priceLabel.TextColor3 = ShopUtils.COLORS.SUCCESS
    priceLabel.Font = Enum.Font.GothamBold
    priceLabel.TextSize = 16
    priceLabel.Size = UDim2.new(0, 150, 0, 20)
    priceLabel.Position = UDim2.new(0, 120, 0, 60)
    priceLabel.BackgroundTransparency = 1
    priceLabel.TextXAlignment = Enum.TextXAlignment.Left
    priceLabel.TextTruncate = Enum.TextTruncate.AtEnd
    priceLabel.Parent = card

    -- å–å‡ºæŒ‰é’®
    local sellButton = ShopUtils.createButton("ğŸ’° å–å‡º", ShopUtils.COLORS.WARNING, card, function()
        showQuantityDialog(itemId, "sell", item)
    end)
    sellButton.Position = UDim2.new(0, 300, 0, 85)
    sellButton.Size = UDim2.new(0, 100, 0, 25)

    -- æ‹¥æœ‰æ•°é‡æ˜¾ç¤º
    local stockLabel = Instance.new("TextLabel")
    stockLabel.Name = "StockLabel"
    stockLabel.Font = Enum.Font.Gotham
    stockLabel.TextSize = 12
    stockLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    stockLabel.Size = UDim2.new(0, 120, 0, 20)
    stockLabel.Position = UDim2.new(1, -130, 0, 85)
    stockLabel.BackgroundTransparency = 1
    stockLabel.TextXAlignment = Enum.TextXAlignment.Right
    stockLabel.TextTruncate = Enum.TextTruncate.AtEnd
    stockLabel.Parent = card

    local playerQuantity = (playerData and playerData.inventory[itemId]) or 0
    stockLabel.Text = "æ‹¥æœ‰: " .. playerQuantity

    -- æ£€æŸ¥æ˜¯å¦å¯ä»¥å–å‡º
    local canSell = true -- é»˜è®¤å…è®¸å–å‡ºï¼Œå…·ä½“é€»è¾‘ç”±æœåŠ¡å™¨ç«¯æ§åˆ¶

    if playerQuantity <= 0 then
        sellButton.BackgroundColor3 = ShopUtils.COLORS.TEXT_MUTED
        sellButton.Text = "æ— ç‰©å“"
        sellButton.Active = false
    elseif not canSell then
        sellButton.BackgroundColor3 = ShopUtils.COLORS.TEXT_MUTED
        sellButton.Text = "æ— æ³•å‡ºå”®"
        sellButton.Active = false
        stockLabel.Text = stockLabel.Text .. "\n(ç‰¹æ®Šç‰©å“)"
        stockLabel.TextWrapped = true
    end

    return card
end

-- æ˜¾ç¤ºå–å‡ºå•†å“åˆ—è¡¨
function ShopSell.showSellItems(scrollFrame, shopData, playerData, showQuantityDialog)
    if not scrollFrame then return end

    -- æ¸…ç©ºç°æœ‰å†…å®¹
    for _, child in pairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") and child.Name:find("Card") then
            child:Destroy()
        end
    end

    local yPos = 0
    local itemsToShow = {}

    -- åªæ˜¾ç¤ºç©å®¶æ‹¥æœ‰çš„ç‰©å“
    if playerData and playerData.inventory and type(playerData.inventory) == "table" then
        for itemId, quantity in pairs(playerData.inventory) do
            if quantity > 0 then
                -- ä½¿ç”¨shopDataä¸­çš„ç‰©å“æ•°æ®
                local itemData = shopData and shopData[itemId]
                if itemData then
                    itemsToShow[itemId] = itemData
                end
            end
        end
    end

    if itemsToShow and type(itemsToShow) == "table" then
        for itemId, item in pairs(itemsToShow) do
            local card = ShopSell.createItemCard(item, itemId, shopData, playerData, showQuantityDialog)
            card.Position = UDim2.new(0, 20, 0, yPos + 20)
            card.Parent = scrollFrame
            yPos = yPos + 140
        end
    end

    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 40)
end

return ShopSell
