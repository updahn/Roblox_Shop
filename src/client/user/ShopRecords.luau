-- å•†åº—è®°å½•ç•Œé¢æ¨¡å—

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))
local ShopUtils = require(script.Parent.Parent:WaitForChild("ShopUtils"))

local player = Players.LocalPlayer

local ShopRecords = {}

-- å­˜å‚¨å½“å‰æ˜¾ç¤ºçš„scrollFrameå¼•ç”¨ï¼Œç”¨äºæ›´æ–°
local currentScrollFrame = nil
local currentShowAdminPanel = nil

-- è¯·æ±‚çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒå®æ—¶æ›´æ–°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
local isRequestingTransactions = false
local lastRequestTime = 0
local REQUEST_COOLDOWN = 2 -- å¢åŠ åˆ°2ç§’ï¼Œé¿å…è¿‡åº¦è¯·æ±‚
local pendingRequestCount = 0 -- å¾…å¤„ç†è¯·æ±‚è®¡æ•°å™¨

-- æ˜¾ç¤ºè´­ä¹°è®°å½•
function ShopRecords.showPurchaseRecords(scrollFrame, playerData, showAdminPanel)
    if not scrollFrame then return end

    -- å­˜å‚¨å¼•ç”¨ä»¥ä¾›åç»­æ›´æ–°ä½¿ç”¨
    currentScrollFrame = scrollFrame
    currentShowAdminPanel = showAdminPanel

    -- æ¸…ç©ºç°æœ‰å†…å®¹
    for _, child in pairs(scrollFrame:GetChildren()) do
        if child:IsA("Frame") and (child.Name:find("Record") or child.Name == "RecordTitle" or child.Name == "NoRecord" or child.Name == "LoadingRecord") then
            child:Destroy()
        end
    end

    local yPos = 20

    -- æ ‡é¢˜
    local titleFrame = Instance.new("Frame")
    titleFrame.Name = "RecordTitle"
    titleFrame.Size = UDim2.new(1, -40, 0, 40)
    titleFrame.Position = UDim2.new(0, 20, 0, yPos)
    titleFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    titleFrame.BorderSizePixel = 0
    titleFrame.Parent = scrollFrame
    ShopUtils.createCorner(titleFrame, 8)

    local titleText = Instance.new("TextLabel")
    titleText.Text = "ğŸ“Š äº¤æ˜“è®°å½•"
    titleText.Font = Enum.Font.SourceSansBold
    titleText.TextSize = 18
    titleText.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
    titleText.Size = UDim2.new(0.7, 0, 1, 0)
    titleText.BackgroundTransparency = 1
    titleText.TextXAlignment = Enum.TextXAlignment.Center
    titleText.Parent = titleFrame

    -- ç®¡ç†å‘˜æ§åˆ¶æŒ‰é’®ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
    local isAdmin = Config.isValidAdmin(player)
    local hasAdminPanelFunction = showAdminPanel ~= nil

    if isAdmin and showAdminPanel then
        print("âœ… [è°ƒè¯•] åˆ›å»ºç®¡ç†å‘˜æŒ‰é’®")
        local adminButton = ShopUtils.createButton("ğŸ‘‘ ç®¡ç†", ShopUtils.COLORS.WARNING, titleFrame, function()
            showAdminPanel()
        end)
        adminButton.Position = UDim2.new(1, -100, 0, 5)
        adminButton.Size = UDim2.new(0, 90, 0, 30)
        adminButton.TextSize = 12
    end

    yPos = yPos + 60

    -- æ˜¾ç¤ºåŠ è½½æç¤º
    local loadingFrame = Instance.new("Frame")
    loadingFrame.Name = "LoadingRecord"
    loadingFrame.Size = UDim2.new(1, -40, 0, 60)
    loadingFrame.Position = UDim2.new(0, 20, 0, yPos)
    loadingFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    loadingFrame.BorderSizePixel = 0
    loadingFrame.Parent = scrollFrame
    ShopUtils.createCorner(loadingFrame, 8)

    local loadingText = Instance.new("TextLabel")
    loadingText.Text = "â³ æ­£åœ¨åŠ è½½äº¤æ˜“è®°å½•..."
    loadingText.Font = Enum.Font.SourceSans
    loadingText.TextSize = 16
    loadingText.TextColor3 = ShopUtils.COLORS.TEXT_SECONDARY
    loadingText.Size = UDim2.new(1, 0, 1, 0)
    loadingText.BackgroundTransparency = 1
    loadingText.TextXAlignment = Enum.TextXAlignment.Center
    loadingText.Parent = loadingFrame

    -- è¯·æ±‚ç”¨æˆ·äº¤æ˜“è®°å½•ï¼ˆä¼˜åŒ–é˜²æŠ–æœºåˆ¶ï¼‰
    local currentTime = tick()

    -- å¢åŠ å¾…å¤„ç†è¯·æ±‚è®¡æ•°
    pendingRequestCount = pendingRequestCount + 1

    if isRequestingTransactions then
        print("âš ï¸ [äº¤æ˜“è®°å½•] è¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚ (å¾…å¤„ç†:", pendingRequestCount, ")")
        return
    end

    if currentTime - lastRequestTime < REQUEST_COOLDOWN then
        print("âš ï¸ [äº¤æ˜“è®°å½•] è¯·æ±‚å†·å´ä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚ (å†·å´å‰©ä½™:", math.ceil(REQUEST_COOLDOWN - (currentTime - lastRequestTime)), "ç§’)")
        return
    end

    print("ğŸ“Š [äº¤æ˜“è®°å½•] è¯·æ±‚è·å–äº¤æ˜“è®°å½• (å¾…å¤„ç†:", pendingRequestCount, ")")
    isRequestingTransactions = true
    lastRequestTime = currentTime
    pendingRequestCount = 0 -- é‡ç½®è®¡æ•°å™¨
    ShopEvents.User.GetTransactions:FireServer(50, 0, nil) -- è·å–æœ€è¿‘50æ¡è®°å½•

    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 80)
end

-- å¼ºåˆ¶åˆ·æ–°äº¤æ˜“è®°å½•ï¼ˆå®æ—¶æ›´æ–°ç”¨ - ä¼˜åŒ–ç‰ˆï¼‰
function ShopRecords.forceRefreshTransactions()
    print("ğŸ”„ [äº¤æ˜“è®°å½•] å¼ºåˆ¶åˆ·æ–°äº¤æ˜“è®°å½•")

    -- æ£€æŸ¥æ˜¯å¦å¯ä»¥å¼ºåˆ¶åˆ·æ–°ï¼ˆé¿å…è¿‡åº¦åˆ·æ–°ï¼‰
    local currentTime = tick()
    if isRequestingTransactions and (currentTime - lastRequestTime) < 1 then
        print("âš ï¸ [äº¤æ˜“è®°å½•] å¼ºåˆ¶åˆ·æ–°è¢«é™åˆ¶ï¼Œè¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­")
        return
    end

    -- é‡ç½®å†·å´æ—¶é—´ï¼Œå…è®¸ç«‹å³åˆ·æ–°
    lastRequestTime = 0
    isRequestingTransactions = false
    pendingRequestCount = 0

    -- å¦‚æœæœ‰æ´»åŠ¨çš„scrollFrameï¼Œé‡æ–°æ˜¾ç¤ºè®°å½•
    if currentScrollFrame and currentShowAdminPanel then
        ShopRecords.showPurchaseRecords(currentScrollFrame, nil, currentShowAdminPanel)
    end
end

-- å¤„ç†äº¤æ˜“è®°å½•å“åº”å¹¶æ›´æ–°UI
function ShopRecords.handleTransactionResponse(success, message, responseData)
    -- é‡ç½®è¯·æ±‚çŠ¶æ€
    isRequestingTransactions = false

    if not currentScrollFrame then
        print("âŒ [äº¤æ˜“è®°å½•] æ²¡æœ‰æ´»åŠ¨çš„scrollFrameæ¥æ›´æ–°")
        return
    end

    print("ğŸ“Š [äº¤æ˜“è®°å½•] æ”¶åˆ°å“åº”:", success, message)

    -- ç§»é™¤åŠ è½½æç¤º
    local loadingFrame = currentScrollFrame:FindFirstChild("LoadingRecord")
    if loadingFrame then
        loadingFrame:Destroy()
    end

    local yPos = 80 -- æ ‡é¢˜åçš„ä½ç½®

    if success and responseData and responseData.transactions then
        local transactions = responseData.transactions
        print("ğŸ“Š [äº¤æ˜“è®°å½•] æ˜¾ç¤º", #transactions, "æ¡äº¤æ˜“è®°å½•")

        -- æ˜¾ç¤ºäº¤æ˜“è®°å½•
        for i, record in ipairs(transactions) do
            local recordFrame = Instance.new("Frame")
            recordFrame.Name = "Record" .. i
            recordFrame.Size = UDim2.new(1, -40, 0, 80)
            recordFrame.Position = UDim2.new(0, 20, 0, yPos)
            recordFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
            recordFrame.BorderSizePixel = 0
            recordFrame.Parent = currentScrollFrame
            ShopUtils.createCorner(recordFrame, 8)

            -- æ—¶é—´æˆ³
            local timeLabel = Instance.new("TextLabel")
            timeLabel.Text = ShopUtils.formatTimestamp(record.timestamp or record.createdAt)
            timeLabel.Font = Enum.Font.SourceSans
            timeLabel.TextSize = 12
            timeLabel.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
            timeLabel.Size = UDim2.new(0, 150, 0, 20)
            timeLabel.Position = UDim2.new(0, 10, 0, 5)
            timeLabel.BackgroundTransparency = 1
            timeLabel.TextXAlignment = Enum.TextXAlignment.Left
            timeLabel.Parent = recordFrame

            -- äº¤æ˜“ç±»å‹å’Œç‰©å“
            local actionLabel = Instance.new("TextLabel")
            local actionText = ""
            if record.type == "buy" then
                actionText = "ğŸ›’ è´­ä¹° " .. (record.itemName or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
            elseif record.type == "sell" then
                actionText = "ğŸ’° å–å‡º " .. (record.itemName or "æœªçŸ¥ç‰©å“") .. " x" .. (record.quantity or 1)
            elseif record.type == "admin" then
                actionText = "âš™ï¸ ç®¡ç†å‘˜æ“ä½œ x" .. (record.quantity or 1)
            elseif record.type == "daily_reward" then
                actionText = "ğŸ æ¯æ—¥å¥–åŠ± x" .. (record.quantity or 1)
            elseif record.type == "membership_purchase" then
                actionText = "ğŸ’ è´­ä¹°ä¼šå‘˜ " .. (record.itemName or "æœªçŸ¥ä¼šå‘˜") .. " x" .. (record.quantity or 1)
            end
            actionLabel.Text = actionText
            actionLabel.Font = Enum.Font.SourceSansBold
            actionLabel.TextSize = 16
            actionLabel.TextColor3 = ShopUtils.COLORS.TEXT_PRIMARY
            actionLabel.Size = UDim2.new(1, -20, 0, 25)
            actionLabel.Position = UDim2.new(0, 10, 0, 25)
            actionLabel.BackgroundTransparency = 1
            actionLabel.TextXAlignment = Enum.TextXAlignment.Left
            actionLabel.Parent = recordFrame

            -- é‡‘é¢
            local amountLabel = Instance.new("TextLabel")
            local amountText = ""
            local amountColor = ShopUtils.COLORS.TEXT_SECONDARY
            if record.type == "buy" then
                amountText = "-" .. (record.totalAmount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.ERROR
            elseif record.type == "sell" then
                amountText = "+" .. (record.totalAmount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.type == "admin" then
                amountText = (record.totalAmount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.TEXT_PRIMARY
            elseif record.type == "daily_reward" then
                amountText = "+" .. (record.totalAmount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.SUCCESS
            elseif record.type == "membership_purchase" then
                amountText = "-" .. (record.totalAmount or 0) .. " é‡‘å¸"
                amountColor = ShopUtils.COLORS.ERROR
            end
            amountLabel.Text = amountText
            amountLabel.Font = Enum.Font.SourceSansBold
            amountLabel.TextSize = 14
            amountLabel.TextColor3 = amountColor
            amountLabel.Size = UDim2.new(0, 120, 0, 20)
            amountLabel.Position = UDim2.new(1, -130, 0, 30)
            amountLabel.BackgroundTransparency = 1
            amountLabel.TextXAlignment = Enum.TextXAlignment.Right
            amountLabel.Parent = recordFrame

            yPos = yPos + 90
        end

        if #transactions == 0 then
            -- ç©ºè®°å½•æç¤º
            ShopRecords._showNoRecordsMessage(yPos)
            yPos = yPos + 120
        end
    else
        -- é”™è¯¯æˆ–æ— æ•°æ®å¤„ç†
        print("âŒ [äº¤æ˜“è®°å½•] åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®:", message)
        ShopRecords._showErrorMessage(yPos, message or "åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥")
        yPos = yPos + 120
    end

    currentScrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

-- æ˜¾ç¤ºæ— è®°å½•æ¶ˆæ¯
function ShopRecords._showNoRecordsMessage(yPos)
    local noRecordFrame = Instance.new("Frame")
    noRecordFrame.Name = "NoRecord"
    noRecordFrame.Size = UDim2.new(1, -40, 0, 100)
    noRecordFrame.Position = UDim2.new(0, 20, 0, yPos)
    noRecordFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    noRecordFrame.BorderSizePixel = 0
    noRecordFrame.Parent = currentScrollFrame
    ShopUtils.createCorner(noRecordFrame, 8)

    local noRecordText = Instance.new("TextLabel")
    noRecordText.Text = "ğŸ“ æš‚æ— äº¤æ˜“è®°å½•"
    noRecordText.Font = Enum.Font.SourceSans
    noRecordText.TextSize = 16
    noRecordText.TextColor3 = ShopUtils.COLORS.TEXT_MUTED
    noRecordText.Size = UDim2.new(1, 0, 1, 0)
    noRecordText.BackgroundTransparency = 1
    noRecordText.TextXAlignment = Enum.TextXAlignment.Center
    noRecordText.Parent = noRecordFrame
end

-- æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function ShopRecords._showErrorMessage(yPos, errorMessage)
    local errorFrame = Instance.new("Frame")
    errorFrame.Name = "ErrorRecord"
    errorFrame.Size = UDim2.new(1, -40, 0, 100)
    errorFrame.Position = UDim2.new(0, 20, 0, yPos)
    errorFrame.BackgroundColor3 = ShopUtils.COLORS.SECONDARY
    errorFrame.BorderSizePixel = 0
    errorFrame.Parent = currentScrollFrame
    ShopUtils.createCorner(errorFrame, 8)

    local errorText = Instance.new("TextLabel")
    errorText.Text = "âŒ " .. errorMessage
    errorText.Font = Enum.Font.SourceSans
    errorText.TextSize = 16
    errorText.TextColor3 = ShopUtils.COLORS.ERROR
    errorText.Size = UDim2.new(1, 0, 1, 0)
    errorText.BackgroundTransparency = 1
    errorText.TextXAlignment = Enum.TextXAlignment.Center
    errorText.Parent = errorFrame
end

-- æ˜¾ç¤ºè®°å½•æŸ¥çœ‹ç•Œé¢ï¼ˆä¸ºäº†å…¼å®¹æ€§ï¼‰
function ShopRecords.showRecordsUI(playerName)
    print("ğŸ“Š è¯·æ±‚æŸ¥çœ‹ " .. (playerName or "å½“å‰ç©å®¶") .. " çš„è®°å½•")
    -- è¯·æ±‚æœåŠ¡å™¨è·å–è¯¥ç©å®¶çš„è®°å½•
    if ShopEvents.Admin.GetUserHistory then
        ShopEvents.Admin.GetUserHistory:FireServer(playerName)
    end
end

-- å¤„ç†ç®¡ç†å‘˜æŸ¥çœ‹ç”¨æˆ·å†å²è®°å½•çš„å“åº”å‡½æ•°ï¼ˆç”±ShopUI.luauè°ƒç”¨ï¼‰
function ShopRecords.handleAdminHistoryResponse(success, message, data)
    print("ğŸ“Š [ç®¡ç†å‘˜è®°å½•] æ”¶åˆ°ç”¨æˆ·å†å²è®°å½•å“åº”:", success, message)

    if success and data and data.transactions then
        -- å°†APIå“åº”è½¬æ¢ä¸ºä¸æ™®é€šäº¤æ˜“è®°å½•å…¼å®¹çš„æ ¼å¼
        local formattedData = {
            transactions = {}
        }

        for _, transaction in ipairs(data.transactions) do
            local formattedTransaction = {
                type = transaction.type,
                itemName = transaction.item_name,
                quantity = transaction.quantity,
                totalAmount = transaction.total_amount,
                timestamp = transaction.created_at,
                createdAt = transaction.created_at
            }
            table.insert(formattedData.transactions, formattedTransaction)
        end

        -- ä½¿ç”¨æ™®é€šçš„äº¤æ˜“è®°å½•å“åº”å¤„ç†å‡½æ•°æ¥æ˜¾ç¤ºæ ¼å¼åŒ–çš„æ•°æ®
        ShopRecords.handleTransactionResponse(true, "è·å–ç”¨æˆ·äº¤æ˜“å†å²æˆåŠŸ", formattedData)
    else
        -- å¤„ç†é”™è¯¯æƒ…å†µ
        local errorMessage = message or "è·å–ç”¨æˆ·äº¤æ˜“è®°å½•å¤±è´¥"
        ShopRecords.handleTransactionResponse(false, errorMessage, nil)
    end
end

return ShopRecords

