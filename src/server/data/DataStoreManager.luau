-- DataStore ç®¡ç†å™¨ - æ›¿æ¢ MySQL å’Œ API è°ƒç”¨
-- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ•°æ®å­˜å‚¨æ“ä½œï¼Œæ”¯æŒæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜åˆ†ç¦»æƒé™

local DataStoreService = game:GetService("DataStoreService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- ç¯å¢ƒç®¡ç†å™¨
local EnvironmentManager = require(script.Parent.Parent.utils.EnvironmentManager)

local DataStoreManager = {}

-- ==============================================
-- DataStore é…ç½®
-- ==============================================

-- ç¯å¢ƒæ£€æµ‹å’Œé…ç½®
local isStudio = EnvironmentManager.isStudio()
local dataStoreConfig = EnvironmentManager.getDataStoreConfig()

-- DataStore å®ä¾‹
local dataStores = {}
local mockDataStores = {} -- Studioç¯å¢ƒä¸­çš„æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨

-- DataStore åç§°é…ç½®
local DATASTORE_NAMES = {
    USERS = "ShopUserData_v3",              -- ç”¨æˆ·æ•°æ®
    SYSTEM_CONFIG = "ShopSystemConfig_v3",   -- ç³»ç»Ÿé…ç½®
    ITEMS = "ShopItemData_v3",              -- å•†å“æ•°æ®
    TRANSACTIONS = "ShopTransactions_v3",    -- äº¤æ˜“è®°å½•
    MEMBERSHIPS = "ShopMemberships_v3",     -- ä¼šå‘˜æ•°æ®
    ADMIN_DATA = "ShopAdminData_v3",        -- ç®¡ç†å‘˜æ•°æ®
    SYSTEM_STATS = "ShopSystemStats_v3",    -- ç³»ç»Ÿç»Ÿè®¡
    DAILY_REWARDS = "ShopDailyRewards_v3"   -- æ¯æ—¥å¥–åŠ±è®°å½•
}

-- åˆå§‹åŒ– DataStores
local function initializeDataStores()
    local currentEnv = EnvironmentManager.getCurrentEnvironment()

    if dataStoreConfig.mockData or not dataStoreConfig.enabled then
        print("âš ï¸ " .. currentEnv .. "ç¯å¢ƒ - ä½¿ç”¨æ¨¡æ‹ŸDataStore")
        -- åˆå§‹åŒ–æ¨¡æ‹Ÿå­˜å‚¨
        for name, storeName in pairs(DATASTORE_NAMES) do
            mockDataStores[name] = {}
        end
    else
        print("ğŸš€ " .. currentEnv .. "ç¯å¢ƒ - åˆå§‹åŒ–DataStore")
        -- åˆå§‹åŒ–çœŸå®DataStore
        for name, storeName in pairs(DATASTORE_NAMES) do
            local success, dataStore = pcall(function()
                return DataStoreService:GetDataStore(storeName)
            end)

            if success then
                dataStores[name] = dataStore
                print("âœ… DataStore åˆå§‹åŒ–æˆåŠŸ:", storeName)
            else
                warn("âŒ DataStore åˆå§‹åŒ–å¤±è´¥:", storeName, dataStore)
                -- åœ¨åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œå›é€€åˆ°æ¨¡æ‹Ÿæ¨¡å¼
                if not mockDataStores[name] then
                    mockDataStores[name] = {}
                    print("ğŸ”„ å›é€€åˆ°æ¨¡æ‹ŸDataStore:", storeName)
                end
            end
        end
    end
end

-- ==============================================
-- é€šç”¨æ•°æ®æ“ä½œå‡½æ•°
-- ==============================================

-- å®‰å…¨çš„æ•°æ®è·å–ï¼ˆæ”¯æŒé‡è¯•æœºåˆ¶ï¼‰
local function safeGetAsync(dataStore, key, defaultValue, maxRetries)
    maxRetries = maxRetries or dataStoreConfig.retryAttempts

    if isStudio then
        -- Studioç¯å¢ƒ
        return mockDataStores[dataStore][key] or defaultValue
    else
        -- ç”Ÿäº§ç¯å¢ƒ - å¸¦é‡è¯•æœºåˆ¶
        for attempt = 1, maxRetries do
            local success, data = pcall(function()
                return dataStores[dataStore]:GetAsync(key)
            end)

            if success then
                return data or defaultValue
            else
                warn("âŒ æ•°æ®è·å–å¤±è´¥ (å°è¯• " .. attempt .. "/" .. maxRetries .. "):", dataStore, key, data)

                -- å¦‚æœæ˜¯è¯·æ±‚é™åˆ¶é”™è¯¯ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´
                if string.find(tostring(data), "throttled") or string.find(tostring(data), "limit") then
                    wait(attempt * 2) -- é€’å¢ç­‰å¾…æ—¶é—´
                else
                    wait(attempt * 0.5) -- å…¶ä»–é”™è¯¯è¾ƒçŸ­ç­‰å¾…
                end

                -- æœ€åä¸€æ¬¡å°è¯•å¤±è´¥åè®°å½•é”™è¯¯
                if attempt == maxRetries then
                    -- è®°å½•é”™è¯¯åˆ°ç³»ç»Ÿæ—¥å¿—ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                    spawn(function()
                        local success2, AdminDataService = pcall(function()
                            return require(script.Parent:WaitForChild("AdminDataService"))
                        end)
                        if success2 then
                            AdminDataService.logAdminAction("SYSTEM", "datastore_error", {
                                operation = "GetAsync",
                                datastore = dataStore,
                                key = key,
                                error = tostring(data),
                                attempts = maxRetries
                            })
                        end
                    end)
                end
            end
        end

        return defaultValue
    end
end

-- å®‰å…¨çš„æ•°æ®ä¿å­˜ï¼ˆæ”¯æŒé‡è¯•æœºåˆ¶ï¼‰
local function safeSetAsync(dataStore, key, value, maxRetries)
    maxRetries = maxRetries or dataStoreConfig.retryAttempts

    if isStudio then
        -- Studioç¯å¢ƒ
        mockDataStores[dataStore][key] = value
        return true
    else
        -- ç”Ÿäº§ç¯å¢ƒ - å¸¦é‡è¯•æœºåˆ¶
        for attempt = 1, maxRetries do
            local success, error = pcall(function()
                dataStores[dataStore]:SetAsync(key, value)
            end)

            if success then
                return true
            else
                warn("âŒ æ•°æ®ä¿å­˜å¤±è´¥ (å°è¯• " .. attempt .. "/" .. maxRetries .. "):", dataStore, key, error)

                -- å¦‚æœæ˜¯è¯·æ±‚é™åˆ¶é”™è¯¯ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´
                if string.find(tostring(error), "throttled") or string.find(tostring(error), "limit") then
                    wait(attempt * 2) -- é€’å¢ç­‰å¾…æ—¶é—´
                else
                    wait(attempt * 0.5) -- å…¶ä»–é”™è¯¯è¾ƒçŸ­ç­‰å¾…
                end

                -- æœ€åä¸€æ¬¡å°è¯•å¤±è´¥åè®°å½•é”™è¯¯
                if attempt == maxRetries then
                    spawn(function()
                        local success2, AdminDataService = pcall(function()
                            return require(script.Parent:WaitForChild("AdminDataService"))
                        end)
                        if success2 then
                            AdminDataService.logAdminAction("SYSTEM", "datastore_error", {
                                operation = "SetAsync",
                                datastore = dataStore,
                                key = key,
                                error = tostring(error),
                                attempts = maxRetries
                            })
                        end
                    end)
                end
            end
        end

        return false
    end
end

-- å®‰å…¨çš„æ•°æ®æ›´æ–°ï¼ˆä½¿ç”¨ UpdateAsyncï¼Œæ”¯æŒé‡è¯•æœºåˆ¶ï¼‰
local function safeUpdateAsync(dataStore, key, updateFunction, maxRetries)
    maxRetries = maxRetries or dataStoreConfig.retryAttempts

    if isStudio then
        -- Studioç¯å¢ƒæ¨¡æ‹ŸUpdateAsync
        local currentData = mockDataStores[dataStore][key]
        local newData = updateFunction(currentData)
        mockDataStores[dataStore][key] = newData
        return true, newData
    else
        -- ç”Ÿäº§ç¯å¢ƒ - å¸¦é‡è¯•æœºåˆ¶
        for attempt = 1, maxRetries do
            local success, result = pcall(function()
                return dataStores[dataStore]:UpdateAsync(key, updateFunction)
            end)

            if success then
                return true, result
            else
                warn("âŒ æ•°æ®æ›´æ–°å¤±è´¥ (å°è¯• " .. attempt .. "/" .. maxRetries .. "):", dataStore, key, result)

                -- å¦‚æœæ˜¯è¯·æ±‚é™åˆ¶é”™è¯¯ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´
                if string.find(tostring(result), "throttled") or string.find(tostring(result), "limit") then
                    wait(attempt * 2) -- é€’å¢ç­‰å¾…æ—¶é—´
                elseif string.find(tostring(result), "concurrent") then
                    -- å¹¶å‘ä¿®æ”¹é”™è¯¯ï¼Œè¾ƒçŸ­ç­‰å¾…åé‡è¯•
                    wait(attempt * 0.2)
                else
                    wait(attempt * 0.5) -- å…¶ä»–é”™è¯¯è¾ƒçŸ­ç­‰å¾…
                end

                -- æœ€åä¸€æ¬¡å°è¯•å¤±è´¥åè®°å½•é”™è¯¯
                if attempt == maxRetries then
                    spawn(function()
                        local success2, AdminDataService = pcall(function()
                            return require(script.Parent:WaitForChild("AdminDataService"))
                        end)
                        if success2 then
                            AdminDataService.logAdminAction("SYSTEM", "datastore_error", {
                                operation = "UpdateAsync",
                                datastore = dataStore,
                                key = key,
                                error = tostring(result),
                                attempts = maxRetries
                            })
                        end
                    end)
                end
            end
        end

        return false, nil
    end
end

-- ==============================================
-- ç”Ÿäº§ç¯å¢ƒæ•°æ®å¤‡ä»½æœºåˆ¶
-- ==============================================

-- å¤‡ä»½å…³é”®æ•°æ®åˆ°å¤‡ä»½DataStore
local function backupData(originalStore, backupStore, key, data)
    if not isStudio then
        spawn(function()
            local timestamp = os.time()
            local backupKey = key .. "_backup_" .. timestamp
            local backupData = {
                originalData = data,
                timestamp = timestamp,
                originalKey = key,
                originalStore = originalStore
            }

            local success = safeSetAsync(backupStore, backupKey, backupData, 1) -- åªå°è¯•ä¸€æ¬¡
            if not success then
                warn("âš ï¸ å¤‡ä»½æ•°æ®å¤±è´¥:", originalStore, key)
            end
        end)
    end
end

-- å®šæœŸæ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘30å¤©ï¼‰
local function cleanupOldBackups()
    if not isStudio then
        spawn(function()
            while true do
                wait(3600) -- æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡

                local currentTime = os.time()
                local thirtyDaysAgo = currentTime - (30 * 24 * 3600)

                -- è¿™é‡Œå¯ä»¥å®ç°å¤‡ä»½æ¸…ç†é€»è¾‘
                -- ç”±äºDataStore APIé™åˆ¶ï¼Œå®é™…å®ç°å¯èƒ½éœ€è¦ç»´æŠ¤å¤‡ä»½ç´¢å¼•
                print("ğŸ§¹ å¼€å§‹æ¸…ç†æ—§å¤‡ä»½æ•°æ®...")
            end
        end)
    end
end

-- å¯åŠ¨å¤‡ä»½æ¸…ç†ä»»åŠ¡
spawn(cleanupOldBackups)

-- ==============================================
-- é»˜è®¤æ•°æ®ç»“æ„å®šä¹‰
-- ==============================================

-- é»˜è®¤ç”¨æˆ·æ•°æ®ç»“æ„
local function getDefaultUserData()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Config = require(ReplicatedStorage:WaitForChild("SharedModules"):WaitForChild("Config"))
    return {
        userId = "",
        username = "",
        displayName = "",
        coins = Config.GAME.ECONOMY.STARTING_COINS,
        isAdmin = false,
        status = "active",
        inventory = {}, -- {itemId = quantity}
        createdAt = os.time(),
        updatedAt = os.time(),
        lastLogin = os.time(),
        membership = {
            isActive = false,
            membershipId = nil,
            startDate = nil,
            endDate = nil,
            dailyReward = 100
        },
        stats = {
            totalPurchases = 0,
            totalSales = 0,
            totalSpent = 0,
            totalEarned = 0
        }
    }
end

-- é»˜è®¤å•†å“æ•°æ®ç»“æ„
local function getDefaultItemData()
    return {
        id = "",
        name = "",
        description = "",
        price = 0,
        sellPrice = 0, -- å¦‚æœä¸º0åˆ™ä½¿ç”¨price * 0.8
        maxQuantity = nil, -- nilè¡¨ç¤ºæ— é™åˆ¶
        currentStock = -1, -- -1è¡¨ç¤ºæ— é™åº“å­˜
        dailyPurchaseLimit = nil, -- nilè¡¨ç¤ºæ— é™åˆ¶
        canSell = true,
        category = "default",
        imageUrl = "",
        isActive = true,
        sortOrder = 0,
        createdAt = os.time(),
        updatedAt = os.time()
    }
end

-- é»˜è®¤äº¤æ˜“è®°å½•ç»“æ„
local function createTransactionRecord(userId, transactionType, itemId, quantity, unitPrice, totalAmount, coinsBefore, coinsAfter, notes)
    return {
        id = HttpService:GenerateGUID(false), -- ç”Ÿæˆå”¯ä¸€ID
        userId = userId,
        type = transactionType, -- "buy", "sell", "admin", "daily_reward", "membership_purchase"
        itemId = itemId,
        quantity = quantity or 1,
        unitPrice = unitPrice or 0,
        totalAmount = totalAmount or 0,
        coinsBefore = coinsBefore or 0,
        coinsAfter = coinsAfter or 0,
        transactionDate = os.date("%Y-%m-%d"),
        notes = notes or "",
        createdAt = os.time()
    }
end

-- é»˜è®¤ä¼šå‘˜æ•°æ®ç»“æ„
local function createMembershipData(userId, startDate, endDate, dailyReward)
    return {
        id = HttpService:GenerateGUID(false),
        userId = userId,
        startDate = startDate,
        endDate = endDate,
        dailyRewardCoins = dailyReward or 100,
        isActive = true,
        createdAt = os.time(),
        updatedAt = os.time()
    }
end

-- ==============================================
-- ç³»ç»Ÿé…ç½®ç®¡ç†
-- ==============================================

-- è·å–ç³»ç»Ÿé…ç½®
function DataStoreManager.getSystemConfig(key, defaultValue)
    return safeGetAsync("SYSTEM_CONFIG", key, defaultValue)
end

-- è®¾ç½®ç³»ç»Ÿé…ç½®
function DataStoreManager.setSystemConfig(key, value, description)
    local configData = {
        value = value,
        description = description or "",
        updatedAt = os.time()
    }
    return safeSetAsync("SYSTEM_CONFIG", key, configData)
end

-- è·å–æ‰€æœ‰ç³»ç»Ÿé…ç½®
function DataStoreManager.getAllSystemConfig()
    if isStudio then
        return mockDataStores["SYSTEM_CONFIG"] or {}
    else
        -- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œéœ€è¦é€šè¿‡ListDataStoresAsyncè·å–æ‰€æœ‰é”®
        -- è¿™é‡Œè¿”å›ä¸€äº›é»˜è®¤é…ç½®
        return {
            sell_rate = {value = "0.8", description = "ç‰©å“å‡ºå”®ä»·æ ¼æ¯”ä¾‹"},
            rate_limit_window_ms = {value = "900000", description = "APIè¯·æ±‚é™åˆ¶æ—¶é—´çª—å£(æ¯«ç§’)"},
            rate_limit_max_requests = {value = "100", description = "APIè¯·æ±‚é™åˆ¶æœ€å¤§æ¬¡æ•°"},
            membership_daily_reward = {value = "100", description = "æœˆå¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
            membership_duration_days = {value = "30", description = "æœˆå¡æœ‰æ•ˆæœŸå¤©æ•°"},
            membership_max_missed_rewards = {value = "7", description = "æœˆå¡æœ€å¤šè¡¥å‘å¥–åŠ±å¤©æ•°"},
            weekly_membership_duration_days = {value = "7", description = "å‘¨å¡æœ‰æ•ˆæœŸå¤©æ•°"},
            quarterly_membership_duration_days = {value = "90", description = "å­£å¡æœ‰æ•ˆæœŸå¤©æ•°"},
            premium_membership_daily_reward = {value = "200", description = "é«˜çº§æœˆå¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
            vip_membership_duration_days = {value = "365", description = "VIPå¹´å¡æœ‰æ•ˆæœŸå¤©æ•°"},
            vip_membership_daily_reward = {value = "150", description = "VIPå¹´å¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
            default_coins_for_new_user = {value = "3000", description = "æ–°ç”¨æˆ·æ³¨å†Œæ—¶çš„é»˜è®¤é‡‘å¸æ•°é‡"}
        }
    end
end

-- åˆå§‹åŒ–é»˜è®¤ç³»ç»Ÿé…ç½®
local function initializeSystemConfig()
    local defaultConfigs = {
        sell_rate = {value = "0.8", description = "ç‰©å“å‡ºå”®ä»·æ ¼æ¯”ä¾‹"},
        rate_limit_window_ms = {value = "900000", description = "APIè¯·æ±‚é™åˆ¶æ—¶é—´çª—å£(æ¯«ç§’)"},
        rate_limit_max_requests = {value = "100", description = "APIè¯·æ±‚é™åˆ¶æœ€å¤§æ¬¡æ•°"},
        membership_daily_reward = {value = "100", description = "æœˆå¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
        membership_duration_days = {value = "30", description = "æœˆå¡æœ‰æ•ˆæœŸå¤©æ•°"},
        membership_max_missed_rewards = {value = "7", description = "æœˆå¡æœ€å¤šè¡¥å‘å¥–åŠ±å¤©æ•°"},
        weekly_membership_duration_days = {value = "7", description = "å‘¨å¡æœ‰æ•ˆæœŸå¤©æ•°"},
        quarterly_membership_duration_days = {value = "90", description = "å­£å¡æœ‰æ•ˆæœŸå¤©æ•°"},
        premium_membership_daily_reward = {value = "200", description = "é«˜çº§æœˆå¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
        vip_membership_duration_days = {value = "365", description = "VIPå¹´å¡æœ‰æ•ˆæœŸå¤©æ•°"},
        vip_membership_daily_reward = {value = "150", description = "VIPå¹´å¡æ¯æ—¥å¥–åŠ±é‡‘å¸"},
        default_coins_for_new_user = {value = "3000", description = "æ–°ç”¨æˆ·æ³¨å†Œæ—¶çš„é»˜è®¤é‡‘å¸æ•°é‡"}
    }

    for key, config in pairs(defaultConfigs) do
        local existingConfig = DataStoreManager.getSystemConfig(key)
        if not existingConfig then
            DataStoreManager.setSystemConfig(key, config.value, config.description)
        end
    end
    print("âœ… ç³»ç»Ÿé…ç½®åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- ç”¨æˆ·æ•°æ®ç®¡ç†
-- ==============================================

-- è·å–ç”¨æˆ·æ•°æ®
function DataStoreManager.getUserData(userId)
    local userData = safeGetAsync("USERS", userId, nil)
    if not userData then
        -- åˆ›å»ºæ–°ç”¨æˆ·æ•°æ®
        userData = getDefaultUserData()
        userData.userId = userId
        userData.username = userId -- ä¸´æ—¶ä½¿ç”¨userIdä½œä¸ºç”¨æˆ·å

        local success = safeSetAsync("USERS", userId, userData)
        if success then
            print("âœ… åˆ›å»ºæ–°ç”¨æˆ·æ•°æ®:", userId)
            -- ä¸ºæ–°ç”¨æˆ·æ•°æ®åˆ›å»ºå¤‡ä»½
            backupData("USERS", "USER_BACKUPS", userId, userData)
        else
            warn("âŒ åˆ›å»ºç”¨æˆ·æ•°æ®å¤±è´¥:", userId)
        end
    end
    return userData
end

-- æ›´æ–°ç”¨æˆ·æ•°æ®
function DataStoreManager.updateUserData(userId, updateFunction)
    local success, newData = safeUpdateAsync("USERS", userId, function(currentData)
        local userData = currentData or getDefaultUserData()
        userData.userId = userId
        userData.updatedAt = os.time()

        -- è°ƒç”¨æ›´æ–°å‡½æ•°
        local updatedData = updateFunction(userData)
        return updatedData
    end)

    if success and newData then
        -- ä¸ºé‡è¦çš„ç”¨æˆ·æ•°æ®æ›´æ–°åˆ›å»ºå¤‡ä»½
        backupData("USERS", "USER_BACKUPS", userId, newData)
        print("âœ… ç”¨æˆ·æ•°æ®æ›´æ–°æˆåŠŸ:", userId)
    else
        warn("âŒ ç”¨æˆ·æ•°æ®æ›´æ–°å¤±è´¥:", userId)
    end

    return success, newData
end

-- ä¿å­˜ç”¨æˆ·æ•°æ®
function DataStoreManager.saveUserData(userId, userData)
    userData.updatedAt = os.time()
    local success = safeSetAsync("USERS", userId, userData)

    if success then
        -- ä¸ºç”¨æˆ·æ•°æ®ä¿å­˜åˆ›å»ºå¤‡ä»½
        backupData("USERS", "USER_BACKUPS", userId, userData)
        print("âœ… ç”¨æˆ·æ•°æ®ä¿å­˜æˆåŠŸ:", userId)
    else
        warn("âŒ ç”¨æˆ·æ•°æ®ä¿å­˜å¤±è´¥:", userId)
    end

    return success
end

-- è·å–å¤šä¸ªç”¨æˆ·æ•°æ®ï¼ˆæ‰¹é‡æ“ä½œï¼‰
function DataStoreManager.getBatchUserData(userIds)
    local results = {}
    local tasks = {}

    for i, userId in ipairs(userIds) do
        table.insert(tasks, spawn(function()
            results[userId] = DataStoreManager.getUserData(userId)
        end))
    end

    -- ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    for _, task in ipairs(tasks) do
        task.Completed:Wait()
    end

    return results
end

-- åˆ é™¤ç”¨æˆ·æ•°æ®ï¼ˆè½¯åˆ é™¤ï¼‰
function DataStoreManager.deleteUserData(userId, adminUserId)
    local success, deletedData = safeUpdateAsync("USERS", userId, function(currentData)
        if currentData then
            currentData.status = "deleted"
            currentData.deletedAt = os.time()
            currentData.deletedBy = adminUserId
            return currentData
        end
        return nil
    end)

    if success and deletedData then
        -- ä¸ºåˆ é™¤æ“ä½œåˆ›å»ºå¤‡ä»½
        backupData("USERS", "USER_BACKUPS", userId .. "_deleted", deletedData)
        print("âœ… ç”¨æˆ·æ•°æ®æ ‡è®°ä¸ºåˆ é™¤:", userId)
    end

    return success
end

-- ==============================================
-- å•†å“æ•°æ®ç®¡ç†
-- ==============================================

-- è·å–æ‰€æœ‰å•†å“
function DataStoreManager.getAllItems()
    local allItems = safeGetAsync("ITEMS", "all_items", {})
    return allItems
end

-- è·å–å•ä¸ªå•†å“
function DataStoreManager.getItem(itemId)
    local allItems = DataStoreManager.getAllItems()
    return allItems[itemId]
end

-- æ›´æ–°å•†å“
function DataStoreManager.updateItem(itemId, itemData)
    local success, newData = safeUpdateAsync("ITEMS", "all_items", function(currentData)
        local items = currentData or {}
        items[itemId] = itemData
        return items
    end)

    if success then
        -- ä¸ºå•†å“æ•°æ®æ›´æ–°åˆ›å»ºå¤‡ä»½
        backupData("ITEMS", "ITEM_BACKUPS", "all_items", newData)
        print("âœ… å•†å“æ•°æ®æ›´æ–°æˆåŠŸ:", itemId)
    else
        warn("âŒ å•†å“æ•°æ®æ›´æ–°å¤±è´¥:", itemId)
    end

    return success
end

-- æ‰¹é‡æ›´æ–°å•†å“
function DataStoreManager.updateBatchItems(itemUpdates)
    local success, newData = safeUpdateAsync("ITEMS", "all_items", function(currentData)
        local items = currentData or {}
        for itemId, itemData in pairs(itemUpdates) do
            items[itemId] = itemData
        end
        return items
    end)

    if success then
        backupData("ITEMS", "ITEM_BACKUPS", "all_items_batch", newData)
        print("âœ… æ‰¹é‡å•†å“æ•°æ®æ›´æ–°æˆåŠŸ")
    else
        warn("âŒ æ‰¹é‡å•†å“æ•°æ®æ›´æ–°å¤±è´¥")
    end

    return success
end

-- åˆå§‹åŒ–é»˜è®¤å•†å“æ•°æ®
local function initializeItemsData()
    -- ä½¿ç”¨å¤–éƒ¨ ItemsInitializer æ¨¡å—æ¥å¤„ç†å•†å“åˆå§‹åŒ–
    local ItemsInitializer = require(script.Parent.Parent.utils.ItemsInitializer)
    ItemsInitializer.initializeAllItems()
end

-- ==============================================
-- äº¤æ˜“æ•°æ®ç®¡ç†
-- ==============================================

-- è®°å½•äº¤æ˜“
function DataStoreManager.recordTransaction(transactionData)
    local transactionId = "txn_" .. os.time() .. "_" .. math.random(1000, 9999)
    transactionData.id = transactionId
    transactionData.timestamp = os.time()
    transactionData.status = transactionData.status or "completed"

    local success = safeSetAsync("TRANSACTIONS", transactionId, transactionData)
    if success then
        -- ä¸ºäº¤æ˜“æ•°æ®åˆ›å»ºå¤‡ä»½
        backupData("TRANSACTIONS", "TRANSACTION_BACKUPS", transactionId, transactionData)
        print("âœ… äº¤æ˜“è®°å½•æˆåŠŸ:", transactionId)
    else
        warn("âŒ äº¤æ˜“è®°å½•å¤±è´¥:", transactionId)
    end

    return success, transactionId
end

-- è·å–ç”¨æˆ·äº¤æ˜“å†å²
function DataStoreManager.getUserTransactionHistory(userId, limit)
    limit = limit or 50

    -- è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç´¢å¼•ç³»ç»Ÿ
    if isStudio then
        local userTransactions = {}
        for key, transaction in pairs(mockDataStores["TRANSACTIONS"] or {}) do
            if transaction.userId == userId then
                table.insert(userTransactions, transaction)
            end
        end

        -- æŒ‰æ—¶é—´æ’åº
        table.sort(userTransactions, function(a, b)
            return a.timestamp > b.timestamp
        end)

        -- é™åˆ¶æ•°é‡
        local result = {}
        for i = 1, math.min(limit, #userTransactions) do
            table.insert(result, userTransactions[i])
        end

        return result
    else
        -- ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´å¤æ‚çš„æŸ¥è¯¢æœºåˆ¶
        -- è¿™é‡Œè¿”å›ç©ºæ•°ç»„ï¼Œå®é™…åº”è¯¥å®ç°åŸºäºç´¢å¼•çš„æŸ¥è¯¢
        warn("âš ï¸ ç”Ÿäº§ç¯å¢ƒäº¤æ˜“å†å²æŸ¥è¯¢éœ€è¦é¢å¤–å®ç°")
        return {}
    end
end

-- è·å–äº¤æ˜“ç»Ÿè®¡ä¿¡æ¯
function DataStoreManager.getTransactionStats(timeRange)
    timeRange = timeRange or 86400 -- é»˜è®¤24å°æ—¶
    local currentTime = os.time()
    local startTime = currentTime - timeRange

    local stats = {
        totalTransactions = 0,
        totalVolume = 0,
        buyTransactions = 0,
        sellTransactions = 0,
        avgTransactionValue = 0
    }

    if isStudio then
        for key, transaction in pairs(mockDataStores["TRANSACTIONS"] or {}) do
            if transaction.timestamp >= startTime then
                stats.totalTransactions = stats.totalTransactions + 1
                stats.totalVolume = stats.totalVolume + (transaction.amount or 0)

                if transaction.type == "buy" then
                    stats.buyTransactions = stats.buyTransactions + 1
                elseif transaction.type == "sell" then
                    stats.sellTransactions = stats.sellTransactions + 1
                end
            end
        end

        if stats.totalTransactions > 0 then
            stats.avgTransactionValue = stats.totalVolume / stats.totalTransactions
        end
    end

    return stats
end

-- ==============================================
-- åˆ†æå’Œç›‘æ§æ•°æ®
-- ==============================================

-- è®°å½•æ€§èƒ½æŒ‡æ ‡
function DataStoreManager.recordPerformanceMetric(metricName, value, metadata)
    local metricData = {
        name = metricName,
        value = value,
        metadata = metadata or {},
        timestamp = os.time()
    }

    local metricKey = metricName .. "_" .. os.time()
    local success = safeSetAsync("PERFORMANCE_METRICS", metricKey, metricData, 1) -- åªå°è¯•ä¸€æ¬¡

    if not success then
        warn("âš ï¸ æ€§èƒ½æŒ‡æ ‡è®°å½•å¤±è´¥:", metricName)
    end

    return success
end

-- è·å–ç³»ç»Ÿå¥åº·çŠ¶æ€
function DataStoreManager.getSystemHealth()
    local health = {
        status = "healthy",
        lastChecked = os.time(),
        issues = {}
    }

    -- æ£€æŸ¥ DataStore è¿æ¥
    if not isStudio then
        local testSuccess = safeGetAsync("SYSTEM_CONFIG", "health_check", "ok")
        if not testSuccess then
            health.status = "degraded"
            table.insert(health.issues, "DataStoreè¿æ¥å¼‚å¸¸")
        end
    end

    -- å¯ä»¥æ·»åŠ æ›´å¤šå¥åº·æ£€æŸ¥
    return health
end

-- ==============================================
-- æ¨¡å—åˆå§‹åŒ–
-- ==============================================

function DataStoreManager.initialize()
    initializeDataStores()

    -- å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DataStoreå‡†å¤‡å°±ç»ª
    spawn(function()
        wait(1)
        initializeSystemConfig()
        initializeItemsData()
        print("ğŸ¯ DataStoreManager åˆå§‹åŒ–å®Œæˆ")
    end)
end

-- ==============================================
-- å…¬å…±æ¥å£
-- ==============================================

-- è·å–DataStoreå®ä¾‹ï¼ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰
function DataStoreManager.getDataStore(name)
    if isStudio then
        return mockDataStores[name]
    else
        return dataStores[name]
    end
end

-- æ£€æŸ¥æ˜¯å¦ä¸ºStudioç¯å¢ƒ
function DataStoreManager.isStudioMode()
    return isStudio
end

-- å®‰å…¨æ“ä½œçš„å…¬å…±æ¥å£
DataStoreManager.safeGetAsync = safeGetAsync
DataStoreManager.safeSetAsync = safeSetAsync
DataStoreManager.safeUpdateAsync = safeUpdateAsync

-- é»˜è®¤æ•°æ®ç»“æ„çš„å…¬å…±æ¥å£
DataStoreManager.getDefaultUserData = getDefaultUserData
DataStoreManager.createTransactionRecord = createTransactionRecord
DataStoreManager.createMembershipData = createMembershipData

return DataStoreManager
