-- æ•°æ®æœåŠ¡æ¨¡å— - ç»Ÿä¸€å¤„ç†æ‰€æœ‰APIè°ƒç”¨
-- ç®€åŒ–ç‰ˆæœ¬ï¼Œé›†ä¸­ç®¡ç†HTTPè¯·æ±‚

local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local DataService = {}

-- ç­‰å¾…é…ç½®æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))

-- ç”¨æˆ·è®¤è¯ä»¤ç‰Œå­˜å‚¨
local userTokens = {}

-- ==============================================
-- HTTPè¯·æ±‚å·¥å…·
-- ==============================================

local function makeRequest(method: string, endpoint: string, data: any?, token: string?)
    local url = Config.getApiUrl(endpoint)
    local headers = {}
    for key, value in pairs(Config.API.DEFAULT_HEADERS) do
        headers[key] = value
    end

    if token then
        headers["Authorization"] = "Bearer " .. token
    end

    local requestData = {
        Url = url,
        Method = method,
        Headers = headers
    }

    if data and (method == "POST" or method == "PUT") then
        requestData.Body = HttpService:JSONEncode(data)
    end

    local success, response = pcall(function()
        return HttpService:RequestAsync(requestData)
    end)

    if success then
        if response.Success then
            local responseData = response.Body and HttpService:JSONDecode(response.Body) or {}
            return responseData.success ~= false, responseData
        else
            warn("APIè¯·æ±‚å¤±è´¥ [HTTP " .. (response.StatusCode or "Unknown") .. "]: " .. (response.StatusMessage or "Unknown error"))
            return false, {error = "HTTP " .. (response.StatusCode or "Unknown")}
        end
    else
        warn("ç½‘ç»œè¯·æ±‚å¼‚å¸¸: " .. tostring(response))
        return false, {error = "Network error"}
    end
end

-- ==============================================
-- è®¤è¯ç›¸å…³
-- ==============================================

function DataService.authenticateUser(userId: string, username: string, displayName: string?)
    local success, response = makeRequest("POST", "/auth/login", {
        userId = userId,
        username = username,
        displayName = displayName
    })

    if success and response and response.data then
        userTokens[userId] = response.data.token
        return true, response.data.user
    end

    return false, nil
end

function DataService.isAuthenticated(userId: string): boolean
    return userTokens[userId] ~= nil
end

function DataService.getToken(userId: string): string?
    return userTokens[userId]
end

function DataService.removeToken(userId: string)
    userTokens[userId] = nil
end

-- ==============================================
-- æ™®é€šç”¨æˆ·æ•°æ®
-- ==============================================

function DataService.getUserData(userId: string)
    local token = userTokens[userId]
    if not token then return nil end

    local success, response = makeRequest("GET", "/users/me", nil, token)
    if success and response and response.data then
        return response.data
    end
    return nil
end

function DataService.getUserInventory(userId: string)
    local token = userTokens[userId]
    if not token then return nil end

    local success, response = makeRequest("GET", "/users/inventory", nil, token)
    if success and response and response.data then
        local inventory = {}
        for _, item in ipairs(response.data.inventory) do
            inventory[item.item_id] = item.quantity
        end
        return inventory
    end
    return nil
end

function DataService.getShopItems()
    local success, response = makeRequest("GET", "/items")
    if success and response and response.data then
        local items = {}
        for _, item in ipairs(response.data.items) do
            items[item.id] = item
        end
        return items
    end
    return nil
end

function DataService.buyItem(userId: string, itemId: string, quantity: number): (boolean, string?)
    local token = userTokens[userId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, response = makeRequest("POST", "/users/buy", {
        itemId = itemId,
        quantity = quantity
    }, token)

    if success and response then
        if response.success then
            return true, response.message
        else
            return false, response.error or "è´­ä¹°å¤±è´¥"
        end
    elseif response and response.error then
        return false, response.error
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

function DataService.sellItem(userId: string, itemId: string, quantity: number): (boolean, string?)
    local token = userTokens[userId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, response = makeRequest("POST", "/users/sell", {
        itemId = itemId,
        quantity = quantity
    }, token)

    if success and response then
        if response.success then
            return true, response.message
        else
            return false, response.error or "å‡ºå”®å¤±è´¥"
        end
    elseif response and response.error then
        return false, response.error
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

function DataService.claimDailyRewards(userId: string): (boolean, string?, any?)
    local token = userTokens[userId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("POST", "/users/membership/claim-rewards", nil, token)
    if success and response then
        if response.success then
            return true, response.message, response.data
        else
            -- å³ä½¿å¥–åŠ±é¢†å–å¤±è´¥ï¼ˆæ¯”å¦‚æ²¡æœ‰ä¼šå‘˜æˆ–å·²é¢†å–ï¼‰ï¼Œä¹Ÿè¿”å›æˆåŠŸï¼Œé¿å…é˜»å¡ç™»å½•æµç¨‹
            return true, response.message or "æ— å¯é¢†å–çš„å¥–åŠ±", response.data or {totalRewards = 0}
        end
    elseif response and response.error then
        return true, response.error, {totalRewards = 0}
    end
    return true, "ç½‘ç»œè¯·æ±‚å¤±è´¥", {totalRewards = 0}
end

function DataService.getMembershipStatus(userId: string)
    local token = userTokens[userId]
    if not token then return nil end

    local success, response = makeRequest("GET", "/users/membership/status", nil, token)
    if success and response and response.data then
        return response.data
    end
    return nil
end

-- ==============================================
-- ç®¡ç†å‘˜åŠŸèƒ½
-- ==============================================

function DataService.getAllUsers(adminUserId: string, limit: number?, offset: number?, includeStats: boolean?): (boolean, any?, string?)
    local token = userTokens[adminUserId]
    if not token then
        return false, nil, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local endpoint = "/admin/users"
    local params = {}
    if limit then table.insert(params, "limit=" .. tostring(limit)) end
    if offset then table.insert(params, "offset=" .. tostring(offset)) end
    if includeStats then table.insert(params, "includeStats=true") end

    if #params > 0 then
        endpoint = endpoint .. "?" .. table.concat(params, "&")
    end

    local success, response = makeRequest("GET", endpoint, nil, token)
    if success and response and response.data then
        return true, response.data, nil
    elseif response and response.error then
        return false, nil, response.error
    end
    return false, nil, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

function DataService.setUserCoins(adminUserId: string, targetUserId: string, newCoins: number, reason: string?): (boolean, string?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, response = makeRequest("PUT", "/admin/users/" .. targetUserId .. "/coins", {
        coins = newCoins,
        reason = reason
    }, token)

    if success and response then
        if response.success then
            return true, response.message
        else
            return false, response.error or "ä¿®æ”¹å¤±è´¥"
        end
    elseif response and response.error then
        return false, response.error
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

function DataService.getMembersList(adminUserId: string, page: number?, limit: number?, status: string?): (boolean, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    local params = {}
    if page then params.page = tostring(page) end
    if limit then params.limit = tostring(limit) end
    if status then params.status = status end

    local queryString = ""
    local first = true
    for key, value in pairs(params) do
        if first then
            queryString = "?" .. key .. "=" .. value
            first = false
        else
            queryString = queryString .. "&" .. key .. "=" .. value
        end
    end

    local success, response = makeRequest("GET", "/admin/members-list" .. queryString, nil, token)
    return success, response
end

function DataService.getAllUsersWithMembership(adminUserId: string, page: number?, limit: number?, status: string?): (boolean, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    local params = {}
    if page then params.page = tostring(page) end
    if limit then params.limit = tostring(limit) end
    if status then params.status = status end

    local queryString = ""
    local first = true
    for key, value in pairs(params) do
        if first then
            queryString = "?" .. key .. "=" .. value
            first = false
        else
            queryString = queryString .. "&" .. key .. "=" .. value
        end
    end

    local success, response = makeRequest("GET", "/admin/all-users-membership" .. queryString, nil, token)
    return success, response
end

function DataService.manageUserMembership(adminUserId: string, requestData: any): (boolean, any?)
    print("ğŸ”§ [ManageUserMembership] å¼€å§‹å¤„ç†è¯·æ±‚:", HttpService:JSONEncode(requestData))

    local token = userTokens[adminUserId]
    if not token then
        print("âŒ [ManageUserMembership] è®¤è¯å¤±è´¥: æ²¡æœ‰æ‰¾åˆ°token")
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    -- æ ¹æ®ä¸åŒçš„åŠ¨ä½œè·¯ç”±åˆ°ç›¸åº”çš„APIç«¯ç‚¹
    local action = requestData.action
    print("ğŸ”§ [ManageUserMembership] åŠ¨ä½œç±»å‹:", action)
    local success, response

    -- å…ˆè·å–ç”¨æˆ·åï¼ˆå¦‚æœåªæœ‰userIdï¼Œéœ€è¦è½¬æ¢ä¸ºplayerNameï¼‰
    local playerName = requestData.playerName or requestData.username
    print("ğŸ”§ [ManageUserMembership] åˆå§‹ç”¨æˆ·å:", playerName)

    if not playerName and requestData.userId then
        print("ğŸ”§ [ManageUserMembership] é€šè¿‡userIdè·å–ç”¨æˆ·å:", requestData.userId)
        -- å¦‚æœåªæœ‰userIdï¼Œéœ€è¦å…ˆè·å–ç”¨æˆ·ä¿¡æ¯æ¥å¾—åˆ°ç”¨æˆ·å
        local userSuccess, userResponse = makeRequest("GET", "/admin/users/" .. requestData.userId, nil, token)
        print("ğŸ”§ [ManageUserMembership] ç”¨æˆ·ä¿¡æ¯è·å–ç»“æœ:", userSuccess, userResponse and "æœ‰å“åº”" or "æ— å“åº”")

        if userSuccess and userResponse and userResponse.data and userResponse.data.user then
            playerName = userResponse.data.user.username
            print("ğŸ”§ [ManageUserMembership] è·å–åˆ°ç”¨æˆ·å:", playerName)
        else
            print("âŒ [ManageUserMembership] æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯")
            return false, {error = "æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯: " .. (userResponse and userResponse.error or "æœªçŸ¥é”™è¯¯")}
        end
    end

    if not playerName then
        print("âŒ [ManageUserMembership] ç¼ºå°‘ç”¨æˆ·åä¿¡æ¯")
        return false, {error = "ç¼ºå°‘ç”¨æˆ·åä¿¡æ¯"}
    end

    print("ğŸ”§ [ManageUserMembership] ä½¿ç”¨ç”¨æˆ·å:", playerName)

    if action == "activate" then
        -- æ¿€æ´»ä¼šå‘˜ - ä½¿ç”¨add-membership
        local days = requestData.days or 30
        print("ğŸ”§ [ManageUserMembership] æ¿€æ´»ä¼šå‘˜ï¼Œå¤©æ•°:", days)
        success, response = makeRequest("POST", "/admin/add-membership", {
            playerName = playerName,
            days = days
        }, token)
    elseif action == "deactivate" then
        -- åœç”¨ä¼šå‘˜ - ä½¿ç”¨cancel-membership
        print("ğŸ”§ [ManageUserMembership] åœç”¨ä¼šå‘˜")
        success, response = makeRequest("POST", "/admin/cancel-membership", {
            playerName = playerName
        }, token)
    elseif action == "set_days" then
        -- è®¾ç½®ä¼šå‘˜å¤©æ•° - ä½¿ç”¨extend-membershipæˆ–add-membership
        local days = requestData.days or 0
        print("ğŸ”§ [ManageUserMembership] è®¾ç½®ä¼šå‘˜å¤©æ•°:", days)
        if days > 0 then
            success, response = makeRequest("POST", "/admin/extend-membership", {
                playerName = playerName,
                days = days
            }, token)
        else
            -- å¦‚æœå¤©æ•°ä¸º0ï¼Œç›¸å½“äºå–æ¶ˆä¼šå‘˜
            print("ğŸ”§ [ManageUserMembership] å¤©æ•°ä¸º0ï¼Œå–æ¶ˆä¼šå‘˜")
            success, response = makeRequest("POST", "/admin/cancel-membership", {
                playerName = playerName
            }, token)
        end
    elseif action == "set_reward" then
        -- æ¯æ—¥å¥–åŠ±æ˜¯ç³»ç»Ÿçº§é…ç½®ï¼Œä¸æ”¯æŒå•ç”¨æˆ·è®¾ç½®
        -- æš‚æ—¶è¿”å›æˆåŠŸçŠ¶æ€ï¼Œæç¤ºç”¨æˆ·éœ€è¦åœ¨ç³»ç»Ÿé…ç½®ä¸­ä¿®æ”¹
        print("ğŸ”§ [ManageUserMembership] set_rewardæ“ä½œï¼Œè¿”å›æç¤ºä¿¡æ¯")
        return true, {
            success = true,
            message = "æ¯æ—¥å¥–åŠ±æ˜¯ç³»ç»Ÿçº§é…ç½®ï¼Œè¯·åœ¨ç³»ç»Ÿé…ç½®ä¸­ä¿®æ”¹å…¨å±€è®¾ç½®"
        }
    else
        -- æœªçŸ¥åŠ¨ä½œï¼Œè¿”å›é”™è¯¯
        print("âŒ [ManageUserMembership] æœªçŸ¥çš„æ“ä½œç±»å‹:", action)
        return false, {error = "æœªçŸ¥çš„æ“ä½œç±»å‹: " .. tostring(action)}
    end

    print("ğŸ”§ [ManageUserMembership] APIè°ƒç”¨ç»“æœ:", success, response and "æœ‰å“åº”" or "æ— å“åº”")
    if response then
        print("ğŸ”§ [ManageUserMembership] å“åº”å†…å®¹:", HttpService:JSONEncode(response))
    end

    return success, response
end

function DataService.addPlayerMembership(adminUserId: string, playerName: string, days: number): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("POST", "/admin/add-membership", {
        playerName = playerName,
        days = days
    }, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.updatePlayerMembership(adminUserId: string, playerName: string, membershipType: string?, status: string?, endDate: string?): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("PUT", "/admin/update-membership", {
        playerName = playerName,
        membershipType = membershipType,
        status = status,
        endDate = endDate
    }, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.cancelPlayerMembership(adminUserId: string, playerName: string): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("POST", "/admin/cancel-membership", {
        playerName = playerName
    }, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.extendPlayerMembership(adminUserId: string, playerName: string, days: number): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("POST", "/admin/extend-membership", {
        playerName = playerName,
        days = days
    }, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.batchMembershipOperation(adminUserId: string, playerNames: {string}, action: string, days: number?): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("POST", "/admin/batch-membership", {
        playerNames = playerNames,
        action = action,
        days = days
    }, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.getUserHistory(adminUserId: string, targetPlayerName: string, page: number?, limit: number?): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local params = {}
    if page then params.page = tostring(page) end
    if limit then params.limit = tostring(limit) end

    local queryString = ""
    local first = true
    for key, value in pairs(params) do
        if first then
            queryString = "?" .. key .. "=" .. value
            first = false
        else
            queryString = queryString .. "&" .. key .. "=" .. value
        end
    end

    local success, response = makeRequest("GET", "/admin/users/" .. targetPlayerName .. "/history" .. queryString, nil, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

function DataService.getAdminMembershipStatus(adminUserId: string, targetPlayerName: string): (boolean, string?, any?)
    local token = userTokens[adminUserId]
    if not token then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, response = makeRequest("GET", "/admin/users/" .. targetPlayerName .. "/membership", nil, token)

    if success and response then
        return response.success, response.message, response.data
    end
    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥", nil
end

-- ==============================================
-- ç®¡ç†å‘˜æƒé™éªŒè¯
-- ==============================================

function DataService.checkAdminPermission(userId: string): (boolean, string?)
    local success, response = makeRequest("POST", "/auth/check-admin", {
        userId = userId
    })

    if success and response and response.data then
        return response.data.isAdmin == true, response.data.message
    elseif response and response.error then
        return false, response.error
    end

    return false, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

-- ==============================================
-- ç”¨æˆ·äº¤æ˜“è®°å½•åŠŸèƒ½
-- ==============================================

function DataService.getUserTransactions(userId: string, limit: number?, offset: number?, type: string?): (boolean, any?, string?)
    local token = userTokens[userId]
    if not token then
        return false, nil, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local endpoint = "/users/transactions"
    local params = {}

    if limit then params.limit = tostring(limit) end
    if offset then params.offset = tostring(offset) end
    if type then params.type = type end

    local queryString = ""
    local first = true
    for key, value in pairs(params) do
        if first then
            queryString = "?" .. key .. "=" .. value
            first = false
        else
            queryString = queryString .. "&" .. key .. "=" .. value
        end
    end

    local success, response = makeRequest("GET", endpoint .. queryString, nil, token)

    if success and response and response.data then
        return true, response.data, nil
    elseif response and response.error then
        return false, nil, response.error
    end
    return false, nil, "ç½‘ç»œè¯·æ±‚å¤±è´¥"
end

print("ğŸ’¾ æ•°æ®æœåŠ¡æ¨¡å—å·²åŠ è½½")

return DataService
