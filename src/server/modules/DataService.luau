-- æ•°æ®æœåŠ¡æ¨¡å— - åŸºäº DataStoreService çš„ç»Ÿä¸€æ•°æ®ç®¡ç†

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")

local DataService = {}

-- ç­‰å¾…é…ç½®å’Œæ•°æ®æœåŠ¡æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))

-- å¯¼å…¥æ•°æ®æœåŠ¡æ¨¡å—
local DataStoreManager = require(script.Parent:WaitForChild("DataStoreManager"))
local UserDataService = require(script.Parent:WaitForChild("UserDataService"))
local AdminDataService = require(script.Parent:WaitForChild("AdminDataService"))

-- ç”¨æˆ·ä¼šè¯å­˜å‚¨ï¼ˆæ›¿æ¢ä»¤ç‰Œç³»ç»Ÿï¼‰
local userSessions = {}

-- åˆå§‹åŒ– DataStore ç®¡ç†å™¨
DataStoreManager.initialize()

-- ==============================================
-- è®¤è¯ç›¸å…³
-- ==============================================

function DataService.authenticateUser(userId: string, username: string, displayName: string?)
    local success, result = pcall(function()
        return UserDataService.createOrLoginUser(userId, username, displayName)
    end)

    if success and result then
        -- åˆ›å»ºç”¨æˆ·ä¼šè¯
        userSessions[userId] = {
            userId = userId,
            username = username,
            displayName = displayName,
            authenticated = true,
            createdAt = os.time()
        }

        return true, result.user
    end

    return false, nil
end

function DataService.isAuthenticated(userId: string): boolean
    return userSessions[userId] ~= nil and userSessions[userId].authenticated
end

-- æ¸…ç†ç”¨æˆ·ä¼šè¯
function DataService.clearUserSession(userId: string)
    if userSessions[userId] then
        userSessions[userId] = nil
        print("ğŸ§¹ [DataService] æ¸…ç†ç”¨æˆ·ä¼šè¯:", userId)
    end
end

function DataService.getSession(userId: string)
    return userSessions[userId]
end

function DataService.removeSession(userId: string)
    userSessions[userId] = nil
end

-- ==============================================
-- æ™®é€šç”¨æˆ·æ•°æ®
-- ==============================================

function DataService.getUserData(userId: string)
    if not DataService.isAuthenticated(userId) then
        return nil
    end

    local success, userData = pcall(function()
        return UserDataService.getUserDetails(userId)
    end)

    return success and userData or nil
end

function DataService.getUserInventory(userId: string)
    if not DataService.isAuthenticated(userId) then
        return nil
    end

    local success, inventory = pcall(function()
        return UserDataService.getUserInventory(userId)
    end)

    if success and inventory then
        -- è½¬æ¢æ ¼å¼
        local formattedInventory = {}
        for itemId, itemData in pairs(inventory) do
            formattedInventory[itemId] = itemData.quantity
        end
        return formattedInventory
    end

    return nil
end

function DataService.getShopItems()
    local success, items = pcall(function()
        return UserDataService.getItems(true) -- åªè·å–æ¿€æ´»çš„å•†å“
    end)

    if success and items then
        return items
    end

    return nil
end

function DataService.buyItem(userId: string, itemId: string, quantity: number): (boolean, string?)
    if not DataService.isAuthenticated(userId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, result = pcall(function()
        return UserDataService.buyItem(userId, itemId, quantity)
    end)

    if success and result and result.success then
        return true, "è´­ä¹°æˆåŠŸ"
    else
        local errorMessage = (result and result.message) or "è´­ä¹°å¤±è´¥"
        return false, errorMessage
    end
end

function DataService.sellItem(userId: string, itemId: string, quantity: number): (boolean, string?)
    if not DataService.isAuthenticated(userId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local result, errorMessage = UserDataService.sellItem(userId, itemId, quantity)

    if result and result.success then
        return true, "å‡ºå”®æˆåŠŸ"
    else
        return false, errorMessage or "å‡ºå”®å¤±è´¥"
    end
end

function DataService.claimDailyRewards(userId: string): (boolean, string?, any?)
    if not DataService.isAuthenticated(userId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local success, result = pcall(function()
        return UserDataService.processLoginRewards(userId)
    end)

    if success and result then
        if result.success then
            return true, result.message, {
                totalRewards = result.totalRewards,
                rewardAmount = result.rewardAmount,
                rewardedDays = result.rewardedDays,
                membershipType = result.membershipType
            }
        else
            -- å³ä½¿å¥–åŠ±é¢†å–å¤±è´¥ï¼ˆæ¯”å¦‚æ²¡æœ‰ä¼šå‘˜æˆ–å·²é¢†å–ï¼‰ï¼Œä¹Ÿè¿”å›æˆåŠŸï¼Œé¿å…é˜»å¡ç™»å½•æµç¨‹
            return true, result.message or "æ— å¯é¢†å–çš„å¥–åŠ±", {totalRewards = 0}
        end
    end

    return true, "ç½‘ç»œè¯·æ±‚å¤±è´¥", {totalRewards = 0}
end

function DataService.getMembershipStatus(userId: string)
    if not DataService.isAuthenticated(userId) then
        return nil
    end

    local success, membershipStatus = pcall(function()
        return UserDataService.getMembershipStatus(userId)
    end)

    return success and membershipStatus or nil
end

-- ==============================================
-- ç®¡ç†å‘˜åŠŸèƒ½
-- ==============================================

function DataService.getAllUsers(adminUserId: string, limit: number?, offset: number?, includeStats: boolean?): (boolean, any?, string?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, nil, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, users = pcall(function()
        return AdminDataService.getUsersWithPagination({
            limit = limit or 100,
            offset = offset or 0,
            includeStats = includeStats
        })
    end)

    if success and users then
        return true, {users = users}, nil
    else
        local errorMessage = users or "è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥"
        return false, nil, errorMessage
    end
end

function DataService.setUserCoins(adminUserId: string, targetUserId: string, newCoins: number, reason: string?): (boolean, string?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, result = pcall(function()
        return AdminDataService.updateUserCoins(targetUserId, newCoins, reason, adminUserId)
    end)

    if success then
        return true, "é‡‘å¸ä¿®æ”¹æˆåŠŸ"
    else
        local errorMessage = result or "ä¿®æ”¹å¤±è´¥"
        return false, errorMessage
    end
end

function DataService.getMembersList(adminUserId: string, page: number?, limit: number?, status: string?): (boolean, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    local success, result = pcall(function()
        return AdminDataService.getMembersList(page, limit, status)
    end)

    if success and result then
        return true, result
    else
        return false, {error = result or "è·å–ä¼šå‘˜åˆ—è¡¨å¤±è´¥"}
    end
end

function DataService.getAllUsersWithMembership(adminUserId: string, page: number?, limit: number?, status: string?): (boolean, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    local success, result = pcall(function()
        return AdminDataService.getAllUsersWithMembershipStatus(page, limit, status)
    end)

    if success and result then
        return true, {success = true, data = result}
    else
        local errorMessage = result or "è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å¤±è´¥"
        warn("âŒ [DataService] è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å¤±è´¥:", errorMessage)
        return false, {success = false, error = errorMessage, message = errorMessage}
    end
end

function DataService.manageUserMembership(adminUserId: string, requestData: any): (boolean, any?)
    print("ğŸ”§ [ManageUserMembership] å¼€å§‹å¤„ç†è¯·æ±‚:", HttpService:JSONEncode(requestData))

    if not DataService.isAuthenticated(adminUserId) then
        print("âŒ [ManageUserMembership] è®¤è¯å¤±è´¥: ç”¨æˆ·æœªè®¤è¯")
        return false, {error = "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"}
    end

    local action = requestData.action
    print("ğŸ”§ [ManageUserMembership] åŠ¨ä½œç±»å‹:", action)

    local playerName = requestData.playerName or requestData.username
    local userId = requestData.userId

    -- å¦‚æœåªæœ‰userIdï¼Œéœ€è¦è½¬æ¢ä¸ºç”¨æˆ·å
    if not playerName and userId then
        local userData = AdminDataService.checkUserExists(userId, true)
        if userData then
            playerName = userData.username
            print("ğŸ”§ [ManageUserMembership] è·å–åˆ°ç”¨æˆ·å:", playerName)
        else
            print("âŒ [ManageUserMembership] æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯")
            return false, {error = "ç”¨æˆ·ä¸å­˜åœ¨"}
        end
    end

    if not playerName then
        print("âŒ [ManageUserMembership] ç¼ºå°‘ç”¨æˆ·åä¿¡æ¯")
        return false, {error = "ç¼ºå°‘ç”¨æˆ·åä¿¡æ¯"}
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·IDï¼ˆå› ä¸ºæˆ‘ä»¬çš„DataStoreä½¿ç”¨userIdä½œä¸ºé”®ï¼‰
    local userInfo = AdminDataService.getUserByUsername(playerName)
    if not userInfo then
        return false, {error = "ç”¨æˆ·ä¸å­˜åœ¨: " .. playerName}
    end

    local targetUserId = userInfo.id
    print("ğŸ”§ [ManageUserMembership] ç›®æ ‡ç”¨æˆ·ID:", targetUserId)

    local success, response

    if action == "activate" then
        local days = requestData.days or 30
        print("ğŸ”§ [ManageUserMembership] æ¿€æ´»ä¼šå‘˜ï¼Œå¤©æ•°:", days)
        success, response = pcall(function()
            return AdminDataService.buyMembership(targetUserId, days, 100)
        end)

        if success and response then
            response = {success = true, message = "ä¼šå‘˜æ¿€æ´»æˆåŠŸ", data = response}
        else
            response = {success = false, error = response or "æ¿€æ´»ä¼šå‘˜å¤±è´¥"}
        end

    elseif action == "deactivate" then
        print("ğŸ”§ [ManageUserMembership] åœç”¨ä¼šå‘˜")
        success, response = pcall(function()
            return AdminDataService.cancelMembership(targetUserId)
        end)

        if success and response and response.success then
            response = {success = true, message = response.message, data = response}
        else
            response = {success = false, error = response or "åœç”¨ä¼šå‘˜å¤±è´¥"}
        end

    elseif action == "set_days" then
        local days = requestData.days or 0
        print("ğŸ”§ [ManageUserMembership] è®¾ç½®ä¼šå‘˜å¤©æ•°ï¼ˆç»å¯¹å€¼ï¼‰ - ç›®æ ‡ç”¨æˆ·ID:", targetUserId, "å¤©æ•°:", days)

        success, response = pcall(function()
            return AdminDataService.setMembershipDays(targetUserId, days)
        end)

        -- è¯¦ç»†é”™è¯¯è¯Šæ–­
        if not success then
            local errorMsg = "pcallå¤±è´¥: " .. tostring(response)
            print("âŒ [ManageUserMembership] " .. errorMsg)
            response = {success = false, error = errorMsg}
        elseif not response then
            local errorMsg = "setMembershipDaysè¿”å›nil"
            print("âŒ [ManageUserMembership] " .. errorMsg)
            response = {success = false, error = errorMsg}
        elseif not response.success then
            local errorMsg = response.message or "setMembershipDayså†…éƒ¨å¤±è´¥"
            print("âŒ [ManageUserMembership] " .. errorMsg)
            response = {success = false, error = errorMsg}
        end

        if success and response and response.success then
            -- è®°å½•æ›´è¯¦ç»†çš„æ“ä½œä¿¡æ¯
            local oldDays = response.oldDaysRemaining or 0
            local newDays = response.newDays or 0
            local changeDesc = ""

            if newDays == 0 then
                changeDesc = "ä¼šå‘˜å·²å–æ¶ˆ"
            elseif oldDays == 0 then
                changeDesc = "ä¼šå‘˜å·²æ¿€æ´»ï¼Œè®¾ç½®ä¸º " .. newDays .. " å¤©"
            else
                changeDesc = "ä¼šå‘˜å¤©æ•°ä» " .. oldDays .. " å¤©æ”¹ä¸º " .. newDays .. " å¤©"
            end

            print("âœ… [ManageUserMembership] " .. changeDesc)
            response = {success = true, message = response.message or changeDesc, data = response}
        else
            local errorMsg = response and response.message or "è®¾ç½®ä¼šå‘˜å¤©æ•°å¤±è´¥"
            print("âŒ [ManageUserMembership] " .. errorMsg)
            response = {success = false, error = errorMsg}
        end

    elseif action == "set_reward" then
        local reward = requestData.dailyReward or 100
        print("ğŸ”§ [ManageUserMembership] è®¾ç½®æ¯æ—¥å¥–åŠ±:", reward)

        success, response = pcall(function()
            return AdminDataService.setMembershipReward(targetUserId, reward)
        end)

        if success and response and response.success then
            response = {success = true, message = response.message or "æ¯æ—¥å¥–åŠ±è®¾ç½®æˆåŠŸ", data = response}
        else
            response = {success = false, error = response or "è®¾ç½®æ¯æ—¥å¥–åŠ±å¤±è´¥"}
        end
    else
        print("âŒ [ManageUserMembership] æœªçŸ¥çš„æ“ä½œç±»å‹:", action)
        return false, {error = "æœªçŸ¥çš„æ“ä½œç±»å‹: " .. tostring(action)}
    end

    print("ğŸ”§ [ManageUserMembership] æ“ä½œç»“æœ:", success, response and "æœ‰å“åº”" or "æ— å“åº”")
    if response then
        print("ğŸ”§ [ManageUserMembership] å“åº”å†…å®¹:", HttpService:JSONEncode(response))
    end

    return true, response
end

function DataService.addPlayerMembership(adminUserId: string, playerName: string, days: number): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(playerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. playerName, nil
    end

    local success, result = pcall(function()
        return AdminDataService.buyMembership(userInfo.id, days, 100)
    end)

    if success and result then
        return true, "ä¼šå‘˜æ·»åŠ æˆåŠŸ", result
    else
        return false, result or "æ·»åŠ ä¼šå‘˜å¤±è´¥", nil
    end
end

function DataService.updatePlayerMembership(adminUserId: string, playerName: string, membershipType: string?, status: string?, endDate: string?): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(playerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. playerName, nil
    end

    local success, result = pcall(function()
        return AdminDataService.updateMembershipInfo(userInfo.id, {
            membershipType = membershipType,
            status = status,
            endDate = endDate
        })
    end)

    if success and result and result.success then
        return true, "ä¼šå‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸ", result
    else
        return false, result and result.message or "æ›´æ–°ä¼šå‘˜ä¿¡æ¯å¤±è´¥", nil
    end
end

function DataService.cancelPlayerMembership(adminUserId: string, playerName: string): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(playerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. playerName, nil
    end

    local success, result = pcall(function()
        return AdminDataService.cancelMembership(userInfo.id)
    end)

    if success and result and result.success then
        return true, result.message, result
    else
        return false, result and result.message or "å–æ¶ˆä¼šå‘˜å¤±è´¥", nil
    end
end

function DataService.extendPlayerMembership(adminUserId: string, playerName: string, days: number): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(playerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. playerName, nil
    end

    local success, result = pcall(function()
        return AdminDataService.extendMembership(userInfo.id, days)
    end)

    if success and result and result.success then
        return true, result.message or "ä¼šå‘˜å»¶é•¿æˆåŠŸ", result
    else
        return false, result and result.message or "å»¶é•¿ä¼šå‘˜å¤±è´¥", nil
    end
end

function DataService.batchMembershipOperation(adminUserId: string, playerNames: {string}, action: string, days: number?): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    local results = {}
    local successCount = 0
    local failureCount = 0

    for _, playerName in ipairs(playerNames) do
        local userInfo = AdminDataService.getUserByUsername(playerName)
        if userInfo then
            local success, result

            if action == "add" or action == "activate" then
                success, result = pcall(function()
                    return AdminDataService.buyMembership(userInfo.id, days or 30, 100)
                end)
            elseif action == "cancel" or action == "deactivate" then
                success, result = pcall(function()
                    return AdminDataService.cancelMembership(userInfo.id)
                end)
            elseif action == "extend" then
                success, result = pcall(function()
                    return AdminDataService.extendMembership(userInfo.id, days or 30)
                end)
            else
                success, result = false, "æœªçŸ¥æ“ä½œ: " .. action
            end

            if success and result then
                successCount = successCount + 1
                results[playerName] = {success = true, message = "æ“ä½œæˆåŠŸ"}
            else
                failureCount = failureCount + 1
                results[playerName] = {success = false, message = result or "æ“ä½œå¤±è´¥"}
            end
        else
            failureCount = failureCount + 1
            results[playerName] = {success = false, message = "ç”¨æˆ·ä¸å­˜åœ¨"}
        end
    end

    local message = string.format("æ‰¹é‡æ“ä½œå®Œæˆï¼ŒæˆåŠŸ: %dï¼Œå¤±è´¥: %d", successCount, failureCount)
    return successCount > 0, message, {results = results, summary = {success = successCount, failure = failureCount}}
end

function DataService.getUserHistory(adminUserId: string, targetPlayerName: string, page: number?, limit: number?): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(targetPlayerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. targetPlayerName, nil
    end

    local success, transactions = pcall(function()
        return UserDataService.getUserTransactions(userInfo.id, limit or 50)
    end)

    if success and transactions then
        return true, "è·å–äº¤æ˜“å†å²æˆåŠŸ", {
            transactions = transactions,
            pagination = {
                page = page or 1,
                limit = limit or 50,
                total = #transactions
            }
        }
    else
        return false, transactions or "è·å–äº¤æ˜“å†å²å¤±è´¥", nil
    end
end

function DataService.getAdminMembershipStatus(adminUserId: string, targetPlayerName: string): (boolean, string?, any?)
    if not DataService.isAuthenticated(adminUserId) then
        return false, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ", nil
    end

    -- é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ID
    local userInfo = AdminDataService.getUserByUsername(targetPlayerName)
    if not userInfo then
        return false, "ç”¨æˆ·ä¸å­˜åœ¨: " .. targetPlayerName, nil
    end

    local success, membershipStatus = pcall(function()
        return UserDataService.getMembershipStatus(userInfo.id)
    end)

    if success and membershipStatus then
        return true, "è·å–ä¼šå‘˜çŠ¶æ€æˆåŠŸ", membershipStatus
    else
        return false, membershipStatus or "è·å–ä¼šå‘˜çŠ¶æ€å¤±è´¥", nil
    end
end

-- ==============================================
-- ç®¡ç†å‘˜æƒé™éªŒè¯
-- ==============================================

function DataService.checkAdminPermission(userId: string): (boolean, string?)
    local userData = AdminDataService.checkUserExists(userId, true)

    if userData then
        return userData.is_admin == true, userData.is_admin and "ç”¨æˆ·æ˜¯ç®¡ç†å‘˜" or "ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜"
    else
        return false, "ç”¨æˆ·ä¸å­˜åœ¨"
    end
end

-- ==============================================
-- ç”¨æˆ·äº¤æ˜“è®°å½•åŠŸèƒ½
-- ==============================================

function DataService.getUserTransactions(userId: string, limit: number?, offset: number?, type: string?): (boolean, any?, string?)
    if not DataService.isAuthenticated(userId) then
        return false, nil, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ"
    end

    local success, transactions = pcall(function()
        return UserDataService.getUserTransactions(userId, limit or 50)
    end)

    if success and transactions then
        -- æ ¹æ®ç±»å‹ç­›é€‰
        local filteredTransactions = transactions
        if type then
            filteredTransactions = {}
            for _, transaction in ipairs(transactions) do
                if transaction.type == type then
                    table.insert(filteredTransactions, transaction)
                end
            end
        end

        -- åº”ç”¨åç§»é‡å’Œé™åˆ¶
        if offset and offset > 0 then
            local offsetTransactions = {}
            for i = offset + 1, #filteredTransactions do
                table.insert(offsetTransactions, filteredTransactions[i])
            end
            filteredTransactions = offsetTransactions
        end

        if limit and #filteredTransactions > limit then
            local limitedTransactions = {}
            for i = 1, limit do
                table.insert(limitedTransactions, filteredTransactions[i])
            end
            filteredTransactions = limitedTransactions
        end

        return true, {
            transactions = filteredTransactions,
            pagination = {
                offset = offset or 0,
                limit = limit or 50,
                total = #transactions
            }
        }, nil
    else
        return false, nil, transactions or "è·å–äº¤æ˜“è®°å½•å¤±è´¥"
    end
end

print("ğŸ’¾ æ•°æ®æœåŠ¡æ¨¡å—å·²åŠ è½½ï¼ˆåŸºäº DataStoreï¼‰")

return DataService
