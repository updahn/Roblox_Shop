-- å•†åº—ç³»ç»ŸæœåŠ¡ç«¯é€»è¾‘ - é‡æ„ä¸ºAPIä»£ç†ç‰ˆæœ¬

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- ç­‰å¾…å…±äº«æ¨¡å—ï¼ˆç”±Bootstrapè„šæœ¬è®¾ç½®ï¼‰
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local ShopData = require(SharedModules:WaitForChild("ShopData"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))

-- ç©å®¶ä¼šè¯ç®¡ç†
local playerSessions = {} -- å­˜å‚¨å·²ç™»å½•çš„ç©å®¶

-- æ£€æŸ¥ç©å®¶æ˜¯å¦ä¸ºç®¡ç†å‘˜
local function isPlayerAdmin(player)
    return Config.isValidAdmin(player)
end

print("ğŸª å•†åº—ç³»ç»Ÿå·²åˆå§‹åŒ– (APIæ¨¡å¼)")

-- ç©å®¶è®¤è¯å’Œæ•°æ®è·å–
local function authenticatePlayer(player: Player)
    local userId = tostring(player.UserId)
    local username = player.Name
    local displayName = player.DisplayName ~= player.Name and player.DisplayName or nil

    local success, userData = ShopData.authenticateUser(userId, username, displayName)
    if success then
        playerSessions[player] = {
            userId = userId,
            userData = userData,
            authenticated = true,
            isAdmin = isPlayerAdmin(player)
        }
        print("âœ… [è®¤è¯] " .. player.Name .. " è®¤è¯æˆåŠŸ | é‡‘å¸: " .. (userData.coins or 0))
        return true
    else
        warn("âŒ [è®¤è¯] " .. player.Name .. " è®¤è¯å¤±è´¥")
        warn("ğŸ’¡ å¯èƒ½åŸå› ï¼šç½‘ç»œè¿æ¥é—®é¢˜æˆ–HTTPæœåŠ¡æœªå¯ç”¨")
        warn("ğŸ’¡ APIåœ°å€ï¼š" .. Config.getApiUrl("/auth/login"))
        return false
    end
end

-- è·å–ç©å®¶ä¼šè¯
local function getPlayerSession(player: Player)
    return playerSessions[player]
end

-- å¤„ç†è·å–ç©å®¶æ•°æ®è¯·æ±‚
local function handleGetPlayerData(player: Player)
    local session = getPlayerSession(player)
    if not session or not session.authenticated then
        -- å°è¯•é‡æ–°è®¤è¯
        if not authenticatePlayer(player) then
            ShopEvents.RemoteEvents.GetPlayerData:FireClient(player, nil)
            return
        end
        session = getPlayerSession(player)
    end

    -- è·å–æœ€æ–°çš„ç”¨æˆ·æ•°æ®
    local userData = ShopData.getUserData(session.userId)
    if userData then
        -- è·å–ç”¨æˆ·åº“å­˜
        local inventory = ShopData.getUserInventory(session.userId)

        -- è½¬æ¢ä¸ºæ—§æ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§
        local playerData = {
            coins = userData.coins,
            inventory = inventory or {},
            stats = {
                totalPurchases = userData.total_purchases or 0,
                totalSales = userData.total_sales or 0,
                totalSpent = userData.total_spent or 0,
                totalEarned = userData.total_earned or 0
            }
        }

        -- è·å–äº¤æ˜“è®°å½•ï¼ˆæœ€è¿‘20æ¡ï¼‰
        local transactionData = ShopData.getTransactions(session.userId, 20, 0)
        if transactionData and transactionData.transactions then
            playerData.purchaseHistory = {}
            for _, transaction in ipairs(transactionData.transactions) do
                local action, totalCost, totalEarned = "", 0, 0

                if transaction.type == "buy" then
                    action = "buy"
                    totalCost = transaction.total_amount or 0
                elseif transaction.type == "sell" then
                    action = "sell"
                    totalEarned = transaction.total_amount or 0
                elseif transaction.type == "admin" then
                    action = "admin_edit"
                    -- å¯¹äºç®¡ç†å‘˜æ“ä½œï¼Œtotal_amount è¡¨ç¤ºé‡‘å¸å˜åŒ–é‡
                    if transaction.total_amount and transaction.total_amount > 0 then
                        totalEarned = transaction.total_amount
                    else
                        totalCost = math.abs(transaction.total_amount or 0)
                    end
                else
                    action = "unknown"
                end

                table.insert(playerData.purchaseHistory, {
                    action = action,
                    itemId = transaction.item_id,
                    itemName = transaction.item_name,
                    quantity = transaction.quantity,
                    totalCost = totalCost,
                    totalEarned = totalEarned,
                    timestamp = transaction.created_at,
                    balanceAfter = transaction.coins_after
                })
            end
        end

        session.userData = userData
        ShopEvents.RemoteEvents.GetPlayerData:FireClient(player, playerData)
    else
        ShopEvents.RemoteEvents.GetPlayerData:FireClient(player, nil)
    end
end

-- å¤„ç†è·å–å•†åº—æ•°æ®è¯·æ±‚
local function handleGetShopData(player: Player)
    local session = getPlayerSession(player)
    if not session or not session.authenticated then
        ShopEvents.RemoteEvents.GetShopData:FireClient(player, {})
        return
    end

    local shopItems = ShopData.getShopItems()
    if shopItems then
        -- è½¬æ¢æ ¼å¼ä»¥ä¿æŒå…¼å®¹æ€§
        local shopData = {}
        for itemId, item in pairs(shopItems) do
            shopData[itemId] = {
                id = item.id,
                name = item.name,
                price = item.price,
                maxQuantity = item.max_quantity,
                currentStock = item.current_stock,  -- ç›´æ¥ä½¿ç”¨æ•°æ®åº“ä¸­çš„å½“å‰åº“å­˜
                description = item.description,
                icon = item.icon,
                imageId = item.image_id,
                category = item.category,
                sellPrice = item.sell_price
            }
        end

        ShopEvents.RemoteEvents.GetShopData:FireClient(player, shopData)
    else
        ShopEvents.RemoteEvents.GetShopData:FireClient(player, {})
    end
end

--- å¤„ç†åˆ·æ–°å•†åº—æ•°æ®è¯·æ±‚
local function handleRefreshShopData(player: Player)
    -- ç›´æ¥è°ƒç”¨è·å–å•†åº—æ•°æ®å‡½æ•°ï¼Œè¿™æ ·ä¼šè‡ªåŠ¨åˆ·æ–°
    handleGetShopData(player)
end

-- å¤„ç†è´­ä¹°ç‰©å“
local function handlePurchaseItem(player: Player, itemId: string, quantity: number)
    local session = getPlayerSession(player)
    if not session or not session.authenticated then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "ç”¨æˆ·æœªè®¤è¯", nil)
        return
    end

    -- éªŒè¯è¾“å…¥
    if not itemId or quantity <= 0 then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "æ— æ•ˆçš„å‚æ•°", nil)
        return
    end

    local success, message = ShopData.buyItem(session.userId, itemId, quantity)

    if success then
        -- è·å–æ›´æ–°åçš„ç”¨æˆ·æ•°æ®
        local userData = ShopData.getUserData(session.userId)
        local inventory = ShopData.getUserInventory(session.userId)

        local playerData = {
            coins = userData.coins,
            inventory = inventory or {},
            stats = {
                totalPurchases = userData.total_purchases or 0,
                totalSales = userData.total_sales or 0,
                totalSpent = userData.total_spent or 0,
                totalEarned = userData.total_earned or 0
            }
        }

        session.userData = userData
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, true, message, playerData)
        print("ğŸ›’ [è´­ä¹°] " .. player.Name .. " è´­ä¹°äº† " .. itemId .. " x" .. quantity)

        -- ç«‹å³å¹¿æ’­å•†åº—æ•°æ®æ›´æ–°ç»™æ‰€æœ‰ç©å®¶
        for _, otherPlayer in pairs(Players:GetPlayers()) do
            handleGetShopData(otherPlayer)
        end
    else
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, message or "è´­ä¹°å¤±è´¥", nil)
    end
end

-- å¤„ç†å–å‡ºç‰©å“
local function handleSellItem(player: Player, itemId: string, quantity: number)
    local session = getPlayerSession(player)
    if not session or not session.authenticated then
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, "ç”¨æˆ·æœªè®¤è¯", nil)
        return
    end

    -- éªŒè¯è¾“å…¥
    if not itemId or quantity <= 0 then
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, "æ— æ•ˆçš„å‚æ•°", nil)
        return
    end

    local success, message = ShopData.sellItem(session.userId, itemId, quantity)

    if success then
        -- è·å–æ›´æ–°åçš„ç”¨æˆ·æ•°æ®
        local userData = ShopData.getUserData(session.userId)
        local inventory = ShopData.getUserInventory(session.userId)

        local playerData = {
            coins = userData.coins,
            inventory = inventory or {},
            stats = {
                totalPurchases = userData.total_purchases or 0,
                totalSales = userData.total_sales or 0,
                totalSpent = userData.total_spent or 0,
                totalEarned = userData.total_earned or 0
            }
        }

        session.userData = userData
        ShopEvents.RemoteEvents.SellItem:FireClient(player, true, message, playerData)
        print("ğŸ’° [å–å‡º] " .. player.Name .. " å–å‡ºäº† " .. itemId .. " x" .. quantity)

        -- ç«‹å³å¹¿æ’­å•†åº—æ•°æ®æ›´æ–°ç»™æ‰€æœ‰ç©å®¶
        for _, otherPlayer in pairs(Players:GetPlayers()) do
            handleGetShopData(otherPlayer)
        end
    else
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, message or "å–å‡ºå¤±è´¥", nil)
    end
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–æ‰€æœ‰ç©å®¶æ•°æ®
local function handleGetAllPlayersData(player: Player)
    local session = getPlayerSession(player)
    if not session or not session.authenticated or not session.isAdmin then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–æ‰€æœ‰ç©å®¶æ•°æ®ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    local success, allUsersData, errorMsg = ShopData.getAllUsers(session.userId, 50, 0)
    if success and allUsersData then
        local allPlayersData = {}
        for _, user in ipairs(allUsersData.users) do
            allPlayersData[user.username] = {
                userId = user.id,
                name = user.username,
                coins = user.coins or 0,
                totalPurchases = user.total_purchases or 0,
                totalSpent = user.total_spent or 0,
                totalSales = user.total_sales or 0,
                totalEarned = user.total_earned or 0,
                inventoryCount = 0 -- éœ€è¦å•ç‹¬æŸ¥è¯¢åº“å­˜
            }
        end

        ShopEvents.RemoteEvents.GetAllPlayersData:FireClient(player, allPlayersData)
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†æ‰€æœ‰ç©å®¶æ•°æ®")
    else
        local errorMessage = errorMsg or "æ— æ³•è·å–ç©å®¶æ•°æ®"
        warn("âŒ [APIé”™è¯¯] " .. errorMessage)
        -- å‘é€é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯ï¼ˆä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’é”™è¯¯ä¿¡æ¯ï¼‰
        ShopEvents.RemoteEvents.GetAllPlayersData:FireClient(player, nil, errorMessage)
    end
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè®¾ç½®ç©å®¶é‡‘å¸
local function handleSetPlayerCoins(player: Player, targetPlayerName: string, newCoins: number)
    local session = getPlayerSession(player)
    if not session or not session.authenticated or not session.isAdmin then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•ä¿®æ”¹ " .. targetPlayerName .. " çš„é‡‘å¸ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    -- æŸ¥æ‰¾ç›®æ ‡ç©å®¶çš„ID
    local targetUserId = nil
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer.Name == targetPlayerName then
            targetUserId = tostring(otherPlayer.UserId)
            break
        end
    end

    if not targetUserId then
        ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, false, "ç©å®¶ " .. targetPlayerName .. " ä¸åœ¨çº¿")
        return
    end

    local success, message = ShopData.setUserCoins(session.userId, targetUserId, newCoins, "ç®¡ç†å‘˜è°ƒæ•´ by " .. player.Name)

    if success then
        ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, true, message)

        -- é€šçŸ¥ç›®æ ‡ç©å®¶æ•°æ®æ›´æ–°
        for _, otherPlayer in pairs(Players:GetPlayers()) do
            if otherPlayer.Name == targetPlayerName then
                handleGetPlayerData(otherPlayer)
                break
            end
        end

        print("ğŸ‘‘ [ç®¡ç†å‘˜æ“ä½œ] " .. player.Name .. " ä¿®æ”¹äº† " .. targetPlayerName .. " çš„é‡‘å¸ä¸º " .. newCoins)
    else
        ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, false, message or "ä¿®æ”¹å¤±è´¥")
    end
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–ç©å®¶è´­ä¹°è®°å½•
local function handleGetPlayerPurchaseHistory(player: Player, targetPlayerName: string)
    local session = getPlayerSession(player)
    if not session or not session.authenticated or not session.isAdmin then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•æŸ¥çœ‹ " .. targetPlayerName .. " çš„è´­ä¹°è®°å½•ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    -- æŸ¥æ‰¾ç›®æ ‡ç©å®¶çš„ID
    local targetUserId = nil
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer.Name == targetPlayerName then
            targetUserId = tostring(otherPlayer.UserId)
            break
        end
    end

    if not targetUserId then
        ShopEvents.RemoteEvents.GetPlayerPurchaseHistory:FireClient(player, targetPlayerName, nil, "ç©å®¶ä¸åœ¨çº¿")
        return
    end

    local transactionData = ShopData.getTransactions(targetUserId, 50, 0)
    if transactionData then
        local purchaseHistory = {}
        for _, transaction in ipairs(transactionData.transactions) do
            local action, totalCost, totalEarned = "", 0, 0

            if transaction.type == "buy" then
                action = "buy"
                totalCost = transaction.total_amount or 0
            elseif transaction.type == "sell" then
                action = "sell"
                totalEarned = transaction.total_amount or 0
            elseif transaction.type == "admin" then
                action = "admin_edit"
                -- å¯¹äºç®¡ç†å‘˜æ“ä½œï¼Œtotal_amount è¡¨ç¤ºé‡‘å¸å˜åŒ–é‡
                if transaction.total_amount and transaction.total_amount > 0 then
                    totalEarned = transaction.total_amount
                else
                    totalCost = math.abs(transaction.total_amount or 0)
                end
            else
                action = "unknown"
            end

            table.insert(purchaseHistory, {
                action = action,
                itemId = transaction.item_id,
                itemName = transaction.item_name,
                quantity = transaction.quantity,
                totalCost = totalCost,
                totalEarned = totalEarned,
                timestamp = transaction.created_at,
                balanceAfter = transaction.coins_after
            })
        end

        ShopEvents.RemoteEvents.GetPlayerPurchaseHistory:FireClient(player, targetPlayerName, purchaseHistory)
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº† " .. targetPlayerName .. " çš„è´­ä¹°è®°å½•")
    end
end

-- ç©å®¶åŠ å…¥æ¸¸æˆæ—¶
local function onPlayerAdded(player: Player)
    print("ğŸ‘¤ [åŠ å…¥] " .. player.Name .. " å·²è¿æ¥åˆ°å•†åº—æœåŠ¡å™¨")

    -- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿å®¢æˆ·ç«¯å‡†å¤‡å¥½
    wait(2)

    -- è®¤è¯ç©å®¶
    if authenticatePlayer(player) then
        local session = getPlayerSession(player)
        print("ğŸ“Š [æ•°æ®] " .. player.Name .. " | é‡‘å¸: " .. (session.userData.coins or 0))

        -- æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
        if session.isAdmin then
            print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " å·²è·å¾—å•†åº—ç®¡ç†æƒé™")
        end
    else
        warn("âš ï¸ [è­¦å‘Š] " .. player.Name .. " æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨")
    end
end

-- ç©å®¶ç¦»å¼€æ¸¸æˆæ—¶
local function onPlayerRemoving(player: Player)
    print("ğŸ‘‹ [ç¦»å¼€] " .. player.Name .. " å·²æ–­å¼€è¿æ¥")
    -- æ¸…é™¤ä¼šè¯æ•°æ®
    playerSessions[player] = nil
end

-- è¿æ¥è¿œç¨‹äº‹ä»¶
ShopEvents.RemoteEvents.GetPlayerData.OnServerEvent:Connect(handleGetPlayerData)
ShopEvents.RemoteEvents.GetShopData.OnServerEvent:Connect(handleGetShopData)
ShopEvents.RemoteEvents.RefreshShopData.OnServerEvent:Connect(handleRefreshShopData)
ShopEvents.RemoteEvents.PurchaseItem.OnServerEvent:Connect(handlePurchaseItem)
ShopEvents.RemoteEvents.SellItem.OnServerEvent:Connect(handleSellItem)

-- ç®¡ç†å‘˜åŠŸèƒ½äº‹ä»¶
ShopEvents.RemoteEvents.GetAllPlayersData.OnServerEvent:Connect(handleGetAllPlayersData)
ShopEvents.RemoteEvents.SetPlayerCoins.OnServerEvent:Connect(handleSetPlayerCoins)
ShopEvents.RemoteEvents.GetPlayerPurchaseHistory.OnServerEvent:Connect(handleGetPlayerPurchaseHistory)

-- è¿æ¥ç©å®¶äº‹ä»¶
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- å¤„ç†å·²ç»åœ¨æ¸¸æˆä¸­çš„ç©å®¶
for _, player in pairs(Players:GetPlayers()) do
    spawn(function()
        onPlayerAdded(player)
    end)
end

print("âœ… å•†åº—æœåŠ¡ç«¯å·²å¯åŠ¨ (APIæ¨¡å¼)")
print("ğŸŒ APIæœåŠ¡å™¨: " .. (ShopData and "å·²è¿æ¥" or "æœªè¿æ¥"))
print("ğŸ›’ æ”¯æŒè´­ä¹°å’Œå–å‡ºåŠŸèƒ½")
print("ğŸ“Š æ•°æ®å­˜å‚¨åœ¨MySQLæ•°æ®åº“ä¸­")

-- è¿”å›trueè¡¨ç¤ºå¯åŠ¨æˆåŠŸ
return true