-- å•†åº—ç³»ç»ŸæœåŠ¡ç«¯é€»è¾‘

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ç­‰å¾…å…±äº«æ¨¡å—ï¼ˆç”±Bootstrapè„šæœ¬è®¾ç½®ï¼‰
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local ShopData = require(SharedModules:WaitForChild("ShopData"))
local ShopEvents = require(SharedModules:WaitForChild("ShopEvents"))
local DataManager = require(script:WaitForChild("DataManager"))

-- å•†åº—åº“å­˜ç®¡ç†
local shopInventory = {}
local shopItems = ShopData.SHOP_ITEMS or {}
for itemId, item in pairs(shopItems) do
    shopInventory[itemId] = {
        available = item.maxQuantity or math.huge,
        maxQuantity = item.maxQuantity
    }
end

-- ç®¡ç†å‘˜åˆ—è¡¨ (å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹)
-- ğŸ’¡ å¦‚ä½•è®¾ç½®ç®¡ç†å‘˜:
-- 1. è·å–ç©å®¶çš„ UserId: åœ¨æ¸¸æˆä¸­è¾“å…¥ print(Players.LocalPlayer.UserId)
-- 2. å°† UserId æ·»åŠ åˆ°ä¸‹é¢çš„åˆ—è¡¨ä¸­
-- 3. æˆ–è€…ç›´æ¥ä½¿ç”¨ç”¨æˆ·å (ä¸æ¨èï¼Œå› ä¸ºç”¨æˆ·åå¯èƒ½ä¼šæ”¹å˜)
local ADMIN_USER_IDS = {
    -- åœ¨è¿™é‡Œæ·»åŠ ç®¡ç†å‘˜çš„ UserId
    -- ç¤ºä¾‹: 123456789, 987654321
}

-- ç®¡ç†å‘˜ç”¨æˆ·ååˆ—è¡¨ (å¤‡é€‰æ–¹æ¡ˆï¼Œä¸æ¨è)
local ADMIN_USERNAMES = {
    -- åœ¨è¿™é‡Œæ·»åŠ ç®¡ç†å‘˜çš„ç”¨æˆ·å
    -- ç¤ºä¾‹: "YourUsername", "AdminName"
}

-- æ£€æŸ¥ç©å®¶æ˜¯å¦ä¸ºç®¡ç†å‘˜
local function isPlayerAdmin(player)
    -- æ–¹æ³•1: æ£€æŸ¥ UserId
    for _, adminId in pairs(ADMIN_USER_IDS) do
        if player.UserId == adminId then
            return true
        end
    end

    -- æ–¹æ³•2: æ£€æŸ¥ç”¨æˆ·å
    for _, adminName in pairs(ADMIN_USERNAMES) do
        if player.Name == adminName then
            return true
        end
    end

    -- æ–¹æ³•3: æ£€æŸ¥å¼€å‘è€…æƒé™ (æ¸¸æˆåˆ›å»ºè€…)
    if player.UserId == game.CreatorId then
        return true
    end

    -- æ–¹æ³•4: æ£€æŸ¥ Roblox ç®¡ç†å‘˜
    if player:GetRankInGroup(1) >= 100 then -- Roblox å‘˜å·¥ç»„
        return true
    end

    return false
end

print("ğŸª å•†åº—ç³»ç»Ÿå·²åˆå§‹åŒ–")
print("ğŸ“¦ åº“å­˜æ¦‚è§ˆ:")
for itemId, inventory in pairs(shopInventory) do
    local item = ShopData.SHOP_ITEMS[itemId]
    if item then
        local stockText = inventory.available == math.huge and "æ— é™" or tostring(inventory.available)
        print("  ğŸ“¦ " .. item.name .. " (" .. itemId .. "): " .. stockText)
    end
end

-- è·å–ç©å®¶æ•°æ®
local function getPlayerData(player: Player)
    local data = DataManager.getPlayerData(player)
    if not data then
        -- åˆ›å»ºé»˜è®¤ç©å®¶æ•°æ®
        local defaultData = {
            coins = 3000,
            inventory = {},
            stats = {
                totalPurchases = 0,
                totalSales = 0,
                totalSpent = 0,
                totalEarned = 0
            }
        }
        data = DataManager.loadPlayerData(player, defaultData)
    end
    return data
end

-- æ›´æ–°ç©å®¶æ•°æ®å¹¶ä¿å­˜
local function updatePlayerData(player: Player, newData)
    DataManager.setPlayerData(player, newData)
    -- ç«‹å³ä¿å­˜ä»¥ç¡®ä¿æ•°æ®æŒä¹…åŒ–
    DataManager.savePlayerData(player)
end

-- å¤„ç†è·å–ç©å®¶æ•°æ®è¯·æ±‚
local function handleGetPlayerData(player: Player)
    local playerData = getPlayerData(player)
    ShopEvents.RemoteEvents.GetPlayerData:FireClient(player, playerData)
end

-- å¤„ç†è·å–å•†åº—æ•°æ®è¯·æ±‚
local function handleGetShopData(player: Player)
    -- åˆ›å»ºåŒ…å«å®æ—¶åº“å­˜çš„å•†åº—æ•°æ®
    local shopData = {}
    for itemId, item in pairs(ShopData.SHOP_ITEMS) do
        local itemData = {}
        -- å¤åˆ¶æ‰€æœ‰ç‰©å“å±æ€§
        for key, value in pairs(item) do
            itemData[key] = value
        end
        -- æ·»åŠ å®æ—¶åº“å­˜ä¿¡æ¯
        if shopInventory[itemId] then
            itemData.currentStock = shopInventory[itemId].available
        else
            itemData.currentStock = item.maxQuantity or -1
        end
        shopData[itemId] = itemData
    end

    ShopEvents.RemoteEvents.GetShopData:FireClient(player, shopData)
end

-- å¹¿æ’­å•†åº—æ•°æ®ç»™æ‰€æœ‰ç©å®¶
local function broadcastShopData()
    -- åˆ›å»ºåŒ…å«å®æ—¶åº“å­˜çš„å•†åº—æ•°æ®
    local shopData = {}
    for itemId, item in pairs(ShopData.SHOP_ITEMS) do
        local itemData = {}
        -- å¤åˆ¶æ‰€æœ‰ç‰©å“å±æ€§
        for key, value in pairs(item) do
            itemData[key] = value
        end
        -- æ·»åŠ å½“å‰åº“å­˜ä¿¡æ¯
        if shopInventory[itemId] then
            itemData.currentStock = shopInventory[itemId].available
        else
            itemData.currentStock = item.maxQuantity or -1
        end
        shopData[itemId] = itemData
    end

    -- å‘é€ç»™æ‰€æœ‰ç©å®¶
    for _, player in pairs(Players:GetPlayers()) do
        ShopEvents.RemoteEvents.GetShopData:FireClient(player, shopData)
    end

    print("ğŸ“¡ [å¹¿æ’­] å•†åº—æ•°æ®å·²æ›´æ–°ç»™æ‰€æœ‰ç©å®¶")
end

-- å¤„ç†è´­ä¹°ç‰©å“
local function handlePurchaseItem(player: Player, itemId: string, quantity: number)
    local playerData = getPlayerData(player)
    local item = ShopData.SHOP_ITEMS[itemId]

    if not item then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "ç‰©å“ä¸å­˜åœ¨", playerData)
        return
    end

    -- éªŒè¯æ•°é‡
    if quantity <= 0 then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "æ•°é‡å¿…é¡»å¤§äº0", playerData)
        return
    end

    -- æ£€æŸ¥åº“å­˜
    if item.maxQuantity ~= nil and item.maxQuantity ~= -1 and shopInventory[itemId].available < quantity then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "å•†åº—åº“å­˜ä¸è¶³", playerData)
        return
    end

    -- æ£€æŸ¥é‡‘å¸
    local totalCost = item.price * quantity
    if playerData.coins < totalCost then
        ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, false, "é‡‘å¸ä¸è¶³ï¼Œéœ€è¦ " .. totalCost .. " é‡‘å¸", playerData)
        return
    end

    -- æ‰§è¡Œè´­ä¹°
    playerData.coins = playerData.coins - totalCost

    -- æ›´æ–°ç©å®¶åº“å­˜
    if not playerData.inventory[itemId] then
        playerData.inventory[itemId] = 0
    end
    playerData.inventory[itemId] = playerData.inventory[itemId] + quantity

    -- æ›´æ–°å•†åº—åº“å­˜
    if item.maxQuantity ~= nil and item.maxQuantity ~= -1 then
        shopInventory[itemId].available = shopInventory[itemId].available - quantity
        if shopInventory[itemId].available < 0 then
            shopInventory[itemId].available = 0
        end
    end

    -- æ›´æ–°ç»Ÿè®¡æ•°æ®
    playerData.stats.totalPurchases = playerData.stats.totalPurchases + quantity
    playerData.stats.totalSpent = playerData.stats.totalSpent + totalCost

    -- è®°å½•äº¤æ˜“å†å²
    if not playerData.purchaseHistory then
        playerData.purchaseHistory = {}
    end

    local record = {
        action = "buy",
        itemId = itemId,
        itemName = item.name,
        quantity = quantity,
        totalCost = totalCost,
        timestamp = os.date("%Y-%m-%d %H:%M:%S"),
        balanceAfter = playerData.coins
    }

    table.insert(playerData.purchaseHistory, 1, record) -- æ’å…¥åˆ°å¼€å¤´ï¼Œæœ€æ–°çš„åœ¨å‰é¢

    -- é™åˆ¶è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘50æ¡
    if #playerData.purchaseHistory > 50 then
        table.remove(playerData.purchaseHistory, #playerData.purchaseHistory)
    end

    -- ä¿å­˜æ•°æ®
    updatePlayerData(player, playerData)

    -- é€šçŸ¥æ‰€æœ‰ç©å®¶æ›´æ–°å•†åº—æ•°æ®ï¼ˆå¦‚æœå•†åº—åº“å­˜å‘ç”Ÿå˜åŒ–ï¼‰
    if item.maxQuantity ~= nil and item.maxQuantity ~= -1 then
        broadcastShopData()
    end

    local message = "æˆåŠŸè´­ä¹° " .. quantity .. " ä¸ª " .. item.name .. "ï¼ŒèŠ±è´¹ " .. totalCost .. " é‡‘å¸"
    ShopEvents.RemoteEvents.PurchaseItem:FireClient(player, true, message, playerData)
    print("ğŸ›’ [è´­ä¹°] " .. player.Name .. " è´­ä¹°äº† " .. item.name .. " x" .. quantity .. " | æ€»ä»·: " .. totalCost .. " é‡‘å¸ | ä½™é¢: " .. playerData.coins)
end

-- å¤„ç†å–å‡ºç‰©å“
local function handleSellItem(player: Player, itemId: string, quantity: number)
    local playerData = getPlayerData(player)
    local item = ShopData.SHOP_ITEMS[itemId]

    if not item then
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, "ç‰©å“ä¸å­˜åœ¨", playerData)
        return
    end

    -- éªŒè¯æ•°é‡
    if quantity <= 0 then
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, "æ•°é‡å¿…é¡»å¤§äº0", playerData)
        return
    end

    -- æ£€æŸ¥ç©å®¶æ˜¯å¦æ‹¥æœ‰è¶³å¤Ÿçš„ç‰©å“
    local ownedQuantity = playerData.inventory[itemId] or 0
    if ownedQuantity < quantity then
        ShopEvents.RemoteEvents.SellItem:FireClient(player, false, "ç‰©å“æ•°é‡ä¸è¶³ï¼Œä½ åªæœ‰ " .. ownedQuantity .. " ä¸ª", playerData)
        return
    end

    -- è®¡ç®—å–å‡ºä»·æ ¼ï¼ˆ80%å›æ”¶ä»·ï¼‰
    local sellPrice = math.floor(item.price * 0.8)
    local totalEarned = sellPrice * quantity

    -- æ‰§è¡Œå–å‡º
    playerData.inventory[itemId] = playerData.inventory[itemId] - quantity
    if playerData.inventory[itemId] <= 0 then
        playerData.inventory[itemId] = nil
    end

    playerData.coins = playerData.coins + totalEarned

    -- æ›´æ–°å•†åº—åº“å­˜ï¼ˆå–å›å•†åº—ï¼‰
    if item.maxQuantity ~= nil and item.maxQuantity ~= -1 then
        shopInventory[itemId].available = shopInventory[itemId].available + quantity
        -- ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§åº“å­˜ï¼ˆå¦‚æœæœ‰è®¾ç½®ï¼‰
        if shopInventory[itemId].maxQuantity and shopInventory[itemId].available > shopInventory[itemId].maxQuantity then
            shopInventory[itemId].available = shopInventory[itemId].maxQuantity
        end
    end

    -- æ›´æ–°ç»Ÿè®¡æ•°æ®
    playerData.stats.totalSales = playerData.stats.totalSales + quantity
    playerData.stats.totalEarned = playerData.stats.totalEarned + totalEarned

    -- è®°å½•äº¤æ˜“å†å²
    if not playerData.purchaseHistory then
        playerData.purchaseHistory = {}
    end

    local record = {
        action = "sell",
        itemId = itemId,
        itemName = item.name,
        quantity = quantity,
        totalEarned = totalEarned,
        timestamp = os.date("%Y-%m-%d %H:%M:%S"),
        balanceAfter = playerData.coins
    }

    table.insert(playerData.purchaseHistory, 1, record) -- æ’å…¥åˆ°å¼€å¤´ï¼Œæœ€æ–°çš„åœ¨å‰é¢

    -- é™åˆ¶è®°å½•æ•°é‡ï¼Œåªä¿ç•™æœ€è¿‘50æ¡
    if #playerData.purchaseHistory > 50 then
        table.remove(playerData.purchaseHistory, #playerData.purchaseHistory)
    end

    -- ä¿å­˜æ•°æ®
    updatePlayerData(player, playerData)

    -- é€šçŸ¥æ‰€æœ‰ç©å®¶æ›´æ–°å•†åº—æ•°æ®ï¼ˆå¦‚æœå•†åº—åº“å­˜å‘ç”Ÿå˜åŒ–ï¼‰
    if item.maxQuantity ~= nil and item.maxQuantity ~= -1 then
        broadcastShopData()
    end

    local message = "æˆåŠŸå–å‡º " .. quantity .. " ä¸ª " .. item.name .. "ï¼Œè·å¾— " .. totalEarned .. " é‡‘å¸"
    ShopEvents.RemoteEvents.SellItem:FireClient(player, true, message, playerData)
    print("ğŸ’° [å–å‡º] " .. player.Name .. " å–å‡ºäº† " .. item.name .. " x" .. quantity .. " | æ”¶å…¥: " .. totalEarned .. " é‡‘å¸ | ä½™é¢: " .. playerData.coins)
end

-- ç©å®¶åŠ å…¥æ¸¸æˆæ—¶
local function onPlayerAdded(player: Player)
    print("ğŸ‘¤ [åŠ å…¥] " .. player.Name .. " å·²è¿æ¥åˆ°å•†åº—æœåŠ¡å™¨")

    -- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿å®¢æˆ·ç«¯å‡†å¤‡å¥½
    wait(2)

    -- åŠ è½½ç©å®¶æ•°æ®
    local playerData = getPlayerData(player)
    local itemCount = 0
    if playerData.inventory then
        for _, quantity in pairs(playerData.inventory) do
            itemCount = itemCount + quantity
        end
    end
    print("ğŸ“Š [æ•°æ®] " .. player.Name .. " | é‡‘å¸: " .. playerData.coins .. " | ç‰©å“æ€»æ•°: " .. itemCount)

    -- æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
    if isPlayerAdmin(player) then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " å·²è·å¾—å•†åº—ç®¡ç†æƒé™")
    end
end

-- ç©å®¶ç¦»å¼€æ¸¸æˆæ—¶
local function onPlayerRemoving(player: Player)
    print("ğŸ‘‹ [ç¦»å¼€] " .. player.Name .. " å·²æ–­å¼€è¿æ¥ï¼Œæ•°æ®å·²ä¿å­˜")
    -- DataManagerä¼šè‡ªåŠ¨å¤„ç†æ•°æ®ä¿å­˜
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–æ‰€æœ‰ç©å®¶æ•°æ®
local function handleGetAllPlayersData(player: Player)
    if not isPlayerAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–æ‰€æœ‰ç©å®¶æ•°æ®ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    local allPlayersData = {}
    for _, targetPlayer in pairs(Players:GetPlayers()) do
        local playerData = getPlayerData(targetPlayer)
        allPlayersData[targetPlayer.Name] = {
            userId = targetPlayer.UserId,
            name = targetPlayer.Name,
            coins = playerData.coins,
            totalPurchases = playerData.stats.totalPurchases,
            totalSpent = playerData.stats.totalSpent,
            totalSales = playerData.stats.totalSales,
            totalEarned = playerData.stats.totalEarned,
            inventoryCount = 0
        }

        -- è®¡ç®—åº“å­˜æ€»æ•°
        if playerData.inventory then
            for _, quantity in pairs(playerData.inventory) do
                allPlayersData[targetPlayer.Name].inventoryCount = allPlayersData[targetPlayer.Name].inventoryCount + quantity
            end
        end
    end

    ShopEvents.RemoteEvents.GetAllPlayersData:FireClient(player, allPlayersData)
    print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†æ‰€æœ‰ç©å®¶æ•°æ®")
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè®¾ç½®ç©å®¶é‡‘å¸
local function handleSetPlayerCoins(player: Player, targetPlayerName: string, newCoins: number)
    if not isPlayerAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•ä¿®æ”¹ " .. targetPlayerName .. " çš„é‡‘å¸ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    -- æŸ¥æ‰¾ç›®æ ‡ç©å®¶
    local targetPlayer = nil
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name == targetPlayerName then
            targetPlayer = p
            break
        end
    end

    if not targetPlayer then
        ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, false, "ç©å®¶ " .. targetPlayerName .. " ä¸åœ¨çº¿")
        return
    end

    -- éªŒè¯é‡‘å¸æ•°é‡
    if newCoins < 0 or newCoins > 999999 then
        ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, false, "é‡‘å¸æ•°é‡å¿…é¡»åœ¨ 0-999999 ä¹‹é—´")
        return
    end

    -- ä¿®æ”¹é‡‘å¸
    local targetPlayerData = getPlayerData(targetPlayer)
    local oldCoins = targetPlayerData.coins
    targetPlayerData.coins = newCoins

    -- è®°å½•ç®¡ç†å‘˜æ“ä½œ
    if not targetPlayerData.purchaseHistory then
        targetPlayerData.purchaseHistory = {}
    end

    local record = {
        action = "admin_edit",
        itemName = "é‡‘å¸ä¿®æ”¹",
        quantity = newCoins - oldCoins,
        totalCost = 0,
        totalEarned = newCoins - oldCoins,
        timestamp = os.date("%Y-%m-%d %H:%M:%S") .. " (ç®¡ç†å‘˜: " .. player.Name .. ")",
        balanceAfter = newCoins
    }

    table.insert(targetPlayerData.purchaseHistory, 1, record)

    -- ä¿å­˜æ•°æ®
    updatePlayerData(targetPlayer, targetPlayerData)

    -- é€šçŸ¥ç›®æ ‡ç©å®¶æ•°æ®æ›´æ–°
    ShopEvents.RemoteEvents.GetPlayerData:FireClient(targetPlayer, targetPlayerData)

    -- é€šçŸ¥ç®¡ç†å‘˜æ“ä½œæˆåŠŸ
    ShopEvents.RemoteEvents.SetPlayerCoins:FireClient(player, true, "æˆåŠŸå°† " .. targetPlayerName .. " çš„é‡‘å¸ä» " .. oldCoins .. " ä¿®æ”¹ä¸º " .. newCoins)

    print("ğŸ‘‘ [ç®¡ç†å‘˜æ“ä½œ] " .. player.Name .. " å°† " .. targetPlayerName .. " çš„é‡‘å¸ä» " .. oldCoins .. " ä¿®æ”¹ä¸º " .. newCoins)
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–ç©å®¶è´­ä¹°è®°å½•
local function handleGetPlayerPurchaseHistory(player: Player, targetPlayerName: string)
    if not isPlayerAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•æŸ¥çœ‹ " .. targetPlayerName .. " çš„è´­ä¹°è®°å½•ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    -- æŸ¥æ‰¾ç›®æ ‡ç©å®¶
    local targetPlayer = nil
    for _, p in pairs(Players:GetPlayers()) do
        if p.Name == targetPlayerName then
            targetPlayer = p
            break
        end
    end

    if not targetPlayer then
        ShopEvents.RemoteEvents.GetPlayerPurchaseHistory:FireClient(player, targetPlayerName, nil, "ç©å®¶ä¸åœ¨çº¿")
        return
    end

    local targetPlayerData = getPlayerData(targetPlayer)
    ShopEvents.RemoteEvents.GetPlayerPurchaseHistory:FireClient(player, targetPlayerName, targetPlayerData.purchaseHistory or {})
    print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº† " .. targetPlayerName .. " çš„è´­ä¹°è®°å½•")
end

-- è¿æ¥è¿œç¨‹äº‹ä»¶
ShopEvents.RemoteEvents.GetPlayerData.OnServerEvent:Connect(handleGetPlayerData)
ShopEvents.RemoteEvents.GetShopData.OnServerEvent:Connect(handleGetShopData)
ShopEvents.RemoteEvents.PurchaseItem.OnServerEvent:Connect(handlePurchaseItem)
ShopEvents.RemoteEvents.SellItem.OnServerEvent:Connect(handleSellItem)

-- ç®¡ç†å‘˜åŠŸèƒ½äº‹ä»¶
ShopEvents.RemoteEvents.GetAllPlayersData.OnServerEvent:Connect(handleGetAllPlayersData)
ShopEvents.RemoteEvents.SetPlayerCoins.OnServerEvent:Connect(handleSetPlayerCoins)
ShopEvents.RemoteEvents.GetPlayerPurchaseHistory.OnServerEvent:Connect(handleGetPlayerPurchaseHistory)

-- è¿æ¥ç©å®¶äº‹ä»¶
Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- å¤„ç†å·²ç»åœ¨æ¸¸æˆä¸­çš„ç©å®¶
for _, player in pairs(Players:GetPlayers()) do
    spawn(function()
        onPlayerAdded(player)
    end)
end

print("âœ… å•†åº—æœåŠ¡ç«¯å·²å¯åŠ¨")
print("ğŸ’¾ æ•°æ®æŒä¹…åŒ–: " .. (game:GetService("RunService"):IsStudio() and "Studioæ¨¡æ‹Ÿæ¨¡å¼" or "ç”Ÿäº§æ¨¡å¼"))
print("ğŸ›’ æ”¯æŒè´­ä¹°å’Œå–å‡ºåŠŸèƒ½")
print("ğŸ“Š åŒ…å«å®Œæ•´çš„ç©å®¶ç»Ÿè®¡æ•°æ®")

-- æœåŠ¡ç«¯GUIç•Œé¢ç³»ç»Ÿ
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- åˆ›å»ºæœåŠ¡ç«¯GUI
local function createServerGUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "ShopServerGUI"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = true

    -- ä¸»ç•Œé¢æ¡†æ¶
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(1, 0, 1, 0)
    mainFrame.Position = UDim2.new(0, 0, 0, 0)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    -- åˆ›å»ºæ ‡é¢˜æ 
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 60)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "TitleLabel"
    titleLabel.Text = "ğŸª å•†åº—æœåŠ¡å™¨ç®¡ç†ç•Œé¢"
    titleLabel.Font = Enum.Font.SourceSansBold
    titleLabel.TextSize = 24
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.Size = UDim2.new(0, 400, 1, 0)
    titleLabel.Position = UDim2.new(0, 20, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar

    -- çŠ¶æ€æ˜¾ç¤º
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Text = "ğŸŸ¢ æœåŠ¡å™¨è¿è¡Œä¸­"
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.TextSize = 16
    statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
    statusLabel.Size = UDim2.new(0, 200, 1, 0)
    statusLabel.Position = UDim2.new(1, -220, 0, 0)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextXAlignment = Enum.TextXAlignment.Right
    statusLabel.Parent = titleBar

    -- å¯¼èˆªæŒ‰é’®åŒºåŸŸ
    local navFrame = Instance.new("Frame")
    navFrame.Name = "NavFrame"
    navFrame.Size = UDim2.new(1, 0, 0, 50)
    navFrame.Position = UDim2.new(0, 0, 0, 60)
    navFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    navFrame.BorderSizePixel = 0
    navFrame.Parent = mainFrame

    -- å•†åº—æ¦‚è§ˆæŒ‰é’®
    local shopOverviewBtn = Instance.new("TextButton")
    shopOverviewBtn.Name = "ShopOverviewBtn"
    shopOverviewBtn.Text = "ğŸ“Š å•†åº—æ¦‚è§ˆ"
    shopOverviewBtn.Font = Enum.Font.SourceSansBold
    shopOverviewBtn.TextSize = 16
    shopOverviewBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    shopOverviewBtn.Size = UDim2.new(0, 150, 0, 40)
    shopOverviewBtn.Position = UDim2.new(0, 10, 0, 5)
    shopOverviewBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 200)
    shopOverviewBtn.BorderSizePixel = 0
    shopOverviewBtn.Parent = navFrame

    -- è´­ä¹°è®°å½•æŒ‰é’®
    local purchaseRecordsBtn = Instance.new("TextButton")
    purchaseRecordsBtn.Name = "PurchaseRecordsBtn"
    purchaseRecordsBtn.Text = "ğŸ“ è´­ä¹°è®°å½•"
    purchaseRecordsBtn.Font = Enum.Font.SourceSansBold
    purchaseRecordsBtn.TextSize = 16
    purchaseRecordsBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    purchaseRecordsBtn.Size = UDim2.new(0, 150, 0, 40)
    purchaseRecordsBtn.Position = UDim2.new(0, 170, 0, 5)
    purchaseRecordsBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 200)
    purchaseRecordsBtn.BorderSizePixel = 0
    purchaseRecordsBtn.Parent = navFrame

    -- å†…å®¹åŒºåŸŸ
    local contentFrame = Instance.new("ScrollingFrame")
    contentFrame.Name = "ContentFrame"
    contentFrame.Size = UDim2.new(1, 0, 1, -110)
    contentFrame.Position = UDim2.new(0, 0, 0, 110)
    contentFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    contentFrame.BorderSizePixel = 0
    contentFrame.ScrollBarThickness = 10
    contentFrame.CanvasSize = UDim2.new(0, 0, 2, 0)
    contentFrame.Parent = mainFrame

    return screenGui, contentFrame, shopOverviewBtn, purchaseRecordsBtn
end

-- æ˜¾ç¤ºå•†åº—æ¦‚è§ˆ
local function showShopOverview(contentFrame)
    contentFrame:ClearAllChildren()

    -- å•†åº—ç»Ÿè®¡
    local statsFrame = Instance.new("Frame")
    statsFrame.Name = "StatsFrame"
    statsFrame.Size = UDim2.new(1, -20, 0, 200)
    statsFrame.Position = UDim2.new(0, 10, 0, 10)
    statsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    statsFrame.BorderSizePixel = 0
    statsFrame.Parent = contentFrame

    local statsTitle = Instance.new("TextLabel")
    statsTitle.Text = "ğŸ“Š å•†åº—ç»Ÿè®¡ä¿¡æ¯"
    statsTitle.Font = Enum.Font.SourceSansBold
    statsTitle.TextSize = 20
    statsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    statsTitle.Size = UDim2.new(1, 0, 0, 40)
    statsTitle.Position = UDim2.new(0, 0, 0, 0)
    statsTitle.BackgroundTransparency = 1
    statsTitle.TextXAlignment = Enum.TextXAlignment.Center
    statsTitle.Parent = statsFrame

    -- å•†å“åº“å­˜åˆ—è¡¨
    local inventoryFrame = Instance.new("Frame")
    inventoryFrame.Name = "InventoryFrame"
    inventoryFrame.Size = UDim2.new(1, -20, 1, -220)
    inventoryFrame.Position = UDim2.new(0, 10, 0, 220)
    inventoryFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    inventoryFrame.BorderSizePixel = 0
    inventoryFrame.Parent = contentFrame

    local inventoryTitle = Instance.new("TextLabel")
    inventoryTitle.Text = "ğŸ“¦ å•†å“åº“å­˜"
    inventoryTitle.Font = Enum.Font.SourceSansBold
    inventoryTitle.TextSize = 18
    inventoryTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    inventoryTitle.Size = UDim2.new(1, 0, 0, 40)
    inventoryTitle.Position = UDim2.new(0, 0, 0, 0)
    inventoryTitle.BackgroundTransparency = 1
    inventoryTitle.TextXAlignment = Enum.TextXAlignment.Center
    inventoryTitle.Parent = inventoryFrame

    -- æ˜¾ç¤ºæ¯ä¸ªå•†å“çš„åº“å­˜ä¿¡æ¯
    local yOffset = 50
    for itemId, inventory in pairs(shopInventory) do
        local item = ShopData.SHOP_ITEMS[itemId]
        if item then
            local itemFrame = Instance.new("Frame")
            itemFrame.Size = UDim2.new(1, -20, 0, 30)
            itemFrame.Position = UDim2.new(0, 10, 0, yOffset)
            itemFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
            itemFrame.BorderSizePixel = 0
            itemFrame.Parent = inventoryFrame

            local itemLabel = Instance.new("TextLabel")
            itemLabel.Text = item.icon .. " " .. item.name
            itemLabel.Font = Enum.Font.SourceSans
            itemLabel.TextSize = 14
            itemLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            itemLabel.Size = UDim2.new(0.3, 0, 1, 0)
            itemLabel.Position = UDim2.new(0, 10, 0, 0)
            itemLabel.BackgroundTransparency = 1
            itemLabel.TextXAlignment = Enum.TextXAlignment.Left
            itemLabel.Parent = itemFrame

            local priceLabel = Instance.new("TextLabel")
            priceLabel.Text = "ğŸ’° " .. item.price
            priceLabel.Font = Enum.Font.SourceSans
            priceLabel.TextSize = 14
            priceLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            priceLabel.Size = UDim2.new(0.2, 0, 1, 0)
            priceLabel.Position = UDim2.new(0.3, 0, 0, 0)
            priceLabel.BackgroundTransparency = 1
            priceLabel.TextXAlignment = Enum.TextXAlignment.Center
            priceLabel.Parent = itemFrame

            local stockLabel = Instance.new("TextLabel")
            local stockText = inventory.available == math.huge and "æ— é™" or tostring(inventory.available)
            stockLabel.Text = "åº“å­˜: " .. stockText
            stockLabel.Font = Enum.Font.SourceSans
            stockLabel.TextSize = 14
            stockLabel.TextColor3 = inventory.available == math.huge and Color3.fromRGB(100, 255, 100) or
                                  (inventory.available > 10 and Color3.fromRGB(200, 255, 200) or Color3.fromRGB(255, 100, 100))
            stockLabel.Size = UDim2.new(0.3, 0, 1, 0)
            stockLabel.Position = UDim2.new(0.5, 0, 0, 0)
            stockLabel.BackgroundTransparency = 1
            stockLabel.TextXAlignment = Enum.TextXAlignment.Center
            stockLabel.Parent = itemFrame

            yOffset = yOffset + 40
        end
    end
end

-- æ˜¾ç¤ºè´­ä¹°è®°å½•
local function showPurchaseRecords(contentFrame)
    contentFrame:ClearAllChildren()

    local recordsFrame = Instance.new("Frame")
    recordsFrame.Name = "RecordsFrame"
    recordsFrame.Size = UDim2.new(1, -20, 1, -20)
    recordsFrame.Position = UDim2.new(0, 10, 0, 10)
    recordsFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    recordsFrame.BorderSizePixel = 0
    recordsFrame.Parent = contentFrame

    local recordsTitle = Instance.new("TextLabel")
    recordsTitle.Text = "ğŸ“ ç©å®¶äº¤æ˜“è®°å½•"
    recordsTitle.Font = Enum.Font.SourceSansBold
    recordsTitle.TextSize = 20
    recordsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    recordsTitle.Size = UDim2.new(1, 0, 0, 40)
    recordsTitle.Position = UDim2.new(0, 0, 0, 0)
    recordsTitle.BackgroundTransparency = 1
    recordsTitle.TextXAlignment = Enum.TextXAlignment.Center
    recordsTitle.Parent = recordsFrame

    -- æ˜¾ç¤ºåœ¨çº¿ç©å®¶ç»Ÿè®¡
    local yOffset = 50
    for _, player in pairs(Players:GetPlayers()) do
        local playerData = getPlayerData(player)
        if playerData then
            local playerFrame = Instance.new("Frame")
            playerFrame.Size = UDim2.new(1, -20, 0, 100)
            playerFrame.Position = UDim2.new(0, 10, 0, yOffset)
            playerFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
            playerFrame.BorderSizePixel = 0
            playerFrame.Parent = recordsFrame

            local playerLabel = Instance.new("TextLabel")
            playerLabel.Text = "ğŸ‘¤ " .. player.Name
            playerLabel.Font = Enum.Font.SourceSansBold
            playerLabel.TextSize = 16
            playerLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            playerLabel.Size = UDim2.new(1, 0, 0, 25)
            playerLabel.Position = UDim2.new(0, 10, 0, 5)
            playerLabel.BackgroundTransparency = 1
            playerLabel.TextXAlignment = Enum.TextXAlignment.Left
            playerLabel.Parent = playerFrame

            local statsText = string.format(
                "ğŸ’° é‡‘å¸: %d | ğŸ›’ è´­ä¹°æ¬¡æ•°: %d | ğŸ’° æ€»æ”¯å‡º: %d | ğŸ“¦ æ€»æ”¶å…¥: %d",
                playerData.coins,
                playerData.stats.totalPurchases,
                playerData.stats.totalSpent,
                playerData.stats.totalEarned
            )

            local statsLabel = Instance.new("TextLabel")
            statsLabel.Text = statsText
            statsLabel.Font = Enum.Font.SourceSans
            statsLabel.TextSize = 12
            statsLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            statsLabel.Size = UDim2.new(1, -20, 0, 60)
            statsLabel.Position = UDim2.new(0, 10, 0, 30)
            statsLabel.BackgroundTransparency = 1
            statsLabel.TextXAlignment = Enum.TextXAlignment.Left
            statsLabel.TextWrapped = true
            statsLabel.Parent = playerFrame

            yOffset = yOffset + 110
        end
    end
end

-- ä¸ºç‰¹å®šç©å®¶åˆå§‹åŒ–æœåŠ¡ç«¯GUI
local function initServerGUIForPlayer(player)
    if not isPlayerAdmin(player) then
        return -- ä¸æ˜¯ç®¡ç†å‘˜ï¼Œä¸åˆ›å»ºGUI
    end

    local screenGui, contentFrame, shopOverviewBtn, purchaseRecordsBtn = createServerGUI()

    -- é»˜è®¤æ˜¾ç¤ºå•†åº—æ¦‚è§ˆ
    showShopOverview(contentFrame)

    -- æŒ‰é’®äº‹ä»¶
    shopOverviewBtn.MouseButton1Click:Connect(function()
        shopOverviewBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 200)
        purchaseRecordsBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 200)
        showShopOverview(contentFrame)
    end)

    purchaseRecordsBtn.MouseButton1Click:Connect(function()
        purchaseRecordsBtn.BackgroundColor3 = Color3.fromRGB(50, 100, 200)
        shopOverviewBtn.BackgroundColor3 = Color3.fromRGB(100, 50, 200)
        showPurchaseRecords(contentFrame)
    end)

    -- å°†GUIæ·»åŠ åˆ°è¯¥ç©å®¶çš„PlayerGui
    screenGui.Parent = player:WaitForChild("PlayerGui")

    print("ğŸ–¥ï¸ [æœåŠ¡ç«¯GUI] ä¸ºç®¡ç†å‘˜ " .. player.Name .. " åˆ›å»ºå•†åº—ç®¡ç†ç•Œé¢")
end

-- å½“ç©å®¶åŠ å…¥æ—¶æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜å¹¶åˆ›å»ºGUI
local function checkAndCreateAdminGUI(player)
    -- ç­‰å¾…ç©å®¶å®Œå…¨åŠ è½½
    wait(2)

    if isPlayerAdmin(player) then
        initServerGUIForPlayer(player)
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " å·²è·å¾—å•†åº—ç®¡ç†æƒé™")
    end
end

-- è¿”å›trueè¡¨ç¤ºå¯åŠ¨æˆåŠŸ
return true