-- æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨

local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local DataManager = {}

-- æ•°æ®å­˜å‚¨é…ç½®
local DATA_STORE_NAME = "PlayerShopData"
local SAVE_INTERVAL = 30 -- æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡

-- æ£€æµ‹æ˜¯å¦åœ¨Studioç¯å¢ƒä¸­
local isStudio = RunService:IsStudio()
local playerDataStore = nil
local mockDataStore = {} -- Studioç¯å¢ƒä¸­çš„æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨

if isStudio then
    print("âš ï¸ æ£€æµ‹åˆ°Studioç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨")
else
    playerDataStore = DataStoreService:GetDataStore(DATA_STORE_NAME)
end

-- ç©å®¶æ•°æ®ç¼“å­˜
local playerDataCache = {}
local lastSaveTime = {}

-- è·å–ç©å®¶æ•°æ®
function DataManager.getPlayerData(player: Player)
    if playerDataCache[player.UserId] then
        return playerDataCache[player.UserId]
    end
    return nil
end

-- è®¾ç½®ç©å®¶æ•°æ®
function DataManager.setPlayerData(player: Player, data)
    playerDataCache[player.UserId] = data
    lastSaveTime[player.UserId] = tick()
end

-- ä»æ•°æ®å­˜å‚¨åŠ è½½ç©å®¶æ•°æ®
function DataManager.loadPlayerData(player: Player, defaultData)
    local success, data = false, nil

    if isStudio then
        -- Studioç¯å¢ƒï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨
        data = mockDataStore[tostring(player.UserId)]
        success = true
    else
        -- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨çœŸå®æ•°æ®å­˜å‚¨
        success, data = pcall(function()
            return playerDataStore:GetAsync(tostring(player.UserId))
        end)
    end

    if success and data then
        playerDataCache[player.UserId] = data
        print("âœ… æˆåŠŸåŠ è½½ç©å®¶ " .. player.Name .. " çš„æ•°æ®")
    else
        playerDataCache[player.UserId] = defaultData
        print("ğŸ“ ä¸ºç©å®¶ " .. player.Name .. " åˆ›å»ºæ–°æ•°æ®")
    end

    lastSaveTime[player.UserId] = tick()
    return playerDataCache[player.UserId]
end

-- ä¿å­˜ç©å®¶æ•°æ®åˆ°æ•°æ®å­˜å‚¨
function DataManager.savePlayerData(player: Player)
    if not playerDataCache[player.UserId] then
        return false
    end

    local success, error = false, nil

    if isStudio then
        -- Studioç¯å¢ƒï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨
        mockDataStore[tostring(player.UserId)] = playerDataCache[player.UserId]
        success = true
    else
        -- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨çœŸå®æ•°æ®å­˜å‚¨
        success, error = pcall(function()
            playerDataStore:SetAsync(tostring(player.UserId), playerDataCache[player.UserId])
        end)
    end

    if success then
        print("ğŸ’¾ æˆåŠŸä¿å­˜ç©å®¶ " .. player.Name .. " çš„æ•°æ®")
        return true
    else
        warn("âŒ ä¿å­˜ç©å®¶ " .. player.Name .. " æ•°æ®å¤±è´¥: " .. tostring(error))
        return false
    end
end

-- å¼ºåˆ¶ä¿å­˜æ‰€æœ‰ç©å®¶æ•°æ®
function DataManager.saveAllPlayerData()
    for userId, data in pairs(playerDataCache) do
        local player = Players:GetPlayerByUserId(userId)
        if player then
            DataManager.savePlayerData(player)
        end
    end
end

-- æ¸…ç†ç©å®¶æ•°æ®ç¼“å­˜
function DataManager.clearPlayerData(player: Player)
    if playerDataCache[player.UserId] then
        DataManager.savePlayerData(player)
        playerDataCache[player.UserId] = nil
        lastSaveTime[player.UserId] = nil
    end
end

-- è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ
local function startAutoSave()
    spawn(function()
        while true do
            wait(SAVE_INTERVAL)

            local currentTime = tick()
            for userId, lastSave in pairs(lastSaveTime) do
                if currentTime - lastSave >= SAVE_INTERVAL then
                    local player = Players:GetPlayerByUserId(userId)
                    if player then
                        DataManager.savePlayerData(player)
                    end
                end
            end
        end
    end)
end

-- ç©å®¶ç¦»å¼€æ—¶ä¿å­˜æ•°æ®
Players.PlayerRemoving:Connect(function(player)
    DataManager.clearPlayerData(player)
end)

-- æ¸¸æˆå…³é—­æ—¶ä¿å­˜æ‰€æœ‰æ•°æ®
game:BindToClose(function()
    DataManager.saveAllPlayerData()
    wait(2) -- ç­‰å¾…ä¿å­˜å®Œæˆ
end)

-- å¯åŠ¨è‡ªåŠ¨ä¿å­˜
startAutoSave()


return DataManager
