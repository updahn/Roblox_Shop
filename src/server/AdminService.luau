--[[
ç®¡ç†å‘˜æƒé™æœåŠ¡
è´Ÿè´£å¤„ç†ç®¡ç†å‘˜æƒé™éªŒè¯å’Œé…ç½®ç®¡ç†
åªåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œï¼Œé€šè¿‡RemoteFunctionä¸ºå®¢æˆ·ç«¯æä¾›æƒé™æŸ¥è¯¢æœåŠ¡
--]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")

-- ç¡®ä¿åªåœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ
if not RunService:IsServer() then
    error("AdminService åªèƒ½åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œ")
end

local Config = require(ReplicatedStorage:WaitForChild("SharedModules"):WaitForChild("Config"))

local AdminService = {}

-- ç®¡ç†å‘˜é…ç½®ç¼“å­˜
local adminCache = {
    usernames = {},
    lastUpdate = 0,
    cacheDuration = 300 -- 5åˆ†é’Ÿç¼“å­˜
}

--[[
ä»APIåŠ è½½ç®¡ç†å‘˜é…ç½®
@return boolean - æ˜¯å¦æˆåŠŸåŠ è½½
--]]
local function loadAdminConfigFromAPI()
    local success, result = pcall(function()
        local response = HttpService:GetAsync(Config.getApiUrl("/config"))
        return HttpService:JSONDecode(response)
    end)

    if success and result and result.success then
        local adminConfig = result.data and result.data.admin
        if adminConfig and adminConfig.usernames then
            adminCache.usernames = adminConfig.usernames
            adminCache.lastUpdate = tick()

            Config.log("INFO", "ç®¡ç†å‘˜é…ç½®å·²ä»APIåŠ è½½", {
                usernames = adminConfig.usernames,
                count = #adminConfig.usernames
            })
            return true
        end
    else
        Config.log("ERROR", "åŠ è½½ç®¡ç†å‘˜é…ç½®å¤±è´¥", {
            success = success,
            result = result
        })
    end

    return false
end

--[[
ç¡®ä¿ç®¡ç†å‘˜é…ç½®å·²åŠ è½½
@return boolean - é…ç½®æ˜¯å¦å¯ç”¨
--]]
local function ensureAdminConfigLoaded()
    local currentTime = tick()

    -- å¦‚æœç¼“å­˜è¿‡æœŸæˆ–ä¸ºç©ºï¼Œå°è¯•é‡æ–°åŠ è½½
    if currentTime - adminCache.lastUpdate > adminCache.cacheDuration or #adminCache.usernames == 0 then
        print("ğŸ”„ [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®ç¼“å­˜è¿‡æœŸï¼Œå°è¯•é‡æ–°åŠ è½½")
        if loadAdminConfigFromAPI() then
            print("âœ… [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®é‡æ–°åŠ è½½æˆåŠŸ")
        else
            print("âŒ [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®é‡æ–°åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰ç¼“å­˜")
        end
    end

    return #adminCache.usernames > 0
end

--[[
æœ¬åœ°æ£€æŸ¥ç©å®¶æ˜¯å¦ä¸ºç®¡ç†å‘˜
@param player Player - ç©å®¶å¯¹è±¡
@return boolean - æ˜¯å¦ä¸ºç®¡ç†å‘˜
--]]
function AdminService.isPlayerAdminLocal(player)
    if not player or not player.Name then
        return false
    end

    -- ç¡®ä¿é…ç½®å·²åŠ è½½
    if not ensureAdminConfigLoaded() then
        print("âš ï¸ [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®æœªåŠ è½½ï¼Œæ— æ³•è¿›è¡Œæœ¬åœ°æ£€æŸ¥")
        return false
    end

    -- æ£€æŸ¥ç©å®¶åæ˜¯å¦åœ¨ç®¡ç†å‘˜åˆ—è¡¨ä¸­
    for _, adminName in pairs(adminCache.usernames) do
        if player.Name == adminName then
            return true
        end
    end

    return false
end

--[[
æ£€æŸ¥ç©å®¶æ˜¯å¦ä¸ºç®¡ç†å‘˜
ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ£€æŸ¥ï¼Œé¿å…HTTPè¯·æ±‚é˜»å¡RemoteFunction
@param player Player - è¦æ£€æŸ¥çš„ç©å®¶
@return boolean - æ˜¯å¦ä¸ºç®¡ç†å‘˜
--]]
function AdminService.isPlayerAdmin(player)
    if not player or not player.UserId then
        return false
    end

    print("ğŸ” [è°ƒè¯•] æ£€æŸ¥ç®¡ç†å‘˜æƒé™:", player.Name)

    -- ç›´æ¥ä½¿ç”¨æœ¬åœ°æ£€æŸ¥ï¼Œé¿å…HTTPè¯·æ±‚é˜»å¡
    local isLocalAdmin = AdminService.isPlayerAdminLocal(player)
    if isLocalAdmin then
        print("âš¡ [è°ƒè¯•] " .. player.Name .. " é€šè¿‡æœ¬åœ°éªŒè¯ç¡®è®¤ä¸ºç®¡ç†å‘˜")
        return true
    end

    print("âŒ [è°ƒè¯•] " .. player.Name .. " ä¸æ˜¯ç®¡ç†å‘˜ï¼ˆæœ¬åœ°æ£€æŸ¥ï¼‰")
    return false
end

--[[
è·å–æ‰€æœ‰ç®¡ç†å‘˜ç”¨æˆ·ååˆ—è¡¨
@return table - ç®¡ç†å‘˜ç”¨æˆ·åæ•°ç»„
--]]
function AdminService.getAdminUsernames()
    ensureAdminConfigLoaded()
    return adminCache.usernames
end

--[[
æ‰‹åŠ¨åˆ·æ–°ç®¡ç†å‘˜é…ç½®ç¼“å­˜
@return boolean - æ˜¯å¦åˆ·æ–°æˆåŠŸ
--]]
function AdminService.refreshAdminCache()
    print("ğŸ”„ [è°ƒè¯•] æ‰‹åŠ¨åˆ·æ–°ç®¡ç†å‘˜é…ç½®ç¼“å­˜")
    adminCache.lastUpdate = 0 -- å¼ºåˆ¶è¿‡æœŸ
    return ensureAdminConfigLoaded()
end

--[[
å¼‚æ­¥åˆ·æ–°ç®¡ç†å‘˜é…ç½®ç¼“å­˜ï¼ˆä¸é˜»å¡è°ƒç”¨ï¼‰
--]]
function AdminService.refreshAdminCacheAsync(player)
    spawn(function()
        print("ğŸ”„ [è°ƒè¯•] å¼‚æ­¥åˆ·æ–°ç®¡ç†å‘˜é…ç½®ç¼“å­˜")
        AdminService.refreshAdminCache()

        -- é‡æ–°æ£€æŸ¥è¯¥ç©å®¶æƒé™
        if player and AdminService.isPlayerAdminLocal(player) then
            print("âœ… [è°ƒè¯•] å¼‚æ­¥æ›´æ–°åç¡®è®¤", player.Name, "ä¸ºç®¡ç†å‘˜")
        end
    end)
end

-- ä½¿ç”¨Eventsç³»ç»Ÿè¿›è¡Œæƒé™æŸ¥è¯¢
local Events = require(ReplicatedStorage:WaitForChild("SharedModules"):WaitForChild("ShopEvents"))

-- å¤„ç†å®¢æˆ·ç«¯çš„æƒé™æŸ¥è¯¢è¯·æ±‚
if Events.Admin.CheckPermission then
    Events.Admin.CheckPermission.OnServerInvoke = function(player)
        print("ğŸ”„ [è°ƒè¯•] æœåŠ¡ç«¯æ”¶åˆ°ç®¡ç†å‘˜æƒé™æŸ¥è¯¢è¯·æ±‚:", player.Name)

        -- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜è¿›è¡Œå¿«é€Ÿæ£€æŸ¥ï¼Œå®Œå…¨é¿å…HTTPè¯·æ±‚é˜»å¡RemoteFunction
        local success, result = pcall(function()
            -- ç¡®ä¿æœ¬åœ°ç¼“å­˜å·²åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•å¿«é€ŸåŠ è½½
            if #adminCache.usernames == 0 and tick() - adminCache.lastUpdate > 2 then
                -- ä½¿ç”¨éé˜»å¡æ–¹å¼å°è¯•å¿«é€ŸåŠ è½½
                spawn(function()
                    loadAdminConfigFromAPI()
                end)
            end

            return AdminService.isPlayerAdminLocal(player)
        end)

        if success then
            print("âœ… [è°ƒè¯•] æƒé™æŸ¥è¯¢å®Œæˆ:", player.Name, "ç»“æœ:", result)

            -- å¦‚æœæœ¬åœ°ç¼“å­˜ä¸ºç©ºæˆ–è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°ç¼“å­˜ï¼ˆä¸é˜»å¡å½“å‰è¯·æ±‚ï¼‰
            if #adminCache.usernames == 0 or tick() - adminCache.lastUpdate > adminCache.cacheDuration then
                spawn(function()
                    print("ğŸ”„ [è°ƒè¯•] å¼‚æ­¥åˆ·æ–°ç®¡ç†å‘˜é…ç½®ç¼“å­˜")
                    loadAdminConfigFromAPI()

                    -- é‡æ–°æ£€æŸ¥è¯¥ç©å®¶æƒé™
                    if AdminService.isPlayerAdminLocal(player) then
                        print("âœ… [è°ƒè¯•] å¼‚æ­¥æ›´æ–°åç¡®è®¤", player.Name, "ä¸ºç®¡ç†å‘˜")
                    end
                end)
            end

            return result
        else
            print("âŒ [è°ƒè¯•] æƒé™æŸ¥è¯¢å‡ºé”™:", player.Name, "é”™è¯¯:", result)
            -- å‡ºé”™æ—¶è¿”å›falseï¼Œä½†ä¸é˜»å¡
            return false
        end
    end
    print("âœ… [è°ƒè¯•] AdminService CheckPermission RemoteFunction å·²è¿æ¥")
else
    print("âŒ [è°ƒè¯•] è­¦å‘Š: CheckPermission RemoteFunction æœªæ‰¾åˆ°")
end

-- åˆå§‹åŒ–æ—¶é¢„åŠ è½½é…ç½®
spawn(function()
    wait(2) -- ç­‰å¾…æ¸¸æˆå®Œå…¨åŠ è½½
    print("ğŸš€ [è°ƒè¯•] å¼€å§‹åˆå§‹åŒ– AdminService...")

    -- å¤šæ¬¡å°è¯•åŠ è½½ç®¡ç†å‘˜é…ç½®
    local loadAttempts = 0
    local maxAttempts = 5

    while loadAttempts < maxAttempts do
        loadAttempts = loadAttempts + 1
        print("ğŸ”„ [è°ƒè¯•] å°è¯•åŠ è½½ç®¡ç†å‘˜é…ç½® (ç¬¬" .. loadAttempts .. "/" .. maxAttempts .. "æ¬¡)")

        if loadAdminConfigFromAPI() then
            print("âœ… [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®åŠ è½½æˆåŠŸï¼Œå½“å‰ç®¡ç†å‘˜åˆ—è¡¨:")
            for i, username in pairs(adminCache.usernames) do
                print("  " .. i .. ": " .. tostring(username))
            end
            break
        else
            print("âŒ [è°ƒè¯•] ç®¡ç†å‘˜é…ç½®åŠ è½½å¤±è´¥ï¼Œç­‰å¾…2ç§’åé‡è¯•...")
            wait(2)
        end
    end

    if #adminCache.usernames == 0 then
        print("âš ï¸ [è°ƒè¯•] æ— æ³•ä»APIåŠ è½½ç®¡ç†å‘˜é…ç½®ï¼Œå°†ä¾èµ–æ•°æ®åº“é¦–æ¬¡åˆ›å»ºç”¨æˆ·æ—¶çš„ç®¡ç†å‘˜è®¾ç½®")
    end

    print("ğŸš€ [è°ƒè¯•] AdminService åˆå§‹åŒ–å®Œæˆ")
end)

return AdminService