-- å•†å“åˆå§‹åŒ–æ¨¡å—
-- åŒ…å«æ‰€æœ‰æ¥è‡ª init.sql çš„å•†å“æ•°æ®

local DataStoreManager = require(script.Parent.Parent.data.DataStoreManager)

local ItemsInitializer = {}

-- æ ¹æ® init.sql å®šä¹‰çš„å®Œæ•´å•†å“æ•°æ®
local function getInitialItemsData()
    return {
        -- æ­¦å™¨ç±»
        ["sword_basic"] = {
            id = "sword_basic",
            name = "åŸºç¡€å‰‘",
            description = "ä¸€æŠŠæ™®é€šçš„é“å‰‘ï¼Œé€‚åˆæ–°æ‰‹ä½¿ç”¨ã€‚æ”»å‡»åŠ›+10",
            price = 100,
            sellPrice = 80,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "weapons",
            imageUrl = "rbxasset://textures/sword_basic.png",
            isActive = true,
            sortOrder = 1,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["sword_steel"] = {
            id = "sword_steel",
            name = "é’¢å‰‘",
            description = "é”»é€ ç²¾è‰¯çš„é’¢å‰‘ï¼Œæ¯”åŸºç¡€å‰‘æ›´åŠ é”‹åˆ©ã€‚æ”»å‡»åŠ›+25",
            price = 250,
            sellPrice = 200,
            maxQuantity = nil,
            currentStock = 10,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "weapons",
            imageUrl = "rbxasset://textures/sword_steel.png",
            isActive = true,
            sortOrder = 2,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["sword_enchanted"] = {
            id = "sword_enchanted",
            name = "é™„é­”å‰‘",
            description = "è¢«é­”æ³•åŠ›é‡åŠ æŒçš„å‰‘ï¼Œæ•£å‘ç€ç¥ç§˜å…‰èŠ’ã€‚æ”»å‡»åŠ›+50 (æ¯æ—¥é™è´­1ä»¶ï¼Œæ— æ³•å–å‡º)",
            price = 500,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "weapons",
            imageUrl = "rbxasset://textures/sword_enchanted.png",
            isActive = true,
            sortOrder = 3,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- é˜²å…·ç±»
        ["shield_wooden"] = {
            id = "shield_wooden",
            name = "æœ¨åˆ¶ç›¾ç‰Œ",
            description = "ç®€å•çš„æœ¨åˆ¶ç›¾ç‰Œï¼Œæä¾›åŸºç¡€é˜²æŠ¤ã€‚é˜²å¾¡åŠ›+5",
            price = 80,
            sellPrice = 64,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "armor",
            imageUrl = "rbxasset://textures/shield_wooden.png",
            isActive = true,
            sortOrder = 4,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["shield_iron"] = {
            id = "shield_iron",
            name = "é“åˆ¶ç›¾ç‰Œ",
            description = "åšå›ºçš„é“åˆ¶ç›¾ç‰Œï¼Œèƒ½å¤ŸæŠµæŒ¡æ›´å¼ºçš„æ”»å‡»ã€‚é˜²å¾¡åŠ›+15",
            price = 180,
            sellPrice = 144,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "armor",
            imageUrl = "rbxasset://textures/shield_iron.png",
            isActive = true,
            sortOrder = 5,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["armor_leather"] = {
            id = "armor_leather",
            name = "çš®ç”²",
            description = "è½»ä¾¿çš„çš®é©æŠ¤ç”²ï¼Œé€‚åˆå¿«é€Ÿç§»åŠ¨ã€‚é˜²å¾¡åŠ›+8",
            price = 150,
            sellPrice = 120,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "armor",
            imageUrl = "rbxasset://textures/armor_leather.png",
            isActive = true,
            sortOrder = 6,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["armor_chainmail"] = {
            id = "armor_chainmail",
            name = "é”å­ç”²",
            description = "é‡‘å±åˆ¶æˆçš„é˜²å…·ï¼Œæä¾›ä¼˜ç§€çš„ä¿æŠ¤ã€‚é˜²å¾¡åŠ›+20",
            price = 300,
            sellPrice = 240,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "armor",
            imageUrl = "rbxasset://textures/armor_chainmail.png",
            isActive = true,
            sortOrder = 7,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- æ¶ˆè€—å“ç±»
        ["potion_health"] = {
            id = "potion_health",
            name = "ç”Ÿå‘½è¯æ°´",
            description = "æ¢å¤50ç‚¹ç”Ÿå‘½å€¼çš„è¯æ°´ï¼Œæˆ˜æ–—å¿…å¤‡ (æ¯æ—¥é™è´­5ç“¶)",
            price = 50,
            sellPrice = 40,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 5,
            canSell = true,
            category = "consumables",
            imageUrl = "rbxasset://textures/potion_health.png",
            isActive = true,
            sortOrder = 8,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["potion_mana"] = {
            id = "potion_mana",
            name = "é­”æ³•è¯æ°´",
            description = "æ¢å¤30ç‚¹é­”æ³•å€¼çš„è¯æ°´ï¼Œæ–½æ³•è€…å¿…å¤‡ (æ¯æ—¥é™è´­5ç“¶)",
            price = 60,
            sellPrice = 48,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 5,
            canSell = true,
            category = "consumables",
            imageUrl = "rbxasset://textures/potion_mana.png",
            isActive = true,
            sortOrder = 9,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["potion_strength"] = {
            id = "potion_strength",
            name = "åŠ›é‡è¯æ°´",
            description = "ä¸´æ—¶å¢åŠ æ”»å‡»åŠ›çš„è¯æ°´ï¼ŒæŒç»­5åˆ†é’Ÿ (æ¯æ—¥é™è´­3ç“¶)",
            price = 120,
            sellPrice = 96,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 3,
            canSell = true,
            category = "consumables",
            imageUrl = "rbxasset://textures/potion_strength.png",
            isActive = true,
            sortOrder = 10,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["scroll_teleport"] = {
            id = "scroll_teleport",
            name = "ä¼ é€å·è½´",
            description = "ç¬é—´ä¼ é€åˆ°æŒ‡å®šåœ°ç‚¹çš„é­”æ³•å·è½´ (æ¯æ—¥é™è´­2å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 150,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 2,
            canSell = false,
            category = "consumables",
            imageUrl = "rbxasset://textures/scroll_teleport.png",
            isActive = true,
            sortOrder = 11,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["food_bread"] = {
            id = "food_bread",
            name = "é¢åŒ…",
            description = "ç®€å•çš„é£Ÿç‰©ï¼Œæ¢å¤å°‘é‡ç”Ÿå‘½å€¼",
            price = 20,
            sellPrice = 16,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "consumables",
            imageUrl = "rbxasset://textures/food_bread.png",
            isActive = true,
            sortOrder = 12,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- ææ–™ç±»
        ["gem_ruby"] = {
            id = "gem_ruby",
            name = "çº¢å®çŸ³",
            description = "çè´µçš„çº¢è‰²å®çŸ³ï¼Œå¯ç”¨äºè£…å¤‡å¼ºåŒ– (æ¯æ—¥é™è´­2é¢—)",
            price = 200,
            sellPrice = 160,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 2,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/gem_ruby.png",
            isActive = true,
            sortOrder = 13,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["gem_sapphire"] = {
            id = "gem_sapphire",
            name = "è“å®çŸ³",
            description = "ç¨€æœ‰çš„è“è‰²å®çŸ³ï¼Œè•´å«é­”æ³•èƒ½é‡ (æ¯æ—¥é™è´­2é¢—)",
            price = 220,
            sellPrice = 176,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 2,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/gem_sapphire.png",
            isActive = true,
            sortOrder = 14,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["gem_emerald"] = {
            id = "gem_emerald",
            name = "ç»¿å®çŸ³",
            description = "ç¥ç§˜çš„ç»¿è‰²å®çŸ³ï¼Œæ®è¯´æœ‰æ²»æ„ˆèƒ½åŠ› (æ¯æ—¥é™è´­2é¢—)",
            price = 250,
            sellPrice = 200,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 2,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/gem_emerald.png",
            isActive = true,
            sortOrder = 15,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["ore_iron"] = {
            id = "ore_iron",
            name = "é“çŸ¿çŸ³",
            description = "å¸¸è§çš„é‡‘å±çŸ¿çŸ³ï¼Œç”¨äºåˆ¶ä½œè£…å¤‡",
            price = 30,
            sellPrice = 24,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/ore_iron.png",
            isActive = true,
            sortOrder = 16,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["ore_gold"] = {
            id = "ore_gold",
            name = "é‡‘çŸ¿çŸ³",
            description = "çè´µçš„é»„é‡‘çŸ¿çŸ³ï¼Œä»·å€¼ä¸è² (æ¯æ—¥é™è´­10ä¸ª)",
            price = 100,
            sellPrice = 80,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 10,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/ore_gold.png",
            isActive = true,
            sortOrder = 17,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["wood_oak"] = {
            id = "wood_oak",
            name = "æ©¡æœ¨",
            description = "åšç¡¬çš„æœ¨æï¼Œåˆ¶ä½œå·¥å…·çš„å¥½ææ–™",
            price = 25,
            sellPrice = 20,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "materials",
            imageUrl = "rbxasset://textures/wood_oak.png",
            isActive = true,
            sortOrder = 18,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- ä¹¦ç±ç±»
        ["book_spells"] = {
            id = "book_spells",
            name = "æ³•æœ¯ä¹¦",
            description = "è®°å½•ç€å„ç§é­”æ³•å’’è¯­çš„å¤è€ä¹¦ç± (æ¯æ—¥é™è´­1æœ¬ï¼Œæ— æ³•å–å‡º)",
            price = 180,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "books",
            imageUrl = "rbxasset://textures/book_spells.png",
            isActive = true,
            sortOrder = 19,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["book_history"] = {
            id = "book_history",
            name = "å†å²ä¹¦",
            description = "è®°å½•ç€è¿™ä¸ªä¸–ç•Œå†å²çš„çè´µå…¸ç±",
            price = 80,
            sellPrice = 64,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "books",
            imageUrl = "rbxasset://textures/book_history.png",
            isActive = true,
            sortOrder = 20,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- å·¥å…·ç±»
        ["map_world"] = {
            id = "map_world",
            name = "ä¸–ç•Œåœ°å›¾",
            description = "è¯¦ç»†çš„ä¸–ç•Œåœ°å›¾ï¼Œæ¢é™©è€…å¿…å¤‡ (æ¯æ—¥é™è´­1å¼ )",
            price = 120,
            sellPrice = 96,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = true,
            category = "tools",
            imageUrl = "rbxasset://textures/map_world.png",
            isActive = true,
            sortOrder = 21,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["pickaxe"] = {
            id = "pickaxe",
            name = "é•å­",
            description = "æŒ–æ˜çŸ¿çŸ³çš„å·¥å…·ï¼Œæ¢çŸ¿å¿…å¤‡",
            price = 90,
            sellPrice = 72,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "tools",
            imageUrl = "rbxasset://textures/pickaxe.png",
            isActive = true,
            sortOrder = 22,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["fishing_rod"] = {
            id = "fishing_rod",
            name = "é’“é±¼ç«¿",
            description = "åœ¨æ²³è¾¹æ¹–è¾¹é’“é±¼çš„å·¥å…·",
            price = 70,
            sellPrice = 56,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = nil,
            canSell = true,
            category = "tools",
            imageUrl = "rbxasset://textures/fishing_rod.png",
            isActive = true,
            sortOrder = 23,
            createdAt = os.time(),
            updatedAt = os.time()
        },

        -- ä¼šå‘˜ç±»å•†å“
        ["monthly_membership"] = {
            id = "monthly_membership",
            name = "æœˆå¡ä¼šå‘˜",
            description = "è´­ä¹°åè·å¾—30å¤©ä¼šå‘˜ç‰¹æƒï¼Œæ¯æ—¥ç™»å½•å¯è·å¾—100é‡‘å¸å¥–åŠ± (æ¯æ—¥é™è´­1å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 1000,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "membership",
            imageUrl = "rbxasset://textures/monthly_membership.png",
            isActive = true,
            sortOrder = 24,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["weekly_membership"] = {
            id = "weekly_membership",
            name = "å‘¨å¡ä¼šå‘˜",
            description = "è´­ä¹°åè·å¾—7å¤©ä¼šå‘˜ç‰¹æƒï¼Œæ¯æ—¥ç™»å½•å¯è·å¾—100é‡‘å¸å¥–åŠ± (æ¯æ—¥é™è´­2å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 300,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 2,
            canSell = false,
            category = "membership",
            imageUrl = "rbxasset://textures/weekly_membership.png",
            isActive = true,
            sortOrder = 25,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["quarterly_membership"] = {
            id = "quarterly_membership",
            name = "å­£å¡ä¼šå‘˜",
            description = "è´­ä¹°åè·å¾—90å¤©ä¼šå‘˜ç‰¹æƒï¼Œæ¯æ—¥ç™»å½•å¯è·å¾—100é‡‘å¸å¥–åŠ±ï¼Œè¶…å€¼ä¼˜æƒ ï¼ (æ¯æ—¥é™è´­1å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 2700,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "membership",
            imageUrl = "rbxasset://textures/quarterly_membership.png",
            isActive = true,
            sortOrder = 26,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["premium_membership"] = {
            id = "premium_membership",
            name = "é«˜çº§æœˆå¡",
            description = "è´­ä¹°åè·å¾—30å¤©é«˜çº§ä¼šå‘˜ç‰¹æƒï¼Œæ¯æ—¥ç™»å½•å¯è·å¾—200é‡‘å¸å¥–åŠ± (æ¯æ—¥é™è´­1å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 1800,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "membership",
            imageUrl = "rbxasset://textures/premium_membership.png",
            isActive = true,
            sortOrder = 27,
            createdAt = os.time(),
            updatedAt = os.time()
        },
        ["vip_membership"] = {
            id = "vip_membership",
            name = "VIPå¹´å¡",
            description = "è´­ä¹°åè·å¾—365å¤©VIPä¼šå‘˜ç‰¹æƒï¼Œæ¯æ—¥ç™»å½•å¯è·å¾—150é‡‘å¸å¥–åŠ±ï¼Œä¸€å¹´æ— å¿§ï¼ (æ¯æ—¥é™è´­1å¼ ï¼Œæ— æ³•å–å‡º)",
            price = 10000,
            sellPrice = 0,
            maxQuantity = nil,
            currentStock = -1,
            dailyPurchaseLimit = 1,
            canSell = false,
            category = "membership",
            imageUrl = "rbxasset://textures/vip_membership.png",
            isActive = true,
            sortOrder = 28,
            createdAt = os.time(),
            updatedAt = os.time()
        }
    }
end

-- åˆå§‹åŒ–æ‰€æœ‰å•†å“æ•°æ®
function ItemsInitializer.initializeAllItems()
    local existingItems = DataStoreManager.getAllItems()

    -- å¦‚æœå•†å“æ•°æ®ä¸ºç©ºæˆ–è€…æ•°é‡è¾ƒå°‘ï¼Œåˆ™åˆå§‹åŒ–æ‰€æœ‰å•†å“
    local existingCount = 0
    for _ in pairs(existingItems) do
        existingCount = existingCount + 1
    end

    if existingCount < 5 then -- å¦‚æœç°æœ‰å•†å“å°‘äº5ä¸ªï¼Œåˆ™è¿›è¡Œåˆå§‹åŒ–
        print("ğŸ›’ å¼€å§‹åˆå§‹åŒ–å•†å“æ•°æ®...")

        local allItems = getInitialItemsData()
        local success = DataStoreManager.safeSetAsync("ITEMS", "all_items", allItems)

        if success then
            local totalCount = 0
            for _ in pairs(allItems) do
                totalCount = totalCount + 1
            end
            print("âœ… å•†å“æ•°æ®åˆå§‹åŒ–æˆåŠŸï¼å…±åˆå§‹åŒ–", totalCount, "ä¸ªå•†å“")

            -- æŒ‰ç±»åˆ«ç»Ÿè®¡å•†å“æ•°é‡
            local categoryCount = {}
            for _, item in pairs(allItems) do
                categoryCount[item.category] = (categoryCount[item.category] or 0) + 1
            end

            print("ğŸ“¦ å•†å“åˆ†ç±»ç»Ÿè®¡:")
            for category, count in pairs(categoryCount) do
                print("   ", category, ":", count, "ä¸ª")
            end
        else
            warn("âŒ å•†å“æ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼")
        end
    else
        print("âœ… å•†å“æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ– (ç°æœ‰", existingCount, "ä¸ªå•†å“)")
    end
end

-- è·å–ç‰¹å®šç±»åˆ«çš„å•†å“æ•°é‡
function ItemsInitializer.getCategoryItemCount(category)
    local allItems = getInitialItemsData()
    local count = 0

    for _, item in pairs(allItems) do
        if item.category == category then
            count = count + 1
        end
    end

    return count
end

-- è·å–æ‰€æœ‰å•†å“ç±»åˆ«
function ItemsInitializer.getAllCategories()
    local allItems = getInitialItemsData()
    local categories = {}

    for _, item in pairs(allItems) do
        if not categories[item.category] then
            categories[item.category] = true
        end
    end

    local categoryList = {}
    for category in pairs(categories) do
        table.insert(categoryList, category)
    end

    return categoryList
end

-- è·å–å•†å“æ€»æ•°
function ItemsInitializer.getTotalItemCount()
    local allItems = getInitialItemsData()
    local count = 0

    for _ in pairs(allItems) do
        count = count + 1
    end

    return count
end

return ItemsInitializer
