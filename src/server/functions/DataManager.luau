-- æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨
-- é›†æˆç¼“å­˜ç³»ç»Ÿï¼Œæä¾›é«˜æ•ˆçš„ç©å®¶æ•°æ®ç®¡ç†
-- æ”¯æŒè‡ªåŠ¨ä¿å­˜ã€ç¼“å­˜ç®¡ç†å’Œæ•°æ®æŒä¹…åŒ–

local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local DataManager = {}

-- æ•°æ®å­˜å‚¨é…ç½®
local DATA_STORE_NAME = "PlayerShopData"
local SAVE_INTERVAL = 30 -- æ¯30ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡

-- æ£€æµ‹æ˜¯å¦åœ¨Studioç¯å¢ƒä¸­
local isStudio = RunService:IsStudio()
local playerDataStore = nil
local mockDataStore = {} -- Studioç¯å¢ƒä¸­çš„æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨

if isStudio then
    print("âš ï¸ æ£€æµ‹åˆ°Studioç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨")
else
    playerDataStore = DataStoreService:GetDataStore(DATA_STORE_NAME)
end

-- å¯¼å…¥ç¼“å­˜æœåŠ¡
local CacheService = nil -- å»¶è¿ŸåŠ è½½é¿å…å¾ªç¯ä¾èµ–

-- è·å–ç¼“å­˜æœåŠ¡ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
local function getCacheService()
    if not CacheService then
        CacheService = require(game:GetService("ServerScriptService").Server.services.CacheService)
    end
    return CacheService
end

-- ç©å®¶æ•°æ®ä¿å­˜æ—¶é—´è®°å½•
local lastSaveTime = {}

-- è·å–ç©å®¶æ•°æ®
function DataManager.getPlayerData(player: Player)
    local cacheService = getCacheService()
    local userId = tostring(player.UserId)
    return cacheService.getUserData(userId)
end

-- è®¾ç½®ç©å®¶æ•°æ®
function DataManager.setPlayerData(player: Player, data)
    local cacheService = getCacheService()
    local userId = tostring(player.UserId)
    cacheService.cacheUserData(userId, data, 600) -- ç¼“å­˜10åˆ†é’Ÿ
    lastSaveTime[player.UserId] = tick()
end

-- ä»æ•°æ®å­˜å‚¨åŠ è½½ç©å®¶æ•°æ®
function DataManager.loadPlayerData(player: Player, defaultData)
    local success, data = false, nil
    local userId = tostring(player.UserId)

    if isStudio then
        -- Studioç¯å¢ƒï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨
        data = mockDataStore[userId]
        success = true
    else
        -- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨çœŸå®æ•°æ®å­˜å‚¨
        success, data = pcall(function()
            return playerDataStore:GetAsync(userId)
        end)
    end

    local finalData
    if success and data then
        finalData = data
        print("âœ… æˆåŠŸåŠ è½½ç©å®¶ " .. player.Name .. " çš„æ•°æ®")
    else
        finalData = defaultData
        print("ğŸ“ ä¸ºç©å®¶ " .. player.Name .. " åˆ›å»ºæ–°æ•°æ®")
    end

    -- ç¼“å­˜æ•°æ®
    local cacheService = getCacheService()
    cacheService.cacheUserData(userId, finalData, 600) -- ç¼“å­˜10åˆ†é’Ÿ

    lastSaveTime[player.UserId] = tick()
    return finalData
end

-- ä¿å­˜ç©å®¶æ•°æ®åˆ°æ•°æ®å­˜å‚¨
function DataManager.savePlayerData(player: Player)
    local cacheService = getCacheService()
    local userId = tostring(player.UserId)
    local cachedData = cacheService.getUserData(userId)

    if not cachedData then
        return false
    end

    local success, error = false, nil

    if isStudio then
        -- Studioç¯å¢ƒï¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨
        mockDataStore[userId] = cachedData
        success = true
    else
        -- ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨çœŸå®æ•°æ®å­˜å‚¨
        success, error = pcall(function()
            playerDataStore:SetAsync(userId, cachedData)
        end)
    end

    if success then
        print("ğŸ’¾ æˆåŠŸä¿å­˜ç©å®¶ " .. player.Name .. " çš„æ•°æ®")
        return true
    else
        warn("âŒ ä¿å­˜ç©å®¶ " .. player.Name .. " æ•°æ®å¤±è´¥: " .. tostring(error))
        return false
    end
end

-- å¼ºåˆ¶ä¿å­˜æ‰€æœ‰ç©å®¶æ•°æ®
function DataManager.saveAllPlayerData()
    local cacheService = getCacheService()
    local allCachedUsers = cacheService.getAllCachedUsers()

    for _, userId in ipairs(allCachedUsers) do
        local player = Players:GetPlayerByUserId(tonumber(userId))
        if player then
            DataManager.savePlayerData(player)
        end
    end
end

-- æ¸…ç†ç©å®¶æ•°æ®ç¼“å­˜
function DataManager.clearPlayerData(player: Player)
    local cacheService = getCacheService()
    local userId = tostring(player.UserId)
    local userData = cacheService.getUserData(userId)

    if userData then
        -- å…ˆä¿å­˜æ•°æ®å†æ¸…ç†
        DataManager.savePlayerData(player)
        cacheService.clearUserData(userId)
        lastSaveTime[player.UserId] = nil
        print("ğŸ§¹ æ¸…ç†ç©å®¶ " .. player.Name .. " çš„ç¼“å­˜æ•°æ®")
    end
end

-- è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ
local function startAutoSave()
    spawn(function()
        while true do
            wait(SAVE_INTERVAL)

            local currentTime = tick()
            for userId, lastSave in pairs(lastSaveTime) do
                if currentTime - lastSave >= SAVE_INTERVAL then
                    local player = Players:GetPlayerByUserId(userId)
                    if player then
                        DataManager.savePlayerData(player)
                    end
                end
            end
        end
    end)
end

-- ç©å®¶ç¦»å¼€æ—¶ä¿å­˜æ•°æ®
Players.PlayerRemoving:Connect(function(player)
    DataManager.clearPlayerData(player)
end)

-- æ¸¸æˆå…³é—­æ—¶ä¿å­˜æ‰€æœ‰æ•°æ®
game:BindToClose(function()
    DataManager.saveAllPlayerData()
    wait(2) -- ç­‰å¾…ä¿å­˜å®Œæˆ
end)

-- å¯åŠ¨è‡ªåŠ¨ä¿å­˜
startAutoSave()


return DataManager
