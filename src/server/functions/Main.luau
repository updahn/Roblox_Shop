-- å•†åº—ç³»ç»Ÿä¸»æœåŠ¡å™¨è„šæœ¬
-- ç®€åŒ–åçš„ç»Ÿä¸€å…¥å£ç‚¹

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

print("ğŸª å•†åº—ç³»ç»Ÿå¯åŠ¨ä¸­...")

-- ç­‰å¾…å…±äº«æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules", 5)
if not SharedModules then
    error("âš ï¸ æ— æ³•åŠ è½½å…±äº«æ¨¡å—ï¼Œç³»ç»Ÿæ— æ³•å¯åŠ¨")
    return
end

local Config = require(SharedModules:WaitForChild("Config"))
local Events = require(SharedModules:WaitForChild("ShopEvents"))

-- åŠ è½½æœåŠ¡æ¨¡å— - ä½¿ç”¨é‡æ„åçš„è·¯å¾„
local ServicesFolder = game:GetService("ServerScriptService").Server:WaitForChild("services")
local UtilsFolder = game:GetService("ServerScriptService"):WaitForChild("utils")

local UserService = require(ServicesFolder:WaitForChild("UserService"))
local AdminService = require(ServicesFolder:WaitForChild("AdminService"))
local DroneService = require(ServicesFolder:WaitForChild("DroneService"))
local TargetService = require(UtilsFolder:WaitForChild("TargetService"))

-- åˆå§‹åŒ–é¶å­ç³»ç»Ÿ
TargetService.initialize()

print("âœ… å•†åº—ç³»ç»Ÿå·²å¯åŠ¨")
print("ğŸ›’ æ”¯æŒæ™®é€šç”¨æˆ·å’Œç®¡ç†å‘˜åŠŸèƒ½")
print("ğŸ¤– æ— äººæœºç³»ç»Ÿå·²æ¿€æ´»")
print("ğŸ¯ é¶å­ç³»ç»Ÿå·²æ¿€æ´»")
print("ğŸ“Š æ•°æ®å­˜å‚¨åœ¨ DataStore ä¸­")

-- å¤„ç†ç©å®¶è¿æ¥äº‹ä»¶
Players.PlayerAdded:Connect(function(player)
    print("ğŸ‘¤ [åŠ å…¥] " .. player.Name .. " å·²è¿æ¥")

    -- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿å®¢æˆ·ç«¯å‡†å¤‡å¥½
    wait(2)

    -- è®¤è¯ç©å®¶
    UserService.authenticatePlayer(player)
end)

Players.PlayerRemoving:Connect(function(player)
    print("ğŸ‘‹ [ç¦»å¼€] " .. player.Name .. " å·²æ–­å¼€è¿æ¥")
    UserService.cleanupPlayer(player)
    AdminService.cleanupPlayer(player)
end)

-- å¤„ç†å·²ç»åœ¨æ¸¸æˆä¸­çš„ç©å®¶
for _, player in pairs(Players:GetPlayers()) do
    spawn(function()
        UserService.authenticatePlayer(player)
    end)
end

return true
