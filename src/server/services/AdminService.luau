-- ç®¡ç†å‘˜æœåŠ¡æ¨¡å—
-- å¤„ç†ç®¡ç†å‘˜åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€ä¼šå‘˜ç®¡ç†ç­‰

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local AdminService = {}

-- ç­‰å¾…æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))
local Events = require(SharedModules:WaitForChild("ShopEvents"))
local DataService = require(script.Parent:WaitForChild("DataService"))
local UserService = require(script.Parent:WaitForChild("UserService"))

-- å¯¼å…¥ç¼“å­˜æœåŠ¡ - ä½¿ç”¨ç»Ÿä¸€ç¼“å­˜ç³»ç»Ÿè¿›è¡Œç®¡ç†å‘˜æƒé™ç¼“å­˜
local CacheService = nil -- å»¶è¿ŸåŠ è½½é¿å…å¾ªç¯ä¾èµ–

-- è·å–ç¼“å­˜æœåŠ¡ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼‰
-- ç®¡ç†å‘˜æƒé™éªŒè¯ç»“æœå°†è¢«ç¼“å­˜3åˆ†é’Ÿï¼Œæé«˜æ€§èƒ½
local function getCacheService()
    if not CacheService then
        CacheService = require(script.Parent.CacheService)
    end
    return CacheService
end

-- ==============================================
-- æƒé™æ£€æŸ¥
-- ==============================================

-- ç®¡ç†å‘˜æƒé™éªŒè¯å‡½æ•°ï¼ˆå¸¦ç¼“å­˜ï¼‰
function AdminService.isValidAdmin(player: Player): boolean
    if not player or not player.UserId then
        return false
    end

    local userId = tostring(player.UserId)
    local cacheService = getCacheService()

    -- æ£€æŸ¥ç¼“å­˜
    local cachedResult = cacheService.getAdminPermission(userId)
    if cachedResult ~= nil then
        return cachedResult
    end

    -- ä¼˜å…ˆæ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ç®¡ç†å‘˜ç”¨æˆ·åï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
    local SharedModules = game:GetService("ReplicatedStorage"):WaitForChild("SharedModules")
    local Config = require(SharedModules:WaitForChild("Config"))
    local defaultAdminUsernames = Config.ADMIN.DEFAULT_ADMIN_USERNAMES or {}

    local isConfigAdmin = false
    for _, adminUsername in ipairs(defaultAdminUsernames) do
        if player.Name == adminUsername then
            isConfigAdmin = true
            break
        end
    end

    local isDataAdmin = false
    if not isConfigAdmin then
        -- åªæœ‰å½“é…ç½®æ–‡ä»¶æ£€æŸ¥ä¸é€šè¿‡æ—¶æ‰æŸ¥è¯¢æ•°æ®åº“
        isDataAdmin, _ = DataService.checkAdminPermission(userId)
    end

    local finalIsAdmin = isConfigAdmin or isDataAdmin

    -- ç¼“å­˜ç»“æœ
    cacheService.cacheAdminPermission(userId, finalIsAdmin, 180) -- ç¼“å­˜3åˆ†é’Ÿ

    if isConfigAdmin then
        print("âœ… [AdminService]", player.Name, "ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡ï¼ˆé…ç½®æ–‡ä»¶ï¼‰")
    elseif isDataAdmin then
        print("âœ… [AdminService]", player.Name, "ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡ï¼ˆæ•°æ®åº“ï¼‰")
    else
        print("âŒ [AdminService]", player.Name, "æƒé™éªŒè¯å¤±è´¥")
    end

    return finalIsAdmin
end

-- ==============================================
-- ç”¨æˆ·ç®¡ç†åŠŸèƒ½
-- ==============================================

local function handleGetAllUsers(player: Player)
    print("ğŸ‘‘ [è°ƒè¯•] å¤„ç†è·å–æ‰€æœ‰ç”¨æˆ·è¯·æ±‚:", player.Name)

    if not AdminService.isValidAdmin(player) then
        print("âŒ [æƒé™é”™è¯¯] ç”¨æˆ·", player.Name, "ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.GetAllUsers:FireClient(player, nil, "æƒé™ä¸è¶³ï¼šæ‚¨ä¸æ˜¯ç®¡ç†å‘˜")
        return
    end

    local userId = tostring(player.UserId)
    print("ğŸ‘‘ [è°ƒè¯•] ç®¡ç†å‘˜æƒé™éªŒè¯é€šè¿‡ï¼Œå¼€å§‹è®¤è¯æ£€æŸ¥")

    -- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•è‡ªåŠ¨è®¤è¯
    local session = UserService.isPlayerAuthenticated(player)
    if not session then
        print("ğŸ‘‘ [è°ƒè¯•] ç®¡ç†å‘˜æœªè®¤è¯ï¼Œå°è¯•è‡ªåŠ¨è®¤è¯")
        local authSuccess, userData = DataService.authenticateUser(userId, player.Name, player.DisplayName)
        if not authSuccess then
            print("âŒ [è®¤è¯å¤±è´¥] ç®¡ç†å‘˜", player.Name, "è®¤è¯å¤±è´¥")
            Events.Admin.GetAllUsers:FireClient(player, nil, "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥æ¸¸æˆ")
            return
        end
        print("âœ… [è®¤è¯æˆåŠŸ] ç®¡ç†å‘˜", player.Name, "è‡ªåŠ¨è®¤è¯æˆåŠŸ")
    end

    print("ğŸ‘‘ [è°ƒè¯•] å¼€å§‹è·å–ç”¨æˆ·æ•°æ®...")
    local success, allUsersData, errorMsg = DataService.getAllUsers(userId, 50, 0, true)

    if success and allUsersData then
        local allPlayersData = {}
        for _, user in ipairs(allUsersData.users) do
            -- è·å–ç”¨æˆ·åº“å­˜æ•°æ®
            local inventory = DataService.getUserInventory(tostring(user.id))
            local inventoryCount = 0
            if inventory then
                for itemId, quantity in pairs(inventory) do
                    inventoryCount = inventoryCount + quantity
                end
            end

            local playerData = {
                userId = user.id,
                name = user.username,
                coins = user.coins or 0,
                totalPurchases = user.buy_count or 0,
                totalSpent = user.total_spent or 0,
                totalSales = user.sell_count or 0,
                totalEarned = user.total_earned or 0,
                inventoryCount = inventoryCount,
                -- æ·»åŠ ä¼šå‘˜çŠ¶æ€ç›¸å…³å­—æ®µ
                membership_status = user.membership_status or "none",
                end_date = user.membership_end_date or user.end_date,
                days_remaining = user.days_remaining or 0,
                daily_reward_coins = user.daily_reward_coins or 100
            }

            allPlayersData[user.username] = playerData
            print("ğŸ‘‘ [è°ƒè¯•] æ·»åŠ ç©å®¶æ•°æ®:", user.username, "->", playerData)
        end

        local playerCount = 0
        for _ in pairs(allPlayersData) do
            playerCount = playerCount + 1
        end

        print("ğŸ‘‘ [è°ƒè¯•] å‡†å¤‡å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ï¼Œç©å®¶æ•°é‡:", playerCount)
        print("ğŸ‘‘ [è°ƒè¯•] å‘é€çš„æ•°æ®:", allPlayersData)

        Events.Admin.GetAllUsers:FireClient(player, allPlayersData)
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†æ‰€æœ‰ç”¨æˆ·æ•°æ®")
    else
        local errorMessage = errorMsg or "æ— æ³•è·å–ç”¨æˆ·æ•°æ®"
        warn("âŒ [æ•°æ®é”™è¯¯] " .. errorMessage)

        -- æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é—®é¢˜
        if errorMsg and string.find(errorMsg, "è®¤è¯") then
            print("âŒ [è®¤è¯é—®é¢˜] ç®¡ç†å‘˜è®¤è¯å¤±è´¥ï¼Œå‘é€è®¤è¯é”™è¯¯")
            Events.Admin.GetAllUsers:FireClient(player, nil, "è®¤è¯å¤±è´¥ï¼š" .. errorMessage)
            return
        end

        -- å¦‚æœæ•°æ®æœåŠ¡ä¸å¯ç”¨ï¼Œå‘é€é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯
        print("ğŸ‘‘ [è°ƒè¯•] æ•°æ®æœåŠ¡ä¸å¯ç”¨ï¼Œå‘é€é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯")
        local detailedError = string.format(
            "æ•°æ®åŠ è½½å¤±è´¥ï¼š%s\n\nå¯èƒ½çš„åŸå› ï¼š\nâ€¢ æ•°æ®å­˜å‚¨æœåŠ¡å¼‚å¸¸\nâ€¢ ç½‘ç»œè¿æ¥é—®é¢˜\nâ€¢ æƒé™é…ç½®é”™è¯¯\n\nè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜",
            errorMessage
        )
        Events.Admin.GetAllUsers:FireClient(player, nil, detailedError)

        -- åŒæ—¶æä¾›ä¸€äº›åŸºæœ¬çš„æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡é€‰
        print("ğŸ‘‘ [è°ƒè¯•] åŒæ—¶æä¾›æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡é€‰")
        spawn(function()
            wait(1) -- ç­‰å¾…1ç§’åå†å‘é€æ¨¡æ‹Ÿæ•°æ®
            local mockData = {
                [player.Name] = {
                    userId = player.UserId,
                    name = player.Name,
                    coins = 1000,
                    totalPurchases = 5,
                    totalSpent = 500,
                    totalSales = 3,
                    totalEarned = 300,
                    inventoryCount = 10,
                    membership_status = "active",
                    end_date = "2024-12-31",
                    days_remaining = 30,
                    daily_reward_coins = 100
                },
                ["æ¨¡æ‹Ÿç”¨æˆ·1"] = {
                    userId = 12345,
                    name = "æ¨¡æ‹Ÿç”¨æˆ·1",
                    coins = 500,
                    totalPurchases = 2,
                    totalSpent = 200,
                    totalSales = 1,
                    totalEarned = 100,
                    inventoryCount = 5,
                    membership_status = "none",
                    end_date = nil,
                    days_remaining = 0,
                    daily_reward_coins = 100
                },
                ["æ¨¡æ‹Ÿç”¨æˆ·2"] = {
                    userId = 67890,
                    name = "æ¨¡æ‹Ÿç”¨æˆ·2",
                    coins = 2000,
                    totalPurchases = 10,
                    totalSpent = 1000,
                    totalSales = 8,
                    totalEarned = 800,
                    inventoryCount = 15,
                    membership_status = "active",
                    end_date = "2024-10-15",
                    days_remaining = 15,
                    daily_reward_coins = 150
                }
            }

            print("ğŸ‘‘ [è°ƒè¯•] å‘é€æ¨¡æ‹Ÿæ•°æ®:", mockData)
            -- å…ˆå‘é€ä¸€ä¸ªæç¤ºï¼Œå‘ŠçŸ¥è¿™æ˜¯æ¨¡æ‹Ÿæ•°æ®
            Events.Admin.GetAllUsers:FireClient(player, nil, "æ³¨æ„ï¼šä»¥ä¸‹ä¸ºæ¨¡æ‹Ÿæ•°æ®ï¼ˆæ•°æ®æœåŠ¡ç¦»çº¿ï¼‰")
            wait(0.5)
            Events.Admin.GetAllUsers:FireClient(player, mockData)
            print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®ï¼ˆæ•°æ®æœåŠ¡ä¸å¯ç”¨ï¼‰")
        end)
    end
end

local function handleSetUserCoins(player: Player, targetPlayerName: string, newCoins: number)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•ä¿®æ”¹é‡‘å¸ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.SetUserCoins:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    -- æŸ¥æ‰¾ç›®æ ‡ç©å®¶çš„IDå’ŒPlayerå¯¹è±¡
    local targetUserId = nil
    local targetPlayer = nil
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer.Name == targetPlayerName then
            targetUserId = tostring(otherPlayer.UserId)
            targetPlayer = otherPlayer
            break
        end
    end

    if not targetUserId then
        Events.Admin.SetUserCoins:FireClient(player, false, "ç©å®¶ " .. targetPlayerName .. " ä¸åœ¨çº¿")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message = DataService.setUserCoins(adminUserId, targetUserId, newCoins, "ç®¡ç†å‘˜è°ƒæ•´ by " .. player.Name)

    if success then
        Events.Admin.SetUserCoins:FireClient(player, true, message)
        print("ğŸ‘‘ [ç®¡ç†å‘˜æ“ä½œ] " .. player.Name .. " ä¿®æ”¹äº† " .. targetPlayerName .. " çš„é‡‘å¸ä¸º " .. newCoins)

        -- ç«‹å³é€šçŸ¥ç›®æ ‡ç©å®¶åˆ·æ–°æ•°æ®
        if targetPlayer then
            print("ğŸ”„ [æ•°æ®åŒæ­¥] é€šçŸ¥ " .. targetPlayerName .. " åˆ·æ–°æ•°æ®")

            -- å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿æ•°æ®å·²ä¿å­˜ï¼Œç„¶åé€šçŸ¥ç›®æ ‡ç©å®¶åˆ·æ–°
            spawn(function()
                task.wait(0.2) -- ç¨ç­‰ç‰‡åˆ»ç¡®ä¿æ•°æ®å·²ä¿å­˜

                -- é€šè¿‡äº‹ä»¶è§¦å‘ç›®æ ‡ç©å®¶çš„æ•°æ®åˆ·æ–°
                Events.User.RefreshData:FireClient(targetPlayer)
                print("âœ… [æ•°æ®åŒæ­¥] å·²é€šçŸ¥ " .. targetPlayerName .. " åˆ·æ–°æ•°æ®")
            end)
        end
    else
        Events.Admin.SetUserCoins:FireClient(player, false, message or "ä¿®æ”¹å¤±è´¥")
    end
end

-- ==============================================
-- ä¼šå‘˜ç®¡ç†åŠŸèƒ½
-- ==============================================

local function handleGetMembersList(player: Player, page: number?, limit: number?, status: string?)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–ä¼šå‘˜åˆ—è¡¨ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.GetMembersList:FireClient(player, false, {error = "æƒé™ä¸è¶³"})
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, response = DataService.getMembersList(adminUserId, page, limit, status)

    Events.Admin.GetMembersList:FireClient(player, success, response)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†ä¼šå‘˜åˆ—è¡¨")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " è·å–ä¼šå‘˜åˆ—è¡¨å¤±è´¥")
    end
end

local function handleUpdateMembership(player: Player, membershipData)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•æ›´æ–°ä¼šå‘˜ä¿¡æ¯ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.UpdateMembership:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.updatePlayerMembership(
        adminUserId,
        membershipData.playerName,
        membershipData.membershipType,
        membershipData.status,
        membershipData.endDate
    )

    Events.Admin.UpdateMembership:FireClient(player, success, message, data)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æ›´æ–°äº† " .. membershipData.playerName .. " çš„ä¼šå‘˜ä¿¡æ¯")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " æ›´æ–°ä¼šå‘˜ä¿¡æ¯å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

local function handleAddMembership(player: Player, playerName: string, days: number)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•æ·»åŠ ä¼šå‘˜ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.AddMembership:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.addPlayerMembership(adminUserId, playerName, days)

    Events.Admin.AddMembership:FireClient(player, success, message, data)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " ä¸º " .. playerName .. " æ·»åŠ äº† " .. days .. " å¤©ä¼šå‘˜")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " æ·»åŠ ä¼šå‘˜å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

local function handleCancelMembership(player: Player, playerName: string)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•å–æ¶ˆä¼šå‘˜ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.CancelMembership:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.cancelPlayerMembership(adminUserId, playerName)

    Events.Admin.CancelMembership:FireClient(player, success, message, data)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " å–æ¶ˆäº† " .. playerName .. " çš„ä¼šå‘˜")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " å–æ¶ˆä¼šå‘˜å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

local function handleExtendMembership(player: Player, playerName: string, days: number)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•å»¶é•¿ä¼šå‘˜ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.ExtendMembership:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.extendPlayerMembership(adminUserId, playerName, days)

    Events.Admin.ExtendMembership:FireClient(player, success, message, data)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " ä¸º " .. playerName .. " å»¶é•¿äº† " .. days .. " å¤©ä¼šå‘˜")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " å»¶é•¿ä¼šå‘˜å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

local function handleBatchMembershipOp(player: Player, playerNames: {string}, action: string, days: number?)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•æ‰¹é‡æ“ä½œä¼šå‘˜ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.BatchMembershipOp:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.batchMembershipOperation(adminUserId, playerNames, action, days)

    Events.Admin.BatchMembershipOp:FireClient(player, success, message, data)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " å¯¹ " .. #playerNames .. " ä¸ªç©å®¶æ‰§è¡Œäº†æ‰¹é‡" .. action .. "æ“ä½œ")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " æ‰¹é‡æ“ä½œå¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

local function handleGetAllUsersWithMembership(player: Player, page: number?, limit: number?, status: string?)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–ç”¨æˆ·ä¼šå‘˜æ•°æ®ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.GetAllUsersWithMembership:FireClient(player, false, {error = "æƒé™ä¸è¶³"})
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, response = DataService.getAllUsersWithMembership(adminUserId, page, limit, status)

    Events.Admin.GetAllUsersWithMembership:FireClient(player, success, response)

    if success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " æŸ¥çœ‹äº†æ‰€æœ‰ç”¨æˆ·ä¼šå‘˜çŠ¶æ€")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€å¤±è´¥")
    end
end

local function handleManageUserMembership(player: Player, requestData)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•ç®¡ç†ç”¨æˆ·ä¼šå‘˜ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.ManageUserMembership:FireClient(player, false, {error = "æƒé™ä¸è¶³"})
        return
    end

    local adminUserId = tostring(player.UserId)
    local success, response = DataService.manageUserMembership(adminUserId, requestData)

    Events.Admin.ManageUserMembership:FireClient(player, success, response)

    if success and response and response.success then
        print("ğŸ‘‘ [ç®¡ç†å‘˜] " .. player.Name .. " ç®¡ç†äº†ç”¨æˆ·ä¼šå‘˜çŠ¶æ€")

        -- å®æ—¶æ›´æ–°ç›®æ ‡ç”¨æˆ·çš„çŠ¶æ€ï¼ˆå¦‚æœè¯¥ç”¨æˆ·åœ¨çº¿ï¼‰
        local targetPlayerName = requestData.playerName or requestData.username
        if targetPlayerName then
            -- æŸ¥æ‰¾åœ¨çº¿çš„ç›®æ ‡ç©å®¶
            for _, targetPlayer in pairs(Players:GetPlayers()) do
                if targetPlayer.Name == targetPlayerName then
                    print("ğŸ”„ [å®æ—¶æ›´æ–°] ä¸ºåœ¨çº¿ç”¨æˆ·", targetPlayerName, "æ›´æ–°ä¼šå‘˜çŠ¶æ€")

                    -- å¼‚æ­¥åˆ·æ–°ç›®æ ‡ç”¨æˆ·çš„æ•°æ®å¹¶é€šçŸ¥çŠ¶æ€å˜æ›´
                    local UserService = require(script.Parent:WaitForChild("UserService"))
                    spawn(function()
                        -- å…ˆæ¸…é™¤ç›®æ ‡ç”¨æˆ·çš„ä¼šå‘˜ç¼“å­˜
                        local UserDataService = require(script.Parent.Parent.data:WaitForChild("UserDataService"))
                        if UserDataService.clearMembershipCache then
                            UserDataService.clearMembershipCache(tostring(targetPlayer.UserId))
                            print("ğŸ§¹ [å®æ—¶æ›´æ–°] å·²æ¸…é™¤", targetPlayerName, "çš„ä¼šå‘˜ç¼“å­˜")
                        end

                        -- ç­‰å¾…çŸ­æš‚æ—¶é—´ç¡®ä¿æ•°æ®ä¿å­˜å®Œæˆ
                        task.wait(0.2)

                        -- åˆ·æ–°ç”¨æˆ·æ•°æ®
                        UserService.refreshPlayerData(targetPlayer)

                        -- å‘é€ä¼šå‘˜çŠ¶æ€å˜æ›´é€šçŸ¥
                        if Events.User.MembershipStatusChanged then
                            task.wait(0.1) -- å†ç­‰å¾…ä¸€ç‚¹ç¡®ä¿æ•°æ®åˆ·æ–°å®Œæˆ
                            Events.User.MembershipStatusChanged:FireClient(targetPlayer, {
                                action = requestData.action,
                                success = true,
                                message = "æ‚¨çš„ä¼šå‘˜çŠ¶æ€å·²ç”±ç®¡ç†å‘˜æ›´æ–°",
                                admin = player.Name
                            })
                            print("ğŸ“¤ [å®æ—¶æ›´æ–°] å·²é€šçŸ¥", targetPlayerName, "ä¼šå‘˜çŠ¶æ€å˜æ›´")
                        end
                    end)
                    break
                end
            end
        end
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " ç®¡ç†ç”¨æˆ·ä¼šå‘˜å¤±è´¥")
    end
end

-- å¤„ç†è·å–ç”¨æˆ·äº¤æ˜“å†å²
local function handleGetUserHistory(player: Player, targetPlayerName: string, page: number?, limit: number?)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–ç”¨æˆ·äº¤æ˜“å†å²ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.GetUserHistory:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    print("ğŸ“œ [ç®¡ç†å‘˜] " .. player.Name .. " æ­£åœ¨è·å– " .. targetPlayerName .. " çš„äº¤æ˜“å†å²")

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.getUserHistory(adminUserId, targetPlayerName, page or 1, limit or 50)

    Events.Admin.GetUserHistory:FireClient(player, success, message, data)

    if success then
        print("âœ… [ç®¡ç†å‘˜] æˆåŠŸè·å– " .. targetPlayerName .. " çš„äº¤æ˜“å†å²")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " è·å–äº¤æ˜“å†å²å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

-- å¤„ç†è·å–ä¼šå‘˜çŠ¶æ€
local function handleGetMembershipStatus(player: Player, targetPlayerName: string)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [æƒé™è­¦å‘Š] " .. player.Name .. " å°è¯•è·å–ä¼šå‘˜çŠ¶æ€ï¼Œä½†ä¸æ˜¯ç®¡ç†å‘˜")
        Events.Admin.GetMembershipStatus:FireClient(player, false, "æƒé™ä¸è¶³")
        return
    end

    print("ğŸ‘¤ [ç®¡ç†å‘˜] " .. player.Name .. " æ­£åœ¨è·å– " .. targetPlayerName .. " çš„ä¼šå‘˜çŠ¶æ€")

    local adminUserId = tostring(player.UserId)
    local success, message, data = DataService.getAdminMembershipStatus(adminUserId, targetPlayerName)

    Events.Admin.GetMembershipStatus:FireClient(player, success, message, data)

    if success then
        print("âœ… [ç®¡ç†å‘˜] æˆåŠŸè·å– " .. targetPlayerName .. " çš„ä¼šå‘˜çŠ¶æ€")
    else
        print("âŒ [é”™è¯¯] " .. player.Name .. " è·å–ä¼šå‘˜çŠ¶æ€å¤±è´¥: " .. (message or "æœªçŸ¥é”™è¯¯"))
    end
end

-- ==============================================
-- æ¸…ç†å‡½æ•°
-- ==============================================

-- æ¸…ç†ç©å®¶æƒé™ç¼“å­˜
function AdminService.clearPlayerCache(userId: string)
    local cacheService = getCacheService()
    cacheService.Manager.invalidate(cacheService.Types.ADMIN_PERMISSIONS, userId)
    print("ğŸ§¹ [AdminService] å·²æ¸…ç†ç©å®¶æƒé™ç¼“å­˜:", userId)
end

-- æ¸…ç†æ‰€æœ‰è¿‡æœŸç¼“å­˜
function AdminService.cleanupExpiredCache()
    local cacheService = getCacheService()
    local cleanedCount = cacheService.Manager.cleanupExpired()

    if cleanedCount > 0 then
        print("ğŸ§¹ [AdminService] æ¸…ç†äº†", cleanedCount, "ä¸ªè¿‡æœŸç¼“å­˜")
    end
end

function AdminService.cleanupPlayer(player: Player)
    if player and player.UserId then
        local userId = tostring(player.UserId)
        AdminService.clearPlayerCache(userId)
    end
end

-- ==============================================
-- äº‹ä»¶è¿æ¥
-- ==============================================

-- æƒé™æ£€æŸ¥è¿œç¨‹å‡½æ•°
Events.Admin.CheckPermission.OnServerInvoke = function(player)
    print("ğŸ” [AdminService] æ”¶åˆ°æƒé™æ£€æŸ¥è¯·æ±‚:", player.Name)
    return AdminService.isValidAdmin(player)
end

-- ç®¡ç†å‘˜äº‹ä»¶
Events.Admin.GetAllUsers.OnServerEvent:Connect(handleGetAllUsers)
Events.Admin.SetUserCoins.OnServerEvent:Connect(handleSetUserCoins)
Events.Admin.GetMembersList.OnServerEvent:Connect(handleGetMembersList)
Events.Admin.GetAllUsersWithMembership.OnServerEvent:Connect(handleGetAllUsersWithMembership)
Events.Admin.GetUserHistory.OnServerEvent:Connect(handleGetUserHistory)
Events.Admin.GetMembershipStatus.OnServerEvent:Connect(handleGetMembershipStatus)
Events.Admin.UpdateMembership.OnServerEvent:Connect(handleUpdateMembership)
Events.Admin.AddMembership.OnServerEvent:Connect(handleAddMembership)
Events.Admin.CancelMembership.OnServerEvent:Connect(handleCancelMembership)
Events.Admin.ExtendMembership.OnServerEvent:Connect(handleExtendMembership)
Events.Admin.BatchMembershipOp.OnServerEvent:Connect(handleBatchMembershipOp)
Events.Admin.ManageUserMembership.OnServerEvent:Connect(handleManageUserMembership)




-- æ³¨æ„ï¼šç¼“å­˜æ¸…ç†ç°åœ¨ç”±CacheManagerè‡ªåŠ¨å¤„ç†

print("ğŸ‘‘ ç®¡ç†å‘˜æœåŠ¡å·²å¯åŠ¨")

return AdminService
