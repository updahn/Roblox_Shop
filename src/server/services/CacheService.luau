--[[
    ç¼“å­˜æœåŠ¡ - ç»Ÿä¸€ç¼“å­˜æ“ä½œæ¥å£

    æœ¬æœåŠ¡æ˜¯ CacheManager çš„é«˜çº§åŒ…è£…å™¨ï¼Œæä¾›ï¼š
    - ç®€åŒ–çš„ç¼“å­˜æ“ä½œæ¥å£
    - ä¸ç°æœ‰æœåŠ¡çš„é›†æˆ
    - ç¼“å­˜äº‹ä»¶å¤„ç†
    - å®¢æˆ·ç«¯é€šçŸ¥åŠŸèƒ½
    - ç®¡ç†å‘˜ç¼“å­˜ç®¡ç†åŠŸèƒ½

    ä½¿ç”¨ç¤ºä¾‹ï¼š
        local CacheService = require(path.to.CacheService)

        -- ç¼“å­˜ç”¨æˆ·æ•°æ®
        CacheService.cacheUserData(userId, userData)

        -- è·å–ç”¨æˆ·æ•°æ®
        local userData = CacheService.getUserData(userId)

        -- åˆ·æ–°ç”¨æˆ·ç¼“å­˜
        CacheService.refreshUserCache(userId)
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- å¯¼å…¥ä¾èµ–
local function getCacheManager()
    local ServerScriptService = game:GetService("ServerScriptService")
    local serverFolder = ServerScriptService:FindFirstChild("Server")
    if serverFolder then
        local srcFolder = serverFolder.Parent
        local utilsFolder = srcFolder:FindFirstChild("utils")
        if utilsFolder and utilsFolder:FindFirstChild("CacheManager") then
            return require(utilsFolder.CacheManager)
        end
    end
    error("âŒ æ— æ³•åŠ è½½CacheManageræ¨¡å—")
end

local CacheManager = getCacheManager()
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Events = require(SharedModules:WaitForChild("ShopEvents"))

local CacheService = {}

-- ==============================================
-- ç”¨æˆ·æ•°æ®ç¼“å­˜æ“ä½œ
-- ==============================================

-- ç¼“å­˜ç”¨æˆ·åŸºç¡€æ•°æ®
function CacheService.cacheUserData(userId, userData, ttl)
    local success = CacheManager.set(CacheManager.Types.USER_DATA, userId, userData, ttl)
    if success then
        -- é€šçŸ¥å®¢æˆ·ç«¯ç”¨æˆ·æ•°æ®å·²æ›´æ–°
        local player = Players:GetPlayerByUserId(tonumber(userId))
        if player then
            Events.Cache.UserDataUpdated:FireClient(player, {
                type = "user_data",
                userId = userId,
                timestamp = os.time()
            })
        end
    end
    return success
end

-- è·å–ç”¨æˆ·åŸºç¡€æ•°æ®
function CacheService.getUserData(userId)
    return CacheManager.get(CacheManager.Types.USER_DATA, userId)
end

-- ç¼“å­˜ç”¨æˆ·åº“å­˜æ•°æ®
function CacheService.cacheUserInventory(userId, inventory, ttl)
    local success = CacheManager.set(CacheManager.Types.USER_INVENTORY, userId, inventory, ttl)
    if success then
        -- é€šçŸ¥å®¢æˆ·ç«¯åº“å­˜å·²æ›´æ–°
        local player = Players:GetPlayerByUserId(tonumber(userId))
        if player then
            Events.Cache.UserDataUpdated:FireClient(player, {
                type = "inventory",
                userId = userId,
                timestamp = os.time()
            })
        end
    end
    return success
end

-- è·å–ç”¨æˆ·åº“å­˜æ•°æ®
function CacheService.getUserInventory(userId)
    return CacheManager.get(CacheManager.Types.USER_INVENTORY, userId)
end

-- ç¼“å­˜ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
function CacheService.cacheMembershipStatus(userId, membership, ttl)
    local success = CacheManager.set(CacheManager.Types.MEMBERSHIP, userId, membership, ttl)
    if success then
        -- é€šçŸ¥å®¢æˆ·ç«¯ä¼šå‘˜çŠ¶æ€å·²æ›´æ–°
        local player = Players:GetPlayerByUserId(tonumber(userId))
        if player then
            Events.Cache.MembershipUpdated:FireClient(player, {
                type = "membership",
                userId = userId,
                membership = membership,
                timestamp = os.time()
            })
        end
    end
    return success
end

-- è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
function CacheService.getMembershipStatus(userId)
    return CacheManager.get(CacheManager.Types.MEMBERSHIP, userId)
end

-- ç¼“å­˜ç”¨æˆ·æ¯æ—¥å¥–åŠ±è®°å½•
function CacheService.cacheDailyRewards(userId, rewards, ttl)
    return CacheManager.set(CacheManager.Types.DAILY_REWARDS, userId, rewards, ttl)
end

-- è·å–ç”¨æˆ·æ¯æ—¥å¥–åŠ±è®°å½•
function CacheService.getDailyRewards(userId)
    return CacheManager.get(CacheManager.Types.DAILY_REWARDS, userId)
end

-- åˆ·æ–°ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜
function CacheService.refreshUserCache(userId, notifyClient)
    notifyClient = notifyClient ~= false -- é»˜è®¤ä¸ºtrue

    local clearedCount = CacheManager.refreshUserCache(userId)

    if notifyClient then
        local player = Players:GetPlayerByUserId(tonumber(userId))
        if player then
            Events.Cache.DataRefreshNotify:FireClient(player, {
                type = "user_refresh",
                userId = userId,
                clearedCount = clearedCount,
                timestamp = os.time()
            })
        end
    end

    return clearedCount
end

-- ==============================================
-- å•†åº—æ•°æ®ç¼“å­˜æ“ä½œ
-- ==============================================

-- ç¼“å­˜å•†å“æ•°æ®
function CacheService.cacheShopItems(items, ttl)
    local success = CacheManager.set(CacheManager.Types.SHOP_ITEMS, "all_items", items, ttl)
    if success then
        -- é€šçŸ¥æ‰€æœ‰åœ¨çº¿å®¢æˆ·ç«¯å•†åº—æ•°æ®å·²æ›´æ–°
        for _, player in pairs(Players:GetPlayers()) do
            Events.Cache.ShopDataUpdated:FireClient(player, {
                type = "shop_items",
                itemCount = 0, -- å¯ä»¥è®¾ç½®å®é™…æ•°é‡
                timestamp = os.time()
            })
        end
    end
    return success
end

-- è·å–å•†å“æ•°æ®
function CacheService.getShopItems()
    return CacheManager.get(CacheManager.Types.SHOP_ITEMS, "all_items")
end

-- ç¼“å­˜å•ä¸ªå•†å“æ•°æ®
function CacheService.cacheShopItem(itemId, itemData, ttl)
    return CacheManager.set(CacheManager.Types.SHOP_ITEMS, itemId, itemData, ttl)
end

-- è·å–å•ä¸ªå•†å“æ•°æ®
function CacheService.getShopItem(itemId)
    return CacheManager.get(CacheManager.Types.SHOP_ITEMS, itemId)
end

-- åˆ·æ–°å•†åº—ç¼“å­˜
function CacheService.refreshShopCache(notifyClients)
    notifyClients = notifyClients ~= false -- é»˜è®¤ä¸ºtrue

    CacheManager.refreshShopCache()

    if notifyClients then
        for _, player in pairs(Players:GetPlayers()) do
            Events.Cache.DataRefreshNotify:FireClient(player, {
                type = "shop_refresh",
                timestamp = os.time()
            })
        end
    end
end

-- ==============================================
-- ç®¡ç†å‘˜æƒé™ç¼“å­˜æ“ä½œ
-- ==============================================

-- ç¼“å­˜ç®¡ç†å‘˜æƒé™
function CacheService.cacheAdminPermission(userId, isAdmin, ttl)
    return CacheManager.set(CacheManager.Types.ADMIN_PERMISSIONS, userId, isAdmin, ttl)
end

-- è·å–ç®¡ç†å‘˜æƒé™
function CacheService.getAdminPermission(userId)
    return CacheManager.get(CacheManager.Types.ADMIN_PERMISSIONS, userId)
end

-- åˆ·æ–°ç®¡ç†å‘˜æƒé™ç¼“å­˜
function CacheService.refreshAdminCache()
    CacheManager.clear(CacheManager.Types.ADMIN_PERMISSIONS)
    print("ğŸ‘‘ [CacheService] ç®¡ç†å‘˜æƒé™ç¼“å­˜å·²åˆ·æ–°")
end

-- ==============================================
-- ç³»ç»Ÿé…ç½®ç¼“å­˜æ“ä½œ
-- ==============================================

-- ç¼“å­˜ç³»ç»Ÿé…ç½®
function CacheService.cacheSystemConfig(configKey, configValue, ttl)
    local success = CacheManager.set(CacheManager.Types.SYSTEM_CONFIG, configKey, configValue, ttl)
    if success then
        -- é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯ç³»ç»Ÿé…ç½®å·²æ›´æ–°
        for _, player in pairs(Players:GetPlayers()) do
            Events.Cache.SystemConfigUpdated:FireClient(player, {
                configKey = configKey,
                timestamp = os.time()
            })
        end
    end
    return success
end

-- è·å–ç³»ç»Ÿé…ç½®
function CacheService.getSystemConfig(configKey)
    return CacheManager.get(CacheManager.Types.SYSTEM_CONFIG, configKey)
end

-- åˆ·æ–°ç³»ç»Ÿé…ç½®ç¼“å­˜
function CacheService.refreshSystemConfig()
    CacheManager.clear(CacheManager.Types.SYSTEM_CONFIG)

    for _, player in pairs(Players:GetPlayers()) do
        Events.Cache.DataRefreshNotify:FireClient(player, {
            type = "config_refresh",
            timestamp = os.time()
        })
    end

    print("âš™ï¸ [CacheService] ç³»ç»Ÿé…ç½®ç¼“å­˜å·²åˆ·æ–°")
end

-- ==============================================
-- äº¤æ˜“è®°å½•ç¼“å­˜æ“ä½œ
-- ==============================================

-- ç¼“å­˜ç”¨æˆ·äº¤æ˜“è®°å½•
function CacheService.cacheUserTransactions(userId, transactions, ttl)
    return CacheManager.set(CacheManager.Types.TRANSACTIONS, "user_" .. userId, transactions, ttl)
end

-- è·å–ç”¨æˆ·äº¤æ˜“è®°å½•
function CacheService.getUserTransactions(userId)
    return CacheManager.get(CacheManager.Types.TRANSACTIONS, "user_" .. userId)
end

-- ==============================================
-- æ‰¹é‡æ“ä½œå’Œç‰¹æ®ŠåŠŸèƒ½
-- ==============================================

-- æ‰¹é‡åˆ·æ–°å¤šä¸ªç”¨æˆ·çš„ç¼“å­˜
function CacheService.batchRefreshUserCache(userIds, notifyClients)
    notifyClients = notifyClients ~= false -- é»˜è®¤ä¸ºtrue

    local totalCleared = 0
    for _, userId in ipairs(userIds) do
        totalCleared = totalCleared + CacheService.refreshUserCache(userId, false)
    end

    -- æ‰¹é‡é€šçŸ¥å®¢æˆ·ç«¯
    if notifyClients then
        for _, userId in ipairs(userIds) do
            local player = Players:GetPlayerByUserId(tonumber(userId))
            if player then
                Events.Cache.DataRefreshNotify:FireClient(player, {
                    type = "batch_refresh",
                    userId = userId,
                    timestamp = os.time()
                })
            end
        end
    end

    print("ğŸ”„ [CacheService] æ‰¹é‡åˆ·æ–°ç”¨æˆ·ç¼“å­˜ï¼Œç”¨æˆ·æ•°:", #userIds, "æ¸…ç†é¡¹ç›®:", totalCleared)
    return totalCleared
end

-- å…¨å±€æ•°æ®åˆ·æ–°ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
function CacheService.globalRefresh()
    local stats = CacheManager.getStats()
    local totalCleared = CacheManager.clearAll()

    -- é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯è¿›è¡Œå…¨å±€åˆ·æ–°
    for _, player in pairs(Players:GetPlayers()) do
        Events.Cache.DataRefreshNotify:FireClient(player, {
            type = "global_refresh",
            clearedCount = totalCleared,
            timestamp = os.time()
        })
    end

    print("ğŸŒ [CacheService] å…¨å±€ç¼“å­˜åˆ·æ–°ï¼Œæ¸…ç†é¡¹ç›®:", totalCleared)
    return totalCleared
end

-- é¢„çƒ­ç¼“å­˜ï¼ˆåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶é¢„åŠ è½½å¸¸ç”¨æ•°æ®ï¼‰
function CacheService.warmupCache()
    print("ğŸ”¥ [CacheService] å¼€å§‹é¢„çƒ­ç¼“å­˜...")

    -- è¿™é‡Œå¯ä»¥é¢„åŠ è½½ä¸€äº›å¸¸ç”¨æ•°æ®ï¼Œæ¯”å¦‚ï¼š
    -- - å•†å“ä¿¡æ¯
    -- - ç³»ç»Ÿé…ç½®
    -- - åœ¨çº¿ç”¨æˆ·çš„åŸºç¡€æ•°æ®

    spawn(function()
        -- é¢„çƒ­å•†å“æ•°æ®
        local DataStoreManager = require(game:GetService("ServerScriptService").Server.datastoreservice.DataStoreManager)
        local shopItems = DataStoreManager.getAllItems()
        if shopItems then
            CacheService.cacheShopItems(shopItems, 1800) -- 30åˆ†é’Ÿ
            print("ğŸ›’ [CacheService] å•†å“æ•°æ®å·²é¢„çƒ­")
        end

        -- é¢„çƒ­ç³»ç»Ÿé…ç½®
        local allConfigs = DataStoreManager.getAllSystemConfig()
        if allConfigs then
            for key, config in pairs(allConfigs) do
                CacheService.cacheSystemConfig(key, config, 3600) -- 1å°æ—¶
            end
            print("âš™ï¸ [CacheService] ç³»ç»Ÿé…ç½®å·²é¢„çƒ­")
        end

        -- é¢„çƒ­åœ¨çº¿ç”¨æˆ·æ•°æ®
        for _, player in pairs(Players:GetPlayers()) do
            local userId = tostring(player.UserId)
            local userData = DataStoreManager.getUserData(userId)
            if userData then
                CacheService.cacheUserData(userId, userData, 600) -- 10åˆ†é’Ÿ
            end
        end
        print("ğŸ‘¤ [CacheService] åœ¨çº¿ç”¨æˆ·æ•°æ®å·²é¢„çƒ­")
    end)

    print("âœ… [CacheService] ç¼“å­˜é¢„çƒ­ä»»åŠ¡å·²å¯åŠ¨")
end

-- ==============================================
-- äº‹ä»¶å¤„ç†å™¨
-- ==============================================

-- å¤„ç†å®¢æˆ·ç«¯å¼ºåˆ¶åˆ·æ–°è¯·æ±‚
local function handleForceRefresh(player, refreshType, targetId)
    local userId = tostring(player.UserId)

    print("ğŸ”„ [CacheService] æ”¶åˆ°å¼ºåˆ¶åˆ·æ–°è¯·æ±‚:", player.Name, refreshType, targetId)

    if refreshType == "user" then
        -- åˆ·æ–°ç”¨æˆ·è‡ªå·±çš„ç¼“å­˜
        CacheService.refreshUserCache(userId)

    elseif refreshType == "shop" then
        -- åˆ·æ–°å•†åº—ç¼“å­˜ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
        local AdminService = require(game:GetService("ServerScriptService").Server.services.AdminService)
        if AdminService.isValidAdmin(player) then
            CacheService.refreshShopCache()
        else
            print("âš ï¸ [CacheService] éç®¡ç†å‘˜å°è¯•åˆ·æ–°å•†åº—ç¼“å­˜:", player.Name)
        end

    elseif refreshType == "config" then
        -- åˆ·æ–°ç³»ç»Ÿé…ç½®ç¼“å­˜ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
        local AdminService = require(game:GetService("ServerScriptService").Server.services.AdminService)
        if AdminService.isValidAdmin(player) then
            CacheService.refreshSystemConfig()
        else
            print("âš ï¸ [CacheService] éç®¡ç†å‘˜å°è¯•åˆ·æ–°ç³»ç»Ÿé…ç½®:", player.Name)
        end

    elseif refreshType == "all" then
        -- å…¨å±€åˆ·æ–°ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
        local AdminService = require(game:GetService("ServerScriptService").Server.services.AdminService)
        if AdminService.isValidAdmin(player) then
            CacheService.globalRefresh()
        else
            print("âš ï¸ [CacheService] éç®¡ç†å‘˜å°è¯•å…¨å±€åˆ·æ–°:", player.Name)
        end
    end
end

-- å¤„ç†ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯è¯·æ±‚
local function handleGetCacheStats(player)
    -- éœ€è¦ç®¡ç†å‘˜æƒé™
    local AdminService = require(game:GetService("ServerScriptService").Server.services.AdminService)
    if not AdminService.isValidAdmin(player) then
        return {
            success = false,
            error = "æƒé™ä¸è¶³"
        }
    end

    local stats = CacheManager.getStats()
    return {
        success = true,
        stats = stats
    }
end

-- å¤„ç†ç¼“å­˜ç®¡ç†æ“ä½œ
local function handleManageCache(player, action, params)
    -- éœ€è¦ç®¡ç†å‘˜æƒé™
    local AdminService = require(game:GetService("ServerScriptService").Server.services.AdminService)
    if not AdminService.isValidAdmin(player) then
        print("âš ï¸ [CacheService] éç®¡ç†å‘˜å°è¯•ç¼“å­˜ç®¡ç†æ“ä½œ:", player.Name, action)
        return
    end

    print("ğŸ‘‘ [CacheService] ç®¡ç†å‘˜ç¼“å­˜æ“ä½œ:", player.Name, action)

    if action == "clear_user" and params.userId then
        CacheService.refreshUserCache(params.userId)

    elseif action == "clear_type" and params.cacheType then
        CacheManager.clear(params.cacheType)

    elseif action == "clear_all" then
        CacheService.globalRefresh()

    elseif action == "warmup" then
        CacheService.warmupCache()

    elseif action == "cleanup" then
        CacheManager.cleanupExpired()

    elseif action == "stats" then
        CacheManager.printStats()

    else
        print("âš ï¸ [CacheService] æœªçŸ¥çš„ç¼“å­˜ç®¡ç†æ“ä½œ:", action)
    end
end

-- ==============================================
-- ç©å®¶è¿æ¥å’Œæ–­å¼€å¤„ç†
-- ==============================================

-- å¤„ç†ç©å®¶åŠ å…¥
function CacheService.onPlayerAdded(player)
    local userId = tostring(player.UserId)
    print("ğŸ‘¤ [CacheService] ç©å®¶åŠ å…¥ï¼Œå‡†å¤‡é¢„çƒ­ç¼“å­˜:", player.Name)

    -- å¼‚æ­¥é¢„çƒ­ç”¨æˆ·æ•°æ®
    spawn(function()
        wait(2) -- ç­‰å¾…ç©å®¶å®Œå…¨åŠ è½½

        -- é¢„çƒ­ç”¨æˆ·åŸºç¡€æ•°æ®
        local DataStoreManager = require(game:GetService("ServerScriptService").Server.datastoreservice.DataStoreManager)
        local userData = DataStoreManager.getUserData(userId)
        if userData then
            CacheService.cacheUserData(userId, userData)
            print("âœ… [CacheService] é¢„çƒ­ç”¨æˆ·æ•°æ®:", player.Name)
        end
    end)
end

-- å¤„ç†ç©å®¶ç¦»å¼€
function CacheService.onPlayerRemoving(player)
    local userId = tostring(player.UserId)
    print("ğŸ‘¤ [CacheService] ç©å®¶ç¦»å¼€ï¼Œæ¸…ç†ç¼“å­˜:", player.Name)

    -- å»¶è¿Ÿæ¸…ç†ç”¨æˆ·ç¼“å­˜ï¼ˆç»™å…¶ä»–æœåŠ¡å™¨ä¸€äº›æ—¶é—´æ¥åŒæ­¥æ•°æ®ï¼‰
    spawn(function()
        wait(300) -- 5åˆ†é’Ÿåæ¸…ç†
        CacheService.refreshUserCache(userId, false) -- ä¸é€šçŸ¥å®¢æˆ·ç«¯
        print("ğŸ§¹ [CacheService] å·²æ¸…ç†ç¦»çº¿ç”¨æˆ·ç¼“å­˜:", userId)
    end)
end

-- ==============================================
-- æ¨¡å—åˆå§‹åŒ–
-- ==============================================

function CacheService.initialize()
    print("ğŸš€ [CacheService] åˆå§‹åŒ–ç¼“å­˜æœåŠ¡...")

    -- è¿æ¥äº‹ä»¶å¤„ç†å™¨
    Events.Cache.ForceRefresh.OnServerEvent:Connect(handleForceRefresh)
    Events.Cache.GetCacheStats.OnServerInvoke = handleGetCacheStats
    Events.Cache.ManageCache.OnServerEvent:Connect(handleManageCache)

    -- è¿æ¥ç©å®¶äº‹ä»¶
    Players.PlayerAdded:Connect(CacheService.onPlayerAdded)
    Players.PlayerRemoving:Connect(CacheService.onPlayerRemoving)

    -- å¯åŠ¨ç¼“å­˜é¢„çƒ­
    spawn(function()
        wait(5) -- ç­‰å¾…å…¶ä»–æœåŠ¡åˆå§‹åŒ–å®Œæˆ
        CacheService.warmupCache()
    end)

    print("âœ… [CacheService] ç¼“å­˜æœåŠ¡åˆå§‹åŒ–å®Œæˆ")
end

-- ==============================================
-- å¯¼å‡ºæ¥å£
-- ==============================================

-- å¯¼å‡ºç¼“å­˜ç±»å‹å¸¸é‡
CacheService.Types = CacheManager.Types

-- å¯¼å‡ºåº•å±‚CacheManagerå¼•ç”¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
CacheService.Manager = CacheManager

-- å¯åŠ¨åˆå§‹åŒ–
spawn(function()
    wait(2) -- ç­‰å¾…CacheManageråˆå§‹åŒ–
    CacheService.initialize()
end)

return CacheService
