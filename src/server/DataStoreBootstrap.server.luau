-- DataStore ç³»ç»Ÿå¯åŠ¨è„šæœ¬
-- æ›¿æ¢åŸæœ‰çš„ MySQL + API æ¶æ„

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- ç­‰å¾…å…±äº«æ¨¡å—åŠ è½½
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")

-- åˆå§‹åŒ– DataStore ç®¡ç†å™¨
local DataStoreManager = require(script.Parent.modules.DataStoreManager)
local UserDataService = require(script.Parent.modules.UserDataService)
local AdminDataService = require(script.Parent.modules.AdminDataService)
local ItemsInitializer = require(script.Parent.modules.ItemsInitializer)

-- å¯åŠ¨ DataStore ç³»ç»Ÿ
DataStoreManager.initialize()

print("ğŸš€ DataStore å•†åº—ç³»ç»Ÿå¯åŠ¨ä¸­...")

-- ç­‰å¾…æ¨¡å—å®Œå…¨åŠ è½½
wait(2)

-- åˆå§‹åŒ–ç®¡ç†å‘˜æƒé™ï¼ˆæ ¹æ®é…ç½®æ–‡ä»¶è‡ªåŠ¨è®¾ç½®ï¼‰
spawn(function()
    wait(3) -- ç­‰å¾…AdminServiceå®Œå…¨åˆå§‹åŒ–

    local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
    local Config = require(SharedModules:WaitForChild("Config"))

    -- ä»é…ç½®æ–‡ä»¶è·å–é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·å
    local defaultAdminUsernames = Config.ADMIN.DEFAULT_ADMIN_USERNAMES or {}

    if #defaultAdminUsernames > 0 then
        print("ğŸ”§ [ç³»ç»Ÿ] å¼€å§‹åˆå§‹åŒ–é»˜è®¤ç®¡ç†å‘˜...")

        -- ç­‰å¾…ç©å®¶åŠ å…¥æ¥è®¾ç½®ç®¡ç†å‘˜æƒé™
        local function setupAdminForUsername(targetUsername)
            -- æ£€æŸ¥ç©å®¶æ˜¯å¦å·²ç»åœ¨çº¿
            for _, player in pairs(Players:GetPlayers()) do
                if player.Name == targetUsername then
                    local success = pcall(function()
                        AdminDataService.promoteToAdmin(tostring(player.UserId))
                    end)

                    if success then
                        print("âœ… [ç³»ç»Ÿ] åœ¨çº¿ç”¨æˆ·ç®¡ç†å‘˜è®¾ç½®æˆåŠŸ:", targetUsername, "(" .. player.UserId .. ")")
                    else
                        print("âŒ [ç³»ç»Ÿ] åœ¨çº¿ç”¨æˆ·ç®¡ç†å‘˜è®¾ç½®å¤±è´¥:", targetUsername)
                    end
                    return true
                end
            end
            return false
        end

        -- å¤„ç†å½“å‰åœ¨çº¿çš„ç©å®¶
        for _, adminUsername in ipairs(defaultAdminUsernames) do
            if adminUsername and adminUsername ~= "" then
                if not setupAdminForUsername(adminUsername) then
                    print("ğŸ“‹ [ç³»ç»Ÿ] ç®¡ç†å‘˜ç”¨æˆ·", adminUsername, "å½“å‰ä¸åœ¨çº¿ï¼Œå°†åœ¨å…¶åŠ å…¥æ—¶è‡ªåŠ¨è®¾ç½®")
                end
            end
        end

        print("ğŸ”§ [ç³»ç»Ÿ] é»˜è®¤ç®¡ç†å‘˜åˆå§‹åŒ–é…ç½®å®Œæˆï¼Œå…±", #defaultAdminUsernames, "ä¸ªç®¡ç†å‘˜ç”¨æˆ·å")
        print("ğŸ“‹ [ç³»ç»Ÿ] ç®¡ç†å‘˜åˆ—è¡¨:", table.concat(defaultAdminUsernames, ", "))
    else
        print("âš ï¸ [ç³»ç»Ÿ] æ²¡æœ‰é…ç½®é»˜è®¤ç®¡ç†å‘˜ï¼Œè¯·åœ¨Config.ADMIN.DEFAULT_ADMIN_USERNAMESä¸­æ·»åŠ ç®¡ç†å‘˜ç”¨æˆ·å")
    end

    -- å°†ç®¡ç†å‘˜ç”¨æˆ·ååˆ—è¡¨æš´éœ²ç»™å…¨å±€ï¼Œä¾›ç©å®¶è¿æ¥å¤„ç†ä½¿ç”¨
    _G.DefaultAdminUsernames = defaultAdminUsernames
end)

-- ç©å®¶è¿æ¥å¤„ç†
Players.PlayerAdded:Connect(function(player)
    spawn(function()
        -- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿ç³»ç»Ÿå®Œå…¨å¯åŠ¨
        wait(1)

        print("ğŸ‘‹ ç©å®¶åŠ å…¥:", player.Name, "(" .. player.UserId .. ")")

        -- æ£€æŸ¥æ˜¯å¦éœ€è¦è®¾ç½®ç®¡ç†å‘˜æƒé™
        local defaultAdminUsernames = _G.DefaultAdminUsernames or {}
        local shouldPromoteToAdmin = false

        for _, adminUsername in ipairs(defaultAdminUsernames) do
            if player.Name == adminUsername then
                shouldPromoteToAdmin = true
                break
            end
        end

        -- è‡ªåŠ¨åˆ›å»ºæˆ–ç™»å½•ç”¨æˆ·
        local success, result = pcall(function()
            return UserDataService.createOrLoginUser(
                tostring(player.UserId),
                player.Name,
                player.DisplayName ~= player.Name and player.DisplayName or nil
            )
        end)

        if success and result then
            if result.isNewUser then
                print("ğŸ‰ æ–°ç”¨æˆ·æ³¨å†Œ:", player.Name)
                -- å¯ä»¥åœ¨è¿™é‡Œç»™æ–°ç”¨æˆ·ä¸€äº›æ¬¢è¿å¥–åŠ±
            else
                print("âœ… ç”¨æˆ·ç™»å½•:", player.Name)
            end

            -- å¦‚æœéœ€è¦ï¼Œè®¾ç½®ç®¡ç†å‘˜æƒé™
            if shouldPromoteToAdmin then
                spawn(function()
                    wait(1) -- ç­‰å¾…ç”¨æˆ·æ•°æ®å®Œå…¨åŠ è½½
                    local adminSuccess = pcall(function()
                        AdminDataService.promoteToAdmin(tostring(player.UserId))
                    end)

                    if adminSuccess then
                        print("âœ… [è‡ªåŠ¨] ç®¡ç†å‘˜æƒé™è®¾ç½®æˆåŠŸ:", player.Name, "(" .. player.UserId .. ")")
                    else
                        print("âŒ [è‡ªåŠ¨] ç®¡ç†å‘˜æƒé™è®¾ç½®å¤±è´¥:", player.Name)
                    end
                end)
            end

            -- è‡ªåŠ¨å¤„ç†æ¯æ—¥ç™»å½•å¥–åŠ±
            spawn(function()
                wait(2) -- ç­‰å¾…ä¸€ä¸‹å†å¤„ç†å¥–åŠ±
                local rewardSuccess, rewardResult = pcall(function()
                    return UserDataService.processLoginRewards(tostring(player.UserId))
                end)

                if rewardSuccess and rewardResult and rewardResult.success and rewardResult.totalRewards > 0 then
                    print("ğŸ ç©å®¶", player.Name, "è·å¾—æ¯æ—¥å¥–åŠ±:", rewardResult.totalRewards, "é‡‘å¸")
                end
            end)
        else
            warn("âŒ ç”¨æˆ·ç™»å½•å¤±è´¥:", player.Name, result or "æœªçŸ¥é”™è¯¯")
        end
    end)
end)

-- ç©å®¶ç¦»å¼€å¤„ç†
Players.PlayerRemoving:Connect(function(player)
    print("ğŸ‘‹ ç©å®¶ç¦»å¼€:", player.Name)
    -- DataStore ä¼šè‡ªåŠ¨å¤„ç†æ•°æ®ä¿å­˜ï¼Œè¿™é‡Œä¸éœ€è¦ç‰¹åˆ«æ“ä½œ
end)

-- å®šæœŸä¿å­˜ç³»ç»Ÿç»Ÿè®¡ï¼ˆå¯é€‰ï¼‰
spawn(function()
    while true do
        wait(300) -- æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ç»Ÿè®¡

        pcall(function()
            local stats = AdminDataService.getCompleteSystemStats()
            if stats then
                print("ğŸ“Š ç³»ç»Ÿç»Ÿè®¡æ›´æ–°:",
                    "ç”¨æˆ·æ•°:", stats.users.total_users,
                    "æ´»è·ƒç”¨æˆ·:", stats.users.active_users,
                    "æ€»äº¤æ˜“:", stats.transactions.total_transactions
                )
            end
        end)
    end
end)

print("ğŸ¯ DataStore å•†åº—ç³»ç»Ÿå¯åŠ¨å®Œæˆï¼")

-- æ˜¾ç¤ºå•†å“åˆå§‹åŒ–ç»Ÿè®¡
spawn(function()
    wait(3) -- ç­‰å¾…å•†å“åˆå§‹åŒ–å®Œæˆ
    local totalItems = ItemsInitializer.getTotalItemCount()
    local categories = ItemsInitializer.getAllCategories()

    print("ğŸ›’ å•†å“ç³»ç»Ÿç»Ÿè®¡ï¼š")
    print("   â€¢ æ€»å•†å“æ•°é‡ï¼š", totalItems, "ä¸ª")
    print("   â€¢ å•†å“åˆ†ç±»ï¼š", #categories, "ä¸ª")
    for _, category in ipairs(categories) do
        local count = ItemsInitializer.getCategoryItemCount(category)
        print("     -", category .. ":", count, "ä¸ªå•†å“")
    end
end)

print("ğŸ“ ç³»ç»Ÿè¯´æ˜ï¼š")
print("   â€¢ ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨ DataStoreService ä¸­")
print("   â€¢ Studio ç¯å¢ƒä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å­˜å‚¨ï¼ˆæ•°æ®ä¸æŒä¹…åŒ–ï¼‰")
print("   â€¢ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå® DataStoreï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰")
print("   â€¢ ç®¡ç†å‘˜æƒé™é€šè¿‡ç”¨æˆ·æ•°æ®ä¸­çš„ isAdmin å­—æ®µæ§åˆ¶")
print("   â€¢ ç³»ç»Ÿé…ç½®å¯é€šè¿‡ DataStoreManager ä¿®æ”¹")
print("   â€¢ æ–°ç”¨æˆ·åˆå§‹é‡‘å¸ï¼š1000ï¼ˆæ ¹æ® init.sql é…ç½®ï¼‰")
print("   â€¢ å•†å“æ•°æ®å·²ä» init.sql å®Œæ•´è¿ç§»")
print("ğŸ”§ ç®¡ç†å‘˜è®¾ç½®æ–¹å¼ï¼š")
print("   1. åœ¨ Config.ADMIN.DEFAULT_ADMIN_USERNAMES ä¸­æ·»åŠ ç”¨æˆ·å")
print("   2. é‡å¯æœåŠ¡å™¨ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¾ç½®å¯¹åº”ç”¨æˆ·ä¸ºç®¡ç†å‘˜")
print("   3. æ‰‹åŠ¨è®¾ç½®ï¼šrequire(ServerScriptService.modules.AdminDataService).promoteToAdmin('ç”¨æˆ·ID')")
print("âš ï¸ æ³¨æ„ï¼šç”¨æˆ·åè®¾ç½®çš„ç®¡ç†å‘˜éœ€è¦è¯¥ç”¨æˆ·è‡³å°‘åŠ å…¥æ¸¸æˆä¸€æ¬¡æ‰èƒ½ç”Ÿæ•ˆ")
