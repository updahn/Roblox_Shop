-- å•†åº—ç³»ç»Ÿå…±äº«æ•°æ®å®šä¹‰
-- åŒ…å«å•†åº—ç›¸å…³çš„æ•°æ®ç»“æ„ã€å¸¸é‡å’Œå·¥å…·å‡½æ•°

local ShopData = {}

-- ==============================================
-- å•†å“ç±»åˆ«å®šä¹‰
-- ==============================================
ShopData.Categories = {
    WEAPONS = "weapons",        -- æ­¦å™¨ç±»
    ARMOR = "armor",           -- é˜²å…·ç±»
    CONSUMABLES = "consumables", -- æ¶ˆè€—å“ç±»
    MATERIALS = "materials",    -- ææ–™ç±»
    BOOKS = "books",           -- ä¹¦ç±ç±»
    TOOLS = "tools",           -- å·¥å…·ç±»
    MEMBERSHIP = "membership"   -- ä¼šå‘˜ç±»
}

-- ç±»åˆ«æ˜¾ç¤ºåç§°
ShopData.CategoryNames = {
    [ShopData.Categories.WEAPONS] = "âš”ï¸ æ­¦å™¨",
    [ShopData.Categories.ARMOR] = "ğŸ›¡ï¸ é˜²å…·",
    [ShopData.Categories.CONSUMABLES] = "ğŸ§ª æ¶ˆè€—å“",
    [ShopData.Categories.MATERIALS] = "ğŸ’ ææ–™",
    [ShopData.Categories.BOOKS] = "ğŸ“š ä¹¦ç±",
    [ShopData.Categories.TOOLS] = "ğŸ”§ å·¥å…·",
    [ShopData.Categories.MEMBERSHIP] = "ğŸ‘‘ ä¼šå‘˜"
}

-- ==============================================
-- äº¤æ˜“ç±»å‹å®šä¹‰
-- ==============================================
ShopData.TransactionTypes = {
    BUY = "buy",
    SELL = "sell"
}

-- ==============================================
-- æ•°æ®éªŒè¯å‡½æ•°
-- ==============================================

-- éªŒè¯å•†å“æ•°æ®ç»“æ„
function ShopData.validateItem(item)
    if type(item) ~= "table" then
        return false, "å•†å“æ•°æ®å¿…é¡»æ˜¯è¡¨æ ¼ç±»å‹"
    end

    -- å¿…éœ€å­—æ®µéªŒè¯
    local requiredFields = {"id", "name", "price", "category"}
    for _, field in ipairs(requiredFields) do
        if not item[field] then
            return false, "ç¼ºå°‘å¿…éœ€å­—æ®µ: " .. field
        end
    end

    -- ç±»å‹éªŒè¯
    if type(item.price) ~= "number" or item.price < 0 then
        return false, "ä»·æ ¼å¿…é¡»æ˜¯éè´Ÿæ•°å­—"
    end

    if not ShopData.Categories[string.upper(item.category)] and
       not ShopData.CategoryNames[item.category] then
        return false, "æ— æ•ˆçš„å•†å“ç±»åˆ«: " .. tostring(item.category)
    end

    return true
end

-- éªŒè¯äº¤æ˜“æ•°æ®
function ShopData.validateTransaction(transaction)
    if type(transaction) ~= "table" then
        return false, "äº¤æ˜“æ•°æ®å¿…é¡»æ˜¯è¡¨æ ¼ç±»å‹"
    end

    local requiredFields = {"id", "playerId", "itemId", "quantity", "type", "timestamp"}
    for _, field in ipairs(requiredFields) do
        if not transaction[field] then
            return false, "ç¼ºå°‘å¿…éœ€å­—æ®µ: " .. field
        end
    end

    -- äº¤æ˜“ç±»å‹éªŒè¯
    local validTypes = {
        [ShopData.TransactionTypes.BUY] = true,
        [ShopData.TransactionTypes.SELL] = true
    }

    if not validTypes[transaction.type] then
        return false, "æ— æ•ˆçš„äº¤æ˜“ç±»å‹: " .. tostring(transaction.type)
    end

    return true
end

-- ==============================================
-- å·¥å…·å‡½æ•°
-- ==============================================

-- è·å–ç±»åˆ«æ˜¾ç¤ºåç§°
function ShopData.getCategoryDisplayName(category)
    return ShopData.CategoryNames[category] or category
end

-- æ ¼å¼åŒ–ä»·æ ¼æ˜¾ç¤º
function ShopData.formatPrice(price)
    if not price or type(price) ~= "number" then
        return "0"
    end

    -- æ ¼å¼åŒ–å¤§æ•°å­—ï¼ˆåƒã€ä¸‡ã€åä¸‡ç­‰ï¼‰
    if price >= 10000 then
        return string.format("%.1fä¸‡", price / 10000)
    elseif price >= 1000 then
        return string.format("%.1fK", price / 1000)
    else
        return tostring(price)
    end
end

-- è®¡ç®—å–å‡ºä»·æ ¼
function ShopData.calculateSellPrice(buyPrice, sellRate)
    sellRate = sellRate or 0.8 -- é»˜è®¤80%çš„å–å‡ºç‡
    if not buyPrice or type(buyPrice) ~= "number" or buyPrice <= 0 then
        return 0
    end
    return math.max(1, math.floor(buyPrice * sellRate))
end

-- æ£€æŸ¥å•†å“æ˜¯å¦å¯ä»¥å–å‡º
function ShopData.canSellItem(item)
    if not item then return false end

    -- æ£€æŸ¥canSellå­—æ®µ
    if item.canSell ~= nil then
        return item.canSell
    end

    -- é»˜è®¤æƒ…å†µä¸‹ï¼Œä»·æ ¼å¤§äº0çš„å•†å“å¯ä»¥å–å‡º
    return item.price and item.price > 0
end

-- æ ¼å¼åŒ–åº“å­˜æ˜¾ç¤º
function ShopData.formatStock(stock)
    if not stock or stock == -1 then
        return "âˆ"
    elseif stock == 0 then
        return "å”®ç½„"
    else
        return tostring(stock)
    end
end

-- ==============================================
-- å¸¸é‡å®šä¹‰
-- ==============================================

-- é»˜è®¤é…ç½®
ShopData.Defaults = {
    SELL_RATE = 0.8,           -- é»˜è®¤å–å‡ºç‡
    MAX_QUANTITY = 999,        -- æœ€å¤§è´­ä¹°æ•°é‡
    TRANSACTION_HISTORY_LIMIT = 50 -- äº¤æ˜“å†å²è®°å½•é™åˆ¶
}

-- UIç›¸å…³å¸¸é‡
ShopData.UI = {
    ITEM_FRAME_HEIGHT = 120,   -- å•†å“æ¡†æ¶é«˜åº¦
    PADDING = 10,              -- å†…è¾¹è·
    SCROLL_SPEED = 50          -- æ»šåŠ¨é€Ÿåº¦
}

print("ğŸ“¦ å•†åº—å…±äº«æ•°æ®æ¨¡å—å·²åŠ è½½")

return ShopData
