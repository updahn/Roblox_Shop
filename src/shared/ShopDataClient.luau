-- å•†åº—ç³»ç»Ÿå®¢æˆ·ç«¯æ•°æ®æ¨¡å—

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local ShopDataClient = {}

-- ç­‰å¾…å…±äº«æ¨¡å—ï¼Œä½¿ç”¨æ›´çŸ­çš„è¶…æ—¶æ—¶é—´é˜²æ­¢æ— é™ç­‰å¾…
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules", 5)
if not SharedModules then
    warn("âš ï¸ æ— æ³•åŠ è½½å…±äº«æ¨¡å—ï¼Œå®¢æˆ·ç«¯æ•°æ®æ¨¡å—å°†æ— æ³•æ­£å¸¸å·¥ä½œ")
    return {}
end

local Events = require(SharedModules:WaitForChild("ShopEvents", 5))
if not Events then
    warn("âš ï¸ æ— æ³•åŠ è½½Eventsæ¨¡å—ï¼Œå®¢æˆ·ç«¯æ•°æ®æ¨¡å—å°†æ— æ³•æ­£å¸¸å·¥ä½œ")
    return {}
end

-- æœ¬åœ°ç¼“å­˜
local playerData = nil
local shopData = {}
local membershipData = {}

-- äº‹ä»¶å›è°ƒå­˜å‚¨
local callbacks = {
    playerData = {},
    shopData = {},
    purchaseResult = {},
    sellResult = {},
    membershipData = {}
}

-- æ·»åŠ å›è°ƒå‡½æ•°
local function addCallback(callbackType, callback)
    table.insert(callbacks[callbackType], callback)
end

-- è§¦å‘å›è°ƒ
local function triggerCallbacks(callbackType, ...)
    for _, callback in ipairs(callbacks[callbackType]) do
        spawn(function()
            callback(...)
        end)
    end
end

-- å®¢æˆ·ç«¯APIæ¥å£

-- è·å–ç©å®¶æ•°æ®ï¼ˆå¼‚æ­¥ï¼‰
function ShopDataClient.getPlayerData(callback)
    if callback then
        addCallback("playerData", callback)
    end

    Events.User.GetPlayerData:FireServer()
end

-- è·å–å•†åº—æ•°æ®ï¼ˆå¼‚æ­¥ï¼‰
function ShopDataClient.getShopData(callback)
    if callback then
        addCallback("shopData", callback)
    end

    Events.User.GetShopData:FireServer()
end

-- åˆ·æ–°å•†åº—æ•°æ®
function ShopDataClient.refreshShopData(callback)
    if callback then
        addCallback("shopData", callback)
    end

    Events.User.RefreshData:FireServer()
end

-- è´­ä¹°ç‰©å“ï¼ˆå¼‚æ­¥ï¼‰
function ShopDataClient.buyItem(itemId, quantity, callback)
    if callback then
        addCallback("purchaseResult", callback)
    end

    Events.User.BuyItem:FireServer(itemId, quantity)
end

-- å–å‡ºç‰©å“ï¼ˆå¼‚æ­¥ï¼‰
function ShopDataClient.sellItem(itemId, quantity, callback)
    if callback then
        addCallback("sellResult", callback)
    end

    Events.User.SellItem:FireServer(itemId, quantity)
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–æ‰€æœ‰ç©å®¶æ•°æ®
function ShopDataClient.getAllPlayersData(callback)
    if callback then
        local connection
        connection = Events.Admin.GetAllUsers.OnClientEvent:Connect(function(data, errorMsg)
            connection:Disconnect()
            callback(data, errorMsg)
        end)
    end

    Events.Admin.GetAllUsers:FireServer()
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè®¾ç½®ç©å®¶é‡‘å¸
function ShopDataClient.setPlayerCoins(playerName, coins, callback)
    if callback then
        local connection
        connection = Events.Admin.SetUserCoins.OnClientEvent:Connect(function(success, message)
            connection:Disconnect()
            callback(success, message)
        end)
    end

    Events.Admin.SetUserCoins:FireServer(playerName, coins)
end

-- ç®¡ç†å‘˜åŠŸèƒ½ï¼šè·å–ä¼šå‘˜åˆ—è¡¨
function ShopDataClient.getAdminMembersList(page, limit, status, callback)
    if callback then
        local connection
        connection = Events.Admin.GetMembersList.OnClientEvent:Connect(function(success, response)
            connection:Disconnect()
            if success then
                callback(true, response)
            else
                callback(false, response and response.error or "è·å–ä¼šå‘˜åˆ—è¡¨å¤±è´¥")
            end
        end)
    end

    Events.Admin.GetMembersList:FireServer(page, limit, status)
end

-- è·å–ç¼“å­˜çš„æ•°æ®ï¼ˆåŒæ­¥ï¼‰
function ShopDataClient.getCachedPlayerData()
    return playerData
end

function ShopDataClient.getCachedShopData()
    return shopData
end

function ShopDataClient.getCachedMembershipData()
    return membershipData
end

-- è¿æ¥æœåŠ¡å™¨äº‹ä»¶
Events.User.GetPlayerData.OnClientEvent:Connect(function(data)
    playerData = data
    triggerCallbacks("playerData", data)
end)

Events.User.GetShopData.OnClientEvent:Connect(function(data)
    shopData = data or {}
    triggerCallbacks("shopData", data)
end)

Events.User.BuyItem.OnClientEvent:Connect(function(success, message, data)
    if success and data then
        playerData = data
    end
    triggerCallbacks("purchaseResult", success, message, data)
end)

Events.User.SellItem.OnClientEvent:Connect(function(success, message, data)
    if success and data then
        playerData = data
    end
    triggerCallbacks("sellResult", success, message, data)
end)

-- åˆå§‹åŒ–ï¼šè‡ªåŠ¨è·å–æ•°æ®
spawn(function()
    wait(1) -- ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è¿æ¥ç¨³å®š
    ShopDataClient.getPlayerData()
    ShopDataClient.getShopData()
end)

print("ğŸ“± å•†åº—å®¢æˆ·ç«¯æ•°æ®æ¨¡å—å·²åŠ è½½")

return ShopDataClient
