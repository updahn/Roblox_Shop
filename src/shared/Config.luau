--[[
å•†åº—ç³»ç»Ÿç»Ÿä¸€é…ç½®æ–‡ä»¶

æœ¬æ–‡ä»¶åŒ…å«æ‰€æœ‰ç³»ç»Ÿé…ç½®å‚æ•°ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†å•†åº—ç³»ç»Ÿçš„å„ç§è®¾ç½®ã€‚

åŒ…å«çš„é…ç½®æ¨¡å—ï¼š
- APIæœåŠ¡å™¨é…ç½®
- ç®¡ç†å‘˜æƒé™é…ç½®
- UIä¸»é¢˜å’Œæ ·å¼é…ç½®
- æ¸¸æˆç©æ³•é…ç½®
- è°ƒè¯•å’Œå¼€å‘é…ç½®
- æœ¬åœ°åŒ–é…ç½®
- å®‰å…¨é…ç½®

ç”¨æ³•ï¼š
  local Config = require(è·¯å¾„åˆ°è¯¥æ–‡ä»¶)
  Config.API.BASE_URL -- è·å–APIåŸºç¡€URL
--]]

local Config = {}

-- ==============================================
-- API æœåŠ¡å™¨é…ç½®
-- ç”¨äºé…ç½®ä¸åç«¯ API æœåŠ¡å™¨çš„é€šä¿¡å‚æ•°
-- ==============================================

Config.API = {
    -- åŸºç¡€URLé…ç½®
    BASE_URL = "http://47.243.109.39/api",

    -- è¯·æ±‚è¶…æ—¶é…ç½® (ç§’)
    TIMEOUT = 30,

    -- é‡è¯•é…ç½®
    RETRY_ATTEMPTS = 3,
    RETRY_DELAY = 2,

    -- è¯·æ±‚å¤´é…ç½®
    DEFAULT_HEADERS = {
        ["Content-Type"] = "application/json"
    },

    -- APIç«¯ç‚¹é…ç½®
    ENDPOINTS = {
        AUTH = "/auth",
        USERS = "/users",
        ITEMS = "/items",
        ADMIN = "/admin"
    }
}

-- ==============================================
-- ç®¡ç†å‘˜æƒé™é…ç½®
-- é€šè¿‡APIåŠ¨æ€åŠ è½½ç®¡ç†å‘˜ä¿¡æ¯ï¼Œæ”¯æŒç¼“å­˜æœºåˆ¶
-- ==============================================

Config.ADMIN = {
    -- æƒé™çº§åˆ«é…ç½®
    PERMISSIONS = {
        MANAGE_USERS = true,
        MANAGE_ITEMS = true,
        MANAGE_TRANSACTIONS = true,
        VIEW_ANALYTICS = true,
        SYSTEM_ADMIN = true
    },

    -- é…ç½®æ˜¯å¦å·²åŠ è½½
    _LOADED = false,
    _LAST_UPDATE = 0,
    _CACHE_DURATION = 300 -- ç¼“å­˜5åˆ†é’Ÿ
}

-- ==============================================
-- ç³»ç»Ÿé…ç½®ï¼ˆä»APIåŠ¨æ€åŠ è½½ï¼‰
-- æ”¯æŒè¦†ç›–æœ¬åœ°é»˜è®¤é…ç½®
-- ==============================================

Config.SYSTEM = {
    -- åŠ¨æ€è·å–çš„ç³»ç»Ÿé…ç½® (ä»APIåŠ è½½)
    _VALUES = {},

    -- é…ç½®æ˜¯å¦å·²åŠ è½½
    _LOADED = false,
    _LAST_UPDATE = 0,
    _CACHE_DURATION = 300 -- ç¼“å­˜5åˆ†é’Ÿ
}

-- ==============================================
-- UI ä¸»é¢˜å’Œæ ·å¼é…ç½®
-- å®šä¹‰å•†åº—ç•Œé¢çš„è§†è§‰æ ·å¼å’Œäº¤äº’æ•ˆæœ
-- ==============================================

Config.UI = {
    -- é¢œè‰²ä¸»é¢˜ - ç°ä»£æ·±è‰²è®¾è®¡
    COLORS = {
        -- ä¸»è‰²è°ƒ
        PRIMARY = Color3.fromRGB(25, 25, 35),       -- æ·±è‰²èƒŒæ™¯
        SECONDARY = Color3.fromRGB(35, 35, 45),     -- ä¸­ç­‰æ·±è‰²
        TERTIARY = Color3.fromRGB(45, 45, 55),      -- æµ…ä¸€ç‚¹çš„æ·±è‰²
        ACCENT = Color3.fromRGB(88, 166, 255),      -- ç°ä»£è“è‰²
        ACCENT_HOVER = Color3.fromRGB(108, 186, 255), -- æ‚¬åœè“è‰²
        SUCCESS = Color3.fromRGB(52, 211, 153),     -- ç°ä»£ç»¿è‰²
        WARNING = Color3.fromRGB(251, 191, 36),     -- ç°ä»£é»„è‰²
        ERROR = Color3.fromRGB(248, 113, 113),      -- ç°ä»£çº¢è‰²
        DANGER = Color3.fromRGB(239, 68, 68),       -- å±é™©çº¢è‰²

        -- æ–‡å­—é¢œè‰²
        TEXT_PRIMARY = Color3.fromRGB(248, 250, 252),    -- çº¯ç™½
        TEXT_SECONDARY = Color3.fromRGB(203, 213, 225),  -- æµ…ç°
        TEXT_MUTED = Color3.fromRGB(148, 163, 184),      -- ä¸­ç°
        TEXT_DARK = Color3.fromRGB(71, 85, 105),         -- æ·±ç°

        -- èƒŒæ™¯å’Œç‰¹æ•ˆ
        GLASS_BG = Color3.fromRGB(15, 15, 25),      -- æ¯›ç»ç’ƒèƒŒæ™¯
        OVERLAY = Color3.fromRGB(0, 0, 0),          -- é®ç½©
        GRADIENT_START = Color3.fromRGB(88, 166, 255), -- æ¸å˜å¼€å§‹
        GRADIENT_END = Color3.fromRGB(147, 51, 234),   -- æ¸å˜ç»“æŸ
    },

    -- éŸ³æ•ˆé…ç½®
    SOUNDS = {
        CLICK = "electronicpingshort.wav",
        SUCCESS = "victory.wav",
        ERROR = "splat.wav",
        VOLUME = {
            CLICK = 0.3,
            SUCCESS = 0.4,
            ERROR = 0.3
        }
    },

    -- åŠ¨ç”»é…ç½®
    ANIMATIONS = {
        DURATION = {
            FAST = 0.2,
            NORMAL = 0.4,
            SLOW = 0.6
        },
        EASING = {
            DEFAULT = Enum.EasingStyle.Quad,
            BOUNCE = Enum.EasingStyle.Back,
            ELASTIC = Enum.EasingStyle.Elastic
        }
    },

    -- UIå°ºå¯¸é…ç½®
    SIZES = {
        MAIN_FRAME = UDim2.new(0, 850, 0, 650),
        BUTTON_HEIGHT = 40,
        CORNER_RADIUS = 12,
        BORDER_WIDTH = 2
    }
}

-- ==============================================
-- æ¸¸æˆç©æ³•é…ç½®
-- å®šä¹‰æ¸¸æˆçš„ç»æµç³»ç»Ÿã€äº¤æ˜“è§„åˆ™å’Œæ•°æ®åŒæ­¥å‚æ•°
-- ==============================================

Config.GAME = {
    -- ç»æµç³»ç»Ÿé…ç½®
    ECONOMY = {
        STARTING_COINS = 3000,           -- æ–°ç©å®¶åˆå§‹é‡‘å¸
        SELL_RATE = 0.8,                 -- å–å‡ºä»·æ ¼æ¯”ä¾‹ (åŸä»·çš„80%)
        MAX_COINS = 999999,              -- é‡‘å¸ä¸Šé™
        MIN_COINS = 0                    -- é‡‘å¸ä¸‹é™
    },

    -- äº¤æ˜“é…ç½®
    TRADING = {
        MIN_QUANTITY = 1,                -- æœ€å°äº¤æ˜“æ•°é‡
        MAX_QUANTITY = 999,              -- æœ€å¤§äº¤æ˜“æ•°é‡
        TRANSACTION_HISTORY_LIMIT = 50   -- äº¤æ˜“è®°å½•ä¿ç•™æ•°é‡
    },

    -- æ•°æ®åŒæ­¥é…ç½®
    DATA_SYNC = {
        AUTO_SAVE_INTERVAL = 300,        -- è‡ªåŠ¨ä¿å­˜é—´éš”(ç§’)
        RETRY_COUNT = 3,                 -- å¤±è´¥é‡è¯•æ¬¡æ•°
        CACHE_DURATION = 60              -- ç¼“å­˜æ—¶é—´(ç§’)
    }
}

-- ==============================================
-- è°ƒè¯•å’Œå¼€å‘é…ç½®
-- æ§åˆ¶æ—¥å¿—è¾“å‡ºå’Œè°ƒè¯•åŠŸèƒ½ï¼Œä»…åœ¨Studioä¸­å¯ç”¨
-- ==============================================

Config.DEBUG = {
    -- æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
    ENABLED = game:GetService("RunService"):IsStudio(),

    -- æ—¥å¿—çº§åˆ«
    LOG_LEVEL = "INFO", -- "DEBUG", "INFO", "WARN", "ERROR"

    -- æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
    VERBOSE_ERRORS = true,

    -- æ˜¯å¦å¯ç”¨æ€§èƒ½ç›‘æ§
    PERFORMANCE_MONITORING = true,

    -- æµ‹è¯•æ•°æ®
    TEST_DATA = {
        USE_MOCK_API = false,
        MOCK_DELAY = 1000, -- æ¯«ç§’
        FAKE_NETWORK_ISSUES = false
    }
}

-- ==============================================
-- æœ¬åœ°åŒ–é…ç½®
-- ==============================================

Config.LOCALIZATION = {
    -- è´§å¸æ˜¾ç¤ºæ ¼å¼
    CURRENCY_FORMAT = {
        SYMBOL = "ğŸ’°",
        SEPARATOR = ",",
        DECIMAL_PLACES = 0
    }
}

-- åˆ é™¤äº†æœªä½¿ç”¨çš„å®‰å…¨é…ç½® - ç”±åç«¯APIå¤„ç†

-- ==============================================
-- å·¥å…·å‡½æ•°
-- æä¾›å„ç§å¸®åŠ©å‡½æ•°ç”¨äºé…ç½®ç®¡ç†å’Œæ•°æ®å¤„ç†
-- ==============================================

-- ç®¡ç†å‘˜éªŒè¯ç¼“å­˜
local adminValidationCache = {}
local ADMIN_CACHE_DURATION = 30

-- è·å–å®Œæ•´çš„API URL
function Config.getApiUrl(endpoint)
    return Config.API.BASE_URL .. endpoint
end

-- æ£€æŸ¥è°ƒè¯•æ¨¡å¼
function Config.isDebugMode()
    return Config.DEBUG.ENABLED
end

-- åˆ é™¤äº†æœ¬åœ°åŒ–æ–‡æœ¬å‡½æ•° - ç°åœ¨ä½¿ç”¨ä¸­æ–‡

--[[
ä»APIåŠ è½½ç®¡ç†å‘˜é…ç½®

è¯¥å‡½æ•°ä»åç«¯ API è·å–æœ€æ–°çš„ç®¡ç†å‘˜é…ç½®ä¿¡æ¯ï¼Œ
å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°†ä¿æŒä¹‹å‰çš„é…ç½®ã€‚

@return boolean - æ˜¯å¦æˆåŠŸåŠ è½½é…ç½®
--]]
function Config.loadAdminConfig()
    local HttpService = game:GetService("HttpService")
    local success, result = pcall(function()
        local response = HttpService:GetAsync(Config.getApiUrl("/config"))
        return HttpService:JSONDecode(response)
    end)

    if success and result.success then
        local adminConfig = result.data.admin
        if adminConfig then
            Config.ADMIN._LOADED = true
            Config.ADMIN._LAST_UPDATE = tick()

            Config.log("INFO", "ç®¡ç†å‘˜é…ç½®å·²ä»APIåŠ è½½", adminConfig)
            return true
        end
    else
        Config.log("ERROR", "åŠ è½½ç®¡ç†å‘˜é…ç½®å¤±è´¥", result)
    end

    return false
end

--[[
ä»APIåŠ è½½ç³»ç»Ÿé…ç½®

è¯¥å‡½æ•°ä»åç«¯ API è·å–æœ€æ–°çš„ç³»ç»Ÿé…ç½®ä¿¡æ¯ï¼Œ
å¹¶æ›´æ–°æœ¬åœ°ç¼“å­˜ã€‚å¯ç”¨äºè¦†ç›–é»˜è®¤çš„æ¸¸æˆé…ç½®ã€‚

@return boolean - æ˜¯å¦æˆåŠŸåŠ è½½é…ç½®
--]]
function Config.loadSystemConfig()
    local HttpService = game:GetService("HttpService")
    local success, result = pcall(function()
        local response = HttpService:GetAsync(Config.getApiUrl("/config"))
        return HttpService:JSONDecode(response)
    end)

    if success and result.success then
        local systemConfig = result.data.system
        if systemConfig then
            Config.SYSTEM._VALUES = systemConfig
            Config.SYSTEM._LOADED = true
            Config.SYSTEM._LAST_UPDATE = tick()

            -- æ›´æ–°æ¸¸æˆé…ç½®ä¸­çš„ç›¸å…³å€¼
            if systemConfig.default_user_coins then
                Config.GAME.ECONOMY.STARTING_COINS = tonumber(systemConfig.default_user_coins) or Config.GAME.ECONOMY.STARTING_COINS
            end
            if systemConfig.sell_rate then
                Config.GAME.ECONOMY.SELL_RATE = tonumber(systemConfig.sell_rate) or Config.GAME.ECONOMY.SELL_RATE
            end
            if systemConfig.max_coins then
                Config.GAME.ECONOMY.MAX_COINS = tonumber(systemConfig.max_coins) or Config.GAME.ECONOMY.MAX_COINS
            end

            Config.log("INFO", "ç³»ç»Ÿé…ç½®å·²ä»APIåŠ è½½", systemConfig)
            return true
        end
    else
        Config.log("ERROR", "åŠ è½½ç³»ç»Ÿé…ç½®å¤±è´¥", result)
    end

    return false
end

--[[
ç¡®ä¿ç³»ç»Ÿé…ç½®å·²åŠ è½½

æ£€æŸ¥é…ç½®æ˜¯å¦å·²åŠ è½½åŠæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœéœ€è¦åˆ™é‡æ–°åŠ è½½ã€‚
ä½¿ç”¨ç¼“å­˜æœºåˆ¶ä»¥é¿å…é¢‘ç¹çš„ API è¯·æ±‚ã€‚

@return boolean - é…ç½®æ˜¯å¦å¯ç”¨
--]]
function Config.ensureSystemConfigLoaded()
    local currentTime = tick()
    if not Config.SYSTEM._LOADED or
       (currentTime - Config.SYSTEM._LAST_UPDATE) > Config.SYSTEM._CACHE_DURATION then
        return Config.loadSystemConfig()
    end
    return true
end

--[[
è·å–ç³»ç»Ÿé…ç½®å€¼

è·å–æŒ‡å®šé”®çš„ç³»ç»Ÿé…ç½®å€¼ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›é»˜è®¤å€¼ã€‚

@param key string - é…ç½®é”®
@param defaultValue any - é»˜è®¤å€¼
@return any - é…ç½®å€¼
--]]
function Config.getSystemValue(key, defaultValue)
    Config.ensureSystemConfigLoaded()
    return Config.SYSTEM._VALUES[key] or defaultValue
end

--[[
ç¡®ä¿ç®¡ç†å‘˜é…ç½®å·²åŠ è½½

æ£€æŸ¥é…ç½®æ˜¯å¦å·²åŠ è½½åŠæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœéœ€è¦åˆ™é‡æ–°åŠ è½½ã€‚
ä½¿ç”¨ç¼“å­˜æœºåˆ¶ä»¥é¿å…é¢‘ç¹çš„ API è¯·æ±‚ã€‚

@return boolean - é…ç½®æ˜¯å¦å¯ç”¨
--]]
function Config.ensureAdminConfigLoaded()
    local currentTime = tick()
    if not Config.ADMIN._LOADED or
       (currentTime - Config.ADMIN._LAST_UPDATE) > Config.ADMIN._CACHE_DURATION then
        return Config.loadAdminConfig()
    end
    return true
end

--[[
å®¢æˆ·ç«¯ç®¡ç†å‘˜æƒé™éªŒè¯å‡½æ•°
é€šè¿‡ RemoteFunction å‘æœåŠ¡å™¨æŸ¥è¯¢æƒé™ï¼Œå¸¦ç¼“å­˜æœºåˆ¶
--]]
function Config.isValidAdmin(player)
    local RunService = game:GetService("RunService")

    if RunService:IsServer() then
        -- æœåŠ¡å™¨ç«¯ç›´æ¥è¿”å›falseï¼Œåº”è¯¥ä½¿ç”¨ AdminService.isValidAdmin
        warn("åœ¨æœåŠ¡å™¨ç«¯è°ƒç”¨ Config.isValidAdminï¼Œè¯·ä½¿ç”¨ AdminService.isValidAdmin")
        return false
    else
        local cacheKey = player.Name
        local currentTime = tick()

        -- æ£€æŸ¥ç¼“å­˜
        if adminValidationCache[cacheKey] then
            local cacheData = adminValidationCache[cacheKey]
            if (currentTime - cacheData.timestamp) < ADMIN_CACHE_DURATION then
                -- ç¼“å­˜è¿˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
                return cacheData.isAdmin
            end
        end

        -- å®¢æˆ·ç«¯é€šè¿‡ RemoteFunction æŸ¥è¯¢
        local ReplicatedStorage = game:GetService("ReplicatedStorage")

        print("ğŸ” [Config] å®¢æˆ·ç«¯æƒé™æ£€æŸ¥:", player.Name)

        local success, Events = pcall(function()
            return require(ReplicatedStorage:WaitForChild("SharedModules"):WaitForChild("ShopEvents"))
        end)

        if not success or not Events then
            print("âŒ [Config] æ— æ³•åŠ è½½Eventsæ¨¡å—")
            return false
        end

        local checkAdminRemote = Events.Admin and Events.Admin.CheckPermission
        if not checkAdminRemote then
            print("âŒ [Config] æ‰¾ä¸åˆ°æƒé™æ£€æŸ¥RemoteFunction")
            return false
        end

        local success, result = pcall(function()
            return checkAdminRemote:InvokeServer()
        end)

        if success then
            -- ç¼“å­˜ç»“æœ
            adminValidationCache[cacheKey] = {
                isAdmin = result,
                timestamp = currentTime
            }
            print("âœ… [Config] æƒé™æ£€æŸ¥å®Œæˆ:", player.Name, "->", result)
            return result
        else
            print("âŒ [Config] æƒé™æ£€æŸ¥å¤±è´¥:", player.Name, "é”™è¯¯:", result)
            return false
        end
    end
end

--[[
æ ¼å¼åŒ–è´§å¸æ˜¾ç¤º

å°†æ•°å­—é‡‘é¢è½¬æ¢ä¸ºæ ¼å¼åŒ–çš„è´§å¸å­—ç¬¦ä¸²ã€‚
ä¼šè‡ªåŠ¨æ·»åŠ åƒä½åˆ†éš”ç¬¦å’Œè´§å¸ç¬¦å·ã€‚

@param amount number - è¦æ ¼å¼åŒ–çš„é‡‘é¢
@return string - æ ¼å¼åŒ–åçš„è´§å¸å­—ç¬¦ä¸²

ä¾‹å­ï¼š
  Config.formatCurrency(12345) -> "ğŸ’° 12,345"
--]]
function Config.formatCurrency(amount)
    local formatted = tostring(amount)
    local symbol = Config.LOCALIZATION.CURRENCY_FORMAT.SYMBOL
    local separator = Config.LOCALIZATION.CURRENCY_FORMAT.SEPARATOR

    -- æ·»åŠ åƒä½åˆ†éš”ç¬¦
    while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", "%1" .. separator .. "%2")
        if k == 0 then break end
    end

    return symbol .. " " .. formatted
end

--[[
å¼ºåˆ¶åˆ·æ–°ç®¡ç†å‘˜æƒé™ç¼“å­˜
ç”¨äºå®ç°å®æ—¶æ›´æ–°ç®¡ç†å‘˜æƒé™åˆ¤æ–­

@param player Player - è¦åˆ·æ–°æƒé™çš„ç©å®¶
--]]
function Config.refreshAdminCache(player)
    if player and player.Name then
        local cacheKey = player.Name
        -- æ¸…é™¤ç¼“å­˜
        adminValidationCache[cacheKey] = nil
        print("ğŸ”„ [è°ƒè¯•] å·²æ¸…é™¤", player.Name, "çš„ç®¡ç†å‘˜æƒé™ç¼“å­˜")
    else
        -- æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        adminValidationCache = {}
        print("ğŸ”„ [è°ƒè¯•] å·²æ¸…é™¤æ‰€æœ‰ç®¡ç†å‘˜æƒé™ç¼“å­˜")
    end
end

-- åˆ é™¤äº†æœ¬åœ°ç®¡ç†å‘˜ç®¡ç†å‡½æ•° - ä½¿ç”¨APIéªŒè¯

--[[
ç»Ÿä¸€æ—¥å¿—è®°å½•å‡½æ•°

æ ¹æ®é…ç½®çš„æ—¥å¿—çº§åˆ«è¾“å‡ºæ—¥å¿—ä¿¡æ¯ã€‚
ä»…åœ¨è°ƒè¯•æ¨¡å¼å¯ç”¨æ—¶æ‰ä¼šå®é™…è¾“å‡ºæ—¥å¿—ã€‚

@param level string - æ—¥å¿—çº§åˆ«ï¼ˆ"DEBUG", "INFO", "WARN", "ERROR"ï¼‰
@param message string - æ—¥å¿—æ¶ˆæ¯
@param data table|nil - å¯é€‰çš„é™„åŠ æ•°æ®ï¼Œä¼šè¢«åºåˆ—åŒ–ä¸ºJSON

ä¾‹å­ï¼š
  Config.log("INFO", "ç³»ç»Ÿå¯åŠ¨")
  Config.log("ERROR", "APIè¯·æ±‚å¤±è´¥", {error = "timeout"})
--]]
function Config.log(level, message, data)
    if not Config.DEBUG.ENABLED then return end

    local levels = {DEBUG = 1, INFO = 2, WARN = 3, ERROR = 4}
    local currentLevel = levels[Config.DEBUG.LOG_LEVEL] or 2
    local messageLevel = levels[level] or 2

    if messageLevel >= currentLevel then
        local timestamp = os.date("%Y-%m-%d %H:%M:%S")
        local logMessage = string.format("[%s] %s: %s", timestamp, level, message)

        if data then
            logMessage = logMessage .. " | Data: " .. game:GetService("HttpService"):JSONEncode(data)
        end

        print(logMessage)
    end
end

-- è‡ªåŠ¨åˆå§‹åŒ–é…ç½®
spawn(function()
    wait(1) -- ç­‰å¾…æ¸¸æˆåŠ è½½å®Œæˆ
    if game:GetService("RunService"):IsServer() then
        Config.ensureAdminConfigLoaded()
        Config.ensureSystemConfigLoaded()
        Config.log("INFO", "å•†åº—ç³»ç»Ÿé…ç½®å·²åˆå§‹åŒ–")
    end
end)

return Config
