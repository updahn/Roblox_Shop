-- ğŸ“‹ Configæ¨¡å—ä½¿ç”¨ç¤ºä¾‹
-- è¿™ä¸ªæ–‡ä»¶å±•ç¤ºå¦‚ä½•æ­£ç¡®ä½¿ç”¨ç»Ÿä¸€é…ç½®æ–‡ä»¶

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- ç­‰å¾…å¹¶å¼•ç”¨é…ç½®æ¨¡å—
local SharedModules = ReplicatedStorage:WaitForChild("SharedModules")
local Config = require(SharedModules:WaitForChild("Config"))

-- ç¤ºä¾‹ï¼šä½¿ç”¨APIé…ç½®
print("APIåŸºç¡€URL:", Config.API.BASE_URL)
print("è¯·æ±‚è¶…æ—¶æ—¶é—´:", Config.API.TIMEOUT .. "ç§’")

-- ç¤ºä¾‹ï¼šæ„å»ºå®Œæ•´API URL
local itemsUrl = Config.getApiUrl("/items")
print("å•†å“APIåœ°å€:", itemsUrl)

-- ç¤ºä¾‹ï¼šæ£€æŸ¥ç®¡ç†å‘˜æƒé™
local function checkPlayerPermissions(player)
    if Config.isValidAdmin(player) then
        print("ğŸ‘‘", player.Name, "æ˜¯ç®¡ç†å‘˜")

        -- æ£€æŸ¥å…·ä½“æƒé™
        if Config.ADMIN.PERMISSIONS.MANAGE_USERS then
            print("âœ“ æ‹¥æœ‰ç”¨æˆ·ç®¡ç†æƒé™")
        end

        if Config.ADMIN.PERMISSIONS.SYSTEM_ADMIN then
            print("âœ“ æ‹¥æœ‰ç³»ç»Ÿç®¡ç†æƒé™")
        end
    else
        print("ğŸ‘¤", player.Name, "æ˜¯æ™®é€šç”¨æˆ·")
    end
end

-- ç¤ºä¾‹ï¼šä½¿ç”¨UIé…ç½®
local function createSampleButton()
    local button = Instance.new("TextButton")
    button.BackgroundColor3 = Config.UI.COLORS.PRIMARY
    button.TextColor3 = Config.UI.COLORS.TEXT_PRIMARY
    button.Size = UDim2.new(0, 120, 0, Config.UI.SIZES.BUTTON_HEIGHT)

    -- åˆ›å»ºåœ†è§’
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, Config.UI.SIZES.CORNER_RADIUS)
    corner.Parent = button

    return button
end

-- ç¤ºä¾‹ï¼šä½¿ç”¨ç»æµé…ç½®
local function giveStartingCoins(player)
    local startingCoins = Config.GAME.ECONOMY.STARTING_COINS
    print("ç»™äºˆæ–°ç©å®¶", Config.formatCurrency(startingCoins))
end

-- ç¤ºä¾‹ï¼šä½¿ç”¨æ—¥å¿—ç³»ç»Ÿ
Config.log("INFO", "é…ç½®ç¤ºä¾‹è„šæœ¬å·²åŠ è½½")
Config.log("DEBUG", "å½“å‰è°ƒè¯•æ¨¡å¼", {enabled = Config.isDebugMode()})

-- ç¤ºä¾‹ï¼šæ£€æŸ¥ç¯å¢ƒé…ç½®
if Config.isDebugMode() then
    print("ğŸ”§ è¿è¡Œåœ¨å¼€å‘ç¯å¢ƒ")
    print("ğŸ” æ—¥å¿—çº§åˆ«:", Config.DEBUG.LOG_LEVEL)
    print("ğŸ“Š æ€§èƒ½ç›‘æ§:", Config.DEBUG.PERFORMANCE_MONITORING and "å¼€å¯" or "å…³é—­")
else
    print("ğŸš€ è¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒ")
end

-- ç¤ºä¾‹ï¼šä½¿ç”¨æœ¬åœ°åŒ–é…ç½®
print("é»˜è®¤è¯­è¨€:", Config.LOCALIZATION.DEFAULT_LANGUAGE)
print("è´§å¸ç¬¦å·:", Config.LOCALIZATION.CURRENCY_FORMAT.SYMBOL)

-- ç¤ºä¾‹ï¼šæ ¼å¼åŒ–è´§å¸æ˜¾ç¤º
local sampleAmount = 12345
print("æ ¼å¼åŒ–å‰:", sampleAmount)
print("æ ¼å¼åŒ–å:", Config.formatCurrency(sampleAmount))

-- ç¤ºä¾‹ï¼šä½¿ç”¨åŠ¨ç”»é…ç½®
local function createFadeAnimation(guiObject)
    local TweenService = game:GetService("TweenService")

    local fadeIn = TweenService:Create(
        guiObject,
        TweenInfo.new(
            Config.UI.ANIMATIONS.DURATION.NORMAL,
            Config.UI.ANIMATIONS.EASING.DEFAULT
        ),
        {BackgroundTransparency = 0}
    )

    return fadeIn
end

-- ç¤ºä¾‹ï¼šå®‰å…¨é…ç½®ä½¿ç”¨
print("é€Ÿç‡é™åˆ¶:", Config.SECURITY.RATE_LIMITING.ENABLED and "å¼€å¯" or "å…³é—­")
print("æœ€å¤§è¯·æ±‚å¤§å°:", Config.SECURITY.MAX_REQUEST_SIZE .. " bytes")

-- ç¤ºä¾‹ï¼šå“åº”å¼é…ç½®
-- åœ¨ä¸åŒç¯å¢ƒä¸‹ä½¿ç”¨ä¸åŒé…ç½®
local function getEnvironmentConfig()
    if game:GetService("RunService"):IsStudio() then
        return {
            apiUrl = "http://localhost:3001/api",  -- å¼€å‘ç¯å¢ƒ
            debugLevel = "DEBUG",
            enableMocking = true
        }
    else
        return {
            apiUrl = Config.API.BASE_URL,  -- ç”Ÿäº§ç¯å¢ƒ
            debugLevel = Config.DEBUG.LOG_LEVEL,
            enableMocking = false
        }
    end
end

local envConfig = getEnvironmentConfig()
print("å½“å‰ç¯å¢ƒAPI URL:", envConfig.apiUrl)

-- ç¤ºä¾‹ï¼šé…ç½®éªŒè¯
local function validateConfig()
    local errors = {}

    -- æ£€æŸ¥å¿…éœ€çš„é…ç½®
    if not Config.API.BASE_URL or Config.API.BASE_URL == "" then
        table.insert(errors, "APIåŸºç¡€URLæœªé…ç½®")
    end

    if Config.GAME.ECONOMY.STARTING_COINS <= 0 then
        table.insert(errors, "åˆå§‹é‡‘å¸æ•°é‡å¿…é¡»å¤§äº0")
    end

    if #errors > 0 then
        warn("é…ç½®éªŒè¯å¤±è´¥:")
        for _, error in ipairs(errors) do
            warn("âŒ", error)
        end
        return false
    else
        print("âœ… é…ç½®éªŒè¯é€šè¿‡")
        return true
    end
end

-- è¿è¡Œé…ç½®éªŒè¯
validateConfig()

-- ç¤ºä¾‹ï¼šé…ç½®ç›‘å¬å™¨ï¼ˆæ¨¡æ‹Ÿï¼‰
-- æ³¨æ„ï¼šå®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦å®ç°é…ç½®çƒ­é‡è½½
local function onConfigChange(configKey, oldValue, newValue)
    Config.log("INFO", "é…ç½®å·²æ›´æ”¹", {
        key = configKey,
        oldValue = oldValue,
        newValue = newValue
    })

    -- æ ¹æ®é…ç½®æ›´æ”¹æ‰§è¡Œç›¸åº”æ“ä½œ
    if configKey == "UI.COLORS.PRIMARY" then
        -- æ›´æ–°æ‰€æœ‰UIå…ƒç´ çš„ä¸»è‰²è°ƒ
        print("ğŸ¨ æ­£åœ¨æ›´æ–°UIä¸»è‰²è°ƒ...")
    elseif configKey == "ADMIN.USER_IDS" then
        -- é‡æ–°éªŒè¯ç®¡ç†å‘˜æƒé™
        print("ğŸ‘‘ æ­£åœ¨æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨...")
    end
end

-- å¯¼å‡ºç¤ºä¾‹å‡½æ•°ä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
return {
    checkPlayerPermissions = checkPlayerPermissions,
    createSampleButton = createSampleButton,
    giveStartingCoins = giveStartingCoins,
    createFadeAnimation = createFadeAnimation,
    getEnvironmentConfig = getEnvironmentConfig,
    validateConfig = validateConfig,
    onConfigChange = onConfigChange
}
