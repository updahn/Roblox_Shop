--[[
    ç¯å¢ƒç®¡ç†å™¨ - ç»Ÿä¸€ç®¡ç†å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒé…ç½®
    æ”¯æŒå¤šç§ç¯å¢ƒæ£€æµ‹æ–¹å¼å’Œé…ç½®ç®¡ç†
]]

local EnvironmentManager = {}

-- æœåŠ¡å¼•ç”¨
local RunService = game:GetService("RunService")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ==============================================
-- ç¯å¢ƒæ£€æµ‹
-- ==============================================

-- ç¯å¢ƒç±»å‹æšä¸¾
local EnvironmentType = {
    STUDIO = "studio",
    DEVELOPMENT = "development",
    STAGING = "staging",
    PRODUCTION = "production"
}

-- å½“å‰ç¯å¢ƒç¼“å­˜
local currentEnvironment = nil
local environmentConfig = nil

-- æ£€æµ‹å½“å‰ç¯å¢ƒ
local function detectEnvironment()
    if currentEnvironment then
        return currentEnvironment
    end

    -- 1. é¦–å…ˆæ£€æŸ¥æ˜¯å¦åœ¨Studio
    if RunService:IsStudio() then
        currentEnvironment = EnvironmentType.STUDIO
        print("ğŸ”§ ç¯å¢ƒæ£€æµ‹: Studioå¼€å‘ç¯å¢ƒ")
        return currentEnvironment
    end

    -- 2. æ£€æŸ¥æ¸¸æˆIDæ¥ç¡®å®šç¯å¢ƒ
    local gameId = game.GameId
    local placeId = game.PlaceId

    -- è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…çš„æ¸¸æˆIDé…ç½®ä¸åŒç¯å¢ƒ
    -- ç¤ºä¾‹é…ç½® - éœ€è¦æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    local environmentPlaces = {
        -- å¼€å‘ç¯å¢ƒçš„PlaceID
        development = {
            gameIds = {},
            placeIds = {}
        },
        -- æµ‹è¯•ç¯å¢ƒçš„PlaceID
        staging = {
            gameIds = {},
            placeIds = {}
        },
        -- ç”Ÿäº§ç¯å¢ƒçš„PlaceID
        production = {
            gameIds = {},
            placeIds = {}
        }
    }

    -- æ£€æŸ¥Place IDåŒ¹é…
    for envType, config in pairs(environmentPlaces) do
        for _, id in ipairs(config.placeIds) do
            if placeId == id then
                currentEnvironment = envType
                print("ğŸŒ ç¯å¢ƒæ£€æµ‹: " .. envType .. "ç¯å¢ƒ (PlaceID: " .. placeId .. ")")
                return currentEnvironment
            end
        end
    end

    -- 3. å¦‚æœæ²¡æœ‰æ˜ç¡®é…ç½®ï¼Œæ£€æŸ¥DataStoreå¯ç”¨æ€§æ¥åˆ¤æ–­
    local hasDataStore = pcall(function()
        local testStore = DataStoreService:GetDataStore("EnvironmentTest")
        testStore:GetAsync("test")
    end)

    if hasDataStore then
        -- é»˜è®¤ä¸ºç”Ÿäº§ç¯å¢ƒ
        currentEnvironment = EnvironmentType.PRODUCTION
        print("ğŸš€ ç¯å¢ƒæ£€æµ‹: ç”Ÿäº§ç¯å¢ƒ (é»˜è®¤)")
    else
        -- DataStoreä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯å¼€å‘ç¯å¢ƒ
        currentEnvironment = EnvironmentType.DEVELOPMENT
        print("âš ï¸ ç¯å¢ƒæ£€æµ‹: å¼€å‘ç¯å¢ƒ (DataStoreä¸å¯ç”¨)")
    end

    return currentEnvironment
end

-- ==============================================
-- ç¯å¢ƒé…ç½®ç®¡ç†
-- ==============================================

-- ä¸åŒç¯å¢ƒçš„é…ç½®
local environmentConfigs = {
    [EnvironmentType.STUDIO] = {
        dataStore = {
            enabled = false,
            mockData = true,
            saveInterval = 5, -- æ›´é¢‘ç¹çš„ä¿å­˜ç”¨äºæµ‹è¯•
            retryAttempts = 1
        },
        logging = {
            level = "debug",
            enableConsole = true,
            enableRemote = false
        },
        performance = {
            cacheTimeout = 60,
            batchSize = 10,
            rateLimitEnabled = false
        },
        features = {
            adminPanelEnabled = true,
            debugMode = true,
            testDataEnabled = true
        }
    },

    [EnvironmentType.DEVELOPMENT] = {
        dataStore = {
            enabled = true,
            mockData = false,
            saveInterval = 30,
            retryAttempts = 2,
            backupEnabled = false
        },
        logging = {
            level = "info",
            enableConsole = true,
            enableRemote = true
        },
        performance = {
            cacheTimeout = 300,
            batchSize = 50,
            rateLimitEnabled = true
        },
        features = {
            adminPanelEnabled = true,
            debugMode = true,
            testDataEnabled = false
        }
    },

    [EnvironmentType.STAGING] = {
        dataStore = {
            enabled = true,
            mockData = false,
            saveInterval = 60,
            retryAttempts = 3,
            backupEnabled = true
        },
        logging = {
            level = "warn",
            enableConsole = false,
            enableRemote = true
        },
        performance = {
            cacheTimeout = 600,
            batchSize = 100,
            rateLimitEnabled = true
        },
        features = {
            adminPanelEnabled = true,
            debugMode = false,
            testDataEnabled = false
        }
    },

    [EnvironmentType.PRODUCTION] = {
        dataStore = {
            enabled = true,
            mockData = false,
            saveInterval = 120,
            retryAttempts = 5,
            backupEnabled = true
        },
        logging = {
            level = "error",
            enableConsole = false,
            enableRemote = true
        },
        performance = {
            cacheTimeout = 1800,
            batchSize = 200,
            rateLimitEnabled = true
        },
        features = {
            adminPanelEnabled = false,
            debugMode = false,
            testDataEnabled = false
        }
    }
}

-- è·å–å½“å‰ç¯å¢ƒé…ç½®
local function getEnvironmentConfig()
    if environmentConfig then
        return environmentConfig
    end

    local env = detectEnvironment()
    environmentConfig = environmentConfigs[env] or environmentConfigs[EnvironmentType.PRODUCTION]

    return environmentConfig
end

-- ==============================================
-- å…¬å…±æ¥å£
-- ==============================================

-- è·å–å½“å‰ç¯å¢ƒç±»å‹
function EnvironmentManager.getCurrentEnvironment()
    return detectEnvironment()
end

-- æ£€æŸ¥æ˜¯å¦ä¸ºç‰¹å®šç¯å¢ƒ
function EnvironmentManager.isStudio()
    return detectEnvironment() == EnvironmentType.STUDIO
end

function EnvironmentManager.isDevelopment()
    local env = detectEnvironment()
    return env == EnvironmentType.DEVELOPMENT or env == EnvironmentType.STUDIO
end

function EnvironmentManager.isStaging()
    return detectEnvironment() == EnvironmentType.STAGING
end

function EnvironmentManager.isProduction()
    return detectEnvironment() == EnvironmentType.PRODUCTION
end

-- è·å–é…ç½®å€¼
function EnvironmentManager.getConfig(configPath)
    local config = getEnvironmentConfig()

    -- æ”¯æŒç‚¹åˆ†è·¯å¾„ï¼Œå¦‚ "dataStore.enabled"
    local keys = string.split(configPath, ".")
    local value = config

    for _, key in ipairs(keys) do
        if type(value) == "table" and value[key] ~= nil then
            value = value[key]
        else
            return nil
        end
    end

    return value
end

-- è·å–å®Œæ•´é…ç½®
function EnvironmentManager.getAllConfig()
    return getEnvironmentConfig()
end

-- è·å–DataStoreé…ç½®
function EnvironmentManager.getDataStoreConfig()
    return getEnvironmentConfig().dataStore
end

-- è·å–æ—¥å¿—é…ç½®
function EnvironmentManager.getLoggingConfig()
    return getEnvironmentConfig().logging
end

-- è·å–æ€§èƒ½é…ç½®
function EnvironmentManager.getPerformanceConfig()
    return getEnvironmentConfig().performance
end

-- è·å–åŠŸèƒ½é…ç½®
function EnvironmentManager.getFeatureConfig()
    return getEnvironmentConfig().features
end

-- å¼ºåˆ¶é‡æ–°æ£€æµ‹ç¯å¢ƒï¼ˆç”¨äºæµ‹è¯•ï¼‰
function EnvironmentManager.forceRedetect()
    currentEnvironment = nil
    environmentConfig = nil
    return detectEnvironment()
end

-- è®¾ç½®ç¯å¢ƒï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
function EnvironmentManager.setEnvironment(envType)
    if EnvironmentManager.isStudio() then
        currentEnvironment = envType
        environmentConfig = nil
        print("ğŸ”§ æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒä¸º:", envType)
    else
        warn("âš ï¸ åªèƒ½åœ¨Studioç¯å¢ƒä¸­æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒç±»å‹")
    end
end

-- ==============================================
-- ç¯å¢ƒä¿¡æ¯è¾“å‡º
-- ==============================================

-- è¾“å‡ºç¯å¢ƒä¿¡æ¯
function EnvironmentManager.printEnvironmentInfo()
    local env = detectEnvironment()
    local config = getEnvironmentConfig()

    print("=" .. string.rep("=", 50))
    print("ğŸŒ ç¯å¢ƒä¿¡æ¯")
    print("=" .. string.rep("=", 50))
    print("ç¯å¢ƒç±»å‹:", env)
    print("æ¸¸æˆID:", game.GameId)
    print("åœºæ™¯ID:", game.PlaceId)
    print("DataStoreå¯ç”¨:", config.dataStore.enabled)
    print("æ¨¡æ‹Ÿæ•°æ®:", config.dataStore.mockData)
    print("æ—¥å¿—çº§åˆ«:", config.logging.level)
    print("è°ƒè¯•æ¨¡å¼:", config.features.debugMode)
    print("ç®¡ç†é¢æ¿:", config.features.adminPanelEnabled)
    print("=" .. string.rep("=", 50))
end

-- æ¨¡å—åˆå§‹åŒ–
spawn(function()
    wait(1) -- ç­‰å¾…æ¸¸æˆå®Œå…¨åŠ è½½
    EnvironmentManager.printEnvironmentInfo()
end)

return EnvironmentManager
